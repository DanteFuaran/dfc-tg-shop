{% extends "base.html" %}
{% block title %}–ö–∞–±–∏–Ω–µ—Ç{% endblock %}

{% block content %}
<div class="bg-glow"></div>
<div class="app-wrapper">

<header class="app-header">
    <div class="brand">
        <span class="brand-logo">üîê</span>
        <span class="brand-name">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</span>
    </div>
    <button class="btn-icon" onclick="logout()" title="–í—ã–π—Ç–∏">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
    </button>
</header>

<main class="app-content">

<!-- ‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê -->
<section id="p-home" class="page active">
    <div class="card sub-card">
        <div class="sub-card-top">
            <span class="sub-badge sub-badge-none" id="sub-badge">‚Äî</span>
            <span class="sub-expire" id="sub-expire"></span>
        </div>
        <div class="sub-traffic" id="sub-traffic"></div>
    </div>
    <div class="action-pills">
        <button class="pill pill-gold" onclick="go('plans')">üõí&nbsp; –ö—É–ø–∏—Ç—å</button>
        <button class="pill pill-cyan" onclick="go('connect')">‚äô&nbsp; –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
        <div class="pill-row">
            <button class="pill pill-outline" onclick="go('promo')">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥—ã</button>
            <button class="pill pill-outline" onclick="go('devices')">üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
        </div>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê PLANS ‚ïê‚ïê‚ïê -->
<section id="p-plans" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã</h2>
    </div>
    <div id="plans-list" class="plans-list"></div>
</section>

<!-- ‚ïê‚ïê‚ïê CONNECT ‚ïê‚ïê‚ïê -->
<section id="p-connect" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h2>
    </div>
    <div class="card">
        <div class="card-title">–°—Å—ã–ª–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏</div>
        <div class="connect-box">
            <code id="con-url">‚Äî</code>
            <button onclick="copyUrl()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>
    <div class="card">
        <div class="card-title">–°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
        <div class="apps-grid">
            <a class="app-link" href="https://apps.apple.com/app/happ-proxy-utility-plus/id6746188973" target="_blank"><span class="app-icon">üçè</span> iOS</a>
            <a class="app-link" href="https://play.google.com/store/apps/details?id=com.happproxy" target="_blank"><span class="app-icon">ü§ñ</span> Android</a>
            <a class="app-link" href="https://github.com/Happ-proxy/happ-desktop/releases/latest/download/setup-Happ.x64.exe" target="_blank"><span class="app-icon">ü™ü</span> Windows</a>
            <a class="app-link" href="https://github.com/Happ-proxy/happ-desktop/releases/" target="_blank"><span class="app-icon">üçé</span> macOS</a>
        </div>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê DEVICES ‚ïê‚ïê‚ïê -->
<section id="p-devices" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h2>
    </div>
    <div class="card">
        <div class="card-row"><span class="card-label">–õ–∏–º–∏—Ç</span><span class="card-value" id="dev-limit">‚Äî</span></div>
        <div class="card-row"><span class="card-label">–ó–∞–Ω—è—Ç–æ</span><span class="card-value" id="dev-used">‚Äî</span></div>
    </div>
    <p style="font-size:.82rem;color:var(--text3);margin-top:8px">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –±–æ—Ç–µ.</p>
</section>

<!-- ‚ïê‚ïê‚ïê PROMO ‚ïê‚ïê‚ïê -->
<section id="p-promo" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ü—Ä–æ–º–æ–∫–æ–¥—ã</h2>
    </div>
    <div class="card">
        <div class="card-title">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</div>
        <div style="display:flex;gap:8px">
            <input class="form-input" id="promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" style="flex:1">
            <button class="btn btn-primary btn-sm" onclick="activatePromo()">OK</button>
        </div>
        <p id="promo-result" style="font-size:.8rem;margin-top:8px;display:none"></p>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê SUPPORT ‚ïê‚ïê‚ïê -->
<section id="p-support" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
    </div>
    <div class="card" id="support-community" style="display:none">
        <div class="card-title">üí¨ –°–æ–æ–±—â–µ—Å—Ç–≤–æ</div>
        <p style="font-size:.84rem;color:var(--text2);margin-bottom:12px">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–π –≥—Ä—É–ø–ø–µ</p>
        <a class="pill pill-cyan" id="btn-community" href="#" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a>
    </div>
    <div class="card" id="support-help" style="display:none">
        <div class="card-title">üõü –ü–æ–º–æ—â—å</div>
        <p style="font-size:.84rem;color:var(--text2);margin-bottom:12px">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</p>
        <a class="pill pill-outline" id="btn-support" href="#" target="_blank">–ù–∞–ø–∏—Å–∞—Ç—å</a>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê -->
<section id="p-profile" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ü—Ä–æ—Ñ–∏–ª—å</h2>
    </div>
    <div class="card">
        <div class="card-row"><span class="card-label">–ò–º—è</span><span class="card-value" id="pr-name">‚Äî</span></div>
        <div class="card-row"><span class="card-label">Telegram</span><span class="card-value" id="pr-uname">‚Äî</span></div>
        <div class="card-row"><span class="card-label">ID</span><span class="card-value" id="pr-tid">‚Äî</span></div>
        <div class="card-row"><span class="card-label">–ë–∞–ª–∞–Ω—Å</span><span class="card-value" id="pr-balance">‚Äî</span></div>
        <div class="card-row"><span class="card-label">–†–æ–ª—å</span><span class="card-value" id="pr-role">‚Äî</span></div>
    </div>
    <div class="card" id="ref-card" style="display:none">
        <div class="card-title">ü§ù –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</div>
        <div class="ref-box">
            <code id="ref-link">‚Äî</code>
            <button class="btn btn-primary btn-sm btn-full" onclick="copyRef()" style="margin-top:4px">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        </div>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê ADMIN ‚ïê‚ïê‚ïê -->
<section id="p-admin" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
    </div>
    <div class="admin-tabs" id="adm-tabs">
        <button class="admin-tab active" onclick="admTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="admin-tab" onclick="admTab('users')">–ü–æ–ª—å–∑.</button>
        <button class="admin-tab" onclick="admTab('plans')">–¢–∞—Ä–∏—Ñ—ã</button>
        <button class="admin-tab" onclick="admTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button class="admin-tab" onclick="admTab('brand')">–ë—Ä–µ–Ω–¥</button>
    </div>
    <div id="adm-stats" class="admin-content active">
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="st-total">‚Äî</div><div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div></div>
            <div class="stat-card"><div class="stat-value" id="st-active">‚Äî</div><div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div></div>
            <div class="stat-card"><div class="stat-value" id="st-expired">‚Äî</div><div class="stat-label">–ò—Å—Ç–µ–∫—à–∏—Ö</div></div>
            <div class="stat-card"><div class="stat-value" id="st-revenue">‚Äî</div><div class="stat-label">–ë–∞–ª–∞–Ω—Å ‚ÇΩ</div></div>
        </div>
    </div>
    <div id="adm-users" class="admin-content">
        <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ / ID" oninput="filterUsers()">
        </div>
        <div id="users-list" class="user-list"></div>
    </div>
    <div id="adm-plans" class="admin-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
            <span style="color:var(--text2);font-size:.84rem" id="adm-plans-count">–¢–∞—Ä–∏—Ñ—ã</span>
            <button class="btn btn-primary btn-sm" onclick="showCreatePlan()">+ –°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <div id="adm-plans-list" class="plans-list"></div>
    </div>
    <div id="adm-settings" class="admin-content"><div id="settings-list"></div></div>
    <div id="adm-brand" class="admin-content">
        <div class="card">
            <div class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–µ–Ω–¥–∞</div>
            <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="form-input" id="br-name" placeholder="VPN Shop"></div>
            <div class="form-group"><label>–õ–æ–≥–æ—Ç–∏–ø (—ç–º–æ–¥–∑–∏)</label><input class="form-input" id="br-logo" placeholder="üîê"></div>
            <div class="form-group"><label>–°–ª–æ–≥–∞–Ω</label><input class="form-input" id="br-slogan" placeholder=""></div>
            <button class="btn btn-primary btn-full" onclick="saveBrand()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</section>

<!-- Admin user detail -->
<section id="p-auser" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="admTab('users');go('admin')">‚Äπ</button>
        <h2 class="page-title" id="aud-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
    </div>
    <div id="aud-body"></div>
</section>

</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <button class="nav-item active" data-p="home" onclick="go('home')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button class="nav-item" data-p="support" onclick="go('support')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
    </button>
    <button class="nav-item" data-p="profile" onclick="go('profile')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </button>
    <button class="nav-item admin-nav" data-p="admin" onclick="go('admin')" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        <span>–ê–¥–º–∏–Ω</span>
    </button>
</nav>

</div>

<div id="modal-root"></div>
<div id="toast" class="toast"></div>
{% endblock %}

{% block scripts %}
<script>
const API='/web', D={{ data_json | safe }};
let IS_ADMIN=D.user.role==='DEV'||D.user.role==='ADMIN';
let usersCache=[],curAdmTab='stats';

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
(function(){
    if(IS_ADMIN) document.querySelectorAll('.admin-nav').forEach(e=>e.style.display='');
    render();
})();

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
function go(p){
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    document.getElementById('p-'+p).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.toggle('active',b.dataset.p===p));
    if(p==='admin')loadAdm(curAdmTab);
    if(p==='plans')renderPlans();
}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
function render(){renderSub();renderConnect();renderProfile();renderSupport()}

function renderSub(){
    const s=D.subscription,b=document.getElementById('sub-badge'),e=document.getElementById('sub-expire'),t=document.getElementById('sub-traffic');
    if(!s||!s.status){b.textContent='–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏';b.className='sub-badge sub-badge-none';e.textContent='';t.innerHTML='';return}
    if(s.is_trial){b.textContent='–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥';b.className='sub-badge sub-badge-trial'}
    else if(s.status==='ACTIVE'){b.textContent='–ê–∫—Ç–∏–≤–Ω–∞';b.className='sub-badge sub-badge-active'}
    else if(s.status==='EXPIRED'){b.textContent='–ò—Å—Ç–µ–∫–ª–∞';b.className='sub-badge sub-badge-expired'}
    else{b.textContent=s.status;b.className='sub-badge sub-badge-none'}
    e.innerHTML=s.expire_at?'üìÖ –¥–æ '+s.expire_at:'';
    const tl=s.traffic_limit?s.traffic_limit+' GB':'‚àû';
    t.innerHTML='–¢—Ä–∞—Ñ–∏–∫ <b>0 B / '+tl+'</b>';
}

function renderPlans(){
    const el=document.getElementById('plans-list');
    if(!D.plans||!D.plans.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">üìã</span><h3>–ù–µ—Ç —Ç–∞—Ä–∏—Ñ–æ–≤</h3></div>';return}
    el.innerHTML=D.plans.map(p=>{
        const durs=(p.durations||[]).map(d=>{
            const pr=(d.prices||[]).map(x=>'<span class="plan-price">'+x.amount+' '+x.currency+'</span>').join(' / ');
            return '<div class="plan-duration"><span class="plan-days">'+d.days+' –¥–Ω.</span>'+pr+'</div>';
        }).join('');
        return '<div class="card plan-card"><h3 class="plan-name">'+esc(p.name)+'</h3><div class="plan-info"><span>–¢—Ä–∞—Ñ–∏–∫: '+(p.traffic_limit||'‚àû')+' GB</span><span>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: '+(p.device_limit||'‚àû')+'</span></div><div class="plan-durations">'+durs+'</div></div>';
    }).join('');
}

function renderConnect(){
    const s=D.subscription;
    document.getElementById('con-url').textContent=(s&&s.url)?s.url:'–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏';
    const dl=s&&s.device_limit;
    document.getElementById('dev-limit').textContent=dl||'‚Äî';
    document.getElementById('dev-used').textContent='‚Äî';
}

function renderProfile(){
    const u=D.user;
    document.getElementById('pr-name').textContent=u.name||'‚Äî';
    document.getElementById('pr-uname').textContent=u.username?'@'+u.username:'‚Äî';
    document.getElementById('pr-tid').textContent=u.telegram_id;
    document.getElementById('pr-balance').textContent=u.balance+' ‚ÇΩ';
    const rm={USER:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',ADMIN:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',DEV:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫'};
    document.getElementById('pr-role').textContent=rm[u.role]||u.role;
    if(D.features&&D.features.referral_enabled!==false){
        document.getElementById('ref-card').style.display='';
        const bot=D.bot_username||'bot';
        document.getElementById('ref-link').textContent='https://t.me/'+bot+'?start=ref_'+u.telegram_id;
    }
}

function renderSupport(){
    if(D.features){
        if(D.features.community_enabled&&D.features.community_url){
            document.getElementById('support-community').style.display='';
            document.getElementById('btn-community').href=D.features.community_url;
        }
    }
    if(D.support_url){
        document.getElementById('support-help').style.display='';
        document.getElementById('btn-support').href=D.support_url;
    }
}

/* ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ */
function copyUrl(){
    const s=D.subscription;
    if(s&&s.url)navigator.clipboard.writeText(s.url).then(()=>toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!')).catch(()=>toast('–û—à–∏–±–∫–∞','error'));
    else toast('–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏','error');
}
function copyRef(){
    navigator.clipboard.writeText(document.getElementById('ref-link').textContent).then(()=>toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')).catch(()=>toast('–û—à–∏–±–∫–∞','error'));
}
async function activatePromo(){
    const code=document.getElementById('promo-input').value.trim();if(!code)return;
    const r=document.getElementById('promo-result');
    try{
        const res=await fetch(API+'/api/promocode/activate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
        const d=await res.json();r.style.display='block';
        if(res.ok){r.style.color='var(--green)';r.textContent=d.message||'–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!'}
        else{r.style.color='var(--red)';r.textContent=d.detail||'–û—à–∏–±–∫–∞'}
    }catch(e){r.style.display='block';r.style.color='var(--red)';r.textContent='–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'}
}
async function logout(){await fetch(API+'/api/auth/logout',{method:'POST'});window.location.href='/web/login'}

/* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
function admTab(t){
    curAdmTab=t;
    document.querySelectorAll('#adm-tabs .admin-tab').forEach((b,i)=>b.classList.toggle('active',['stats','users','plans','settings','brand'][i]===t));
    document.querySelectorAll('.admin-content').forEach(c=>c.classList.remove('active'));
    const el=document.getElementById('adm-'+t);if(el)el.classList.add('active');
    loadAdm(t);
}
async function loadAdm(t){
    if(t==='stats')await loadStats();if(t==='users')await loadUsers();
    if(t==='plans')await loadAdmPlans();if(t==='settings')await loadSettings();
    if(t==='brand')loadBrandForm();
}
async function loadStats(){
    try{const r=await fetch(API+'/api/admin/stats');if(!r.ok)return;const d=await r.json();
    document.getElementById('st-total').textContent=d.total_users||0;document.getElementById('st-active').textContent=d.active_subscriptions||0;
    document.getElementById('st-expired').textContent=d.expired_subscriptions||0;document.getElementById('st-revenue').textContent=d.total_revenue||0}catch(e){}
}
async function loadUsers(){
    try{const r=await fetch(API+'/api/admin/users');if(!r.ok)return;usersCache=await r.json();drawUsers(usersCache)}catch(e){}
}
function filterUsers(){
    const q=document.getElementById('user-search').value.toLowerCase().trim();
    if(!q)return drawUsers(usersCache);
    drawUsers(usersCache.filter(u=>(u.name||'').toLowerCase().includes(q)||String(u.telegram_id).includes(q)||(u.username||'').toLowerCase().includes(q)));
}
function drawUsers(list){
    const el=document.getElementById('users-list');
    if(!list.length){el.innerHTML='<div class="empty-state">–ü—É—Å—Ç–æ</div>';return}
    el.innerHTML=list.slice(0,50).map(u=>{
        const ini=(u.name||'?')[0].toUpperCase();
        const rc=u.role==='DEV'?'role-dev':u.role==='ADMIN'?'role-admin':'role-user';
        const rn=u.role==='DEV'?'DEV':u.role==='ADMIN'?'ADM':'USER';
        return '<div class="user-item" onclick="openUser('+u.telegram_id+')"><div class="user-item-info"><div class="user-avatar">'+esc(ini)+'</div><div><div class="user-name">'+esc(u.name||'‚Äî')+'</div><div class="user-sub">ID: '+u.telegram_id+'</div></div></div><span class="role-badge '+rc+'">'+rn+'</span></div>';
    }).join('');
}
async function openUser(tid){
    go('auser');document.getElementById('aud-title').textContent='–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';
    document.getElementById('aud-body').innerHTML='<div style="text-align:center;padding:40px"><div class="spinner"></div></div>';
    try{
        const r=await fetch(API+'/api/admin/users/'+tid);if(!r.ok){document.getElementById('aud-body').innerHTML='<div class="empty-state">–û—à–∏–±–∫–∞</div>';return}
        const u=await r.json();document.getElementById('aud-title').textContent=u.name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';drawUserDetail(u);
    }catch(e){document.getElementById('aud-body').innerHTML='<div class="empty-state">'+e.message+'</div>'}
}
function drawUserDetail(u){
    const rm={USER:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',ADMIN:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',DEV:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫'};
    const si=u.subscription?'<div class="card-row"><span class="card-label">–ü–æ–¥–ø–∏—Å–∫–∞</span><span class="card-value">'+(u.subscription.plan_name||'‚Äî')+'</span></div><div class="card-row"><span class="card-label">–°—Ç–∞—Ç—É—Å</span><span class="card-value">'+u.subscription.status+'</span></div><div class="card-row"><span class="card-label">–ò—Å—Ç–µ–∫–∞–µ—Ç</span><span class="card-value">'+(u.subscription.expire_at||'‚Äî')+'</span></div>':'<div class="card-row"><span class="card-label">–ü–æ–¥–ø–∏—Å–∫–∞</span><span class="card-value" style="color:var(--text3)">–ù–µ—Ç</span></div>';
    document.getElementById('aud-body').innerHTML='<div class="card"><div class="card-row"><span class="card-label">–ò–º—è</span><span class="card-value">'+esc(u.name||'‚Äî')+'</span></div><div class="card-row"><span class="card-label">Username</span><span class="card-value">'+(u.username?'@'+esc(u.username):'‚Äî')+'</span></div><div class="card-row"><span class="card-label">ID</span><span class="card-value">'+u.telegram_id+'</span></div><div class="card-row"><span class="card-label">–ë–∞–ª–∞–Ω—Å</span><span class="card-value">'+u.balance+' ‚ÇΩ</span></div><div class="card-row"><span class="card-label">–†–æ–ª—å</span><span class="card-value">'+(rm[u.role]||u.role)+'</span></div><div class="card-row"><span class="card-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span><span class="card-value">'+(u.is_blocked?'–î–∞':'–ù–µ—Ç')+'</span></div>'+si+'</div><div style="display:flex;flex-direction:column;gap:8px"><button class="btn btn-secondary btn-full" onclick="changeRole('+u.telegram_id+',\''+u.role+'\')">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button><button class="btn btn-secondary btn-full" onclick="changeBal('+u.telegram_id+','+u.balance+')">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button><button class="btn '+(u.is_blocked?'btn-primary':'btn-danger')+' btn-full" onclick="toggleBlock('+u.telegram_id+','+u.is_blocked+')">'+(u.is_blocked?'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å')+'</button></div>';
}
function changeRole(tid,cur){
    const roles=['USER','ADMIN','DEV'],names=['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å','–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä','–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫'];
    showModal('<h3>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</h3>'+roles.map((r,i)=>'<button class="btn '+(r===cur?'btn-primary':'btn-secondary')+' btn-full" style="margin-top:6px" onclick="setRole('+tid+',\''+r+'\')">'+names[i]+'</button>').join('')+'<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>');
}
async function setRole(tid,role){closeModal();try{const r=await fetch(API+'/api/admin/users/'+tid+'/role',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role})});if(r.ok){toast('–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞');openUser(tid)}else{const d=await r.json();toast(d.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}
function changeBal(tid,cur){
    showModal('<h3>–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3><p style="color:var(--text2);font-size:.84rem;margin-bottom:10px">–¢–µ–∫—É—â–∏–π: '+cur+' ‚ÇΩ</p><div class="form-group"><label>–°—É–º–º–∞ (+/-)</label><input class="form-input" id="bal-amt" type="number" placeholder="100"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="setBal('+tid+')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>');
}
async function setBal(tid){const a=parseFloat(document.getElementById('bal-amt').value);if(isNaN(a))return toast('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ','error');closeModal();try{const r=await fetch(API+'/api/admin/users/'+tid+'/balance',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:a})});if(r.ok){toast('–ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω—ë–Ω');openUser(tid)}else{const d=await r.json();toast(d.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}
async function toggleBlock(tid,blocked){try{const r=await fetch(API+'/api/admin/users/'+tid+'/block',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({block:!blocked})});if(r.ok){toast(blocked?'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');openUser(tid)}else{const d=await r.json();toast(d.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}

/* Plans admin */
async function loadAdmPlans(){
    try{const r=await fetch(API+'/api/admin/plans');if(!r.ok)return;const plans=await r.json();
    document.getElementById('adm-plans-count').textContent='–¢–∞—Ä–∏—Ñ—ã ('+plans.length+')';
    const el=document.getElementById('adm-plans-list');
    if(!plans.length){el.innerHTML='<div class="empty-state">–ù–µ—Ç —Ç–∞—Ä–∏—Ñ–æ–≤</div>';return}
    el.innerHTML=plans.map(p=>{
        const durs=(p.durations||[]).map(d=>{const pr=(d.prices||[]).map(x=>x.amount+' '+x.currency).join(', ');return '<div class="plan-duration"><span class="plan-days">'+d.days+' –¥–Ω.</span><span class="plan-price">'+pr+'</span></div>'}).join('');
        return '<div class="card plan-card"><div style="display:flex;justify-content:space-between;align-items:start"><h3 class="plan-name">'+esc(p.name)+'</h3><button class="btn btn-danger btn-sm" onclick="delPlan('+p.id+')">–£–¥–∞–ª–∏—Ç—å</button></div><div class="plan-info"><span>–¢—Ä–∞—Ñ–∏–∫: '+(p.traffic_limit||'‚àû')+' GB</span><span>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: '+(p.device_limit||'‚àû')+'</span></div><div class="plan-durations">'+durs+'</div></div>';
    }).join('')}catch(e){}
}
function showCreatePlan(){showModal('<h3>–°–æ–∑–¥–∞—Ç—å —Ç–∞—Ä–∏—Ñ</h3><div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="form-input" id="np-name" placeholder="–ë–∞–∑–æ–≤—ã–π"></div><div class="form-group"><label>–¢—Ä–∞—Ñ–∏–∫ (GB)</label><input class="form-input" id="np-traffic" type="number" placeholder="100"></div><div class="form-group"><label>–£—Å—Ç—Ä–æ–π—Å—Ç–≤</label><input class="form-input" id="np-dev" type="number" placeholder="3"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="createPlan()">–°–æ–∑–¥–∞—Ç—å</button></div>')}
async function createPlan(){const n=document.getElementById('np-name').value.trim(),t=parseInt(document.getElementById('np-traffic').value)||0,d=parseInt(document.getElementById('np-dev').value)||1;if(!n)return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','error');closeModal();try{const r=await fetch(API+'/api/admin/plans',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,traffic_limit:t,device_limit:d})});if(r.ok){toast('–¢–∞—Ä–∏—Ñ —Å–æ–∑–¥–∞–Ω');loadAdmPlans()}else{const j=await r.json();toast(j.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}
async function delPlan(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ?'))return;try{const r=await fetch(API+'/api/admin/plans/'+id,{method:'DELETE'});if(r.ok){toast('–£–¥–∞–ª—ë–Ω');loadAdmPlans()}else{const j=await r.json();toast(j.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}

/* Settings */
async function loadSettings(){
    try{const r=await fetch(API+'/api/admin/settings');if(!r.ok)return;const s=await r.json();
    document.getElementById('settings-list').innerHTML='<div class="card">'+Object.entries(s).map(([k,v])=>{
        const l=sLabel(k);
        if(typeof v==='boolean')return '<div class="toggle-row"><label>'+l+'</label><button class="toggle-switch '+(v?'active':'')+'" onclick="toggleSet(\''+k+'\','+(!v)+',this)"></button></div>';
        return '<div class="card-row"><span class="card-label">'+l+'</span><span class="card-value">'+esc(String(v))+'</span></div>';
    }).join('')+'</div>'}catch(e){}
}
function sLabel(k){const m={balance_enabled:'–ë–∞–ª–∞–Ω—Å',community_enabled:'–°–æ–æ–±—â–µ—Å—Ç–≤–æ',tos_enabled:'–û—Ñ–µ—Ä—Ç–∞',referral_enabled:'–†–µ—Ñ–µ—Ä–∞–ª—ã',promocodes_enabled:'–ü—Ä–æ–º–æ–∫–æ–¥—ã',notifications_enabled:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',access_enabled:'–î–æ—Å—Ç—É–ø',language_enabled:'–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å',access_mode:'–†–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞',default_currency:'–í–∞–ª—é—Ç–∞',purchases_allowed:'–ü–æ–∫—É–ø–∫–∏',registration_allowed:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'};return m[k]||k}
async function toggleSet(k,v,btn){try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});if(r.ok){btn.classList.toggle('active',v);toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}}

/* Brand */
function loadBrandForm(){document.getElementById('br-name').value='';document.getElementById('br-logo').value='';document.getElementById('br-slogan').value='';
    fetch(API+'/api/settings/brand').then(r=>r.json()).then(d=>{document.getElementById('br-name').value=d.name||'';document.getElementById('br-logo').value=d.logo||'';document.getElementById('br-slogan').value=d.slogan||''}).catch(()=>{})
}
async function saveBrand(){
    const d={name:document.getElementById('br-name').value.trim()||'VPN Shop',logo:document.getElementById('br-logo').value.trim()||'üîê',slogan:document.getElementById('br-slogan').value.trim()};
    try{const r=await fetch(API+'/api/settings/brand',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});if(r.ok)toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
function toast(m,t){const e=document.getElementById('toast');e.textContent=m;e.className='toast visible'+(t?' toast-'+t:'');clearTimeout(e._t);e._t=setTimeout(()=>e.className='toast',3000)}
function showModal(h){document.getElementById('modal-root').innerHTML='<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-card">'+h+'</div></div>'}
function closeModal(){document.getElementById('modal-root').innerHTML=''}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
</script>
{% endblock %}
