{% extends "base.html" %}
{% block title %}–í—Ö–æ–¥ ‚Äî –ö–∞–±–∏–Ω–µ—Ç{% endblock %}

{% block content %}
<div class="bg-glow"></div>
<div class="auth-container">
    <div class="auth-logo">
        <div class="logo-circle">üîê</div>
        <h1 class="auth-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
    </div>

    <!-- Step 0: Choose auth method -->
    <div id="step-choose" class="auth-step active">
        <p class="auth-hint">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞</p>
        <button class="pill pill-cyan" onclick="chooseTelegram()" style="margin-bottom:10px">
            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" style="flex-shrink:0"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.783-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
            Telegram
        </button>
        <button class="pill pill-outline" onclick="choosePassword()" style="margin-bottom:10px">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="flex-shrink:0"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            –õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å
        </button>
        <button class="pill pill-outline" style="margin-bottom:10px;opacity:.45;cursor:default" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="flex-shrink:0"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞
            <span style="font-size:.7rem;opacity:.7;margin-left:4px">–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</span>
        </button>
    </div>

    <!-- Step: Telegram info -->
    <div id="step-telegram" class="auth-step">
        <p class="auth-hint">–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</p>
        <p class="auth-sub-hint">–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–õ–∏—á–Ω—ã–π&nbsp;–∫–∞–±–∏–Ω–µ—Ç¬ª ‚Äî –≤—Ö–æ–¥ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
        <p class="auth-sub-hint" style="opacity:.6;font-size:.78rem">–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram.</p>
        <button class="pill pill-outline" onclick="showStep('step-choose')" style="margin-top:12px">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <!-- Step: Login with password -->
    <div id="step-password" class="auth-step">
        <p class="auth-hint">–í—Ö–æ–¥ –ø–æ –ª–æ–≥–∏–Ω—É –∏ –ø–∞—Ä–æ–ª—é</p>
        <p class="auth-sub-hint">–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ, –≤–æ–π–¥—è —á–µ—Ä–µ–∑ Telegram</p>
        <div class="input-group">
            <input type="text" id="input-login-username" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username">
        </div>
        <div class="input-group">
            <input type="password" id="input-login-password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
        </div>
        <button class="pill pill-cyan" onclick="loginUser()">–í–æ–π—Ç–∏</button>
        <button class="pill pill-outline" onclick="showStep('step-choose')" style="margin-top:8px">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <div id="auth-error" class="auth-error"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showStep(id) {
    document.querySelectorAll('.auth-step').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    hideError();
}
function showError(msg) {
    const el = document.getElementById('auth-error');
    el.textContent = msg; el.classList.add('visible');
}
function hideError() {
    document.getElementById('auth-error').classList.remove('visible');
}

function chooseTelegram() { showStep('step-telegram'); }
function choosePassword() { showStep('step-password'); }

async function loginUser() {
    const username = document.getElementById('input-login-username').value.trim();
    const password = document.getElementById('input-login-password').value;
    if (!username || !password) { showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
    hideError();
    try {
        const res = await fetch('/web/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({web_username: username, password: password})
        });
        if (!res.ok) {
            let detail = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
            try { const d = await res.json(); detail = d.detail || detail; } catch(e) {}
            showError(detail);
            return;
        }
        window.location.href = '/web/dashboard';
    } catch (e) {
        showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('input-login-password').addEventListener('keydown', e => { if (e.key === 'Enter') loginUser(); });
    // If inside Telegram WebApp ‚Äî auto-authenticate and redirect to miniapp
    try {
        const tg = window.Telegram && window.Telegram.WebApp;
        if (tg && tg.initData) {
            fetch('/web/api/auth/tg', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({initData: tg.initData})
            }).then(r => {
                if (r.ok) window.location.href = '/web/dashboard';
            }).catch(() => {});
        }
    } catch(e) {}
});
</script>
{% endblock %}
