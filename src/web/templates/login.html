{% extends "base.html" %}
{% block title %}–í—Ö–æ–¥ ‚Äî –ö–∞–±–∏–Ω–µ—Ç{% endblock %}

{% block content %}
<div class="bg-glow"></div>
<div class="auth-container">
    <div class="auth-logo">
        <div class="logo-circle">üîê</div>
        <h1 class="auth-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
    </div>

    <!-- Step 1: Enter Telegram ID -->
    <div id="step-telegram" class="auth-step active">
        <p class="auth-hint">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID –¥–ª—è –≤—Ö–æ–¥–∞</p>
        <div class="input-group">
            <input type="number" id="input-telegram-id" placeholder="Telegram ID" autocomplete="off">
        </div>
        <button class="pill pill-cyan" onclick="checkTelegramId()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <!-- Step 2: Registration -->
    <div id="step-register" class="auth-step">
        <p class="auth-hint">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="reg-name"></span>!</p>
        <p class="auth-sub-hint">–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –Ω–∞ —Å–∞–π—Ç</p>
        <div class="input-group">
            <input type="text" id="input-reg-username" placeholder="–õ–æ–≥–∏–Ω (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)" autocomplete="off">
        </div>
        <div class="input-group">
            <input type="password" id="input-reg-password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)">
        </div>
        <div class="input-group">
            <input type="password" id="input-reg-password2" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        </div>
        <button class="pill pill-gold" onclick="registerUser()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <button class="pill pill-outline" onclick="showStep('step-telegram')" style="margin-top:8px">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <!-- Step 3: Login -->
    <div id="step-password" class="auth-step">
        <p class="auth-hint">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="login-name"></span>!</p>
        <p class="auth-sub-hint">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å</p>
        <div class="input-group">
            <input type="text" id="input-login-username" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username">
        </div>
        <div class="input-group">
            <input type="password" id="input-login-password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
        </div>
        <button class="pill pill-cyan" onclick="loginUser()">–í–æ–π—Ç–∏</button>
        <button class="pill pill-outline" onclick="showStep('step-telegram')" style="margin-top:8px">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <div id="auth-error" class="auth-error"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTelegramId = null;

function showStep(id) {
    document.querySelectorAll('.auth-step').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    hideError();
}
function showError(msg) {
    const el = document.getElementById('auth-error');
    el.textContent = msg; el.classList.add('visible');
}
function hideError() {
    document.getElementById('auth-error').classList.remove('visible');
}

async function checkTelegramId() {
    const tid = document.getElementById('input-telegram-id').value.trim();
    if (!tid) { showError('–í–≤–µ–¥–∏—Ç–µ Telegram ID'); return; }
    hideError();
    try {
        const res = await fetch('/web/api/auth/check', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({telegram_id: parseInt(tid)})
        });
        const data = await res.json();
        if (!res.ok) { showError(data.detail || '–û—à–∏–±–∫–∞'); return; }
        currentTelegramId = parseInt(tid);
        if (data.has_credentials) {
            document.getElementById('login-name').textContent = data.name;
            showStep('step-password');
        } else {
            document.getElementById('reg-name').textContent = data.name;
            showStep('step-register');
        }
    } catch (e) {
        showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    }
}

async function registerUser() {
    const username = document.getElementById('input-reg-username').value.trim();
    const password = document.getElementById('input-reg-password').value;
    const password2 = document.getElementById('input-reg-password2').value;
    if (!username || username.length < 3) { showError('–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤'); return; }
    if (!password || password.length < 6) { showError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤'); return; }
    if (password !== password2) { showError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'); return; }
    hideError();
    try {
        const res = await fetch('/web/api/auth/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({telegram_id: currentTelegramId, web_username: username, password: password})
        });
        if (!res.ok) {
            let detail = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
            try { const d = await res.json(); detail = d.detail || detail; } catch(e) {}
            showError(detail);
            return;
        }
        window.location.href = '/web/dashboard';
    } catch (e) {
        showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
}

async function loginUser() {
    const username = document.getElementById('input-login-username').value.trim();
    const password = document.getElementById('input-login-password').value;
    if (!username || !password) { showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
    hideError();
    try {
        const res = await fetch('/web/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({web_username: username, password: password})
        });
        if (!res.ok) {
            let detail = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
            try { const d = await res.json(); detail = d.detail || detail; } catch(e) {}
            showError(detail);
            return;
        }
        window.location.href = '/web/dashboard';
    } catch (e) {
        showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('input-telegram-id').addEventListener('keydown', e => { if (e.key === 'Enter') checkTelegramId(); });
    document.getElementById('input-reg-password2').addEventListener('keydown', e => { if (e.key === 'Enter') registerUser(); });
    document.getElementById('input-login-password').addEventListener('keydown', e => { if (e.key === 'Enter') loginUser(); });
});
</script>
{% endblock %}
