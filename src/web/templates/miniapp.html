<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/web/static/css/style.css">
</head>
<body>
<div class="bg-glow"></div>
<div id="app">

<!-- ‚ïê‚ïê‚ïê Loading ‚ïê‚ïê‚ïê -->
<div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <p>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è‚Ä¶</p>
</div>

<!-- ‚ïê‚ïê‚ïê Error ‚ïê‚ïê‚ïê -->
<div id="error-screen" class="loading-screen" style="display:none">
    <p id="error-msg" style="color:var(--error);padding:20px;text-align:center;"></p>
</div>

<!-- ‚ïê‚ïê‚ïê Main App ‚ïê‚ïê‚ïê -->
<div id="main-app" class="app-wrapper" style="display:none">

    <!-- Header -->
    <header class="app-header">
        <div class="brand">
            <span class="brand-logo" id="brand-logo">üîê</span>
            <span class="brand-name" id="brand-name">VPN Shop</span>
        </div>
        <span class="header-balance" id="header-balance" onclick="showPage('profile')">0 ‚ÇΩ</span>
    </header>

    <!-- Content -->
    <main class="app-content">

        <!-- ‚ïê‚ïê HOME ‚ïê‚ïê -->
        <section id="page-home" class="page active">
            <div class="card subscription-card">
                <div class="card-badge badge-inactive" id="sub-badge">‚Äî</div>
                <h3 class="card-title" id="sub-plan">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</h3>
                <div class="card-row"><span class="card-label">–ò—Å—Ç–µ–∫–∞–µ—Ç</span><span class="card-value" id="sub-expire">‚Äî</span></div>
                <div class="card-row"><span class="card-label">–¢—Ä–∞—Ñ–∏–∫</span><span class="card-value" id="sub-traffic">‚Äî</span></div>
                <div class="card-row"><span class="card-label">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</span><span class="card-value" id="sub-devices">‚Äî</span></div>
            </div>
            <div class="actions-grid">
                <button class="action-btn" onclick="openSubUrl()">
                    <span class="action-icon">üõí</span><span>–ö—É–ø–∏—Ç—å</span>
                </button>
                <button class="action-btn" onclick="showPage('connect')">
                    <span class="action-icon">üîó</span><span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</span>
                </button>
                <button class="action-btn" onclick="showPage('plans')">
                    <span class="action-icon">üìã</span><span>–¢–∞—Ä–∏—Ñ—ã</span>
                </button>
                <button class="action-btn" onclick="showPage('profile')">
                    <span class="action-icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                </button>
            </div>
        </section>

        <!-- ‚ïê‚ïê PLANS ‚ïê‚ïê -->
        <section id="page-plans" class="page">
            <div class="page-header">
                <button class="btn-back" onclick="showPage('home')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="15 18 9 12 15 6"/></svg></button>
                <h2 class="page-title">–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã</h2>
            </div>
            <div id="plans-list" class="plans-list"></div>
        </section>

        <!-- ‚ïê‚ïê CONNECT ‚ïê‚ïê -->
        <section id="page-connect" class="page">
            <div class="page-header">
                <button class="btn-back" onclick="showPage('home')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="15 18 9 12 15 6"/></svg></button>
                <h2 class="page-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h2>
            </div>
            <div id="connect-content">
                <div class="card">
                    <h3 class="card-title" style="font-size:1rem;">–°—Å—ã–ª–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
                    <div class="connect-box">
                        <code id="connect-url">‚Äî</code>
                        <button onclick="copySubUrl()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title" style="font-size:1rem;">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
                    <div class="actions-grid" style="grid-template-columns:1fr 1fr 1fr;">
                        <button class="action-btn" onclick="tg.openLink('https://apps.apple.com/app/streisand/id6450534064')"><span class="action-icon">üçé</span><span>iOS</span></button>
                        <button class="action-btn" onclick="tg.openLink('https://play.google.com/store/apps/details?id=com.v2ray.ang')"><span class="action-icon">ü§ñ</span><span>Android</span></button>
                        <button class="action-btn" onclick="tg.openLink('https://github.com/hiddify/hiddify-app/releases')"><span class="action-icon">üíª</span><span>Desktop</span></button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ‚ïê‚ïê PROFILE ‚ïê‚ïê -->
        <section id="page-profile" class="page">
            <div class="page-header">
                <button class="btn-back" onclick="showPage('home')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="15 18 9 12 15 6"/></svg></button>
                <h2 class="page-title">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            </div>
            <div class="card">
                <div class="card-row"><span class="card-label">–ò–º—è</span><span class="card-value" id="prof-name">‚Äî</span></div>
                <div class="card-row"><span class="card-label">Telegram</span><span class="card-value" id="prof-username">‚Äî</span></div>
                <div class="card-row"><span class="card-label">Telegram ID</span><span class="card-value" id="prof-tid">‚Äî</span></div>
                <div class="card-row"><span class="card-label">–ë–∞–ª–∞–Ω—Å</span><span class="card-value" id="prof-balance">‚Äî</span></div>
                <div class="card-row"><span class="card-label">–†–æ–ª—å</span><span class="card-value" id="prof-role">‚Äî</span></div>
            </div>
            <!-- Promo Section -->
            <div class="card">
                <h3 class="card-title" style="font-size:1rem;">–ü—Ä–æ–º–æ–∫–æ–¥</h3>
                <div style="display:flex;gap:8px;">
                    <input class="form-input" id="promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" style="flex:1;">
                    <button class="btn btn-primary btn-sm" onclick="activatePromo()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
                <p id="promo-result" style="font-size:0.82rem;margin-top:8px;display:none;"></p>
            </div>
            <!-- Referral Section -->
            <div class="card" id="referral-card">
                <h3 class="card-title" style="font-size:1rem;">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3>
                <div class="referral-link-box">
                    <code id="ref-link">‚Äî</code>
                    <button class="btn btn-primary btn-sm btn-full" onclick="copyRefLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                </div>
            </div>
        </section>

        <!-- ‚ïê‚ïê ADMIN ‚ïê‚ïê -->
        <section id="page-admin" class="page">
            <div class="page-header">
                <button class="btn-back" onclick="showPage('home')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="15 18 9 12 15 6"/></svg></button>
                <h2 class="page-title">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
            </div>
            <div class="admin-tabs" id="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('stats')">–°—Ç–∞—Ç.</button>
                <button class="admin-tab" onclick="showAdminTab('users')">–ü–æ–ª—å–∑.</button>
                <button class="admin-tab" onclick="showAdminTab('plans')">–¢–∞—Ä–∏—Ñ—ã</button>
                <button class="admin-tab" onclick="showAdminTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button class="admin-tab" onclick="showAdminTab('brand')">–ë—Ä–µ–Ω–¥</button>
            </div>

            <!-- Admin: Stats -->
            <div id="admin-stats" class="admin-content active">
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="st-users">‚Äî</div><div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑.</div></div>
                    <div class="stat-card"><div class="stat-value" id="st-active">‚Äî</div><div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div></div>
                    <div class="stat-card"><div class="stat-value" id="st-expired">‚Äî</div><div class="stat-label">–ò—Å—Ç–µ–∫—à–∏—Ö</div></div>
                    <div class="stat-card"><div class="stat-value" id="st-revenue">‚Äî</div><div class="stat-label">–î–æ—Ö–æ–¥</div></div>
                </div>
            </div>

            <!-- Admin: Users -->
            <div id="admin-users" class="admin-content">
                <div class="search-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input id="user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID" oninput="searchUsers()">
                </div>
                <div id="users-list" class="user-list"></div>
            </div>

            <!-- Admin: Plans -->
            <div id="admin-plans" class="admin-content">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <span style="color:var(--text-secondary);font-size:0.88rem;" id="plans-count">–¢–∞—Ä–∏—Ñ—ã</span>
                    <button class="btn btn-primary btn-sm" onclick="showCreatePlanModal()">+ –°–æ–∑–¥–∞—Ç—å</button>
                </div>
                <div id="admin-plans-list" class="plans-list"></div>
            </div>

            <!-- Admin: Settings -->
            <div id="admin-settings" class="admin-content">
                <div id="settings-list"></div>
            </div>

            <!-- Admin: Brand -->
            <div id="admin-brand" class="admin-content">
                <div class="card">
                    <h3 class="card-title" style="font-size:1rem;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–µ–Ω–¥–∞</h3>
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input class="form-input" id="brand-input-name" placeholder="VPN Shop">
                    </div>
                    <div class="form-group">
                        <label>–õ–æ–≥–æ—Ç–∏–ø (—ç–º–æ–¥–∑–∏)</label>
                        <input class="form-input" id="brand-input-logo" placeholder="üîê">
                    </div>
                    <div class="form-group">
                        <label>–°–ª–æ–≥–∞–Ω</label>
                        <input class="form-input" id="brand-input-slogan" placeholder="–ë—ã—Å—Ç—Ä—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π VPN">
                    </div>
                    <button class="btn btn-primary btn-full" onclick="saveBrand()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </section>

        <!-- ‚ïê‚ïê ADMIN USER DETAIL ‚ïê‚ïê -->
        <section id="page-admin-user" class="page">
            <div class="page-header">
                <button class="btn-back" onclick="showAdminTab('users');showPage('admin')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="15 18 9 12 15 6"/></svg></button>
                <h2 class="page-title" id="aud-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
            </div>
            <div id="admin-user-detail"></div>
        </section>

    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-page="home" onclick="showPage('home')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button class="nav-item" data-page="plans" onclick="showPage('plans')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            <span>–¢–∞—Ä–∏—Ñ—ã</span>
        </button>
        <button class="nav-item" data-page="connect" onclick="showPage('connect')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
            <span>–°–≤—è–∑—å</span>
        </button>
        <button class="nav-item" data-page="profile" onclick="showPage('profile')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
        <button class="nav-item admin-only" data-page="admin" onclick="showPage('admin')" style="display:none">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
            <span>–ê–¥–º–∏–Ω</span>
        </button>
    </nav>
</div>

<!-- Modal container -->
<div id="modal-root"></div>
<!-- Toast -->
<div id="toast" class="toast"></div>

</div><!-- /app -->

<script>
const API = '/web';
const tg = window.Telegram.WebApp;

let DATA = null;
let BRAND = {name:'VPN Shop', logo:'üîê', slogan:''};
let IS_ADMIN = false;
let adminUsersCache = [];
let currentAdminTab = 'stats';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function init() {
    tg.ready();
    tg.expand();
    try { tg.setHeaderColor('#0B121A'); } catch(e) {}
    try { tg.setBackgroundColor('#0B121A'); } catch(e) {}

    try {
        const auth = await fetch(API+'/api/auth/tg', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({initData: tg.initData})
        });
        if (!auth.ok) return showError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û—Ç–∫—Ä–æ–π—Ç–µ –∏–∑ Telegram.');

        const dr = await fetch(API+'/api/user/data');
        if (!dr.ok) return showError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.');
        DATA = await dr.json();

        try {
            const br = await fetch(API+'/api/settings/brand');
            if (br.ok) BRAND = await br.json();
        } catch(e){}

        IS_ADMIN = DATA.user.role === 'DEV' || DATA.user.role === 'ADMIN';

        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';

        if (IS_ADMIN) {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
        }

        renderApp();
    } catch(e) {
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
    }
}

function showError(msg) {
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('error-screen').style.display = 'flex';
    document.getElementById('error-msg').textContent = msg;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-'+id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(b => b.classList.toggle('active', b.dataset.page === id));

    if (id === 'home') { tg.BackButton.hide(); }
    else {
        tg.BackButton.show();
        tg.BackButton.offClick(goHome);
        tg.BackButton.onClick(goHome);
    }

    if (id === 'admin') loadAdminTab(currentAdminTab);
}

function goHome() { showPage('home'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderApp() {
    document.getElementById('brand-logo').textContent = BRAND.logo || 'üîê';
    document.getElementById('brand-name').textContent = BRAND.name || 'VPN Shop';

    const u = DATA.user;
    document.getElementById('header-balance').textContent = u.balance + ' ‚ÇΩ';

    renderSubscription();
    renderPlans();
    renderProfile();
    renderConnect();
}

function renderSubscription() {
    const sub = DATA.subscription;
    const badge = document.getElementById('sub-badge');

    if (!sub || !sub.status) {
        badge.textContent = '–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏';
        badge.className = 'card-badge badge-inactive';
        document.getElementById('sub-plan').textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏';
        document.getElementById('sub-expire').textContent = '‚Äî';
        document.getElementById('sub-traffic').textContent = '‚Äî';
        document.getElementById('sub-devices').textContent = '‚Äî';
        return;
    }

    if (sub.is_trial) { badge.textContent = '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥'; badge.className = 'card-badge badge-trial'; }
    else if (sub.status === 'ACTIVE') { badge.textContent = '–ê–∫—Ç–∏–≤–Ω–∞'; badge.className = 'card-badge badge-active'; }
    else if (sub.status === 'EXPIRED') { badge.textContent = '–ò—Å—Ç–µ–∫–ª–∞'; badge.className = 'card-badge badge-expired'; }
    else { badge.textContent = sub.status; badge.className = 'card-badge badge-inactive'; }

    document.getElementById('sub-plan').textContent = sub.plan_name || '‚Äî';
    document.getElementById('sub-expire').textContent = sub.expire_at || '‚Äî';
    document.getElementById('sub-traffic').textContent = sub.traffic_limit ? sub.traffic_limit + ' GB' : '‚àû';
    document.getElementById('sub-devices').textContent = sub.device_limit || '‚Äî';
}

function renderPlans() {
    const el = document.getElementById('plans-list');
    if (!DATA.plans || !DATA.plans.length) {
        el.innerHTML = '<div class="empty-state"><span class="empty-icon">üìã</span><h3>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤</h3></div>';
        return;
    }
    el.innerHTML = DATA.plans.map(p => {
        const durs = (p.durations||[]).map(d => {
            const pr = (d.prices||[]).map(x => '<span class="plan-price">'+x.amount+' '+x.currency+'</span>').join(' / ');
            return '<div class="plan-duration"><span class="plan-days">'+d.days+' –¥–Ω.</span> '+pr+'</div>';
        }).join('');
        return '<div class="card plan-card"><h3 class="plan-name">'+esc(p.name)+'</h3><div class="plan-info"><span>–¢—Ä–∞—Ñ–∏–∫: '+(p.traffic_limit||'‚àû')+' GB</span><span>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: '+(p.device_limit||'‚àû')+'</span></div><div class="plan-durations">'+durs+'</div></div>';
    }).join('');
}

function renderProfile() {
    const u = DATA.user;
    document.getElementById('prof-name').textContent = u.name || '‚Äî';
    document.getElementById('prof-username').textContent = u.username ? '@'+u.username : '‚Äî';
    document.getElementById('prof-tid').textContent = u.telegram_id;
    document.getElementById('prof-balance').textContent = u.balance + ' ‚ÇΩ';

    const roleMap = {USER:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', ADMIN:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', DEV:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫'};
    document.getElementById('prof-role').textContent = roleMap[u.role] || u.role;

    const refLink = 'https://t.me/' + (DATA.bot_username||'bot') + '?start=ref_' + u.telegram_id;
    document.getElementById('ref-link').textContent = refLink;
}

function renderConnect() {
    const sub = DATA.subscription;
    document.getElementById('connect-url').textContent = (sub && sub.url) ? sub.url : '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USER ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openSubUrl() {
    const sub = DATA.subscription;
    if (sub && sub.url) tg.openLink(sub.url);
    else showToast('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏', 'error');
}

function copySubUrl() {
    const sub = DATA.subscription;
    if (sub && sub.url) {
        navigator.clipboard.writeText(sub.url).then(() => showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')).catch(() => showToast('–û—à–∏–±–∫–∞','error'));
    } else showToast('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏', 'error');
}

function copyRefLink() {
    const link = document.getElementById('ref-link').textContent;
    navigator.clipboard.writeText(link).then(() => showToast('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')).catch(() => showToast('–û—à–∏–±–∫–∞','error'));
}

async function activatePromo() {
    const code = document.getElementById('promo-input').value.trim();
    if (!code) return;
    const res = document.getElementById('promo-result');
    try {
        const r = await fetch(API+'/api/promocode/activate', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({code: code})
        });
        const d = await r.json();
        res.style.display = 'block';
        if (r.ok) { res.style.color = 'var(--success)'; res.textContent = d.message || '–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!'; }
        else { res.style.color = 'var(--error)'; res.textContent = d.detail || '–û—à–∏–±–∫–∞'; }
    } catch(e) {
        res.style.display = 'block';
        res.style.color = 'var(--error)';
        res.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showAdminTab(tab) {
    currentAdminTab = tab;
    document.querySelectorAll('#admin-tabs .admin-tab').forEach((t,i) => {
        t.classList.toggle('active', ['stats','users','plans','settings','brand'][i] === tab);
    });
    document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
    const el = document.getElementById('admin-'+tab);
    if (el) el.classList.add('active');
    loadAdminTab(tab);
}

async function loadAdminTab(tab) {
    if (tab === 'stats') await loadAdminStats();
    if (tab === 'users') await loadAdminUsers();
    if (tab === 'plans') await loadAdminPlans();
    if (tab === 'settings') await loadAdminSettings();
    if (tab === 'brand') loadBrandForm();
}

// ‚îÄ‚îÄ‚îÄ Admin Stats ‚îÄ‚îÄ‚îÄ
async function loadAdminStats() {
    try {
        const r = await fetch(API+'/api/admin/stats');
        if (!r.ok) return;
        const d = await r.json();
        document.getElementById('st-users').textContent = d.total_users || 0;
        document.getElementById('st-active').textContent = d.active_subscriptions || 0;
        document.getElementById('st-expired').textContent = d.expired_subscriptions || 0;
        document.getElementById('st-revenue').textContent = (d.total_revenue || 0) + ' ‚ÇΩ';
    } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ Admin Users ‚îÄ‚îÄ‚îÄ
async function loadAdminUsers() {
    try {
        const r = await fetch(API+'/api/admin/users');
        if (!r.ok) return;
        adminUsersCache = await r.json();
        renderUsersList(adminUsersCache);
    } catch(e) {}
}

function searchUsers() {
    const q = document.getElementById('user-search').value.toLowerCase().trim();
    if (!q) return renderUsersList(adminUsersCache);
    const filtered = adminUsersCache.filter(u =>
        (u.name||'').toLowerCase().includes(q) ||
        String(u.telegram_id).includes(q) ||
        (u.username||'').toLowerCase().includes(q)
    );
    renderUsersList(filtered);
}

function renderUsersList(users) {
    const el = document.getElementById('users-list');
    if (!users.length) { el.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>'; return; }
    el.innerHTML = users.slice(0, 50).map(u => {
        const initial = (u.name||'?')[0].toUpperCase();
        const roleClass = u.role === 'DEV' ? 'role-dev' : u.role === 'ADMIN' ? 'role-admin' : 'role-user';
        const roleName = u.role === 'DEV' ? 'DEV' : u.role === 'ADMIN' ? 'ADM' : 'USER';
        return '<div class="user-item" onclick="openUser('+u.telegram_id+')">' +
            '<div class="user-item-info"><div class="user-avatar">'+esc(initial)+'</div>' +
            '<div><div class="user-name">'+esc(u.name||'‚Äî')+'</div><div class="user-sub">ID: '+u.telegram_id+'</div></div></div>' +
            '<span class="role-badge '+roleClass+'">'+roleName+'</span></div>';
    }).join('');
}

async function openUser(tid) {
    showPage('admin-user');
    document.getElementById('aud-title').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';
    document.getElementById('admin-user-detail').innerHTML = '<div style="text-align:center;padding:40px;"><div class="spinner"></div></div>';

    try {
        const r = await fetch(API+'/api/admin/users/'+tid);
        if (!r.ok) { document.getElementById('admin-user-detail').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; return; }
        const u = await r.json();
        document.getElementById('aud-title').textContent = u.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        renderUserDetail(u);
    } catch(e) {
        document.getElementById('admin-user-detail').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞: '+e.message+'</div>';
    }
}

function renderUserDetail(u) {
    const roleMap = {USER:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', ADMIN:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', DEV:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫'};
    const subInfo = u.subscription ? '<div class="card-row"><span class="card-label">–ü–æ–¥–ø–∏—Å–∫–∞</span><span class="card-value">'+(u.subscription.plan_name||'‚Äî')+'</span></div><div class="card-row"><span class="card-label">–°—Ç–∞—Ç—É—Å</span><span class="card-value">'+u.subscription.status+'</span></div><div class="card-row"><span class="card-label">–ò—Å—Ç–µ–∫–∞–µ—Ç</span><span class="card-value">'+(u.subscription.expire_at||'‚Äî')+'</span></div>' : '<div class="card-row"><span class="card-label">–ü–æ–¥–ø–∏—Å–∫–∞</span><span class="card-value" style="color:var(--text-muted)">–ù–µ—Ç</span></div>';

    document.getElementById('admin-user-detail').innerHTML =
        '<div class="card">' +
        '<div class="card-row"><span class="card-label">–ò–º—è</span><span class="card-value">'+esc(u.name||'‚Äî')+'</span></div>' +
        '<div class="card-row"><span class="card-label">Username</span><span class="card-value">'+(u.username?'@'+esc(u.username):'‚Äî')+'</span></div>' +
        '<div class="card-row"><span class="card-label">Telegram ID</span><span class="card-value">'+u.telegram_id+'</span></div>' +
        '<div class="card-row"><span class="card-label">–ë–∞–ª–∞–Ω—Å</span><span class="card-value">'+u.balance+' ‚ÇΩ</span></div>' +
        '<div class="card-row"><span class="card-label">–†–æ–ª—å</span><span class="card-value">'+(roleMap[u.role]||u.role)+'</span></div>' +
        '<div class="card-row"><span class="card-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span><span class="card-value">'+(u.is_blocked?'–î–∞':'–ù–µ—Ç')+'</span></div>' +
        subInfo +
        '</div>' +
        '<div style="display:flex;flex-direction:column;gap:8px;">' +
        '<button class="btn btn-secondary btn-full" onclick="changeUserRole('+u.telegram_id+',\''+u.role+'\')">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button>' +
        '<button class="btn btn-secondary btn-full" onclick="changeUserBalance('+u.telegram_id+','+u.balance+')">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>' +
        '<button class="btn '+(u.is_blocked?'btn-primary':'btn-danger')+' btn-full" onclick="toggleUserBlock('+u.telegram_id+','+u.is_blocked+')">'+(u.is_blocked?'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å')+'</button>' +
        '</div>';
}

function changeUserRole(tid, currentRole) {
    const roles = ['USER','ADMIN','DEV'];
    const names = ['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å','–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä','–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫'];
    const html = '<h3>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</h3>' +
        roles.map((r,i) => '<button class="btn '+(r===currentRole?'btn-primary':'btn-secondary')+' btn-full" style="margin-top:6px;" onclick="setUserRole('+tid+',\''+r+'\')">'+names[i]+'</button>').join('') +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>';
    showModal(html);
}

async function setUserRole(tid, role) {
    closeModal();
    try {
        const r = await fetch(API+'/api/admin/users/'+tid+'/role', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({role: role})
        });
        if (r.ok) { showToast('–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞'); openUser(tid); }
        else { const d = await r.json(); showToast(d.detail||'–û—à–∏–±–∫–∞','error'); }
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏','error'); }
}

function changeUserBalance(tid, current) {
    const html = '<h3>–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3><p style="color:var(--text-secondary);font-size:0.88rem;margin-bottom:12px;">–¢–µ–∫—É—â–∏–π: '+current+' ‚ÇΩ</p>' +
        '<div class="form-group"><label>–°—É–º–º–∞ (+ –∏–ª–∏ -)</label><input class="form-input" id="balance-amount" type="number" placeholder="100"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="setUserBalance('+tid+')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>';
    showModal(html);
}

async function setUserBalance(tid) {
    const amount = parseFloat(document.getElementById('balance-amount').value);
    if (isNaN(amount)) return showToast('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ','error');
    closeModal();
    try {
        const r = await fetch(API+'/api/admin/users/'+tid+'/balance', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({amount: amount})
        });
        if (r.ok) { showToast('–ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω—ë–Ω'); openUser(tid); }
        else { const d = await r.json(); showToast(d.detail||'–û—à–∏–±–∫–∞','error'); }
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏','error'); }
}

async function toggleUserBlock(tid, isBlocked) {
    try {
        const r = await fetch(API+'/api/admin/users/'+tid+'/block', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({block: !isBlocked})
        });
        if (r.ok) { showToast(isBlocked?'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'); openUser(tid); }
        else { const d = await r.json(); showToast(d.detail||'–û—à–∏–±–∫–∞','error'); }
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏','error'); }
}

// ‚îÄ‚îÄ‚îÄ Admin Plans ‚îÄ‚îÄ‚îÄ
async function loadAdminPlans() {
    try {
        const r = await fetch(API+'/api/admin/plans');
        if (!r.ok) return;
        const plans = await r.json();
        document.getElementById('plans-count').textContent = '–¢–∞—Ä–∏—Ñ—ã ('+plans.length+')';
        const el = document.getElementById('admin-plans-list');
        if (!plans.length) { el.innerHTML = '<div class="empty-state">–ù–µ—Ç —Ç–∞—Ä–∏—Ñ–æ–≤</div>'; return; }
        el.innerHTML = plans.map(p => {
            const durs = (p.durations||[]).map(d => {
                const pr = (d.prices||[]).map(x => x.amount+' '+x.currency).join(', ');
                return '<div class="plan-duration"><span class="plan-days">'+d.days+' –¥–Ω.</span><span class="plan-price">'+pr+'</span></div>';
            }).join('');
            return '<div class="card plan-card"><div style="display:flex;justify-content:space-between;align-items:start;"><h3 class="plan-name">'+esc(p.name)+'</h3><button class="btn btn-danger btn-sm" onclick="deletePlan('+p.id+')">–£–¥–∞–ª–∏—Ç—å</button></div><div class="plan-info"><span>–¢—Ä–∞—Ñ–∏–∫: '+(p.traffic_limit||'‚àû')+' GB</span><span>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: '+(p.device_limit||'‚àû')+'</span></div><div class="plan-durations">'+durs+'</div></div>';
        }).join('');
    } catch(e) {}
}

function showCreatePlanModal() {
    const html = '<h3>–°–æ–∑–¥–∞—Ç—å —Ç–∞—Ä–∏—Ñ</h3>' +
        '<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="form-input" id="np-name" placeholder="–ë–∞–∑–æ–≤—ã–π"></div>' +
        '<div class="form-group"><label>–õ–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ (GB)</label><input class="form-input" id="np-traffic" type="number" placeholder="100"></div>' +
        '<div class="form-group"><label>–õ–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤</label><input class="form-input" id="np-devices" type="number" placeholder="3"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="createPlan()">–°–æ–∑–¥–∞—Ç—å</button></div>';
    showModal(html);
}

async function createPlan() {
    const name = document.getElementById('np-name').value.trim();
    const traffic = parseInt(document.getElementById('np-traffic').value) || 0;
    const devices = parseInt(document.getElementById('np-devices').value) || 1;
    if (!name) return showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','error');
    closeModal();
    try {
        const r = await fetch(API+'/api/admin/plans', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({name, traffic_limit: traffic, device_limit: devices})
        });
        if (r.ok) { showToast('–¢–∞—Ä–∏—Ñ —Å–æ–∑–¥–∞–Ω'); loadAdminPlans(); }
        else { const d = await r.json(); showToast(d.detail||'–û—à–∏–±–∫–∞','error'); }
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏','error'); }
}

async function deletePlan(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ?')) return;
    try {
        const r = await fetch(API+'/api/admin/plans/'+id, {method:'DELETE'});
        if (r.ok) { showToast('–¢–∞—Ä–∏—Ñ —É–¥–∞–ª—ë–Ω'); loadAdminPlans(); }
        else { const d = await r.json(); showToast(d.detail||'–û—à–∏–±–∫–∞','error'); }
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏','error'); }
}

// ‚îÄ‚îÄ‚îÄ Admin Settings ‚îÄ‚îÄ‚îÄ
async function loadAdminSettings() {
    try {
        const r = await fetch(API+'/api/admin/settings');
        if (!r.ok) return;
        const s = await r.json();
        const el = document.getElementById('settings-list');
        el.innerHTML = '<div class="card">' + Object.entries(s).map(([k,v]) => {
            const label = settingLabel(k);
            if (typeof v === 'boolean') {
                return '<div class="toggle-row"><label>'+label+'</label><button class="toggle-switch '+(v?'active':'')+'" onclick="toggleSetting(\''+k+'\','+(!v)+',this)"></button></div>';
            }
            return '<div class="card-row"><span class="card-label">'+label+'</span><span class="card-value">'+esc(String(v))+'</span></div>';
        }).join('') + '</div>';
    } catch(e) {}
}

function settingLabel(k) {
    const map = {
        balance_enabled:'–ë–∞–ª–∞–Ω—Å', community_enabled:'–°–æ–æ–±—â–µ—Å—Ç–≤–æ', tos_enabled:'–û—Ñ–µ—Ä—Ç–∞',
        extra_devices_enabled:'–î–æ–ø. —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', transfers_enabled:'–ü–µ—Ä–µ–≤–æ–¥—ã',
        referral_enabled:'–†–µ—Ñ–µ—Ä–∞–ª—ã', promocodes_enabled:'–ü—Ä–æ–º–æ–∫–æ–¥—ã',
        multilang_enabled:'–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å', purchase_enabled:'–ü–æ–∫—É–ø–∫–∏',
        registration_enabled:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', access_mode:'–†–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞',
        default_currency:'–í–∞–ª—é—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'
    };
    return map[k] || k;
}

async function toggleSetting(key, val, btn) {
    try {
        const r = await fetch(API+'/api/admin/settings', {
            method:'PATCH', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({[key]: val})
        });
        if (r.ok) {
            btn.classList.toggle('active', val);
            showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        } else showToast('–û—à–∏–±–∫–∞','error');
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏','error'); }
}

// ‚îÄ‚îÄ‚îÄ Admin Brand ‚îÄ‚îÄ‚îÄ
function loadBrandForm() {
    document.getElementById('brand-input-name').value = BRAND.name || '';
    document.getElementById('brand-input-logo').value = BRAND.logo || '';
    document.getElementById('brand-input-slogan').value = BRAND.slogan || '';
}

async function saveBrand() {
    const data = {
        name: document.getElementById('brand-input-name').value.trim() || 'VPN Shop',
        logo: document.getElementById('brand-input-logo').value.trim() || 'üîê',
        slogan: document.getElementById('brand-input-slogan').value.trim()
    };
    try {
        const r = await fetch(API+'/api/settings/brand', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(data)
        });
        if (r.ok) {
            BRAND = data;
            document.getElementById('brand-logo').textContent = BRAND.logo;
            document.getElementById('brand-name').textContent = BRAND.name;
            showToast('–ë—Ä–µ–Ω–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        } else showToast('–û—à–∏–±–∫–∞','error');
    } catch(e) { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏','error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST & MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showToast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast visible' + (type ? ' toast-'+type : '');
    clearTimeout(t._tid);
    t._tid = setTimeout(() => t.className = 'toast', 3000);
}

function showModal(html) {
    document.getElementById('modal-root').innerHTML = '<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-card">'+html+'</div></div>';
}

function closeModal() {
    document.getElementById('modal-root').innerHTML = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

// Start
init();
</script>
</body>
</html>
