<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<link rel="stylesheet" href="/web/static/css/style.css">
</head>
<body>
<div class="bg-glow"></div>
<div id="particles-js"></div>
<div id="app">

<!-- Loading -->
<div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
</div>

<!-- Error -->
<div id="error-screen" class="loading-screen" style="display:none">
    <p id="error-msg" style="color:var(--red);padding:20px;text-align:center"></p>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="main-app" class="app-wrapper" style="display:none">

<header class="app-header">
    <div class="brand">
        <span class="brand-logo" id="brand-logo"></span>
        <div class="brand-info">
            <span class="brand-name" id="brand-name">VPN Shop</span>
            <span class="brand-slogan" id="brand-slogan"></span>
        </div>
    </div>
    <div class="header-balances" onclick="go('profile')">
        <span class="header-badge" id="hdr-balance"><svg class="hdr-wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 14a1 1 0 100 2 1 1 0 000-2z" fill="currentColor" stroke="none"/><path d="M22 7V6a2 2 0 00-2-2H4a2 2 0 00-2 2v1"/></svg>0 ‚ÇΩ</span>
        <span class="header-badge header-badge-bonus" id="hdr-bonus" style="display:none"><svg class="hdr-wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/></svg>0 ‚ÇΩ</span>
    </div>
    <button class="btn-icon" id="btn-logout" onclick="webLogout()" title="–í—ã–π—Ç–∏" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
    </button>
</header>

<main class="app-content">

<!-- ‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê -->
<section id="p-home" class="page active">
    <!-- Subscription card -->
    <div class="card sub-card" id="sub-card">
        <!-- Active sub layout -->
        <div id="sub-active-layout" style="display:none">
            <div class="sub-top-row">
                <span class="sub-lbl">–¢–∞—Ä–∏—Ñ:</span>
                <span class="sub-plan-name" id="sub-plan-name">‚Äî</span>
            </div>
            <div class="sub-sep-line"></div>
            <div class="sub-2col">
                <div class="sub-field"><span class="sub-lbl">–ò—Å—Ç–µ–∫–∞–µ—Ç:</span><span class="sub-val" id="sub-expire-date">‚Äî</span></div>
                <div class="sub-field"><span class="sub-lbl">–¢—Ä–∞—Ñ–∏–∫:</span><span class="sub-val" id="sub-traffic">‚Äî</span></div>
                <div class="sub-field"><span class="sub-lbl">–û—Å—Ç–∞–ª–æ—Å—å:</span><span class="sub-val" id="sub-remaining">‚Äî</span></div>
                <div class="sub-field"><span class="sub-lbl">–£—Å—Ç—Ä–æ–π—Å—Ç–≤:</span><span class="sub-val" id="sub-devices">‚Äî</span></div>
            </div>
            <div class="sub-actions-row">
                <button class="sub-action-btn sub-action-renew" id="btn-renew" onclick="renewCurrentPlan()">–ü—Ä–æ–¥–ª–∏—Ç—å</button>
                <button class="sub-action-btn sub-action-change" id="btn-change" onclick="go('plans')">–°–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>
        <!-- No sub layout -->
        <div id="sub-empty-layout">
            <div class="sub-nosub-text" id="sub-nosub-text">–£ –≤–∞—Å –µ—â—ë –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏</div>
            <button class="sub-action-btn sub-action-buy" id="btn-buy-sub" onclick="go('plans')">–ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
        </div>
    </div>

    <!-- Actions -->
    <div class="action-pills">
        <button class="pill trial-pill" id="btn-trial" onclick="startTrial()" style="display:none">üéÅ&nbsp; –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
        <button class="pill pill-cyan" onclick="go('connect')">‚äô –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <div class="pill-row">
            <button class="pill pill-outline" onclick="go('promo')">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥</button>
            <button class="pill pill-outline" onclick="go('devices')">üì± –ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
        </div>
        <button class="pill pill-outline" id="btn-invite-home" onclick="inviteFriend()" style="display:none">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê PLANS ‚ïê‚ïê‚ïê -->
<section id="p-plans" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‚Äπ</button>
        <h2 class="page-title">–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã</h2>
    </div>
    <div id="plans-list" class="plans-list"></div>
    <div id="plans-bottom-bar" class="plans-bottom-bar" style="display:none">
        <div id="plans-pm-bar-wrap"></div>
        <button class="plan-pay-btn" id="plans-pay-btn" onclick="planPayClickGlobal()"></button>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê RENEW ‚ïê‚ïê‚ïê -->
<section id="p-renew" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‚Äπ</button>
        <h2 class="page-title">–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</h2>
    </div>
    <div id="renew-plan-view" class="plans-list"></div>
</section>

<!-- ‚ïê‚ïê‚ïê CONNECT ‚ïê‚ïê‚ïê -->
<section id="p-connect" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‚Äπ</button>
        <h2 class="page-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h2>
    </div>
    <!-- Block 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ -->
    <div class="card" id="con-actions" style="display:none">
        <div class="card-title">‚ö° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
        <div class="action-pills" style="flex-direction:column;gap:8px">
            <button class="pill pill-cyan btn-full" id="btn-download-auto" onclick="openLink(getDownloadUrl())" style="justify-content:center">
                <svg style="width:16px;height:16px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                &nbsp;<span id="btn-download-label">–°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</span>
            </button>
            <button class="pill pill-outline btn-full" id="btn-oneclick" onclick="" style="justify-content:center">
                <svg style="width:16px;height:16px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                &nbsp;–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
            </button>
        </div>
    </div>
    <!-- Block 2: –ü–æ–¥–ø–∏—Å–∫–∞ -->
    <div class="card" id="con-sub-block">
        <div class="card-title" id="con-link-title">üîó –ü–æ–¥–ø–∏—Å–∫–∞</div>
        <div class="action-pills" style="flex-direction:column;gap:8px">
            <button class="pill pill-outline btn-full" id="btn-subpage" onclick="" style="display:none;justify-content:center">
                <svg style="width:16px;height:16px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                &nbsp;–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏
            </button>
            <button class="pill pill-outline btn-full" id="btn-qr" onclick="showQR()" style="display:none;justify-content:center">
                <svg style="width:15px;height:15px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="5" y="5" width="3" height="3" fill="currentColor" stroke="none"/><rect x="16" y="5" width="3" height="3" fill="currentColor" stroke="none"/><rect x="5" y="16" width="3" height="3" fill="currentColor" stroke="none"/><path d="M14 14h3v3M20 14v3h-3M14 20h7v-3"/></svg>
                &nbsp;–ü–æ–∫–∞–∑–∞—Ç—å QR –∫–æ–¥
            </button>
            <button class="pill pill-outline btn-full" id="btn-show-sub" onclick="toggleSubLink()" style="display:none;justify-content:center">
                üîë&nbsp;–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
            </button>
        </div>
        <div id="con-sub-detail" style="display:none;margin-top:12px">
            <div class="connect-box connect-box-clickable" onclick="copyUrl()" title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                <code id="con-url">‚Äî</code>
            </div>
        </div>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê DEVICES ‚ïê‚ïê‚ïê -->
<section id="p-devices" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‚Äπ</button>
        <h2 class="page-title">–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h2>
    </div>
    <div id="devices-info" class="card">
        <div class="card-row"><span class="card-label">–õ–∏–º–∏—Ç</span><span class="card-value" id="dev-limit">‚Äî</span></div>
        <div class="card-row"><span class="card-label">–ó–∞–Ω—è—Ç–æ</span><span class="card-value" id="dev-used">‚Äî</span></div>
    </div>
    <div class="action-pills" style="margin-top:10px">
        <button class="pill pill-outline" id="btn-expand-devices" onclick="expandDevices()" style="display:none">‚ûï –†–∞—Å—à–∏—Ä–∏—Ç—å —Å–ª–æ—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤</button>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê PROMO ‚ïê‚ïê‚ïê -->
<section id="p-promo" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‚Äπ</button>
        <h2 class="page-title">–ü—Ä–æ–º–æ–∫–æ–¥—ã</h2>
    </div>
    <div class="card">
        <div class="card-title">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</div>
        <div style="display:flex;gap:8px">
            <input class="form-input" id="promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" style="flex:1">
            <button class="btn btn-primary btn-sm" onclick="activatePromo()">OK</button>
        </div>
        <p id="promo-result" style="font-size:.8rem;margin-top:8px;display:none"></p>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê SUPPORT ‚ïê‚ïê‚ïê -->
<section id="p-support" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‚Äπ</button>
        <h2 class="page-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
    </div>
    <div class="card card-compact" style="cursor:pointer" onclick="go('tickets')">
        <div class="card-title">üé´ –¢–∏–∫–µ—Ç—ã <span id="ticket-badge" class="ticket-badge" style="display:none">0</span></div>
        <span class="pill pill-cyan pill-sm">–û—Ç–∫—Ä—ã—Ç—å</span>
    </div>
    <div class="card card-compact" id="support-community" style="display:none">
        <div class="card-title">üí¨ –°–æ–æ–±—â–µ—Å—Ç–≤–æ</div>
        <button class="pill pill-cyan pill-sm" id="btn-community" onclick="">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="card card-compact" id="support-help" style="display:none">
        <div class="card-title">üõü –ü–æ–º–æ—â—å</div>
        <button class="pill pill-outline pill-sm" id="btn-support" onclick="">–ù–∞–ø–∏—Å–∞—Ç—å</button>
    </div>
    <div class="card card-compact" id="support-tos" style="display:none">
        <div class="card-title">üìÑ –°–æ–≥–ª–∞—à–µ–Ω–∏–µ</div>
        <button class="pill pill-outline pill-sm" id="btn-tos" onclick="">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê TICKET LIST ‚ïê‚ïê‚ïê -->
<section id="p-tickets" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‚Äπ</button>
        <h2 class="page-title">–ú–æ–∏ —Ç–∏–∫–µ—Ç—ã</h2>
        <button class="btn btn-primary btn-sm" onclick="showNewTicket()" style="margin-left:auto">+ –ù–æ–≤—ã–π</button>
    </div>
    <div id="tickets-list" class="ticket-list"></div>
</section>

<!-- ‚ïê‚ïê‚ïê TICKET CHAT ‚ïê‚ïê‚ïê -->
<section id="p-ticket" class="page ticket-page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack();loadTickets()">‚Äπ</button>
        <h2 class="page-title" id="ticket-title">–¢–∏–∫–µ—Ç</h2>
    </div>
    <div id="ticket-chat" class="ticket-chat"></div>
    <div class="ticket-bottom-bar">
        <div id="ticket-reply" class="ticket-reply-box" style="display:none">
            <textarea id="ticket-text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" rows="1"></textarea>
            <button class="ticket-send-btn" onclick="sendTicketReply()"><svg width="22" height="22" viewBox="0 0 24 24" fill="var(--cyan)" stroke="none"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê -->
<section id="p-profile" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‚Äπ</button>
        <h2 class="page-title">–ü—Ä–æ—Ñ–∏–ª—å</h2>
    </div>
    <!-- Section: Your Profile -->
    <div class="card">
        <div class="card-title">üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</div>
        <div class="card-row"><span class="card-label">ID</span><span class="card-value card-value-copy" id="pr-tid" onclick="copyValue(this)">‚Äî</span></div>
        <div class="card-row"><span class="card-label">–ò–º—è</span><span class="card-value" id="pr-name">‚Äî</span></div>
        <div class="card-row" id="pr-refcode-row" style="display:none"><span class="card-label">–†–µ—Ñ. –∫–æ–¥</span><span class="card-value card-value-copy" id="pr-refcode" onclick="copyValue(this)">‚Äî</span></div>
    </div>
    <!-- Section: Balance -->
    <div class="card" id="balance-card" style="display:none">
        <div class="card-title">üí∞ –ë–∞–ª–∞–Ω—Å</div>
        <div class="profile-balance-grid">
            <div class="profile-balance-item">
                <div class="profile-balance-label">–û—Å–Ω–æ–≤–Ω–æ–π</div>
                <div class="profile-balance-value" id="pr-balance">0 ‚ÇΩ</div>
            </div>
            <div class="profile-balance-item" id="pr-bonus-item" style="display:none">
                <div class="profile-balance-label">–ë–æ–Ω—É—Å–Ω—ã–π</div>
                <div class="profile-balance-value profile-balance-bonus" id="pr-bonus">0 ‚ÇΩ</div>
            </div>
        </div>
        <div class="profile-balance-actions">
            <button class="pill pill-cyan pill-sm" onclick="topupBalance()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            <button class="pill pill-gold pill-sm" id="btn-get-bonus" onclick="showBonusInfo()" style="display:none">–ü–æ–ª—É—á–∏—Ç—å</button>
        </div>
    </div>
    <!-- Section: Referral System -->
    <div class="card" id="ref-card" style="display:none">
        <div class="card-title">ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</div>
        <div class="ref-stats-grid" id="ref-stats"></div>
        <div class="ref-box">
            <code id="ref-link" style="cursor:pointer" onclick="copyRef()" title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">‚Äî</code>
        </div>
        <button class="pill pill-cyan btn-full" id="btn-invite" onclick="inviteFriend()" style="margin-top:10px;justify-content:center">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>
    </div>
    <!-- Section: Web Credentials (below invite) -->
    <div class="card" id="web-cred-card">
        <div class="card-title">üîë –í–µ–±-–¥–æ—Å—Ç—É–ø</div>
        <div id="web-cred-status"></div>
        <div id="web-cred-setup" style="display:none">
            <div class="form-group"><label>–õ–æ–≥–∏–Ω</label><input class="form-input" id="wc-username" placeholder="–ú–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞" autocomplete="off"></div>
            <div class="form-group"><label>–ü–∞—Ä–æ–ª—å</label><input class="form-input" id="wc-password" type="password" placeholder="–ú–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤"></div>
            <div class="form-group"><label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label><input class="form-input" id="wc-password2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
            <div style="display:flex;gap:8px">
                <button class="sub-action-btn sub-action-renew" style="flex:1" onclick="saveWebCredentials()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button class="sub-action-btn sub-action-change" style="flex:1;border-color:rgba(224,79,95,.35);color:var(--red)" onclick="$('web-cred-setup').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        <div id="web-cred-detail" style="display:none">
            <details class="spoiler-card" id="wc-spoiler">
                <summary><span class="spoiler-title">–î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–∞</span><span class="spoiler-chevron">‚ñº</span></summary>
                <div style="margin-top:10px">
                    <div class="card-row"><span class="card-label">–õ–æ–≥–∏–Ω</span><span class="card-value" id="wc-disp-login">‚Äî</span></div>
                    <div class="card-row"><span class="card-label">–ü–∞—Ä–æ–ª—å</span><span class="card-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
                    <div id="wc-change-section" style="display:none;margin-top:10px;border-top:1px solid var(--border);padding-top:10px">
                        <div class="form-group"><label>–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å</label><input class="form-input" id="wc-old-pass" type="password" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å"></div>
                        <div class="form-group"><label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label><input class="form-input" id="wc-new-pass" type="password" placeholder="–ú–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤"></div>
                        <div class="form-group"><label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label><input class="form-input" id="wc-new-pass2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
                    </div>
                    <button class="pill pill-outline pill-sm" style="margin-top:8px;width:100%;justify-content:center" onclick="showChangePass()">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button class="sub-action-btn sub-action-renew" style="flex:1;border-color:rgba(25,195,125,.35);color:var(--green)" id="wc-apply-btn" onclick="applyWebCredChange()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        <button class="sub-action-btn sub-action-change" style="flex:1;border-color:rgba(224,79,95,.35);color:var(--red)" onclick="cancelWebCredChange()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </details>
        </div>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê ADMIN ‚ïê‚ïê‚ïê -->
<section id="p-admin" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‚Äπ</button>
        <h2 class="page-title">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
    </div>
    <div class="admin-tabs" id="adm-tabs">
        <button class="admin-tab active" onclick="admTab('stats')"><span class="tab-icon">üìä</span><span class="tab-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span></button>
        <button class="admin-tab" onclick="admTab('users')"><span class="tab-icon">üë•</span><span class="tab-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span></button>
        <button class="admin-tab" onclick="admTab('plans')"><span class="tab-icon">üìã</span><span class="tab-label">–¢–∞—Ä–∏—Ñ—ã</span></button>
        <button class="admin-tab" onclick="admTab('settings')"><span class="tab-icon">‚öôÔ∏è</span><span class="tab-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
        <button class="admin-tab" onclick="admTab('tickets')"><span class="tab-icon">üé´</span><span class="tab-label">–¢–∏–∫–µ—Ç—ã</span><span class="admin-tab-badge" id="adm-tickets-badge" style="display:none">0</span></button>
        <button class="admin-tab" onclick="admTab('brand')"><span class="tab-icon">üé®</span><span class="tab-label">–ë—Ä–µ–Ω–¥</span></button>
    </div>

    <!-- Stats -->
    <div id="adm-stats" class="admin-content active">
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="st-total">‚Äî</div><div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div></div>
            <div class="stat-card"><div class="stat-value" id="st-active">‚Äî</div><div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div></div>
            <div class="stat-card"><div class="stat-value" id="st-expired">‚Äî</div><div class="stat-label">–ò—Å—Ç–µ–∫—à–∏—Ö</div></div>
            <div class="stat-card"><div class="stat-value" id="st-revenue">‚Äî</div><div class="stat-label">–ë–∞–ª–∞–Ω—Å ‚ÇΩ</div></div>
        </div>
    </div>
    <!-- Users -->
    <div id="adm-users" class="admin-content">
        <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ / ID" oninput="filterUsers()">
        </div>
        <div id="users-list" class="user-list"></div>
    </div>
    <!-- Plans admin -->
    <div id="adm-plans" class="admin-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
            <span style="color:var(--text2);font-size:.84rem" id="adm-plans-count">–¢–∞—Ä–∏—Ñ—ã</span>
            <button class="btn btn-primary btn-sm" onclick="showCreatePlan()">+ –°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <div id="adm-plans-list" class="plans-list"></div>
    </div>
    <!-- Settings -->
    <div id="adm-settings" class="admin-content"><div id="settings-list"></div></div>
    <!-- Admin Tickets -->
    <div id="adm-tickets" class="admin-content">
        <div id="adm-tickets-list" class="ticket-list"></div>
    </div>
    <!-- Brand -->
    <div id="adm-brand" class="admin-content">
        <div class="card">
            <div class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–µ–Ω–¥–∞</div>
            <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="form-input" id="br-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"></div>
            <div class="form-group"><label>–õ–æ–≥–æ—Ç–∏–ø (—ç–º–æ–¥–∑–∏ –∏–ª–∏ URL –∫–∞—Ä—Ç–∏–Ω–∫–∏)</label><input class="form-input" id="br-logo" placeholder="–£–∫–∞–∂–∏—Ç–µ —ç–º–æ–¥–∑–∏ –∏–ª–∏ url –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–∞"></div>
            <div class="form-group"><label>–°–ª–æ–≥–∞–Ω</label><input class="form-input" id="br-slogan" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≥–∞–Ω"></div>
            <button class="btn btn-primary btn-full" id="btn-save-brand" onclick="saveBrand()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê ADMIN USER DETAIL ‚ïê‚ïê‚ïê -->
<section id="p-auser" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="admTab('users');goBack()">‚Äπ</button>
        <h2 class="page-title" id="aud-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
    </div>
    <div id="aud-body"></div>
</section>

<!-- ‚ïê‚ïê‚ïê ADMIN TICKET DETAIL ‚ïê‚ïê‚ïê -->
<section id="p-aticket" class="page ticket-page">
    <div class="page-header">
        <button class="btn-back" onclick="admTab('tickets');goBack()">‚Äπ</button>
        <h2 class="page-title" id="at-title">–¢–∏–∫–µ—Ç</h2>
    </div>
    <div id="at-chat" class="ticket-chat"></div>
    <div class="ticket-bottom-bar">
        <div id="at-reply" class="ticket-reply-box">
            <textarea id="at-text" placeholder="–û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞‚Ä¶" rows="1"></textarea>
            <button class="ticket-send-btn" onclick="sendAdmTicketReply()"><svg width="22" height="22" viewBox="0 0 24 24" fill="var(--cyan)" stroke="none"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
    </div>
</section>

</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <button class="nav-item active" data-p="home" onclick="go('home')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button class="nav-item" data-p="profile" onclick="go('profile')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </button>
    <button class="nav-item" id="nav-community" onclick="" style="display:none">
        <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.783-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
        <span>–ì—Ä—É–ø–ø–∞</span>
    </button>
    <button class="nav-item" data-p="support" onclick="go('tickets')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
        <span class="nav-badge" id="nav-support-badge" style="display:none">0</span>
    </button>
    <button class="nav-item admin-nav" data-p="admin" onclick="go('admin')" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        <span>–ê–¥–º–∏–Ω</span>
        <span class="nav-badge" id="nav-admin-badge" style="display:none">0</span>
    </button>
</nav>
</div>

<div id="modal-root"></div>
<div id="toast" class="toast"></div>
</div>
<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GLOBALS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const API='/web';
let tg;
try { tg = window.Telegram.WebApp; } catch(e) {
    tg = {ready:()=>{},expand:()=>{},initData:'',setHeaderColor:()=>{},setBackgroundColor:()=>{},
          openTelegramLink:u=>window.open(u,'_blank'),openLink:u=>window.open(u,'_blank'),
          BackButton:{show:()=>{},hide:()=>{},offClick:()=>{},onClick:()=>{}}};
}
let D=null, BRAND={name:'',logo:'',slogan:''}, IS_ADMIN=false;
let planSel={};
const DEFAULT_LOGO='https://i.ibb.co/fdp0nVLN/small-logo.png';
const DEFAULT_NAME='DFC Online';
const DEFAULT_SLOGAN='–†–∞–±–æ—Ç–∞–µ—Ç –∏–∑ —É–ø–∞–∫–æ–≤–∫–∏';
let usersCache=[], curAdmTab='stats', DOMAIN='';
const AVAIL_LABELS={ALL:'–í—Å–µ',NEW:'–ù–æ–≤—ã–µ',EXISTING:'–î–µ–π—Å—Ç–≤—É—é—â–∏–µ',INVITED:'–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ',ALLOWED:'–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ',TRIAL:'–ü—Ä–æ–±–Ω—ã–π'};
const TYPE_LABELS={TRAFFIC:'–¢—Ä–∞—Ñ–∏–∫',DEVICES:'–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',BOTH:'–¢—Ä–∞—Ñ–∏–∫+–£—Å—Ç—Ä.',UNLIMITED:'–ë–µ–∑–ª–∏–º–∏—Ç'};
const CURRENCY_SYMBOLS={USD:'$',EUR:'‚Ç¨',XTR:'‚òÖ',RUB:'‚ÇΩ'};

/* ‚îÄ‚îÄ i18n ‚îÄ‚îÄ */
const I18N={
    RU:{
        home:'–ì–ª–∞–≤–Ω–∞—è',support:'–ü–æ–¥–¥–µ—Ä–∂–∫–∞',profile:'–ü—Ä–æ—Ñ–∏–ª—å',admin:'–ê–¥–º–∏–Ω',
        buy:'–û–ø–ª–∞—Ç–∏—Ç—å',buy_sub:'–ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É',trial:'–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ',connect:'–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è',renew:'–ü—Ä–æ–¥–ª–∏—Ç—å',change_plan:'–°–º–µ–Ω–∏—Ç—å',manage_sub:'–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π',
        promo:'–ü—Ä–æ–º–æ–∫–æ–¥—ã',devices:'–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',plans:'–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã',
        connect_title:'–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ',devices_title:'–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',
        sub_link:'–°—Å—ã–ª–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏',copy:'–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',download:'–°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
        no_sub:'–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏',active:'–ê–∫—Ç–∏–≤–Ω–∞',expired:'–ò—Å—Ç–µ–∫–ª–∞',trial_period:'–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥',
        limit:'–õ–∏–º–∏—Ç',used:'–ó–∞–Ω—è—Ç–æ',expand_devices:'–†–∞—Å—à–∏—Ä–∏—Ç—å —Å–ª–æ—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤',
        activate_promo:'–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥',enter_code:'–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥',
        tickets:'–¢–∏–∫–µ—Ç—ã',community:'–°–æ–æ–±—â–µ—Å—Ç–≤–æ',help:'–ü–æ–º–æ—â—å',open:'–û—Ç–∫—Ä—ã—Ç—å',write:'–ù–∞–ø–∏—Å–∞—Ç—å',
        my_tickets:'–ú–æ–∏ —Ç–∏–∫–µ—Ç—ã',new_ticket:'–ù–æ–≤—ã–π',
        name:'–ò–º—è',telegram:'Telegram',balance:'–ë–∞–ª–∞–Ω—Å',role:'–†–æ–ª—å',
        invite_friend:'–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞',copy_link:'–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É',
        remains:'–û—Å—Ç–∞–ª–æ—Å—å',days_left:'–¥–Ω.',
        select_period:'–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:',cancel:'–û—Ç–º–µ–Ω–∞',close:'–ó–∞–∫—Ä—ã—Ç—å',
        active_sub_note:'–£ –≤–∞—Å –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞. –û–ø–ª–∞—Ç–∞ –±—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–∞ —Å –±–∞–ª–∞–Ω—Å–∞.',
        not_enough:'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ë–∞–ª–∞–Ω—Å:',processing:'–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∫—É–ø–∫–∏‚Ä¶',
        sub_done:'–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!',purchase_error:'–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏',net_error:'–û—à–∏–±–∫–∞ —Å–µ—Ç–∏',
        trial_activating:'–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–±–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏‚Ä¶',trial_done:'–ü—Ä–æ–±–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!',
        trial_go_connect:'–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª ¬´–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ¬ª –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.',
        setup:'–ù–∞—Å—Ç—Ä–æ–∏—Ç—å',expand_unavail:'–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ',
        expand_trial_msg:'–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –ø—Ä–æ–±–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ. –ü—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ –ø–æ–ª–Ω—ã–π —Ç–∞—Ä–∏—Ñ.',
        buy_plan:'–ö—É–ø–∏—Ç—å —Ç–∞—Ä–∏—Ñ',
        no_plans:'–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤',loading:'–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶',error:'–û—à–∏–±–∫–∞',
        savings:'–í—ã–≥–æ–¥–∞',
        new_ticket_title:'–ù–æ–≤—ã–π —Ç–∏–∫–µ—Ç',subject:'–¢–µ–º–∞',message:'–°–æ–æ–±—â–µ–Ω–∏–µ',send:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
        fill_all:'–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è',ticket_created:'–¢–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω',
        resolved:'–í–æ–ø—Ä–æ—Å —Ä–µ—à—ë–Ω',unresolved:'–ù–µ —Ä–µ—à—ë–Ω',
        ticket_closed_resolved:'–¢–∏–∫–µ—Ç –∑–∞–∫—Ä—ã—Ç –∫–∞–∫ —Ä–µ—à—ë–Ω–Ω—ã–π',ticket_closed_unresolved:'–¢–∏–∫–µ—Ç –∑–∞–∫—Ä—ã—Ç –∫–∞–∫ –Ω–µ—Ä–µ—à—ë–Ω–Ω—ã–π',
        ticket_open:'–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',ticket_answered:'–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω',ticket_closed:'–ó–∞–∫—Ä—ã—Ç',ticket_new:'–ù–æ–≤–æ–µ',
        ticket_adm_new:'–ù–æ–≤—ã–π',ticket_adm_done:'–ì–æ—Ç–æ–≤–æ',
        waiting_payment:'–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã',waiting_payment_hint:'–ó–∞–≤–µ—Ä—à–∏—Ç–µ –æ–ø–ª–∞—Ç—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã',pay_success:'–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!',
        copied:'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!',link_copied:'–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!',no_sub_err:'–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏',
        user_role:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',admin_role:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',dev_role:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫',
        agreement:'–°–æ–≥–ª–∞—à–µ–Ω–∏–µ',no_tickets:'–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤',create_first:'–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–∏–∫–µ—Ç',
        write_msg:'–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶',
        traffic:'–¢—Ä–∞—Ñ–∏–∫',dev_short:'—É—Å—Ç—Ä.',select_plan:'–í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ',to_date:'–¥–æ',topup:'–ü–æ–ø–æ–ª–Ω–∏—Ç—å',
        topup_via_bot:'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞',expand_via_bot:'–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞',
        promo_activated:'–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!',quick_connect:'–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ',one_click:'–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è',
        sub_page:'–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏',no_active_sub:'–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏',saved:'–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ',
        auth_error:'–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û—Ç–∫—Ä–æ–π—Ç–µ –∏–∑ Telegram.',user_not_found:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.',
        show_qr:'–ü–æ–∫–∞–∑–∞—Ç—å QR –∫–æ–¥',show_sub:'–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É',hide_sub:'–°–∫—Ä—ã—Ç—å –ø–æ–¥–ø–∏—Å–∫—É',
        done:'–ì–æ—Ç–æ–≤–æ',confirm:'–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',connection:'–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ',subscription:'–ü–æ–¥–ø–∏—Å–∫–∞',
        tariff:'–¢–∞—Ä–∏—Ñ',period:'–ü–µ—Ä–∏–æ–¥',cost:'–°—Ç–æ–∏–º–æ—Å—Ç—å',
        sub_change_note:'–ü–æ–¥–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∞ –±–µ–∑ –ø–µ—Ä–µ—Ä–∞—Å—á—ë—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤',sub_renew_note:'–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –ø—Ä–æ–¥–ª–µ–Ω–∞',
        download_for:'–°–∫–∞—á–∞—Ç—å –¥–ª—è',download_app:'–°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',topup_amount:'–°—É–º–º–∞',payment_method:'–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã',
        pay_created:'–ü–ª–∞—Ç—ë–∂ —Å–æ–∑–¥–∞–Ω',enter_amount:'–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É',level:'–£—Ä–æ–≤–Ω–µ–≤–æ—Å—Ç—å',
        reward_l1:'–ù–∞–≥—Ä–∞–¥–∞ (—É—Ä. 1)',reward_l2:'–ù–∞–≥—Ä–∞–¥–∞ (—É—Ä. 2)',reward_type:'–¢–∏–ø –Ω–∞–≥—Ä–∞–¥—ã',
        accrual_cond:'–£—Å–ª–æ–≤–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è',accrual_form:'–§–æ—Ä–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è',
        invite_text:'–¢–µ–∫—Å—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è',ref_system:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞',
        per_month:'–≤ –º–µ—Å—è—Ü',best_deal:'–≤—ã–≥–æ–¥–Ω–æ',change_method:'–ò–∑–º–µ–Ω–∏—Ç—å',
        change_pay_method:'–ò–∑–º–µ–Ω–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã',pay_btn:'–û–ø–ª–∞—Ç–∏—Ç—å',
        apply_code:'–ü—Ä–∏–º–µ–Ω–∏—Ç—å',promo_placeholder:'–ü—Ä–æ–º–æ–∫–æ–¥...',
        admin_panel:'–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è',statistics:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',users:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
        tariffs:'–¢–∞—Ä–∏—Ñ—ã',settings:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏',branding:'–ë—Ä–µ–Ω–¥',
        web_access:'–í–µ–±-–¥–æ—Å—Ç—É–ø',your_profile:'–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å',referral_sys:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞',
        invited:'–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ',payments:'–û–ø–ª–∞—Ç',earned:'–ù–∞—á–∏—Å–ª–µ–Ω–æ',
        save:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',deleted:'–£–¥–∞–ª—ë–Ω',delete_plan_q:'–£–¥–∞–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ?',delete_ticket_q:'–£–¥–∞–ª–∏—Ç—å —Ç–∏–∫–µ—Ç?',
    },
    EN:{
        home:'Home',support:'Support',profile:'Profile',admin:'Admin',
        buy:'Pay',buy_sub:'Buy subscription',trial:'Try for free',connect:'Connect',renew:'Renew',change_plan:'Change plan',manage_sub:'Manage subscription',
        promo:'Promo codes',devices:'Devices',plans:'Plans',
        connect_title:'Connection',devices_title:'My Devices',
        sub_link:'Subscription Link',copy:'Copy',download:'Download App',
        no_sub:'No subscription',active:'Active',expired:'Expired',trial_period:'Trial',
        limit:'Limit',used:'Used',expand_devices:'Expand device slots',
        activate_promo:'Activate promo code',enter_code:'Enter code',
        tickets:'Tickets',community:'Community',help:'Help',open:'Open',write:'Write',
        my_tickets:'My Tickets',new_ticket:'New',
        name:'Name',telegram:'Telegram',balance:'Balance',role:'Role',
        invite_friend:'Invite a friend',copy_link:'Copy link',
        remains:'Remaining',days_left:'d.',
        select_period:'Choose period:',cancel:'Cancel',close:'Close',
        active_sub_note:'You have an active subscription. Payment will be deducted from balance.',
        not_enough:'Not enough funds. Balance:',processing:'Processing purchase‚Ä¶',
        sub_done:'Subscription activated!',purchase_error:'Purchase error',net_error:'Network error',
        trial_activating:'Activating trial subscription‚Ä¶',trial_done:'Trial subscription activated!',
        trial_go_connect:'Go to "Connection" section to configure.',
        setup:'Setup',expand_unavail:'Unavailable',
        expand_trial_msg:'Device expansion is not available on trial. Purchase a full plan.',
        buy_plan:'Buy plan',
        no_plans:'No available plans',loading:'Loading‚Ä¶',error:'Error',
        savings:'Save',
        new_ticket_title:'New Ticket',subject:'Subject',message:'Message',send:'Send',
        fill_all:'Fill in all fields',ticket_created:'Ticket created',
        resolved:'Resolved',unresolved:'Not resolved',
        ticket_closed_resolved:'Ticket closed as resolved',ticket_closed_unresolved:'Ticket closed as unresolved',
        ticket_open:'Pending',ticket_answered:'Reply received',ticket_closed:'Closed',ticket_new:'New',
        ticket_adm_new:'New',ticket_adm_done:'Done',
        waiting_payment:'Waiting for payment',waiting_payment_hint:'Complete payment on the payment system page',pay_success:'Payment successful!',
        copied:'Copied!',link_copied:'Link copied!',no_sub_err:'No subscription',
        user_role:'User',admin_role:'Administrator',dev_role:'Developer',
        agreement:'Terms',no_tickets:'No tickets',create_first:'Create your first ticket',
        write_msg:'Write a message‚Ä¶',
        traffic:'Traffic',dev_short:'dev.',select_plan:'Select plan',to_date:'until',topup:'Top up',
        topup_via_bot:'Top up balance via bot',expand_via_bot:'Device expansion available via bot',
        promo_activated:'Promo code activated!',quick_connect:'Quick connect',one_click:'Connect',
        sub_page:'Subscription page',no_active_sub:'No active subscription',saved:'Saved',
        auth_error:'Auth error. Open from Telegram.',user_not_found:'User not found. Start the bot.',
        show_qr:'Show QR code',show_sub:'Show subscription',hide_sub:'Hide subscription',
        done:'Done',confirm:'Confirm',connection:'Connection',subscription:'Subscription',
        tariff:'Tariff',period:'Period',cost:'Cost',
        sub_change_note:'Subscription will be changed without refund',sub_renew_note:'Your subscription will be renewed',
        download_for:'Download for',download_app:'Download app',topup_amount:'Amount',payment_method:'Payment method',
        pay_created:'Payment created',enter_amount:'Enter amount',level:'Levels',
        reward_l1:'Reward (lvl 1)',reward_l2:'Reward (lvl 2)',reward_type:'Reward type',
        accrual_cond:'Accrual conditions',accrual_form:'Accrual form',
        invite_text:'Invite text',ref_system:'Referral system',
        per_month:'per month',best_deal:'best deal',change_method:'Change',
        change_pay_method:'Change payment method',pay_btn:'Pay',
        apply_code:'Apply',promo_placeholder:'Promo code...',
        admin_panel:'Control panel',statistics:'Statistics',users:'Users',
        tariffs:'Plans',settings:'Settings',branding:'Brand',
        web_access:'Web access',your_profile:'Your profile',referral_sys:'Referral system',
        invited:'Invited',payments:'Payments',earned:'Earned',
        save:'Save',deleted:'Deleted',delete_plan_q:'Delete tariff?',delete_ticket_q:'Delete ticket?',
    },
    UK:{
        home:'–ì–æ–ª–æ–≤–Ω–∞',support:'–ü—ñ–¥—Ç—Ä–∏–º–∫–∞',profile:'–ü—Ä–æ—Ñ—ñ–ª—å',admin:'–ê–¥–º—ñ–Ω',
        buy:'–û–ø–ª–∞—Ç–∏—Ç–∏',trial:'–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ',connect:'–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è',renew:'–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏',change_plan:'–ó–º—ñ–Ω–∞ —Ç–∞—Ä–∏—Ñ—É',
        promo:'–ü—Ä–æ–º–æ–∫–æ–¥–∏',devices:'–ü—Ä–∏—Å—Ç—Ä–æ—ó',plans:'–¢–∞—Ä–∏—Ñ–Ω—ñ –ø–ª–∞–Ω–∏',
        connect_title:'–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è',devices_title:'–ú–æ—ó –ø—Ä–∏—Å—Ç—Ä–æ—ó',
        sub_link:'–ü–æ—Å–∏–ª–∞–Ω–Ω—è –ø—ñ–¥–ø–∏—Å–∫–∏',copy:'–ö–æ–ø—ñ—é–≤–∞—Ç–∏',download:'–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫',
        no_sub:'–ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å–∫–∏',active:'–ê–∫—Ç–∏–≤–Ω–∞',expired:'–ó–∞–∫—ñ–Ω—á–∏–ª–∞—Å—å',trial_period:'–ü—Ä–æ–±–Ω–∏–π –ø–µ—Ä—ñ–æ–¥',
        limit:'–õ—ñ–º—ñ—Ç',used:'–ó–∞–π–Ω—è—Ç–æ',expand_devices:'–†–æ–∑—à–∏—Ä–∏—Ç–∏ —Å–ª–æ—Ç–∏ –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤',
        activate_promo:'–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥',enter_code:'–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥',
        tickets:'–¢—ñ–∫–µ—Ç–∏',community:'–°–ø—ñ–ª—å–Ω–æ—Ç–∞',help:'–î–æ–ø–æ–º–æ–≥–∞',open:'–í—ñ–¥–∫—Ä–∏—Ç–∏',write:'–ù–∞–ø–∏—Å–∞—Ç–∏',
        my_tickets:'–ú–æ—ó —Ç—ñ–∫–µ—Ç–∏',new_ticket:'–ù–æ–≤–∏–π',
        name:'–Ü–º º—è',telegram:'Telegram',balance:'–ë–∞–ª–∞–Ω—Å',role:'–†–æ–ª—å',
        invite_friend:'–ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –¥—Ä—É–≥–∞',copy_link:'–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è',
        remains:'–ó–∞–ª–∏—à–∏–ª–æ—Å—å',days_left:'–¥–Ω.',
        select_period:'–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥:',cancel:'–°–∫–∞—Å—É–≤–∞—Ç–∏',close:'–ó–∞–∫—Ä–∏—Ç–∏',
        active_sub_note:'–£ –≤–∞—Å —î –∞–∫—Ç–∏–≤–Ω–∞ –ø—ñ–¥–ø–∏—Å–∫–∞. –û–ø–ª–∞—Ç–∞ –±—É–¥–µ —Å–ø–∏—Å–∞–Ω–∞ –∑ –±–∞–ª–∞–Ω—Å—É.',
        not_enough:'–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤. –ë–∞–ª–∞–Ω—Å:',processing:'–û–±—Ä–æ–±–∫–∞ –ø–æ–∫—É–ø–∫–∏‚Ä¶',
        sub_done:'–ü—ñ–¥–ø–∏—Å–∫—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ!',purchase_error:'–ü–æ–º–∏–ª–∫–∞ –ø–æ–∫—É–ø–∫–∏',net_error:'–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ',
        trial_activating:'–ê–∫—Ç–∏–≤–∞—Ü—ñ—è –ø—Ä–æ–±–Ω–æ—ó –ø—ñ–¥–ø–∏—Å–∫–∏‚Ä¶',trial_done:'–ü—Ä–æ–±–Ω—É –ø—ñ–¥–ø–∏—Å–∫—É –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ!',
        trial_go_connect:'–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ —Ä–æ–∑–¥—ñ–ª—É ¬´–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è¬ª –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.',
        setup:'–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏',expand_unavail:'–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ',
        expand_trial_msg:'–†–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Å–ª–æ—Ç—ñ–≤ –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ –ø—Ä–æ–±–Ω—ñ–π –ø—ñ–¥–ø–∏—Å—Ü—ñ. –ü—Ä–∏–¥–±–∞–π—Ç–µ –ø–æ–≤–Ω–∏–π —Ç–∞—Ä–∏—Ñ.',
        buy_plan:'–ö—É–ø–∏—Ç–∏ —Ç–∞—Ä–∏—Ñ',
        no_plans:'–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ç–∞—Ä–∏—Ñ—ñ–≤',loading:'–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶',error:'–ü–æ–º–∏–ª–∫–∞',
        savings:'–í–∏–≥–æ–¥–∞',
        new_ticket_title:'–ù–æ–≤–∏–π —Ç—ñ–∫–µ—Ç',subject:'–¢–µ–º–∞',message:'–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è',send:'–ù–∞–¥—ñ—Å–ª–∞—Ç–∏',
        fill_all:'–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è',ticket_created:'–¢—ñ–∫–µ—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ',
        resolved:'–ü–∏—Ç–∞–Ω–Ω—è –≤–∏—Ä—ñ—à–µ–Ω–æ',unresolved:'–ù–µ –≤–∏—Ä—ñ—à–µ–Ω–æ',
        ticket_closed_resolved:'–¢—ñ–∫–µ—Ç –∑–∞–∫—Ä–∏—Ç–æ —è–∫ –≤–∏—Ä—ñ—à–µ–Ω–∏–π',ticket_closed_unresolved:'–¢—ñ–∫–µ—Ç –∑–∞–∫—Ä–∏—Ç–æ —è–∫ –Ω–µ–≤–∏—Ä—ñ—à–µ–Ω–∏–π',
        ticket_open:'–ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ',ticket_answered:'–í—ñ–¥–ø–æ–≤—ñ–¥—å –æ—Ç—Ä–∏–º–∞–Ω–æ',ticket_closed:'–ó–∞–∫—Ä–∏—Ç–∏–π',ticket_new:'–ù–æ–≤–µ',
        ticket_adm_new:'–ù–æ–≤–∏–π',ticket_adm_done:'–ì–æ—Ç–æ–≤–æ',
        waiting_payment:'–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –æ–ø–ª–∞—Ç–∏',waiting_payment_hint:'–ó–∞–≤–µ—Ä—à—ñ—Ç—å –æ–ø–ª–∞—Ç—É –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –ø–ª–∞—Ç—ñ–∂–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏',pay_success:'–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–π—à–ª–∞ —É—Å–ø—ñ—à–Ω–æ!',
        copied:'–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!',link_copied:'–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!',no_sub_err:'–ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å–∫–∏',
        user_role:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',admin_role:'–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä',dev_role:'–†–æ–∑—Ä–æ–±–Ω–∏–∫',
        agreement:'–£–≥–æ–¥–∞',no_tickets:'–ù–µ–º–∞—î —Ç—ñ–∫–µ—Ç—ñ–≤',create_first:'–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–µ—Ä—à–∏–π —Ç—ñ–∫–µ—Ç',
        write_msg:'–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶',
        traffic:'–¢—Ä–∞—Ñ—ñ–∫',dev_short:'–ø—Ä–∏—Å—Ç—Ä.',select_plan:'–û–±—Ä–∞—Ç–∏ —Ç–∞—Ä–∏—Ñ',to_date:'–¥–æ',topup:'–ü–æ–ø–æ–≤–Ω–∏—Ç–∏',
        topup_via_bot:'–ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É –¥–æ—Å—Ç—É–ø–Ω–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞',expand_via_bot:'–†–æ–∑—à–∏—Ä–µ–Ω–Ω—è –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ –¥–æ—Å—Ç—É–ø–Ω–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞',
        promo_activated:'–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ!',quick_connect:'–®–≤–∏–¥–∫–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è',one_click:'–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è',
        sub_page:'–°—Ç–æ—Ä—ñ–Ω–∫–∞ –ø—ñ–¥–ø–∏—Å–∫–∏',no_active_sub:'–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—ó –ø—ñ–¥–ø–∏—Å–∫–∏',saved:'–ó–±–µ—Ä–µ–∂–µ–Ω–æ',
        auth_error:'–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –∑ Telegram.',user_not_found:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –±–æ—Ç–∞.',
        show_qr:'–ü–æ–∫–∞–∑–∞—Ç–∏ QR –∫–æ–¥',show_sub:'–ü–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É',hide_sub:'–°—Ö–æ–≤–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É',
        done:'–ì–æ—Ç–æ–≤–æ',confirm:'–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏',connection:'–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è',subscription:'–ü—ñ–¥–ø–∏—Å–∫–∞',
        tariff:'–¢–∞—Ä–∏—Ñ',period:'–ü–µ—Ä—ñ–æ–¥',cost:'–í–∞—Ä—Ç—ñ—Å—Ç—å',
        sub_change_note:'–ü—ñ–¥–ø–∏—Å–∫—É –±—É–¥–µ –∑–º—ñ–Ω–µ–Ω–æ –±–µ–∑ –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–∫—É –∫–æ—à—Ç—ñ–≤',sub_renew_note:'–í–∞—à—É –ø—ñ–¥–ø–∏—Å–∫—É –±—É–¥–µ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–æ',
        download_for:'–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–ª—è',download_app:'–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫',topup_amount:'–°—É–º–∞',payment_method:'–°–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏',
        pay_created:'–ü–ª–∞—Ç—ñ–∂ —Å—Ç–≤–æ—Ä–µ–Ω–æ',enter_amount:'–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É',level:'–†—ñ–≤–Ω–µ–≤—ñ—Å—Ç—å',
        reward_l1:'–ù–∞–≥–æ—Ä–æ–¥–∞ (—Ä—ñ–≤. 1)',reward_l2:'–ù–∞–≥–æ—Ä–æ–¥–∞ (—Ä—ñ–≤. 2)',reward_type:'–¢–∏–ø –Ω–∞–≥–æ—Ä–æ–¥–∏',
        accrual_cond:'–£–º–æ–≤–∏ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è',accrual_form:'–§–æ—Ä–º–∞ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è',
        invite_text:'–¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è',ref_system:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞',
        per_month:'–Ω–∞ –º—ñ—Å—è—Ü—å',best_deal:'–≤–∏–≥—ñ–¥–Ω–æ',change_method:'–ó–º—ñ–Ω–∏—Ç–∏',
        change_pay_method:'–ó–º—ñ–Ω–∏—Ç–∏ —Å–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏',pay_btn:'–û–ø–ª–∞—Ç–∏—Ç–∏',
        apply_code:'–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏',promo_placeholder:'–ü—Ä–æ–º–æ–∫–æ–¥...',
        admin_panel:'–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è',statistics:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',users:'–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ',
        tariffs:'–¢–∞—Ä–∏—Ñ–∏',settings:'–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è',branding:'–ë—Ä–µ–Ω–¥',
        web_access:'–í–µ–±-–¥–æ—Å—Ç—É–ø',your_profile:'–í–∞—à –ø—Ä–æ—Ñ—ñ–ª—å',referral_sys:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞',
        invited:'–ó–∞–ø—Ä–æ—à–µ–Ω–æ',payments:'–û–ø–ª–∞—Ç',earned:'–ù–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ',
        save:'–ó–±–µ—Ä–µ–≥—Ç–∏',deleted:'–í–∏–¥–∞–ª–µ–Ω–æ',delete_plan_q:'–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–∞—Ä–∏—Ñ?',delete_ticket_q:'–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–∏–∫–µ—Ç?',
    },
    DE:{
        home:'Startseite',support:'Support',profile:'Profil',admin:'Admin',
        buy:'Bezahlen',trial:'Kostenlos testen',connect:'Verbinden',renew:'Verl√§ngern',change_plan:'Tarif wechseln',
        promo:'Promocodes',devices:'Ger√§te',plans:'Tarife',
        connect_title:'Verbindung',devices_title:'Meine Ger√§te',
        sub_link:'Abo-Link',copy:'Kopieren',download:'App herunterladen',
        no_sub:'Kein Abo',active:'Aktiv',expired:'Abgelaufen',trial_period:'Testphase',
        limit:'Limit',used:'Belegt',expand_devices:'Ger√§teslots erweitern',
        activate_promo:'Promocode aktivieren',enter_code:'Code eingeben',
        tickets:'Tickets',community:'Community',help:'Hilfe',open:'√ñffnen',write:'Schreiben',
        my_tickets:'Meine Tickets',new_ticket:'Neu',
        name:'Name',telegram:'Telegram',balance:'Guthaben',role:'Rolle',
        invite_friend:'Freund einladen',copy_link:'Link kopieren',
        remains:'Verbleibend',days_left:'T.',
        select_period:'Zeitraum w√§hlen:',cancel:'Abbrechen',close:'Schlie√üen',
        active_sub_note:'Sie haben ein aktives Abo. Zahlung wird vom Guthaben abgezogen.',
        not_enough:'Nicht genug Guthaben. Saldo:',processing:'Kauf wird bearbeitet‚Ä¶',
        sub_done:'Abo abgeschlossen!',purchase_error:'Kauffehler',net_error:'Netzwerkfehler',
        trial_activating:'Test-Abo wird aktiviert‚Ä¶',trial_done:'Test-Abo aktiviert!',
        trial_go_connect:'Gehen Sie zum Abschnitt "Verbindung" zur Einrichtung.',
        setup:'Einrichten',expand_unavail:'Nicht verf√ºgbar',
        expand_trial_msg:'Ger√§teerweiterung im Testabo nicht verf√ºgbar. Erwerben Sie einen vollen Tarif.',
        buy_plan:'Tarif kaufen',
        no_plans:'Keine verf√ºgbaren Tarife',loading:'Laden‚Ä¶',error:'Fehler',
        savings:'Ersparnis',
        new_ticket_title:'Neues Ticket',subject:'Betreff',message:'Nachricht',send:'Senden',
        fill_all:'Alle Felder ausf√ºllen',ticket_created:'Ticket erstellt',
        resolved:'Gel√∂st',unresolved:'Nicht gel√∂st',
        ticket_closed_resolved:'Ticket als gel√∂st geschlossen',ticket_closed_unresolved:'Ticket als ungel√∂st geschlossen',
        ticket_open:'In Bearbeitung',ticket_answered:'Antwort erhalten',ticket_closed:'Geschlossen',ticket_new:'Neu',
        ticket_adm_new:'Neu',ticket_adm_done:'Erledigt',
        waiting_payment:'Warten auf Zahlung',waiting_payment_hint:'Schlie√üen Sie die Zahlung auf der Zahlungsseite ab',pay_success:'Zahlung erfolgreich!',
        copied:'Kopiert!',link_copied:'Link kopiert!',no_sub_err:'Kein Abo',
        user_role:'Benutzer',admin_role:'Administrator',dev_role:'Entwickler',
        agreement:'AGB',no_tickets:'Keine Tickets',create_first:'Erstellen Sie Ihr erstes Ticket',
        write_msg:'Nachricht schreiben‚Ä¶',
        traffic:'Traffic',dev_short:'Ger.',select_plan:'Tarif w√§hlen',to_date:'bis',topup:'Aufladen',
        topup_via_bot:'Guthaben √ºber Bot aufladen',expand_via_bot:'Ger√§teerweiterung √ºber Bot verf√ºgbar',
        promo_activated:'Promocode aktiviert!',quick_connect:'Schnellverbindung',one_click:'Verbinden',
        sub_page:'Abo-Seite',no_active_sub:'Kein aktives Abo',saved:'Gespeichert',
        auth_error:'Auth-Fehler. Aus Telegram √∂ffnen.',user_not_found:'Benutzer nicht gefunden. Bot starten.',
        show_qr:'QR-Code anzeigen',show_sub:'Abo anzeigen',hide_sub:'Abo verbergen',
        done:'Fertig',confirm:'Best√§tigen',connection:'Verbindung',subscription:'Abonnement',
        tariff:'Tarif',period:'Zeitraum',cost:'Kosten',
        sub_change_note:'Abo wird ohne R√ºckerstattung ge√§ndert',sub_renew_note:'Ihr Abo wird verl√§ngert',
        download_for:'Herunterladen f√ºr',download_app:'App herunterladen',topup_amount:'Betrag',payment_method:'Zahlungsmethode',
        pay_created:'Zahlung erstellt',enter_amount:'Betrag eingeben',level:'Stufen',
        reward_l1:'Belohnung (St. 1)',reward_l2:'Belohnung (St. 2)',reward_type:'Belohnungstyp',
        accrual_cond:'Gutschriftbedingungen',accrual_form:'Gutschriftform',
        invite_text:'Einladungstext',ref_system:'Empfehlungssystem',
        per_month:'pro Monat',best_deal:'g√ºnstig',change_method:'√Ñndern',
        change_pay_method:'Zahlungsmethode √§ndern',pay_btn:'Bezahlen',
        apply_code:'Anwenden',promo_placeholder:'Promocode...',
        admin_panel:'Verwaltung',statistics:'Statistik',users:'Benutzer',
        tariffs:'Tarife',settings:'Einstellungen',branding:'Marke',
        web_access:'Web-Zugang',your_profile:'Ihr Profil',referral_sys:'Empfehlungssystem',
        invited:'Eingeladen',payments:'Zahlungen',earned:'Verdient',
        save:'Speichern',deleted:'Gel√∂scht',delete_plan_q:'Tarif l√∂schen?',delete_ticket_q:'Ticket l√∂schen?',
    }
};
let CUR_LOCALE='RU';
function t(k){return (I18N[CUR_LOCALE]||I18N.RU)[k]||(I18N.RU[k]||k)}
function applyLocale(){
    // Navigation labels
    document.querySelectorAll('.nav-item').forEach(b=>{
        const pg=b.dataset.p;
        if(pg==='home') b.querySelector('span').textContent=t('home');
        if(pg==='support') b.querySelector('span').textContent=t('support');
        if(pg==='profile') b.querySelector('span').textContent=t('profile');
        if(pg==='admin') b.querySelector('span').textContent=t('admin');
    });
    // Home page buttons
    const hp=$('p-home');
    if(hp){
        const trial=$('btn-trial');if(trial)trial.innerHTML='üéÅ&nbsp; '+t('trial');
        // Sub card buttons
        $('sub-nosub-text').textContent=t('no_active_sub');
        $('btn-buy-sub').textContent=t('buy_sub');
        $('btn-renew').textContent=t('renew');
        const pills=hp.querySelectorAll('.pill');
        pills.forEach(p=>{
            const oc=p.getAttribute('onclick')||'';
            if(oc.includes("go('connect')")) p.innerHTML='‚äô '+t('connect');
            if(oc.includes("go('promo')")) p.innerHTML='üéÅ '+t('promo');
            if(oc.includes("go('devices')")) p.innerHTML='üì± '+t('devices');
            if(oc.includes("inviteFriend()")) p.innerHTML='üîó '+t('invite_friend');
        });
        const commB=$('btn-community-home');if(commB&&commB.style.display!=='none')commB.innerHTML='üí¨ '+t('community');
        const helpB=$('btn-help-home');if(helpB)helpB.innerHTML='üõü '+t('help');
    }
    // Page titles
    const pts={'p-plans':'plans','p-connect':'connect_title','p-devices':'devices_title','p-promo':'promo','p-support':'support','p-tickets':'my_tickets','p-profile':'profile'};
    Object.entries(pts).forEach(([id,key])=>{const el=$(id);if(el){const tt=el.querySelector('.page-title');if(tt)tt.textContent=t(key)}});
    // Connect page
    const cp=$('p-connect');
    if(cp){
        const cardTitles=cp.querySelectorAll('.card-title');
        if(cardTitles[0])cardTitles[0].textContent='‚ö° '+t('connection');
        if(cardTitles[1])cardTitles[1].textContent='üîó '+t('subscription');
        // Download button
        const dlBtn=$('btn-download-label');
        if(dlBtn) dlBtn.textContent=t('download_app');
        const cpills=cp.querySelectorAll('.pill');
        cpills.forEach(p=>{
            const id=p.id||'';
            if(id==='btn-oneclick'){const txt=p.childNodes[p.childNodes.length-1];if(txt)txt.textContent=' '+t('one_click')}
            if(id==='btn-subpage'){const txt=p.childNodes[p.childNodes.length-1];if(txt)txt.textContent=' '+t('sub_page')}
            if(id==='btn-qr') p.innerHTML='<svg style="width:15px;height:15px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="5" y="5" width="3" height="3" fill="currentColor" stroke="none"/><rect x="16" y="5" width="3" height="3" fill="currentColor" stroke="none"/><rect x="5" y="16" width="3" height="3" fill="currentColor" stroke="none"/><path d="M14 14h3v3M20 14v3h-3M14 20h7v-3"/></svg>&nbsp;'+t('show_qr');
            if(id==='btn-show-sub'){const det=$('con-sub-detail');p.innerHTML='üîë&nbsp;'+(det&&det.style.display!=='none'?t('hide_sub'):t('show_sub'))}
        });
    }
    // Devices page
    const dp=$('p-devices');
    if(dp){
        const labels=dp.querySelectorAll('.card-label');
        if(labels[0])labels[0].textContent=t('limit');
        if(labels[1])labels[1].textContent=t('used');
        const eb=$('btn-expand-devices');if(eb)eb.innerHTML='‚ûï '+t('expand_devices');
    }
    // Promo page
    const pp=$('p-promo');
    if(pp){
        const ct=pp.querySelector('.card-title');if(ct)ct.textContent=t('activate_promo');
        const inp=$('promo-input');if(inp)inp.placeholder=t('enter_code');
    }
    // Support page
    const sp=$('p-support');
    if(sp){
        const cards=sp.querySelectorAll('.card');
        cards.forEach(c=>{
            const ct=c.querySelector('.card-title');if(!ct)return;
            if(ct.textContent.includes('üé´')||ct.querySelector('#ticket-badge')){ct.childNodes[0].textContent='üé´ '+t('tickets')+' '}
            if(ct.textContent.includes('üí¨')) ct.textContent='üí¨ '+t('community');
            if(ct.textContent.includes('üõü')) ct.textContent='üõü '+t('help');
            if(ct.textContent.includes('üìÑ')) ct.textContent='üìÑ '+t('agreement');
        });
        sp.querySelectorAll('.pill').forEach(p=>{
            const oc=p.getAttribute('onclick')||'',id=p.id||'';
            if(oc.includes("go('tickets')")) p.textContent=t('open');
            if(id==='btn-community') p.textContent=t('open');
            if(id==='btn-support') p.textContent=t('write');
            if(id==='btn-tos') p.textContent=t('open');
        });
    }
    // Tickets page
    const tp=$('p-tickets');
    if(tp){const nb=tp.querySelector('.btn');if(nb&&nb.textContent.includes('–ù–æ–≤—ã–π')||nb&&nb.textContent.includes('New')||nb)nb.textContent='+ '+t('new_ticket')}
    // Ticket chat
    const ttext=$('ticket-text');if(ttext)ttext.placeholder=t('write_msg');
    const cbtns=$('ticket-close-actions');
    if(cbtns){
        const btns=cbtns.querySelectorAll('.ticket-close-btn');
        if(btns[0])btns[0].innerHTML='‚úÖ '+t('resolved');
        if(btns[1])btns[1].innerHTML='‚ùå '+t('unresolved');
    }
    // Profile page
    const pf=$('p-profile');
    if(pf){
        const labels=pf.querySelectorAll('.card-label');
        // Profile layout: ID, –ò–º—è, –†–µ—Ñ.–∫–æ–¥
        if(labels[0])labels[0].textContent='ID';
        if(labels[1])labels[1].textContent=t('name');
        const cardTitles=pf.querySelectorAll('.card-title');
        cardTitles.forEach(ct=>{
            if(ct.textContent.includes('üë§'))ct.textContent='üë§ '+t('profile');
            if(ct.textContent.includes('üí∞'))ct.textContent='üí∞ '+t('balance');
            if(ct.textContent.includes('ü§ù'))ct.textContent='ü§ù '+t('invite_friend');
        });
        const pfPills=pf.querySelectorAll('.pill');
        pfPills.forEach(p=>{
            if((p.getAttribute('onclick')||'').includes('topupBalance'))p.textContent=t('topup');
            if((p.getAttribute('onclick')||'').includes('copyRef'))p.textContent=t('copy_link');
            if((p.getAttribute('onclick')||'').includes('inviteFriend'))p.textContent='üîó '+t('invite_friend');
        });
    }
    // Admin - save brand button
    const sbBtn=$('btn-save-brand');if(sbBtn)sbBtn.textContent=t('save');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initParticles(){
    if(typeof particlesJS==='undefined')return;
    particlesJS('particles-js',{
        particles:{
            number:{value:70,density:{enable:true,value_area:800}},
            color:{value:'#24C4F1'},
            shape:{type:'circle'},
            opacity:{value:0.25,random:true,anim:{enable:true,speed:0.4,opacity_min:0,sync:false}},
            size:{value:2,random:true,anim:{enable:false}},
            line_linked:{enable:true,distance:180,color:'#24C4F1',opacity:0.08,width:1},
            move:{enable:true,speed:0.6,direction:'none',random:false,straight:false,out_mode:'out',bounce:false}
        },
        interactivity:{
            detect_on:'window',
            events:{onhover:{enable:true,mode:'grab'},onclick:{enable:true,mode:'push'},resize:true},
            modes:{grab:{distance:140,line_linked:{opacity:0.3}},push:{particles_nb:1}}
        },
        retina_detect:true
    });
}
async function init(){
    tg.ready(); tg.expand();
    try{tg.setHeaderColor('#080C14')}catch(e){}
    try{tg.setBackgroundColor('#080C14')}catch(e){}
    try{
        // Try Telegram auth if initData available
        if(tg.initData){
            const a=await fetch(API+'/api/auth/tg',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData:tg.initData})});
            if(!a.ok) return showErr(t('auth_error'));
        }
        // Try to load user data (works with cookie from tg auth or web login)
        const dr=await fetch(API+'/api/user/data');
        if(!dr.ok){
            // No valid session ‚Äî redirect to login for web, show error for miniapp
            if(!tg.initData){window.location.href='/web/login';return}
            return showErr('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.');
        }
        D=await dr.json();
        try{const br=await fetch(API+'/api/settings/brand');if(br.ok)BRAND=await br.json()}catch(e){}
        try{const cfg=await fetch(API+'/api/config');if(cfg.ok){const c=await cfg.json();DOMAIN=c.domain||''}}catch(e){}
        IS_ADMIN=D.user.role==='DEV'||D.user.role==='ADMIN';
        // Set locale from bot_locale or user language
        const bl=(D.bot_locale||'').toUpperCase();
        if(['RU','EN','UK','DE'].includes(bl)) CUR_LOCALE=bl;
        else {
            const ul=(D.user.language||'').toUpperCase();
            if(['RU','EN','UK','DE'].includes(ul)) CUR_LOCALE=ul;
        }
        $('loading-screen').style.display='none';
        $('main-app').style.display='flex';
        if(IS_ADMIN) document.querySelectorAll('.admin-nav').forEach(e=>e.style.display='');
        // Show logout button for web users (not inside Telegram)
        if(!tg.initData){const lb=$('btn-logout');if(lb)lb.style.display=''}
        initParticles();
        render();
        applyLocale();
        _setupTicketKeys();
        // Start polling ticket status every 15 seconds
        setInterval(pollTicketStatus, 15000);
    }catch(e){showErr(t('error')+': '+e.message)}
}

function showErr(m){$('loading-screen').style.display='none';$('error-screen').style.display='flex';$('error-msg').textContent=m}
function $(id){return document.getElementById(id)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAVIGATION
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const mainPages=['home','support','profile','admin'];
let curPage='home';
let navHistory=[];
function go(p){
    if(curPage!==p) navHistory.push(curPage);
    curPage=p;
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    $('p-'+p).classList.add('active');
    const navP=({tickets:'support',ticket:'support',aticket:'admin',auser:'admin'})[p]||p;
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.toggle('active',b.dataset.p===navP));
    if(p==='home'){tg.BackButton.hide();navHistory=[]}else{tg.BackButton.show();tg.BackButton.offClick(goBack);tg.BackButton.onClick(goBack)}
    if(p==='admin')loadAdm(curAdmTab);
    if(p==='plans'){renderPlans()}else{const pb=$('plans-bottom-bar');if(pb)pb.style.display='none'}
    if(p==='tickets')loadTickets();
    updateFab();
}
function goBack(){
    // First close any open modal/overlay
    const mr=$('modal-root');
    if(mr&&mr.innerHTML.trim()){
        const co=mr.querySelector('.confirm-overlay');
        if(co){co.remove();return}
        closeModal();return;
    }
    if(navHistory.length>0){const prev=navHistory.pop();go(prev);if(prev==='home')navHistory=[]}else{go('home')}
}
function goHome(){go('home')}
function updateFab(){
    // Nav support badge
    const nb=$('nav-support-badge');
    if(nb){if(D.ticket_unread>0){nb.style.display='flex';nb.textContent=D.ticket_unread}else{nb.style.display='none'}}
    // Admin ticket badge
    const ab=$('nav-admin-badge');
    if(ab&&IS_ADMIN){if(D.admin_ticket_unread>0){ab.style.display='flex';ab.textContent=D.admin_ticket_unread}else{ab.style.display='none'}}
    // Admin tickets tab badge
    const atb=$('adm-tickets-badge');
    if(atb&&IS_ADMIN){if(D.admin_ticket_unread>0){atb.style.display='inline-flex';atb.textContent=D.admin_ticket_unread}else{atb.style.display='none'}}
}
async function pollTicketStatus(){
    try{
        const r=await fetch(API+'/api/tickets/status');
        if(!r.ok)return;
        const s=await r.json();
        D.has_open_tickets=s.has_open;
        D.ticket_unread=s.unread;
        if(s.admin_unread!==undefined) D.admin_ticket_unread=s.admin_unread;
        updateFab();
    }catch(e){}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RENDER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function render(){
    // Brand logo: URL ‚Üí <img>, emoji ‚Üí text, empty ‚Üí default logo
    const logoEl=$('brand-logo');
    const logoVal=BRAND.logo||'';
    const effectiveLogo=logoVal||DEFAULT_LOGO;
    if(effectiveLogo.startsWith('http')){logoEl.innerHTML='<img class="brand-logo-img" src="'+esc(effectiveLogo)+'" alt="">';logoEl.classList.add('has-img')}
    else if(effectiveLogo){logoEl.textContent=effectiveLogo;logoEl.classList.remove('has-img')}
    else{logoEl.textContent='';logoEl.classList.remove('has-img')}
    $('brand-name').textContent=BRAND.name||DEFAULT_NAME;
    const sloganEl=$('brand-slogan');
    const effectiveSlogan=BRAND.slogan||DEFAULT_SLOGAN;
    sloganEl.textContent=effectiveSlogan;sloganEl.style.display=''
    const _cs=CURRENCY_SYMBOLS[D.default_currency]||'\u20bd';
    $('hdr-balance').innerHTML='<svg class="hdr-wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 14a1 1 0 100 2 1 1 0 000-2z" fill="currentColor" stroke="none"/><path d="M22 7V6a2 2 0 00-2-2H4a2 2 0 00-2 2v1"/></svg>'+D.user.balance+' '+_cs;
    const _bm=D.features&&D.features.balance_mode;
    const _rb=D.user.referral_balance||0;
    if(_bm==='SEPARATE'){$('hdr-bonus').style.display='';$('hdr-bonus').innerHTML='<svg class="hdr-wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/></svg>'+_rb+' '+_cs}else{$('hdr-bonus').style.display='none'}
    renderSub(); renderConnect(); renderProfile(); renderSupport(); renderHomeExtras();
    // Trial button ‚Äî hide if user has/had subscription or used trial
    const hasSub=D.subscription&&D.subscription.status;
    if(D.trial_available && !hasSub) $('btn-trial').style.display='';
    else $('btn-trial').style.display='none';
    // Ticket FAB ‚Äî only on home page, only for open (non-closed/resolved) tickets
    updateFab();
    // Ticket badge
    if(D.ticket_unread>0){$('ticket-badge').style.display='';$('ticket-badge').textContent=D.ticket_unread}
    // Expand devices button
    if(D.subscription&&D.subscription.status==='ACTIVE') $('btn-expand-devices').style.display='';
}

function renderSub(){
    const s=D.subscription;
    const activeLayout=$('sub-active-layout'), emptyLayout=$('sub-empty-layout');

    if(!s||!s.status||s.status==='EXPIRED'){
        activeLayout.style.display='none';
        emptyLayout.style.display='';
        $('sub-nosub-text').textContent=t('no_active_sub');
        return;
    }

    activeLayout.style.display='';
    emptyLayout.style.display='none';

    // Plan name
    const pn=$('sub-plan-name');
    const planLabel=s.is_trial?t('trial_period'):(s.plan_name||'‚Äî');
    pn.textContent=planLabel;
    pn.className='sub-plan-name'+(s.status==='EXPIRED'?' sub-plan-expired':'');

    // Expire info: date + remaining days
    const eid=$('sub-expire-date');
    const eir=$('sub-remaining');
    if(eid){
        if(s.expire_at&&(s.status==='ACTIVE'||s.is_trial)){
            const datePart=s.expire_at.split(' ')[0];
            eid.textContent=datePart;
            const parts=s.expire_at.match(/(\d{2})\.(\d{2})\.(\d{4})\s+(\d{2}):(\d{2})/);
            if(parts){
                const expireDate=new Date(parseInt(parts[3]),parseInt(parts[2])-1,parseInt(parts[1]),parseInt(parts[4]),parseInt(parts[5]));
                const diff=expireDate-new Date();
                if(diff>0){
                    const daysLeft=Math.floor(diff/(1000*60*60*24));
                    if(eir) eir.textContent=daysLeft+' '+pluralDays(daysLeft);
                } else {if(eir) eir.textContent='0 '+pluralDays(0)}
            } else {if(eir) eir.textContent='‚Äî'}
        } else {eid.textContent='‚Äî';if(eir) eir.textContent='‚Äî'}
    }

    // Traffic ‚Äî use current plan type to decide display
    const currentPlan=D.plans&&s.plan_id?D.plans.find(p=>p.id===s.plan_id):null;
    let tl;
    if(currentPlan){
        if(currentPlan.type==='DEVICES') tl='–ë–µ–∑–ª–∏–º.';
        else tl=(currentPlan.traffic_limit||'‚àû')+' –ì–ë';
    } else {
        tl=s.traffic_limit? s.traffic_limit+' –ì–ë':'‚àû';
    }
    const tr=$('sub-traffic');
    if(tr) tr.textContent=tl;

    // Devices
    const dl=$('sub-devices');
    if(dl){
        const devLimit=s.device_limit||'‚àû';
        const devActive=(typeof s.active_devices_count==='number')?s.active_devices_count:null;
        dl.textContent=(devActive!==null)?(devActive+' –∏–∑ '+devLimit):devLimit;
    }

    // Show/hide renew (only for paid subs)
    if(s.is_trial){
        $('btn-renew').style.display='none';
        $('btn-change').textContent=t('buy_sub');
    } else {
        $('btn-renew').style.display='';
        $('btn-change').textContent=t('change_plan');
    }
}

function renderHomeExtras(){
    // nav –ì—Ä—É–ø–ø–∞ button (community)
    const navComm=$('nav-community');
    if(D.features&&D.features.community_enabled&&D.features.community_url){
        const url=D.features.community_url;
        if(navComm){navComm.style.display='';navComm.onclick=()=>openLink(url);}
    } else {
        if(navComm) navComm.style.display='none';
    }
    // Invite button
    const ib=$('btn-invite-home');
    if(ib){
        ib.style.display=(D.features&&D.features.referral_enabled)?'':'none';
    }
}

function _getPayMethods(){
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ';
    const gateways=D.available_gateways||[];
    let methods=[];
    gateways.forEach(gw=>{
        methods.push({type:gw.type,name:GW_LABELS[gw.type]||gw.type,icon:GW_ICONS[gw.type]||'üí≥',desc:GW_DESCS[gw.type]||''});
    });
    methods.push({type:'balance',name:t('balance'),icon:'üí∞',desc:D.user.balance+' '+sym});
    return methods;
}
function _getDefaultMethod(){
    const methods=_getPayMethods();
    return methods.length>0?methods[0].type:'balance';
}
function _fmtPr(n){return n>=1000?n.toLocaleString('ru-RU'):String(n)}

function _renderDurGrid(plan,planId){
    const dc=D.default_currency||'RUB',sym=CURRENCY_SYMBOLS[dc]||'‚ÇΩ';
    let basePpd=null,bestDealDays=null,lowestPpd=null;
    (plan.durations||[]).forEach(d=>{
        const pr=findPrice(d,dc);
        if(pr!==null&&d.days>0){
            const ppd=pr/d.days;
            if(basePpd===null||d.days<basePpd.days)basePpd={ppd,days:d.days};
            if(lowestPpd===null||ppd<lowestPpd){lowestPpd=ppd;bestDealDays=d.days}
        }
    });
    const durs=(plan.durations||[]).filter(d=>findPrice(d,dc)!==null);
    const firstDur=durs[0];
    if(!planSel[planId]){
        planSel[planId]={days:firstDur?firstDur.days:0,price:firstDur?findPrice(firstDur,dc):0,method:_getDefaultMethod()};
    }
    return durs.map(d=>{
        const pr=findPrice(d,dc);
        const isSelected=planSel[planId].days===d.days;
        const isBestDeal=d.days===bestDealDays&&durs.length>1&&basePpd&&d.days>basePpd.days;
        const ppm=d.days>=30?Math.round(pr/(d.days/30)):null;
        let h='<div class="plan-dur-card'+(isSelected?' selected':'')+'" onclick="selectDur(event,'+planId+','+d.days+','+pr+')">';
        if(isBestDeal)h+='<span class="pdc-badge">'+t('best_deal')+'</span>';
        h+='<div class="plan-dur-card-period">'+fmtDaysFull(d.days)+'</div>';
        h+='<div class="plan-dur-card-price">'+_fmtPr(pr)+' '+sym+'</div>';
        if(ppm!==null&&d.days>30)h+='<div class="plan-dur-card-ppm">'+_fmtPr(ppm)+' '+sym+' '+t('per_month')+'</div>';
        h+='</div>';
        return h;
    }).join('');
}
function _renderPmBar(planId){
    const methods=_getPayMethods();
    const sel=planSel[planId];
    const method=methods.find(m=>m.type===sel.method)||methods[0];
    const canChange=methods.length>1;
    return '<div class="plan-pm-bar" '+(canChange?'onclick="showPayMethodPicker(event,'+planId+')"':'')+'>'+
        '<div class="plan-pm-icon">'+method.icon+'</div>'+
        '<div class="plan-pm-info">'+
            '<div class="plan-pm-name">'+esc(method.name)+'</div>'+
            '<div class="plan-pm-desc">'+esc(method.desc)+'</div>'+
        '</div>'+
        (canChange?'<div class="plan-pm-change">'+t('change_method')+' ‚Ä∫</div>':'')+
    '</div>';
}
function _renderPayBtn(planId){
    const sel=planSel[planId];
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ';
    return '<button class="plan-pay-btn" id="pay-btn-'+planId+'" onclick="planPayClick(event,'+planId+')">'+t('pay_btn')+' '+_fmtPr(sel.price)+' '+sym+'</button>';
}

function renderPlans(){
    const el=$('plans-list'),dc=D.default_currency||'RUB',sym=CURRENCY_SYMBOLS[dc]||'‚ÇΩ';
    if(!D.plans||!D.plans.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">üìã</span><h3>'+t('no_plans')+'</h3></div>';return}
    const activePlanId=D.subscription&&D.subscription.status==='ACTIVE'?(D.subscription.plan_id||(D.subscription.plan&&D.subscription.plan.id)):null;
    const visiblePlans=activePlanId?D.plans.filter(p=>p.id!==activePlanId):D.plans;
    if(!visiblePlans.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">‚úÖ</span><h3>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤</h3><p style="color:var(--text3);font-size:.84rem">–í–∞—à —Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π</p></div>';return}
    const singlePlan=visiblePlans.length===1;
    el.innerHTML=visiblePlans.map(p=>{
        const desc=p.description||'';
        const trafficText=(p.traffic_limit||'‚àû')+' GB';
        const devicesText=(p.device_limit||'‚àû')+' '+t('dev_short');
        let minPrice=null;
        (p.durations||[]).forEach(d=>{const pr=findPrice(d,dc);if(pr!==null&&(minPrice===null||pr<minPrice))minPrice=pr});
        const priceText=minPrice!==null?('–æ—Ç '+minPrice+' '+sym):'';
        const gridHtml=_renderDurGrid(p,p.id);
        const pmBar=_renderPmBar(p.id);
        const payBtn=_renderPayBtn(p.id);
        return '<div class="card plan-card-new'+(singlePlan?' open':'')+'" '+(singlePlan?'':'onclick="togglePlanCard(this,event)"')+' data-plan-id="'+p.id+'">'+
            '<div class="plan-card-header">'+
                '<div class="plan-card-name">'+esc(p.name)+'</div>'+
                (singlePlan?'':'<div class="plan-card-price">'+priceText+'</div>')+
            '</div>'+
            (desc?'<div class="plan-card-desc">'+esc(desc)+'</div>':'')+
            '<div class="plan-card-meta"><span>üì¶ '+trafficText+'</span><span>üì± '+devicesText+'</span></div>'+
            '<div class="plan-card-body"'+(singlePlan?' style="max-height:none;opacity:1;margin-top:12px"':'')+'>'+
                '<div class="plan-dur-grid">'+gridHtml+'</div>'+
            '</div>'+
            (singlePlan?'':'<div class="plan-card-toggle" onclick="event.stopPropagation();togglePlanCard(this.parentElement)">‚ñº</div>')+
        '</div>';
    }).join('');
    // Select the first (or single) plan for sticky bar
    selectedPlanId=visiblePlans[0].id;
    _updateStickyBar();
}
let selectedPlanId=null;
function _updateStickyBar(){
    const bar=$('plans-bottom-bar');
    if(!selectedPlanId||!planSel[selectedPlanId]){if(bar)bar.style.display='none';return}
    if(bar)bar.style.display='';
    const wrap=$('plans-pm-bar-wrap');
    if(wrap)wrap.innerHTML=_renderPmBar(selectedPlanId);
    const btn=$('plans-pay-btn');
    if(btn){
        const sel=planSel[selectedPlanId];
        const sym=CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ';
        btn.textContent=t('pay_btn')+' '+_fmtPr(sel.price)+' '+sym;
    }
}
function planPayClickGlobal(){
    if(!selectedPlanId)return;
    const sel=planSel[selectedPlanId];
    if(!sel||!sel.days||!sel.price)return;
    if(sel.method==='balance'){
        showConfirmPurchase(selectedPlanId,sel.days,sel.price,'balance');
    } else {
        doPayment(selectedPlanId,sel.days,sel.price,sel.method);
    }
}
function togglePlanCard(card,ev){
    if(ev&&ev.target&&ev.target.closest&&ev.target.closest('.plan-card-body'))return;
    const isOpen=card.classList.contains('open');
    document.querySelectorAll('.plan-card-new.open').forEach(c=>{if(c!==card)c.classList.remove('open')});
    card.classList.toggle('open',!isOpen);
    document.querySelectorAll('.plan-card-new .plan-card-toggle').forEach(el=>{
        el.textContent=el.parentElement.classList.contains('open')?'‚ñ≤':'‚ñº';
    });
    if(!isOpen){
        const pid=parseInt(card.getAttribute('data-plan-id'));
        if(pid){selectedPlanId=pid;_updateStickyBar()}
    }
}
function selectDur(e,planId,days,price){
    e.stopPropagation();
    planSel[planId]=planSel[planId]||{};
    planSel[planId].days=days;planSel[planId].price=price;
    planSel[planId].method=planSel[planId].method||_getDefaultMethod();
    const card=document.querySelector('[data-plan-id="'+planId+'"]');
    if(card){
        card.querySelectorAll('.plan-dur-card').forEach(c=>c.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
    }
    selectedPlanId=planId;
    _updateStickyBar();
}
function _updatePayBtn(planId){
    const sel=planSel[planId];if(!sel)return;
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ';
    const btn=document.getElementById('pay-btn-'+planId);
    if(btn)btn.textContent=t('pay_btn')+' '+_fmtPr(sel.price)+' '+sym;
}
function showPayMethodPicker(e,planId){
    e.stopPropagation();
    const methods=_getPayMethods();
    const sel=planSel[planId];
    let itemsHtml=methods.map(m=>{
        const isSelected=sel.method===m.type;
        return '<div class="pm-picker-item'+(isSelected?' selected':'')+'" onclick="changePayMethod('+planId+',\''+m.type+'\')">'+
            '<div class="pm-picker-icon">'+m.icon+'</div>'+
            '<div class="pm-picker-info">'+
                '<div class="pm-picker-name">'+esc(m.name)+'</div>'+
                (m.desc?'<div class="pm-picker-desc">'+esc(m.desc)+'</div>':'')+
            '</div>'+
            '<div class="pm-picker-check"></div>'+
        '</div>';
    }).join('');
    showModal(
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">'+
            '<div style="display:flex;align-items:center;gap:10px">'+
                '<span style="font-size:1.1rem">üí≥</span>'+
                '<h3 style="margin:0">'+t('change_pay_method')+'</h3>'+
            '</div>'+
            '<button onclick="closeModal()" style="background:none;border:none;color:var(--text3);font-size:1.2rem;cursor:pointer;padding:4px">‚úï</button>'+
        '</div>'+
        '<div class="pm-picker-list">'+itemsHtml+'</div>',
        'modal-renew'
    );
}
function changePayMethod(planId,method){
    planSel[planId].method=method;
    closeModal();
    document.querySelectorAll('[data-plan-id="'+planId+'"] .plan-pm-bar, #renew-plan-view .plan-pm-bar').forEach(bar=>{
        bar.outerHTML=_renderPmBar(planId);
    });
    _updateStickyBar();
}
function planPayClick(e,planId){
    e.stopPropagation();
    const sel=planSel[planId];
    if(!sel||!sel.days||!sel.price)return;
    if(sel.method==='balance'){
        showConfirmPurchase(planId,sel.days,sel.price,'balance');
    } else {
        doPayment(planId,sel.days,sel.price,sel.method);
    }
}
function applyPlanPromo(e,planId){
    e.stopPropagation();
    const input=document.getElementById('plan-promo-'+planId);
    if(!input)return;
    const code=input.value.trim();if(!code)return;
    (async()=>{
        try{
            const res=await fetch(API+'/api/promocode/activate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
            const d=await res.json();
            if(res.ok){toast(d.message||t('promo_activated'));input.value='';const dr=await fetch(API+'/api/user/data');if(dr.ok){D=await dr.json();render()}}
            else toast(d.detail||t('error'),'error');
        }catch(e2){toast(t('net_error'),'error')}
    })();
}
function _buildPayOpts(){
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ';
    const gateways=D.available_gateways||[];
    let options='<option value="balance">üí∞ '+t('balance')+' ('+D.user.balance+' '+sym+')</option>';
    gateways.forEach(gw=>{
        const label=GW_LABELS[gw.type]||gw.type;
        const icon=GW_ICONS[gw.type]||'üí≥';
        options+='<option value="'+gw.type+'">'+icon+' '+label+'</option>';
    });
    return options;
}
function showConfirmPurchase(planId,days,price,payMethod){
    if(!payMethod)payMethod='balance';
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ';
    const plan=D.plans.find(p=>p.id===planId);
    const planName=plan?esc(plan.name):'‚Äî';
    const gateways=D.available_gateways||[];
    let pmLabel='üí∞ '+t('balance');
    if(payMethod==='balance'){pmLabel='üí∞ '+t('balance')}
    else{const gw=gateways.find(g=>g.type===payMethod);pmLabel=(GW_ICONS[payMethod]||'üí≥')+' '+(gw?(GW_LABELS[gw.type]||gw.type):payMethod)}
    let note='';
    if(D.subscription&&D.subscription.status==='ACTIVE'){
        const curPlanId=D.subscription.plan_id||(D.subscription.plan&&D.subscription.plan.id);
        if(curPlanId && curPlanId!==planId){
            note='<div class="confirm-note">‚ö†Ô∏è '+t('sub_change_note')+'</div>';
        } else {
            note='<div class="confirm-note">‚ö†Ô∏è '+t('sub_renew_note')+'</div>';
        }
    }
    const h='<h3>'+t('confirm')+'</h3>'+
        '<div class="confirm-info">'+
            '<div class="confirm-row"><span class="c-label">'+t('tariff')+':</span><span class="c-value" style="color:var(--green)">'+planName+'</span></div>'+
            '<div class="confirm-row"><span class="c-label">'+t('period')+':</span><span class="c-value">'+fmtDaysFull(days)+'</span></div>'+
            '<div class="confirm-row"><span class="c-label">'+t('cost')+':</span><span class="c-value" style="color:var(--cyan)">'+price+' '+sym+'</span></div>'+
            '<div style="border-top:1px solid rgba(255,255,255,.06);margin:8px 0"></div>'+
            '<div class="confirm-row"><span class="c-label">'+t('payment_method')+':</span><span class="c-value">'+pmLabel+'</span></div>'+
        '</div>'+
        note+
        '<div class="renew-pay-actions">'+
            '<button class="btn-confirm-pay" onclick="closeConfirmOverlay();doPayment('+planId+','+days+','+price+',\''+payMethod+'\')">'+ t('confirm') +'</button>'+
            '<button class="btn btn-cancel" onclick="closeConfirmOverlay()">'+t('cancel')+'</button>'+
        '</div>';
    $('modal-root').insertAdjacentHTML('beforeend',
        '<div class="modal-overlay confirm-overlay" onclick="if(event.target===this)closeConfirmOverlay()" style="z-index:510">'+
        '<div class="modal-card modal-renew">'+h+'</div></div>'
    );
}
function closeConfirmOverlay(){const o=$('modal-root').querySelector('.confirm-overlay');if(o)o.remove()}
function doPayment(planId,days,price,method){
    if(!method)method='balance';
    if(method==='balance') return confirmPurchase(planId,days,price);
    payViaGateway(planId,days,method);
}
let _payPollTimer=null;
async function payViaGateway(planId,days,gwType){
    showModal('<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="margin-top:12px;color:var(--text2)">'+t('processing')+'</p></div>');
    try{
        const r=await fetch(API+'/api/purchase',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan_id:planId,duration_days:days,gateway:gwType})});
        closeModal();
        if(r.ok){
            const j=await r.json();
            if(j.payment_url){
                openLink(j.payment_url);
                _showPayWaiting(planId,days,gwType,j.payment_url);
            } else {
                toast(t('sub_done')+' ‚úÖ');
                const dr=await fetch(API+'/api/user/data');if(dr.ok){D=await dr.json();render()}
            }
        } else {
            try{const j=await r.json();toast(j.detail||t('purchase_error'),'error')}
            catch(e2){toast(t('purchase_error')+' ('+r.status+')','error')}
        }
    }catch(e){closeModal();toast(e.message||t('net_error'),'error')}
}
function _showPayWaiting(planId,days,gwType,payUrl){
    const plan=D.plans.find(p=>p.id===planId);
    const planName=plan?esc(plan.name):'‚Äî';
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ';
    const sel=planSel[planId];
    const amount=sel?_fmtPr(sel.price):'‚Äî';
    const gwLabel=(GW_ICONS[gwType]||'üí≥')+' '+(GW_LABELS[gwType]||gwType);
    showModal(
        '<div style="text-align:center;padding:16px 0">'+
            '<div class="spinner" style="margin:0 auto"></div>'+
            '<h3 style="margin-top:16px;color:var(--gold)">'+t('waiting_payment')+'</h3>'+
            '<p style="color:var(--text3);font-size:.82rem;margin-top:6px">'+t('waiting_payment_hint')+'</p>'+
            '<div class="confirm-info" style="margin-top:16px;text-align:left">'+
                '<div class="confirm-row"><span class="c-label">'+t('tariff')+':</span><span class="c-value" style="color:var(--green)">'+planName+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('period')+':</span><span class="c-value">'+fmtDaysFull(days)+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('cost')+':</span><span class="c-value" style="color:var(--cyan)">'+amount+' '+sym+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('payment_method')+':</span><span class="c-value">'+gwLabel+'</span></div>'+
            '</div>'+
            '<div style="margin-top:18px;display:flex;flex-direction:column;gap:8px">'+
                '<button class="btn btn-primary btn-full" onclick="openLink(\''+esc(payUrl)+'\')">'+t('pay_btn')+'</button>'+
                '<button class="btn btn-secondary btn-full" onclick="_cancelPayWaiting()">'+t('cancel')+'</button>'+
            '</div>'+
        '</div>',
        'modal-renew'
    );
    // Start polling for payment completion
    if(_payPollTimer)clearInterval(_payPollTimer);
    const oldSubStatus=D.subscription?D.subscription.status:null;
    const oldSubExpire=D.subscription?D.subscription.expire_date:null;
    _payPollTimer=setInterval(async()=>{
        try{
            const dr=await fetch(API+'/api/user/data');
            if(!dr.ok)return;
            const newD=await dr.json();
            const newSub=newD.subscription;
            const changed=newSub&&(newSub.status==='ACTIVE')&&(oldSubStatus!=='ACTIVE'||newSub.expire_date!==oldSubExpire);
            if(changed){
                clearInterval(_payPollTimer);_payPollTimer=null;
                D=newD;render();
                closeModal();
                _showPaySuccess(planName,days,amount+' '+sym,gwLabel);
            }
        }catch(e){}
    },4000);
}
function _cancelPayWaiting(){
    if(_payPollTimer){clearInterval(_payPollTimer);_payPollTimer=null}
    closeModal();
}
function _showPaySuccess(planName,period,cost,method){
    showModal(
        '<div style="text-align:center;padding:16px 0">'+
            '<div style="font-size:3.5rem">‚úÖ</div>'+
            '<h3 style="margin-top:12px;color:var(--green)">'+t('pay_success')+'</h3>'+
            '<div class="confirm-info" style="margin-top:16px;text-align:left">'+
                '<div class="confirm-row"><span class="c-label">'+t('tariff')+':</span><span class="c-value" style="color:var(--green)">'+planName+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('period')+':</span><span class="c-value">'+period+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('cost')+':</span><span class="c-value" style="color:var(--cyan)">'+cost+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('payment_method')+':</span><span class="c-value">'+method+'</span></div>'+
            '</div>'+
            '<button class="btn btn-primary btn-full" style="margin-top:18px" onclick="closeModal()">'+t('done')+'</button>'+
        '</div>',
        'modal-renew'
    );
}

function findPrice(dur,currency){
    const p=(dur.prices||[]).find(x=>x.currency===currency);
    return p?parseFloat(p.amount):null;
}
function fmtDays(d){
    if(d<=0)return '‚àû';
    const l=CUR_LOCALE;
    if(l==='EN'){if(d===1)return '1 day';if(d===7)return '7 days';if(d===30)return '1 mo.';if(d===60)return '2 mo.';if(d===90)return '3 mo.';if(d===180)return '6 mo.';if(d===365)return '1 year';return d+' d.'}
    if(l==='UK'){if(d===1)return '1 –¥–µ–Ω—å';if(d===7)return '7 –¥–Ω—ñ–≤';if(d===30)return '1 –º—ñ—Å.';if(d===60)return '2 –º—ñ—Å.';if(d===90)return '3 –º—ñ—Å.';if(d===180)return '6 –º—ñ—Å.';if(d===365)return '1 —Ä—ñ–∫';return d+' –¥–Ω.'}
    if(l==='DE'){if(d===1)return '1 Tag';if(d===7)return '7 Tage';if(d===30)return '1 Mon.';if(d===60)return '2 Mon.';if(d===90)return '3 Mon.';if(d===180)return '6 Mon.';if(d===365)return '1 Jahr';return d+' T.'}
    if(d===1)return '1 –¥–µ–Ω—å';if(d===7)return '7 –¥–Ω–µ–π';if(d===30)return '1 –º–µ—Å.';if(d===60)return '2 –º–µ—Å.';if(d===90)return '3 –º–µ—Å.';if(d===180)return '6 –º–µ—Å.';if(d===365)return '1 –≥–æ–¥';return d+' –¥–Ω.';
}
function fmtDaysFull(d){
    if(d<=0)return '‚àû';
    const l=CUR_LOCALE;
    if(l==='EN'){if(d===1)return '1 day';if(d===7)return '7 days';if(d===30)return '1 month';if(d===60)return '2 months';if(d===90)return '3 months';if(d===180)return '6 months';if(d===365)return '1 year';return d+' days'}
    if(l==='UK'){if(d===1)return '1 –¥–µ–Ω—å';if(d===7)return '7 –¥–Ω—ñ–≤';if(d===30)return '1 –º—ñ—Å—è—Ü—å';if(d===60)return '2 –º—ñ—Å—è—Ü—ñ';if(d===90)return '3 –º—ñ—Å—è—Ü—ñ';if(d===180)return '6 –º—ñ—Å—è—Ü—ñ–≤';if(d===365)return '1 —Ä—ñ–∫';return d+' –¥–Ω—ñ–≤'}
    if(l==='DE'){if(d===1)return '1 Tag';if(d===7)return '7 Tage';if(d===30)return '1 Monat';if(d===60)return '2 Monate';if(d===90)return '3 Monate';if(d===180)return '6 Monate';if(d===365)return '1 Jahr';return d+' Tage'}
    if(d===1)return '1 –¥–µ–Ω—å';if(d===7)return '7 –¥–Ω–µ–π';if(d===30)return '1 –º–µ—Å—è—Ü';if(d===60)return '2 –º–µ—Å—è—Ü–∞';if(d===90)return '3 –º–µ—Å—è—Ü–∞';if(d===180)return '6 –º–µ—Å—è—Ü–µ–≤';if(d===365)return '1 –≥–æ–¥';return d+' '+pluralDays(d);
}

function renderConnect(){
    const s=D.subscription;
    $('con-url').textContent=(s&&s.url)?s.url:t('no_active_sub');
    // Download button ‚Äî always same label
    $('btn-download-label').textContent=t('download_app');
    if(s&&s.url&&DOMAIN){
        $('con-actions').style.display='';
        $('btn-oneclick').onclick=()=>openLink('https://'+DOMAIN+'/api/v1/connect/'+s.url);
        $('btn-subpage').onclick=()=>openLink(s.url);
        $('btn-subpage').style.display='';
        $('btn-qr').style.display='';
        $('btn-show-sub').style.display='';
    } else {
        $('con-actions').style.display='';
        $('btn-subpage').style.display='none';
        $('btn-qr').style.display='none';
        $('btn-show-sub').style.display='none';
    }
    const dl=D.subscription&&D.subscription.device_limit;
    $('dev-limit').textContent=dl||'‚Äî';
    $('dev-used').textContent='‚Äî';
}
function toggleSubLink(){
    const det=$('con-sub-detail');
    const btn=$('btn-show-sub');
    if(det.style.display==='none'){
        det.style.display='';
        btn.innerHTML='üîë&nbsp;'+t('hide_sub');
    } else {
        det.style.display='none';
        btn.innerHTML='üîë&nbsp;'+t('show_sub');
    }
}

function copyValue(el){
    const v=el.textContent;
    navigator.clipboard.writeText(v).then(()=>toast(t('copied'))).catch(()=>toast(t('error'),'error'));
}
function copySubInfo(el){
    const v=(el.textContent||'').trim();
    if(!v||v==='‚Äî') return;
    navigator.clipboard.writeText(v).then(()=>{
        const t2=$('toast');t2.textContent=t('copied');
        t2.className='toast toast-center visible';
        clearTimeout(t2._t);t2._t=setTimeout(()=>{t2.className='toast';},2500);
    }).catch(()=>{});
}
function renderProfile(){
    const u=D.user, sym=CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ';
    $('pr-name').textContent=u.name||'‚Äî';
    $('pr-tid').textContent=u.telegram_id;
    // Referral code from database
    if(D.features&&D.features.referral_enabled!==false && u.referral_code){
        $('pr-refcode-row').style.display='';
        $('pr-refcode').textContent=u.referral_code;
    }
    // Balance section
    $('pr-balance').textContent=u.balance+' '+sym;
    const bm=D.features&&D.features.balance_mode;
    const rb=u.referral_balance||0;
    if(bm==='SEPARATE'){
        $('pr-bonus-item').style.display='';
        $('pr-bonus').textContent=rb+' '+sym;
        $('btn-get-bonus').style.display='';
    } else {
        $('pr-bonus-item').style.display='none';
        $('btn-get-bonus').style.display='none';
    }
    if(D.features&&D.features.balance_enabled!==false) $('balance-card').style.display='';
    // Web credentials section
    loadWebCredStatus();
    // Referral section
    if(D.features&&D.features.referral_enabled!==false){
        $('ref-card').style.display='';
        $('ref-link').textContent=D.ref_link||'–ë–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
        // Referral stats
        const rs=D.referral_stats||{};
        const statsEl=$('ref-stats');
        statsEl.innerHTML=
            '<div class="ref-stat-item"><div class="ref-stat-value">'+(rs.invited_count||0)+'</div><div class="ref-stat-label">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div></div>'+
            '<div class="ref-stat-item"><div class="ref-stat-value">'+(rs.payments_count||0)+'</div><div class="ref-stat-label">–û–ø–ª–∞—Ç</div></div>'+
            '<div class="ref-stat-item"><div class="ref-stat-value">'+(rs.total_bonus||0)+' '+sym+'</div><div class="ref-stat-label">–ù–∞—á–∏—Å–ª–µ–Ω–æ</div></div>';
    }
}
async function loadWebCredStatus(){
    try{
        const r=await fetch(API+'/api/auth/check',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({telegram_id:D.user.telegram_id})});
        const d=await r.json();
        const el=$('web-cred-status');
        if(d.has_credentials){
            el.innerHTML='<div class="card-row"><span class="card-label">–°—Ç–∞—Ç—É—Å</span><span class="card-value" style="color:var(--green)">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ‚úì</span></div>';
            $('web-cred-setup').style.display='none';
            $('web-cred-detail').style.display='';
            $('wc-disp-login').textContent=d.web_username||'‚Äî';
            $('wc-change-section').style.display='none';
            // spoiler arrow toggle
            const sp=$('wc-spoiler');
            if(sp){sp.removeAttribute('open')}
        } else {
            el.innerHTML='<div class="card-row"><span class="card-label">–°—Ç–∞—Ç—É—Å</span><span class="card-value" style="color:var(--text3)">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span></div>';
            $('web-cred-setup').style.display='';
            $('web-cred-detail').style.display='none';
        }
    }catch(e){}
}

function showChangePass(){
    $('wc-change-section').style.display='';
    $('wc-old-pass').value='';$('wc-new-pass').value='';$('wc-new-pass2').value='';
}
function cancelWebCredChange(){
    $('wc-change-section').style.display='none';
    const sp=$('wc-spoiler');if(sp)sp.removeAttribute('open');
}
async function applyWebCredChange(){
    const chSec=$('wc-change-section');
    if(chSec.style.display!=='none'){
        const op=$('wc-old-pass').value,np=$('wc-new-pass').value,np2=$('wc-new-pass2').value;
        if(!op)return toast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å','error');
        if(!np||np.length<6)return toast('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤','error');
        if(np!==np2)return toast('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç','error');
        try{
            const r=await fetch(API+'/api/user/credentials/password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({old_password:op,new_password:np})});
            if(r.ok){toast('–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω');$('wc-change-section').style.display='none'}
            else{const d=await r.json();toast(d.detail||'–û—à–∏–±–∫–∞','error')}
        }catch(e){toast('–û—à–∏–±–∫–∞','error')}
    } else {
        const sp=$('wc-spoiler');if(sp)sp.removeAttribute('open');
    }
}
async function saveWebCredentials(){
    const un=$('wc-username').value.trim(),pw=$('wc-password').value,pw2=$('wc-password2').value;
    if(!un||un.length<3)return toast('–õ–æ–≥–∏–Ω –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞','error');
    if(!pw||pw.length<6)return toast('–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤','error');
    if(pw!==pw2)return toast('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç','error');
    try{
        const r=await fetch(API+'/api/user/credentials',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({web_username:un,password:pw})});
        if(r.ok){toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');loadWebCredStatus()}
        else{const d=await r.json();toast(d.detail||'–û—à–∏–±–∫–∞','error')}
    }catch(e){toast('–û—à–∏–±–∫–∞','error')}
}
function showBonusInfo(){
    const refLink=D.ref_link;
    if(!refLink){toast('–ë–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω','error');return}
    showModal('<h3>–ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å</h3>'+
        '<p style="color:var(--text2);font-size:.84rem;margin-bottom:12px">–ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π —á–µ—Ä–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É.</p>'+
        '<div class="ref-box" style="margin-bottom:12px"><code>'+esc(refLink)+'</code></div>'+
        '<div class="modal-actions" style="flex-direction:column;gap:8px">'+
        '<button class="btn btn-primary btn-full" onclick="closeModal();inviteFriend()">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>'+
        '<button class="btn btn-secondary btn-full" onclick="closeModal()">'+t('close')+'</button></div>');
}
function inviteFriend(){
    const refLink=D.ref_link;
    if(!refLink){toast(t('error'),'error');return}
    // Prefer settingsCache (admin may have updated), fall back to D.features
    let template=(settingsCache&&settingsCache.referral_invite_message!=null)?settingsCache.referral_invite_message:((D.features&&D.features.referral_invite_message)||'');
    let msg='';
    if(template){
        msg=template.replace(/\{space\}/g,'\n').replace(/\{url\}/g,refLink).replace(/\{name\}/g,BRAND.name||DEFAULT_NAME);
        if(msg.startsWith('\n'))msg=msg.substring(1);
    }
    let shareUrl;
    if(msg&&msg.indexOf(refLink)!==-1){
        // Message already contains the link ‚Äî use text-only mode  
        shareUrl='https://t.me/share/url?text='+encodeURIComponent(msg);
    } else if(msg){
        // Message without link ‚Äî put refLink as url param for link preview
        shareUrl='https://t.me/share/url?url='+encodeURIComponent(refLink)+'&text='+encodeURIComponent(msg);
    } else {
        // No custom message ‚Äî share link with brand name
        shareUrl='https://t.me/share/url?url='+encodeURIComponent(refLink)+'&text='+encodeURIComponent(BRAND.name||DEFAULT_NAME);
    }
    try{
        if(tg.initData&&typeof tg.openTelegramLink==='function'){
            tg.openTelegramLink(shareUrl);
        } else {
            window.open(shareUrl,'_blank');
        }
    }catch(e){window.open(shareUrl,'_blank')}
}

function renderSupport(){
    if(D.features){
        if(D.features.community_enabled&&D.features.community_url){
            $('support-community').style.display='';
            $('btn-community').onclick=()=>openLink(D.features.community_url);
        }
        if(D.features.tos_enabled){
            $('support-tos').style.display='';
            $('btn-tos').onclick=()=>openLink(D.features.tos_url||'');
        }
    }
    if(D.support_url){
        $('support-help').style.display='';
        $('btn-support').onclick=()=>openLink(D.support_url);
    }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   USER ACTIONS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openPayment(){
    if(!D.plans||!D.plans.length) return toast(t('no_plans'),'error');
    go('plans');
}
function renewCurrentPlan(){
    const s=D.subscription;
    if(!s) return go('plans');
    const planId=s.plan_id||(s.plan&&s.plan.id);
    const plan=D.plans.find(p=>p.id===planId)||
               (s.plan_name?D.plans.find(p=>p.name===s.plan_name):null);
    if(!plan) return go('plans');
    go('renew');
    renderRenewPage(plan);
}
function renderRenewPage(plan){
    const dc=D.default_currency||'RUB',sym=CURRENCY_SYMBOLS[dc]||'‚ÇΩ';
    let trafficText;
    if(plan.type==='DEVICES') trafficText='–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π';
    else trafficText=(plan.traffic_limit||'‚àû')+' GB';
    const devicesText=(plan.device_limit||'‚àû')+' '+t('dev_short');
    const gridHtml=_renderDurGrid(plan,plan.id);
    const pmBar=_renderPmBar(plan.id);
    const payBtn=_renderPayBtn(plan.id);
    $('renew-plan-view').innerHTML=
        '<div class="card plan-card-new open" data-plan-id="'+plan.id+'">'+
            '<div class="plan-card-header">'+
                '<div class="plan-card-name">'+esc(plan.name)+'</div>'+
            '</div>'+
            '<div class="plan-card-meta"><span>üì¶ '+trafficText+'</span><span>üì± '+devicesText+'</span></div>'+
            '<div class="plan-card-body" style="max-height:none;opacity:1;margin-top:12px">'+
                '<div class="plan-dur-grid">'+gridHtml+'</div>'+
                pmBar+payBtn+
            '</div>'+
        '</div>';
}
function selectPlan(id){
    /* Legacy ‚Äî now handled by renderPlans grid inline */
    go('plans');
}
async function confirmPurchase(planId,days,price){
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ';
    if(D.user.balance<price){
        closeModal();
        return toast(t('not_enough')+' '+D.user.balance+' '+sym,'error');
    }
    closeModal();
    showModal('<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="margin-top:12px;color:var(--text2)">'+t('processing')+'</p></div>');
    try{
        const r=await fetch(API+'/api/purchase',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan_id:planId,duration_days:days})});
        closeModal();
        if(r.ok){
            toast(t('sub_done')+' ‚úÖ');
            const dr=await fetch(API+'/api/user/data');if(dr.ok){D=await dr.json();render()}
        } else {
            try{const j=await r.json();toast(j.detail||t('purchase_error'),'error')}
            catch(e2){toast(t('purchase_error')+' ('+r.status+')','error')}
        }
    }catch(e){closeModal();toast(e.message||t('net_error'),'error')}
}
async function startTrial(){
    showModal('<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="margin-top:12px;color:var(--text2)">'+t('trial_activating')+'</p></div>');
    try{
        const r=await fetch(API+'/api/trial/activate',{method:'POST'});
        closeModal();
        if(r.ok){
            toast(t('trial_done')+' ‚úÖ','success');
            showModal('<div style="text-align:center;padding:30px"><div style="font-size:3rem">‚úÖ</div><h3 style="margin-top:12px;color:var(--green)">'+t('trial_done')+'</h3><p style="color:var(--text2);font-size:.84rem;margin-top:8px">'+t('trial_go_connect')+'</p><div class="modal-actions" style="flex-direction:column;gap:8px;margin-top:14px"><button class="btn btn-primary btn-full" onclick="closeModal();openLink(getDownloadUrl())">üì• '+t('download')+'</button><button class="btn btn-primary btn-full" style="background:linear-gradient(135deg,var(--cyan),#1AA3CC)" onclick="closeModal();go(\'connect\')">‚äô '+t('connect')+'</button><button class="btn btn-secondary btn-full" onclick="closeModal()">'+t('close')+'</button></div></div>');
            const dr=await fetch(API+'/api/user/data');if(dr.ok){D=await dr.json();render()}
        } else {
            const j=await r.json();toast(j.detail||t('error'),'error');
        }
    }catch(e){closeModal();toast(t('net_error'),'error')}
}
function expandDevices(){
    if(D.subscription&&D.subscription.is_trial){
        showModal('<div style="text-align:center;padding:30px"><div style="font-size:3rem">‚ö†Ô∏è</div><h3 style="margin-top:12px;color:var(--gold)">'+t('expand_unavail')+'</h3><p style="color:var(--text2);font-size:.84rem;margin-top:8px">'+t('expand_trial_msg')+'</p><div class="modal-actions"><button class="btn btn-primary" onclick="closeModal();buySubscription()">'+t('buy_plan')+'</button><button class="btn btn-secondary" onclick="closeModal()">'+t('close')+'</button></div></div>');
        return;
    }
    toast(t('expand_via_bot'));
}
function openLink(u){if(u){if(tg.initData)tg.openLink(u);else window.open(u,'_blank')}}
async function webLogout(){try{await fetch(API+'/api/auth/logout',{method:'POST'})}catch(e){}window.location.href='/web/login'}
function copyUrl(){
    const s=D.subscription;
    if(s&&s.url)navigator.clipboard.writeText(s.url).then(()=>toast(t('copied'))).catch(()=>toast(t('error'),'error'));
    else toast(t('no_sub_err'),'error');
}
function copyRef(){
    const rl=$('ref-link').textContent;
    navigator.clipboard.writeText(rl).then(()=>toast(t('link_copied'))).catch(()=>toast(t('error'),'error'));
}
function topupBalance(){
    const gateways=D.available_gateways||[];
    if(!gateways.length){toast(t('topup_via_bot'));return}
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ';
    let gwOpts=gateways.map(gw=>{
        const label=GW_LABELS[gw.type]||gw.type;
        const icon=GW_ICONS[gw.type]||'üí≥';
        return '<option value="'+gw.type+'">'+icon+' '+label+'</option>';
    }).join('');
    showModal('<h3>'+t('topup')+'</h3>'+
        '<div class="form-group"><label>'+t('topup_amount')+' ('+sym+')</label><input class="form-input" id="topup-amt" type="number" placeholder="100" min="1"></div>'+
        '<div class="form-group"><label>'+t('payment_method')+'</label><select class="pay-method-select" id="topup-gw">'+gwOpts+'</select></div>'+
        '<div class="modal-actions" style="gap:8px">'+
            '<button class="btn-confirm-pay" onclick="doTopup()">'+t('topup')+'</button>'+
            '<button class="btn btn-cancel" onclick="closeModal()">'+t('cancel')+'</button>'+
        '</div>');
}
async function doTopup(){
    const amt=parseInt($('topup-amt').value);
    const gw=$('topup-gw').value;
    if(!amt||amt<=0)return toast(t('enter_amount'),'error');
    closeModal();
    showModal('<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="margin-top:12px;color:var(--text2)">'+t('processing')+'</p></div>');
    try{
        const r=await fetch(API+'/api/topup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:amt,gateway:gw})});
        closeModal();
        if(r.ok){
            const j=await r.json();
            if(j.payment_url)openLink(j.payment_url);
            else toast(t('pay_created')+' ‚úÖ');
        } else {
            const j=await r.json();toast(j.detail||t('error'),'error');
        }
    }catch(e){closeModal();toast(t('net_error'),'error')}
}
async function activatePromo(){
    const code=$('promo-input').value.trim();if(!code)return;
    const r=$('promo-result');
    try{
        const res=await fetch(API+'/api/promocode/activate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
        const d=await res.json();r.style.display='block';
        if(res.ok){r.style.color='var(--green)';r.textContent=d.message||t('promo_activated')}
        else{r.style.color='var(--red)';r.textContent=d.detail||t('error')}
    }catch(e){r.style.display='block';r.style.color='var(--red)';r.textContent=t('net_error')}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ADMIN
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function admTab(t){
    curAdmTab=t;
    document.querySelectorAll('#adm-tabs .admin-tab').forEach((b,i)=>b.classList.toggle('active',['stats','users','plans','settings','tickets','brand'][i]===t));
    document.querySelectorAll('.admin-content').forEach(c=>c.classList.remove('active'));
    const el=$('adm-'+t);if(el)el.classList.add('active');
    loadAdm(t);
}
async function loadAdm(t){
    if(t==='stats')await loadStats();
    if(t==='users')await loadUsers();
    if(t==='plans')await loadAdmPlans();
    if(t==='settings')await loadSettings();
    if(t==='tickets')await loadAdmTickets();
    if(t==='brand')loadBrandForm();
}
async function loadStats(){
    try{const r=await fetch(API+'/api/admin/stats');if(!r.ok)return;const d=await r.json();
    $('st-total').textContent=d.total_users||0;$('st-active').textContent=d.active_subscriptions||0;
    $('st-expired').textContent=d.expired_subscriptions||0;$('st-revenue').textContent=(d.total_revenue||0)}catch(e){}
}
async function loadUsers(){
    try{const r=await fetch(API+'/api/admin/users');if(!r.ok)return;usersCache=await r.json();drawUsers(usersCache)}catch(e){}
}
function filterUsers(){
    const q=$('user-search').value.toLowerCase().trim();
    if(!q)return drawUsers(usersCache);
    drawUsers(usersCache.filter(u=>(u.name||'').toLowerCase().includes(q)||String(u.telegram_id).includes(q)||(u.username||'').toLowerCase().includes(q)));
}
function drawUsers(list){
    const el=$('users-list');
    if(!list.length){el.innerHTML='<div class="empty-state">–ü—É—Å—Ç–æ</div>';return}
    el.innerHTML=list.slice(0,50).map(u=>{
        const ini=(u.name||'?')[0].toUpperCase();
        const rc=u.role==='DEV'?'role-dev':u.role==='ADMIN'?'role-admin':'role-user';
        const rn=u.role==='DEV'?'DEV':u.role==='ADMIN'?'ADM':'USER';
        return '<div class="user-item" onclick="openUser('+u.telegram_id+')"><div class="user-item-info"><div class="user-avatar">'+esc(ini)+'</div><div><div class="user-name">'+esc(u.name||'‚Äî')+'</div><div class="user-sub">ID: '+u.telegram_id+'</div></div></div><span class="role-badge '+rc+'">'+rn+'</span></div>';
    }).join('');
}
async function openUser(tid){
    go('auser');$('aud-title').textContent=t('loading');$('aud-body').innerHTML='<div style="text-align:center;padding:40px"><div class="spinner"></div></div>';
    try{
        const r=await fetch(API+'/api/admin/users/'+tid);if(!r.ok){$('aud-body').innerHTML='<div class="empty-state">–û—à–∏–±–∫–∞</div>';return}
        const u=await r.json();$('aud-title').textContent=u.name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';drawUserDetail(u);
    }catch(e){$('aud-body').innerHTML='<div class="empty-state">'+e.message+'</div>'}
}
function drawUserDetail(u){
    const rm={USER:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',ADMIN:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',DEV:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫'};
    const si=u.subscription?'<div class="card-row"><span class="card-label">–ü–æ–¥–ø–∏—Å–∫–∞</span><span class="card-value">'+(u.subscription.plan_name||'‚Äî')+'</span></div><div class="card-row"><span class="card-label">–°—Ç–∞—Ç—É—Å</span><span class="card-value">'+u.subscription.status+'</span></div><div class="card-row"><span class="card-label">–ò—Å—Ç–µ–∫–∞–µ—Ç</span><span class="card-value">'+(u.subscription.expire_at||'‚Äî')+'</span></div>':'<div class="card-row"><span class="card-label">–ü–æ–¥–ø–∏—Å–∫–∞</span><span class="card-value" style="color:var(--text3)">–ù–µ—Ç</span></div>';
    $('aud-body').innerHTML='<div class="card"><div class="card-row"><span class="card-label">–ò–º—è</span><span class="card-value">'+esc(u.name||'‚Äî')+'</span></div><div class="card-row"><span class="card-label">Username</span><span class="card-value">'+(u.username?'@'+esc(u.username):'‚Äî')+'</span></div><div class="card-row"><span class="card-label">ID</span><span class="card-value">'+u.telegram_id+'</span></div><div class="card-row"><span class="card-label">–ë–∞–ª–∞–Ω—Å</span><span class="card-value">'+u.balance+' ‚ÇΩ</span></div><div class="card-row"><span class="card-label">–†–æ–ª—å</span><span class="card-value">'+(rm[u.role]||u.role)+'</span></div><div class="card-row"><span class="card-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span><span class="card-value">'+(u.is_blocked?'–î–∞':'–ù–µ—Ç')+'</span></div>'+si+'</div><div style="display:flex;flex-direction:column;gap:8px"><button class="btn btn-secondary btn-full" onclick="changeRole('+u.telegram_id+',\''+u.role+'\')">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button><button class="btn btn-secondary btn-full" onclick="changeBal('+u.telegram_id+','+u.balance+')">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button><button class="btn '+(u.is_blocked?'btn-primary':'btn-danger')+' btn-full" onclick="toggleBlock('+u.telegram_id+','+u.is_blocked+')">'+(u.is_blocked?'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å')+'</button></div>';
}
function changeRole(tid,cur){
    const roles=['USER','ADMIN','DEV'],names=['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å','–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä','–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫'];
    showModal('<h3>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</h3>'+roles.map((r,i)=>'<button class="btn '+(r===cur?'btn-primary':'btn-secondary')+' btn-full" style="margin-top:6px" onclick="setRole('+tid+',\''+r+'\')">'+names[i]+'</button>').join('')+'<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>');
}
async function setRole(tid,role){closeModal();try{const r=await fetch(API+'/api/admin/users/'+tid+'/role',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role})});if(r.ok){toast('–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞');openUser(tid)}else{const d=await r.json();toast(d.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}
let balType='basic';
function changeBal(tid,cur){
    balType='basic';
    showModal('<h3>–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3><p style="color:var(--text2);font-size:.84rem;margin-bottom:10px">–¢–µ–∫—É—â–∏–π: '+cur+' ‚ÇΩ</p>'+
        '<div class="form-group"><label>–¢–∏–ø –±–∞–ª–∞–Ω—Å–∞</label><div style="display:flex;gap:6px;margin-top:4px"><button class="btn btn-primary btn-sm" id="bal-type-basic" onclick="switchBalType(\'basic\')">–û—Å–Ω–æ–≤–Ω–æ–π</button><button class="btn btn-secondary btn-sm" id="bal-type-bonus" onclick="switchBalType(\'bonus\')">–ë–æ–Ω—É—Å–Ω—ã–π</button></div></div>'+
        '<div class="form-group"><label>–°—É–º–º–∞ (+/-)</label><input class="form-input" id="bal-amt" type="number" placeholder="100"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="setBal('+tid+')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>');
}
function switchBalType(t){
    balType=t;
    const bb=$('bal-type-basic'),bn=$('bal-type-bonus');
    if(t==='basic'){bb.className='btn btn-primary btn-sm';bn.className='btn btn-secondary btn-sm'}
    else{bb.className='btn btn-secondary btn-sm';bn.className='btn btn-primary btn-sm'}
}
async function setBal(tid){const a=parseFloat($('bal-amt').value);if(isNaN(a))return toast('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ','error');closeModal();
    const endpoint=balType==='bonus'?'/bonus-balance':'/balance';
    try{const r=await fetch(API+'/api/admin/users/'+tid+endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:a})});if(r.ok){toast((balType==='bonus'?'–ë–æ–Ω—É—Å–Ω—ã–π –±':'–ë')+'–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω—ë–Ω');openUser(tid)}else{const d=await r.json();toast(d.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}
async function toggleBlock(tid,blocked){try{const r=await fetch(API+'/api/admin/users/'+tid+'/block',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({block:!blocked})});if(r.ok){toast(blocked?'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');openUser(tid)}else{const d=await r.json();toast(d.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}

/* ‚îÄ‚îÄ Admin Plans (enhanced) ‚îÄ‚îÄ */
let admPlansCache=[];
async function loadAdmPlans(){
    try{const r=await fetch(API+'/api/admin/plans');if(!r.ok)return;admPlansCache=await r.json();
    $('adm-plans-count').textContent='–¢–∞—Ä–∏—Ñ—ã ('+admPlansCache.length+')';
    drawAdmPlans()}catch(e){}
}
function drawAdmPlans(){
    const el=$('adm-plans-list');
    if(!admPlansCache.length){el.innerHTML='<div class="empty-state">–ù–µ—Ç —Ç–∞—Ä–∏—Ñ–æ–≤</div>';return}
    el.innerHTML=admPlansCache.map(p=>{
        const avl=AVAIL_LABELS[p.availability]||p.availability;
        const isTrial=p.availability==='TRIAL';
        return '<div class="plan-admin-card'+(p.is_active?'':' inactive')+'" onclick="editPlan('+p.id+')">'+
            '<div class="plan-admin-top">'+
                '<span class="plan-admin-name">'+esc(p.name)+'</span>'+
                (p.tag?'<span class="plan-admin-tag">'+esc(p.tag)+'</span>':'')+
                '<span class="avail-badge'+(isTrial?' trial':'')+'">'+avl+'</span>'+
                '<div class="plan-admin-actions" onclick="event.stopPropagation()">'+
                    '<button class="btn-toggle-plan'+(p.is_active?' active':'')+'" onclick="togglePlan('+p.id+',this)" title="'+(p.is_active?'–í—ã–∫–ª—é—á–∏—Ç—å':'–í–∫–ª—é—á–∏—Ç—å')+'"></button>'+
                    '<button class="btn-trash" onclick="delPlan('+p.id+')" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>'+
                '</div>'+
            '</div>'+
            '<div class="plan-admin-meta">'+
                '<span>üì¶ '+(p.traffic_limit||'‚àû')+' GB</span>'+
                '<span>üì± '+(p.device_limit||'‚àû')+' —É—Å—Ç—Ä.</span>'+
                '<span>‚è± '+(p.durations||[]).length+' –ø–µ—Ä–∏–æ–¥(–æ–≤)</span>'+
            '</div>'+
        '</div>';
    }).join('');
}
async function togglePlan(id,btn){
    try{const r=await fetch(API+'/api/admin/plans/'+id+'/toggle',{method:'PATCH'});
    if(r.ok){const d=await r.json();btn.classList.toggle('active',d.is_active);
    // Update cache
    const p=admPlansCache.find(x=>x.id===id);if(p)p.is_active=d.is_active;
    btn.closest('.plan-admin-card').classList.toggle('inactive',!d.is_active);
    toast(d.is_active?'–í–∫–ª—é—á—ë–Ω':'–í—ã–∫–ª—é—á–µ–Ω')}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}
async function delPlan(id){if(!confirm(t('delete_plan_q')))return;try{const r=await fetch(API+'/api/admin/plans/'+id,{method:'DELETE'});if(r.ok){toast(t('deleted'));loadAdmPlans()}else{const j=await r.json();toast(j.detail||t('error'),'error')}}catch(e){toast(t('error'),'error')}}

/* ‚îÄ‚îÄ Plan Create / Edit Modal ‚îÄ‚îÄ */
let editingPlanId=null;
function showCreatePlan(){editingPlanId=null;showPlanModal({name:'',description:'',tag:'',availability:'ALL',type:'BOTH',traffic_limit:100,device_limit:1,durations:[{days:30,prices:[{currency:D.default_currency||'RUB',amount:'0'}]}]},'–°–æ–∑–¥–∞—Ç—å —Ç–∞—Ä–∏—Ñ')}
function editPlan(id){
    const p=admPlansCache.find(x=>x.id===id);if(!p)return;
    editingPlanId=id;
    showPlanModal(p,'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞—Ä–∏—Ñ');
}
function showPlanModal(p,title){
    const dc=D.default_currency||'RUB';
    const durs=(p.durations||[]).map((d,i)=>{
        const pr=(d.prices||[]).find(x=>x.currency===dc);
        const amt=pr?pr.amount:'0';
        return durEntryHtml(i,d.days,amt);
    }).join('');
    const availOpts=Object.entries(AVAIL_LABELS).map(([k,v])=>'<option value="'+k+'"'+(p.availability===k?' selected':'')+'>'+v+'</option>').join('');
    const typeOpts=Object.entries(TYPE_LABELS).map(([k,v])=>'<option value="'+k+'"'+(p.type===k?' selected':'')+'>'+v+'</option>').join('');
    showModal(
        '<h3>'+title+'</h3>'+
        '<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="form-input" id="np-name" value="'+esc(p.name)+'" placeholder="–ë–∞–∑–æ–≤—ã–π"></div>'+
        '<div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input class="form-input" id="np-desc" value="'+esc(p.description||'')+'" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞"></div>'+
        '<div class="form-row"><div class="form-group"><label>–¢–µ–≥</label><input class="form-input" id="np-tag" value="'+esc(p.tag||'')+'" placeholder="base"></div><div class="form-group"><label>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</label><select class="form-input" id="np-avail">'+availOpts+'</select></div></div>'+
        '<div class="form-row"><div class="form-group"><label>–¢–∏–ø</label><select class="form-input" id="np-type" onchange="onPlanTypeChange()">'+typeOpts+'</select></div><div class="form-group"><label>–¢—Ä–∞—Ñ–∏–∫ (GB)</label><input class="form-input" id="np-traffic" type="number" value="'+p.traffic_limit+'"></div></div>'+
        '<div class="form-group"><label>–£—Å—Ç—Ä–æ–π—Å—Ç–≤</label><input class="form-input" id="np-dev" type="number" value="'+p.device_limit+'"></div>'+
        '<div style="margin-bottom:8px"><label style="font-size:.8rem;color:var(--text3);font-weight:500">–ü–µ—Ä–∏–æ–¥—ã –∏ —Ü–µ–Ω—ã ('+(CURRENCY_SYMBOLS[dc]||dc)+')</label></div>'+
        '<div id="dur-list">'+durs+'</div>'+
        '<button class="btn btn-secondary btn-sm" onclick="addDurEntry()" style="margin-bottom:10px">+ –ü–µ—Ä–∏–æ–¥</button>'+
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">'+t('cancel')+'</button><button class="btn btn-primary" onclick="savePlan()">'+t('save')+'</button></div>'
    );
    // Apply conditional fields after modal renders
    setTimeout(()=>onPlanTypeChange(),0);
}
function onPlanTypeChange(){
    const t=$('np-type');if(!t)return;
    const v=t.value;
    const trEl=$('np-traffic'), devEl=$('np-dev');
    if(!trEl||!devEl)return;
    // TRAFFIC ‚Üí disable devices; DEVICES ‚Üí disable traffic
    if(v==='TRAFFIC'){trEl.disabled=false;devEl.disabled=true;devEl.value='0'}
    else if(v==='DEVICES'){trEl.disabled=true;trEl.value='0';devEl.disabled=false}
    else if(v==='UNLIMITED'){trEl.disabled=true;trEl.value='0';devEl.disabled=true;devEl.value='0'}
    else{trEl.disabled=false;devEl.disabled=false}
}
function durEntryHtml(i,days,amount){
    return '<div class="duration-entry" data-idx="'+i+'"><div class="duration-entry-header"><span style="font-size:.8rem;color:var(--text2);font-weight:600">–ü–µ—Ä–∏–æ–¥ #'+(i+1)+'</span><button class="dur-remove" onclick="this.closest(\'.duration-entry\').remove()">‚úï</button></div><div class="form-row"><div class="form-group"><label>–î–Ω–µ–π</label><input class="form-input dur-days" type="number" value="'+days+'" min="1"></div><div class="form-group"><label>–¶–µ–Ω–∞</label><input class="form-input dur-price" type="number" value="'+amount+'" min="0" step="0.01"></div></div></div>';
}
function addDurEntry(){
    const list=$('dur-list');
    const idx=list.querySelectorAll('.duration-entry').length;
    list.insertAdjacentHTML('beforeend',durEntryHtml(idx,30,'0'));
}
async function savePlan(){
    const name=$('np-name').value.trim();if(!name)return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','error');
    const dc=D.default_currency||'RUB';
    const durations=[];
    $('dur-list').querySelectorAll('.duration-entry').forEach(el=>{
        const days=parseInt(el.querySelector('.dur-days').value)||30;
        const price=el.querySelector('.dur-price').value||'0';
        durations.push({days,prices:[{currency:dc,amount:price}]});
    });
    const body={
        name,
        description:$('np-desc').value.trim(),
        tag:$('np-tag').value.trim(),
        availability:$('np-avail').value,
        type:$('np-type').value,
        traffic_limit:parseInt($('np-traffic').value)||100,
        device_limit:parseInt($('np-dev').value)||1,
        durations
    };
    closeModal();
    try{
        const url=editingPlanId?API+'/api/admin/plans/'+editingPlanId:API+'/api/admin/plans';
        const method=editingPlanId?'PUT':'POST';
        const r=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(r.ok){toast(editingPlanId?'–¢–∞—Ä–∏—Ñ –æ–±–Ω–æ–≤–ª—ë–Ω':'–¢–∞—Ä–∏—Ñ —Å–æ–∑–¥–∞–Ω');loadAdmPlans()}
        else{const j=await r.json();toast(j.detail||'–û—à–∏–±–∫–∞','error')}
    }catch(e){toast('–û—à–∏–±–∫–∞','error')}
}

/* ‚îÄ‚îÄ Admin Settings ‚îÄ‚îÄ */
let settingsCache={};
async function loadSettings(){
    try{const r=await fetch(API+'/api/admin/settings');if(!r.ok)return;settingsCache=await r.json();
    try{const gr=await fetch(API+'/api/admin/gateways');if(gr.ok)gatewaysCache=await gr.json()}catch(e){}
    drawSettings()}catch(e){}
}
function drawSettings(){
    const s=settingsCache;
    const mkToggle=(key,val,stopProp)=>{
        const cls='toggle-switch'+(val?' active':'');
        const sp=stopProp?'event.stopPropagation();':'';
        return '<button class="'+cls+'" onclick="'+sp+'toggleSet(\''+key+'\','+(!val)+');this.classList.toggle(\'active\')"></button>';
    };
    const mkRow=(item)=>{
        const val=s[item.key];
        if(item.type==='select'){
            return '<div class="settings-row" onclick="openSettingDetail(\''+item.key+'\',\''+item.label+'\',\''+(item.detail||'')+'\')"><div class="settings-row-left"><span class="settings-icon">'+item.icon+'</span><div><div class="settings-label">'+item.label+'</div><div class="settings-desc">'+item.desc+'</div></div></div><span class="settings-chevron">'+esc(String(val))+' &#8250;</span></div>';
        } else if(typeof val==='boolean'){
            if(item.detail){
                return '<div class="settings-row" onclick="openSettingDetail(\''+item.key+'\',\''+item.label+'\',\''+item.detail+'\')"><div class="settings-row-left"><span class="settings-icon">'+item.icon+'</span><div><div class="settings-label">'+item.label+'</div><div class="settings-desc">'+item.desc+'</div></div></div>'+mkToggle(item.key,val,true)+'</div>';
            } else {
                return '<div class="settings-row"><div class="settings-row-left"><span class="settings-icon">'+item.icon+'</span><div><div class="settings-label">'+item.label+'</div><div class="settings-desc">'+item.desc+'</div></div></div>'+mkToggle(item.key,val,false)+'</div>';
            }
        } else {
            return '<div class="settings-row" onclick="openSettingDetail(\''+item.key+'\',\''+item.label+'\',\''+(item.detail||'')+'\')"><div class="settings-row-left"><span class="settings-icon">'+item.icon+'</span><div><div class="settings-label">'+item.label+'</div><div class="settings-desc">'+esc(String(val||'‚Äî'))+'</div></div></div><span class="settings-chevron">&#8250;</span></div>';
        }
    };
    const funcItems=[
        {key:'balance_enabled',icon:'üí∞',label:'–ë–∞–ª–∞–Ω—Å',desc:'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞',detail:'balance'},
        {key:'referral_enabled',icon:'ü§ù',label:'–†–µ—Ñ.—Å–∏—Å—Ç–µ–º–∞',desc:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞',detail:'referral'},
        {key:'promocodes_enabled',icon:'üéÅ',label:'–ü—Ä–æ–º–æ–∫–æ–¥—ã',desc:'–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤'},
        {key:'notifications_enabled',icon:'üîî',label:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',desc:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',detail:'notifications'},
        {key:'extra_devices_enabled',icon:'üì±',label:'–î–æ–ø. —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',desc:'–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤',detail:'extra_devices'},
        {key:'transfers_enabled',icon:'üí∏',label:'–ü–µ—Ä–µ–≤–æ–¥—ã',desc:'–ü–µ—Ä–µ–≤–æ–¥—ã –±–∞–ª–∞–Ω—Å–∞ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏',detail:'transfers'},
        {key:'global_discount_enabled',icon:'üè∑',label:'–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞',desc:'–°–∫–∏–¥–∫–∞ –Ω–∞ –≤—Å–µ —Ç–∞—Ä–∏—Ñ—ã',detail:'global_discount'},
        {key:'community_enabled',icon:'üí¨',label:'–°–æ–æ–±—â–µ—Å—Ç–≤–æ',desc:'–°—Å—ã–ª–∫–∞ –Ω–∞ Telegram-–≥—Ä—É–ø–ø—É',detail:'community'},
        {key:'tos_enabled',icon:'üìÑ',label:'–°–æ–≥–ª–∞—à–µ–Ω–∏–µ',desc:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ',detail:'tos'},
        {key:'language_enabled',icon:'üåê',label:'–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å',desc:'–í—ã–±–æ—Ä —è–∑—ã–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞'},
    ];
    let gwRows='';
    gatewaysCache.forEach(gw=>{
        const label=GW_LABELS[gw.type]||gw.type;
        const icon=GW_ICONS[gw.type]||'üí≥';
        gwRows+='<div class="settings-row" onclick="openGatewayDetail('+gw.id+')"><div class="settings-row-left"><span class="settings-icon">'+icon+'</span><div><div class="settings-label">'+label+'</div><div class="settings-desc">'+gw.currency+' ‚Ä¢ '+(gw.is_active?'–ê–∫—Ç–∏–≤–Ω–∞':'–ù–µ–∞–∫—Ç–∏–≤–Ω–∞')+'</div></div></div><button class="toggle-switch '+(gw.is_active?'active':'')+'" onclick="event.stopPropagation();toggleGw('+gw.id+','+(!gw.is_active)+',this)"></button></div>';
    });
    if(!gatewaysCache.length) gwRows='<div class="settings-row"><div class="settings-row-left"><span class="settings-icon">üí≥</span><div><div class="settings-label">–ù–µ—Ç –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º</div><div class="settings-desc">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ –ø–∞–Ω–µ–ª–∏ Remnawave</div></div></div></div>';
    const botItems=[
        {key:'access_mode',icon:'üîë',label:'–†–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞',desc:s.access_mode||'PUBLIC',type:'select',detail:'access_mode'},
        {key:'channel_required',icon:'üì¢',label:'–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª',desc:s.channel_link?'–ö–∞–Ω–∞–ª: '+s.channel_link:'–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ',detail:'channel'},
        {key:'rules_required',icon:'üìú',label:'–ü—Ä–∏–Ω—è—Ç–∏–µ –ø—Ä–∞–≤–∏–ª',desc:'–¢—Ä–µ–±–æ–≤–∞—Ç—å –ø—Ä–∏–Ω—è—Ç–∏–µ —É—Å–ª–æ–≤–∏–π –ø—Ä–∏ –≤—Ö–æ–¥–µ',detail:'tos'},
        {key:'purchases_allowed',icon:'üõí',label:'–†–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–∫—É–ø–∫–∏',desc:'–†–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–∫—É–ø–∫—É –ø–æ–¥–ø–∏—Å–æ–∫'},
        {key:'registration_allowed',icon:'üìù',label:'–†–∞–∑—Ä–µ—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é',desc:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'},
        {key:'default_currency',icon:'üí±',label:'–í–∞–ª—é—Ç–∞',desc:s.default_currency||'RUB',type:'select',detail:'currency_rates'},
        {key:'bot_locale',icon:'üó£',label:'–Ø–∑—ã–∫ –±–æ—Ç–∞',desc:s.bot_locale||'RU',type:'select',detail:'bot_locale'},
    ];
    let html='';
    html+='<details class="spoiler-card settings-spoiler" open><summary><span class="spoiler-title">‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª</span><span class="spoiler-chevron">‚ñº</span></summary><div class="card" style="padding:0;overflow:hidden;margin-top:10px;margin-bottom:0">';
    funcItems.forEach(item=>{html+=mkRow(item)});
    html+='</div></details>';
    html+='<details class="spoiler-card settings-spoiler"><summary><span class="spoiler-title">üí≥ –ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã</span><span class="spoiler-chevron">‚ñº</span></summary><div class="card" style="padding:0;overflow:hidden;margin-top:10px;margin-bottom:0">';
    html+=gwRows;
    html+='</div></details>';
    html+='<details class="spoiler-card settings-spoiler"><summary><span class="spoiler-title">ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º</span><span class="spoiler-chevron">‚ñº</span></summary><div class="card" style="padding:0;overflow:hidden;margin-top:10px;margin-bottom:0">';
    botItems.forEach(item=>{html+=mkRow(item)});
    html+='</div></details>';
    $('settings-list').innerHTML=html;
}
let curDetailCtx=null;
function openSettingDetail(key,label,detail){
    curDetailCtx={key,label,detail};
    const s=settingsCache, val=s[key];
    let body='';
    let saveAction='';
    if(detail==='balance'){
        const curMode=s.balance_mode||'SEPARATE';
        const sym=CURRENCY_SYMBOLS[s.default_currency]||'‚ÇΩ';
        body+='<div class="setting-inline-row"><span class="setting-inline-label">–†–µ–∂–∏–º –±–∞–ª–∞–Ω—Å–∞</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'balance_mode\',this.value)"><option value="SEPARATE"'+(curMode==='SEPARATE'?' selected':'')+'>–†–∞–∑–¥–µ–ª—å–Ω–æ</option><option value="COMBINED"'+(curMode==='COMBINED'?' selected':'')+'>–û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-bal-min" type="number" value="'+(s.balance_min_amount||10)+'" style="width:80px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+sym+'</span></div></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-bal-max" type="number" value="'+(s.balance_max_amount||100000)+'" style="width:80px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+sym+'</span></div></div>';
        saveAction='saveMultiSub({balance_min_amount:parseInt($(\'sd-bal-min\').value),balance_max_amount:parseInt($(\'sd-bal-max\').value)})';
    } else if(detail==='community'){
        body+='<div class="form-group"><label>URL —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</label><input class="form-input" id="sd-comm-url" value="'+esc(s.community_url||'')+'" placeholder="https://t.me/..."></div>';
        saveAction='saveMultiSub({community_url:$(\'sd-comm-url\').value})';
    } else if(detail==='referral'){
        const curLevel=String(s.referral_level||1);
        const curRt=s.referral_reward_type||'MONEY';
        const curAs=s.referral_accrual_strategy||'ON_EACH_PAYMENT';
        const curRs=s.referral_reward_strategy||'AMOUNT';
        const rewardUnit=curRs==='PERCENT'?'%':(curRt==='EXTRA_DAYS'?'–¥–Ω–µ–π':(CURRENCY_SYMBOLS[s.default_currency]||'‚ÇΩ'));
        body+='<div class="setting-inline-row"><span class="setting-inline-label">–£—Ä–æ–≤–Ω–µ–≤–æ—Å—Ç—å</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'referral_level\',parseInt(this.value));setTimeout(()=>openSettingDetail(\'referral_enabled\',\'–†–µ—Ñ.—Å–∏—Å—Ç–µ–º–∞\',\'referral\'),100)"><option value="1"'+(curLevel==='1'?' selected':'')+'>1 —É—Ä–æ–≤–µ–Ω—å</option><option value="2"'+(curLevel==='2'?' selected':'')+'>2 —É—Ä–æ–≤–Ω—è</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">–¢–∏–ø –Ω–∞–≥—Ä–∞–¥—ã</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'referral_reward_type\',this.value)"><option value="MONEY"'+(curRt==='MONEY'?' selected':'')+'>–î–µ–Ω—å–≥–∏</option><option value="EXTRA_DAYS"'+(curRt==='EXTRA_DAYS'?' selected':'')+'>–î–Ω–∏</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">–£—Å–ª–æ–≤–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'referral_accrual_strategy\',this.value)"><option value="ON_EACH_PAYMENT"'+(curAs==='ON_EACH_PAYMENT'?' selected':'')+'>–ó–∞ –∫–∞–∂–¥—É—é –æ–ø–ª–∞—Ç—É</option><option value="ON_FIRST_PAYMENT"'+(curAs==='ON_FIRST_PAYMENT'?' selected':'')+'>–ó–∞ –ø–µ—Ä–≤—É—é –æ–ø–ª–∞—Ç—É</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">–§–æ—Ä–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'referral_reward_strategy\',this.value)"><option value="AMOUNT"'+(curRs==='AMOUNT'?' selected':'')+'>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</option><option value="PERCENT"'+(curRs==='PERCENT'?' selected':'')+'>–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">–ù–∞–≥—Ä–∞–¥–∞ (—É—Ä. 1)</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-ref-val" type="number" value="'+(s.referral_reward_value||10)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+rewardUnit+'</span></div></div>'+
            (curLevel==='2'?'<div class="setting-inline-row"><span class="setting-inline-label">–ù–∞–≥—Ä–∞–¥–∞ (—É—Ä. 2)</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-ref-val2" type="number" value="'+(s.referral_reward_value_l2||5)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+rewardUnit+'</span></div></div>':'')+
            '<div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px"><div class="form-group"><label>–¢–µ–∫—Å—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label><textarea class="form-input" id="sd-ref-msg" rows="7" style="resize:vertical;min-height:120px" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.\n{space} ‚Äî –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏\n{url} ‚Äî —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞\n{name} ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞">'+esc(s.referral_invite_message||'')+'</textarea></div></div>';
        saveAction='saveMultiSub({referral_reward_value:parseInt($(\'sd-ref-val\').value),referral_reward_value_l2:$(\'sd-ref-val2\')?parseInt($(\'sd-ref-val2\').value):undefined,referral_invite_message:$(\'sd-ref-msg\').value})';
    } else if(detail==='notifications'){
        const unLabels={un_expires_3d:'–ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 3 –¥–Ω—è',un_expires_2d:'–ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 2 –¥–Ω—è',un_expires_1d:'–ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 1 –¥–µ–Ω—å',un_expired:'–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞',un_limited:'–¢—Ä–∞—Ñ–∏–∫ –∏—Å—á–µ—Ä–ø–∞–Ω',un_expired_1d_ago:'–ò—Å—Ç–µ–∫–ª–∞ 1 –¥–µ–Ω—å –Ω–∞–∑–∞–¥',un_referral_attached:'–†–µ—Ñ–µ—Ä–∞–ª –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—ë–Ω',un_referral_reward:'–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞'};
        const snLabels={sn_bot_lifetime:'–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞',sn_bot_update:'–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞',sn_user_registered:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',sn_subscription:'–ü–æ–¥–ø–∏—Å–∫–∞',sn_extra_devices:'–î–æ–ø. —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',sn_promocode:'–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω',sn_trial:'–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥',sn_node_status:'–°—Ç–∞—Ç—É—Å –Ω–æ–¥—ã',sn_user_connected:'–ü–µ—Ä–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ',sn_user_hwid:'HWID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',sn_billing:'–ë–∏–ª–ª–∏–Ω–≥',sn_balance_transfer:'–ü–µ—Ä–µ–≤–æ–¥ –±–∞–ª–∞–Ω—Å–∞'};
        body+='<div style="font-size:.76rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ</div>';
        Object.entries(unLabels).forEach(([k,v])=>{
            body+='<div class="toggle-row"><label>'+v+'</label><button class="toggle-switch '+(s[k]?'active':'')+'" onclick="saveSubSetting(\''+k+'\','+(!s[k])+');this.classList.toggle(\'active\')"></button></div>';
        });
        body+='<div style="font-size:.76rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin:14px 0 8px">–°–∏—Å—Ç–µ–º–Ω—ã–µ</div>';
        Object.entries(snLabels).forEach(([k,v])=>{
            body+='<div class="toggle-row"><label>'+v+'</label><button class="toggle-switch '+(s[k]?'active':'')+'" onclick="saveSubSetting(\''+k+'\','+(!s[k])+');this.classList.toggle(\'active\')"></button></div>';
        });
    } else if(detail==='extra_devices'){
        const sym=CURRENCY_SYMBOLS[s.default_currency]||'‚ÇΩ';
        body+='<div class="setting-inline-row"><span class="setting-inline-label">–¶–µ–Ω–∞ –∑–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-ed-price" type="number" value="'+(s.extra_devices_price||100)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+sym+'</span></div></div>'+
            '<div class="toggle-row" style="margin-bottom:8px"><label>–ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞</label><button class="toggle-switch '+(s.extra_devices_one_time?'active':'')+'" onclick="saveSubSetting(\'extra_devices_one_time\','+(!s.extra_devices_one_time)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">–ú–∏–Ω. –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-ed-days" type="number" value="'+(s.extra_devices_min_days||10)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"></div></div>';
        saveAction='saveMultiSub({extra_devices_price:parseInt($(\'sd-ed-price\').value),extra_devices_min_days:parseInt($(\'sd-ed-days\').value)})';
    } else if(detail==='transfers'){
        const curTct=s.transfers_commission_type||'percent';
        const commUnit=curTct==='fixed'?(CURRENCY_SYMBOLS[s.default_currency]||'‚ÇΩ'):'%';
        const sym=CURRENCY_SYMBOLS[s.default_currency]||'‚ÇΩ';
        body+='<div class="setting-inline-row"><span class="setting-inline-label">–¢–∏–ø –∫–æ–º–∏—Å—Å–∏–∏</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'transfers_commission_type\',this.value);setTimeout(()=>openSettingDetail(\'transfers_enabled\',\'–ü–µ—Ä–µ–≤–æ–¥—ã\',\'transfers\'),100)"><option value="percent"'+(curTct==='percent'?' selected':'')+'>–ü—Ä–æ—Ü–µ–Ω—Ç</option><option value="fixed"'+(curTct==='fixed'?' selected':'')+'>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">–ö–æ–º–∏—Å—Å–∏—è</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-tr-comm" type="number" value="'+(s.transfers_commission_value||5)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+commUnit+'</span></div></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">–ú–∏–Ω. —Å—É–º–º–∞</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-tr-min" type="number" value="'+(s.transfers_min_amount||10)+'" style="width:80px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+sym+'</span></div></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">–ú–∞–∫—Å. —Å—É–º–º–∞</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-tr-max" type="number" value="'+(s.transfers_max_amount||100000)+'" style="width:80px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+sym+'</span></div></div>';
        saveAction='saveMultiSub({transfers_commission_value:parseInt($(\'sd-tr-comm\').value),transfers_min_amount:parseInt($(\'sd-tr-min\').value),transfers_max_amount:parseInt($(\'sd-tr-max\').value)})';
    } else if(detail==='global_discount'){
        const curGdt=s.global_discount_type||'percent';
        const discUnit=curGdt==='fixed'?(CURRENCY_SYMBOLS[s.default_currency]||'‚ÇΩ'):'%';
        body+='<div class="setting-inline-row"><span class="setting-inline-label">–¢–∏–ø —Å–∫–∏–¥–∫–∏</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'global_discount_type\',this.value);setTimeout(()=>openSettingDetail(\'global_discount_enabled\',\'–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞\',\'global_discount\'),100)"><option value="percent"'+(curGdt==='percent'?' selected':'')+'>–ü—Ä–æ—Ü–µ–Ω—Ç</option><option value="fixed"'+(curGdt==='fixed'?' selected':'')+'>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">–ó–Ω–∞—á–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-gd-val" type="number" value="'+(s.global_discount_value||0)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+discUnit+'</span></div></div>'+
            '<div class="toggle-row" style="margin-bottom:8px"><label>–°–∫–ª–∞–¥—ã–≤–∞—Ç—å —Å–∫–∏–¥–∫–∏</label><button class="toggle-switch '+(s.global_discount_stack?'active':'')+'" onclick="saveSubSetting(\'global_discount_stack\','+(!s.global_discount_stack)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:10px"><div style="font-size:.76rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">–ü—Ä–∏–º–µ–Ω—è—Ç—å –∫</div>'+
            '<div class="toggle-row"><label>–ü–æ–¥–ø–∏—Å–∫–∏</label><button class="toggle-switch '+(s.global_discount_apply_sub?'active':'')+'" onclick="saveSubSetting(\'global_discount_apply_sub\','+(!s.global_discount_apply_sub)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="toggle-row"><label>–î–æ–ø. —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label><button class="toggle-switch '+(s.global_discount_apply_devices?'active':'')+'" onclick="saveSubSetting(\'global_discount_apply_devices\','+(!s.global_discount_apply_devices)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="toggle-row"><label>–ö–æ–º–∏—Å—Å–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤</label><button class="toggle-switch '+(s.global_discount_apply_transfer?'active':'')+'" onclick="saveSubSetting(\'global_discount_apply_transfer\','+(!s.global_discount_apply_transfer)+');this.classList.toggle(\'active\')"></button></div></div>';
        saveAction='saveMultiSub({global_discount_value:parseInt($(\'sd-gd-val\').value)})';
    } else if(detail==='currency_rates'){
        const opts=['RUB','USD','EUR','XTR'];
        body+=opts.map(o=>'<button class="sub-action-btn sub-action-'+(String(val)===o?'renew':'change')+'" style="margin-top:6px;width:100%" onclick="saveSettingVal(\''+key+'\',\''+o+'\')">'+o+'</button>').join('');
        body+='<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px"><div style="font-size:.76rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</div></div>'+
            '<div class="toggle-row" style="margin-bottom:8px"><label>–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–¶–ë –†–§)</label><button class="toggle-switch '+(s.currency_rates_auto?'active':'')+'" onclick="saveSubSetting(\'currency_rates_auto\','+(!s.currency_rates_auto)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="form-group"><label>USD ‚Üí RUB</label><input class="form-input" id="sd-cr-usd" type="number" step="0.01" value="'+(s.currency_rates_usd||90)+'"></div>'+
            '<div class="form-group"><label>EUR ‚Üí RUB</label><input class="form-input" id="sd-cr-eur" type="number" step="0.01" value="'+(s.currency_rates_eur||100)+'"></div>'+
            '<div class="form-group"><label>Stars ‚Üí RUB</label><input class="form-input" id="sd-cr-stars" type="number" step="0.01" value="'+(s.currency_rates_stars||1.5)+'"></div>';
        saveAction='saveMultiSub({currency_rates_usd:parseFloat($(\'sd-cr-usd\').value),currency_rates_eur:parseFloat($(\'sd-cr-eur\').value),currency_rates_stars:parseFloat($(\'sd-cr-stars\').value)})';
    } else if(detail==='tos'){
        body+='<div class="form-group"><label>URL —Å–æ–≥–ª–∞—à–µ–Ω–∏—è</label><input class="form-input" id="sd-tos-url" value="'+esc(s.tos_url||'')+'" placeholder="https://..."></div>';
        saveAction='saveSettingStr(\'tos_url\',$(\'sd-tos-url\').value)';
    } else if(detail==='access_mode'){
        const amLabels={PUBLIC:'–ü—É–±–ª–∏—á–Ω—ã–π',INVITED:'–ü–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é',RESTRICTED:'–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π'};
        body+=Object.entries(amLabels).map(([k,v])=>'<button class="sub-action-btn sub-action-'+(String(val)===k?'renew':'change')+'" style="margin-top:6px;width:100%" onclick="saveSettingVal(\'access_mode\',\''+k+'\')">'+v+'</button>').join('');
    } else if(detail==='channel'){
        body+='<div class="toggle-row" style="margin-bottom:12px"><label>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</label><button class="toggle-switch '+(s.channel_required?'active':'')+'" onclick="saveSubSetting(\'channel_required\','+(!s.channel_required)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="form-group"><label>–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</label><input class="form-input" id="sd-ch-link" value="'+esc(s.channel_link||'')+'" placeholder="https://t.me/..."></div>';
        saveAction='saveSettingStr(\'channel_link\',$(\'sd-ch-link\').value)';
    } else if(detail==='bot_locale'){
        const locLabels={RU:'–†—É—Å—Å–∫–∏–π',EN:'English',UK:'–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞',DE:'Deutsch'};
        body+=Object.entries(locLabels).map(([k,v])=>'<button class="sub-action-btn sub-action-'+(String(val)===k?'renew':'change')+'" style="margin-top:6px;width:100%" onclick="saveSettingVal(\'bot_locale\',\''+k+'\')">'+v+'</button>').join('');
    } else if(typeof val==='boolean'){
    } else {
        body+='<div class="form-group"><label>–ó–Ω–∞—á–µ–Ω–∏–µ</label><input class="form-input" id="set-val" value="'+esc(String(val||''))+'"></div>';
        saveAction='saveSettingStr(\''+key+'\',$(\'set-val\').value)';
    }
    if(!body)return;
    let footer='<div class="modal-actions" style="gap:8px">';
    if(saveAction) footer+='<button class="sub-action-btn sub-action-renew" style="flex:1;border-color:rgba(25,195,125,.35);color:var(--green)" onclick="'+saveAction+'">–ü—Ä–∏–Ω—è—Ç—å</button>';
    footer+='<button class="sub-action-btn sub-action-change" style="flex:1;border-color:rgba(224,79,95,.35);color:var(--red)" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>';
    showModal('<h3>'+label+'</h3>'+body+footer);
}
async function saveSubSetting(k,v){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        if(curDetailCtx)openSettingDetail(curDetailCtx.key,curDetailCtx.label,curDetailCtx.detail);
    }else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}
async function saveMultiSub(obj){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)});
    if(r.ok){Object.assign(settingsCache,obj);
        if(D.features&&obj.referral_invite_message!=null)D.features.referral_invite_message=obj.referral_invite_message;
        closeModal();drawSettings();toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}
async function toggleSetAndRefresh(k,v,btn){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;if(btn&&typeof btn.classList!=='undefined')btn.classList.toggle('active',v);drawSettings();toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}
async function toggleSet(k,v,dotId){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;
        const dot=typeof dotId==='string'?$(dotId):dotId;
        if(dot){dot.classList.toggle('active',v);}
        drawSettings();toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
    }else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}

/* ‚ïê‚ïê‚ïê PAYMENT GATEWAYS ‚ïê‚ïê‚ïê */
let gatewaysCache=[];
const GW_LABELS={TELEGRAM_STARS:'Telegram Stars',YOOKASSA:'–ÆKassa',YOOMONEY:'–ÆMoney',CRYPTOMUS:'Cryptomus',HELEKET:'–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞',CRYPTOPAY:'CryptoPay',ROBOKASSA:'Robokassa',BALANCE:'–ë–∞–ª–∞–Ω—Å'};
const GW_ICONS={TELEGRAM_STARS:'‚≠ê',YOOKASSA:'üè¶',YOOMONEY:'<svg viewBox="0 0 24 24" width="18" height="18" style="vertical-align:middle"><circle cx="12" cy="12" r="11" fill="#8B3FFD"/><text x="12" y="17" text-anchor="middle" fill="#fff" font-size="14" font-weight="700" font-family="Arial">–Æ</text></svg>',CRYPTOMUS:'ü™ô',HELEKET:'‚Çø',CRYPTOPAY:'üíé',ROBOKASSA:'ü§ñ',BALANCE:'üí∞'};
const GW_DESCS={TELEGRAM_STARS:'Telegram',YOOKASSA:'–û–ø–ª–∞—Ç–∞ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π',YOOMONEY:'–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∫–æ—à–µ–ª—ë–∫',CRYPTOMUS:'USDT, TON, BTC –∏ –¥—Ä—É–≥–∏–µ',HELEKET:'BTC, USDT –∏ –¥—Ä—É–≥–∏–µ',CRYPTOPAY:'TON, USDT –∏ –¥—Ä—É–≥–∏–µ',ROBOKASSA:'–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã',BALANCE:'–û–ø–ª–∞—Ç–∞ —Å –±–∞–ª–∞–Ω—Å–∞'};
const GW_SECRET_FIELDS=['api_key','secret_key'];
async function loadGateways(){
    try{const r=await fetch(API+'/api/admin/gateways');if(!r.ok)return;gatewaysCache=await r.json();drawGateways()}catch(e){}
}
function drawGateways(){
    drawSettings();
}
async function toggleGw(id,v,btn){
    try{const r=await fetch(API+'/api/admin/gateways/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({is_active:v})});
    if(r.ok){btn.classList.toggle('active',v);const gw=gatewaysCache.find(g=>g.id===id);if(gw)gw.is_active=v;drawGateways();toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}
function openGatewayDetail(id){
    const gw=gatewaysCache.find(g=>g.id===id);if(!gw)return;
    const label=GW_LABELS[gw.type]||gw.type;
    const settings=gw.settings||{};
    const fields=Object.keys(settings);
    if(!fields.length){
        showModal('<h3>'+label+'</h3><p style="color:var(--text3);font-size:.84rem;margin:12px 0">–ù–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</p><div class="modal-actions"><button class="sub-action-btn sub-action-change" style="flex:1;border-color:rgba(224,79,95,.35);color:var(--red)" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>');
        return;
    }
    let body='<h3>'+label+'</h3><div style="margin-top:12px">';
    fields.forEach(f=>{
        const isSecret=GW_SECRET_FIELDS.includes(f);
        body+='<div class="form-group"><label>'+f+'</label><input class="form-input" id="gw-f-'+f+'" type="'+(isSecret?'password':'text')+'" value="'+esc(String(settings[f]||''))+'" placeholder="'+f+'"></div>';
    });
    body+='</div><div class="modal-actions" style="gap:8px"><button class="sub-action-btn sub-action-renew" style="flex:1;border-color:rgba(25,195,125,.35);color:var(--green)" onclick="saveGwSettings('+id+')">–ü—Ä–∏–Ω—è—Ç—å</button><button class="sub-action-btn sub-action-change" style="flex:1;border-color:rgba(224,79,95,.35);color:var(--red)" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>';
    showModal(body);
}
async function saveGwSettings(id){
    const gw=gatewaysCache.find(g=>g.id===id);if(!gw)return;
    const settings=gw.settings||{};
    const upd={};
    Object.keys(settings).forEach(f=>{
        const el=$('gw-f-'+f);if(el)upd[f]=el.value;
    });
    try{const r=await fetch(API+'/api/admin/gateways/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:upd})});
    if(r.ok){closeModal();loadGateways();toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}

function showQR(){
    const s=D&&D.subscription;
    if(!s||!s.url)return toast(t('no_active_sub')||'–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏','error');
    const qrUrl='https://api.qrserver.com/v1/create-qr-code/?size=200x200&color=24C4F1&bgcolor=080C14&data='+encodeURIComponent(s.url);
    showModal('<h3>QR-–∫–æ–¥</h3><div style="text-align:center;padding:10px 0"><img src="'+qrUrl+'" style="width:200px;height:200px;border-radius:12px" alt="QR"></div><p style="font-size:.75rem;color:var(--text3);text-align:center">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</p><div class="modal-actions"><button class="btn-confirm-pay" style="flex:1" onclick="closeModal()">–ì–æ—Ç–æ–≤–æ</button></div>');
}
async function saveSettingStr(k,v){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;closeModal();drawSettings();toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}
async function saveSettingVal(k,v){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;closeModal();drawSettings();toast(t('saved'));
        if(k==='bot_locale'){CUR_LOCALE=v;render();applyLocale()}
    }else toast(t('error'),'error')}catch(e){toast(t('error'),'error')}
}

/* ‚îÄ‚îÄ Tickets (User) ‚îÄ‚îÄ */
let curTicketId=null;
async function loadTickets(){
    try{const r=await fetch(API+'/api/tickets');if(!r.ok)return;const tks=await r.json();
    const el=$('tickets-list');
    if(!tks.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">üé´</span><h3>'+t('no_tickets')+'</h3><p style="color:var(--text3);font-size:.84rem">'+t('create_first')+'</p></div>';return}
    // Sort by updated_at descending (newest first)
    tks.sort((a,b)=>(b.updated_at||'').localeCompare(a.updated_at||''));
    el.innerHTML=tks.map(tk=>{
        const st=tk.status.toLowerCase();
        // Determine display status: unread‚Üí"–ù–æ–≤–æ–µ"(red), open‚Üí"–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏", answered‚Üí"–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω"
        let stClass=st, stLabel;
        if(!tk.is_read_by_user && st!=='closed'){
            stClass='new'; stLabel=t('ticket_new');
        } else {
            stLabel=t('ticket_'+st)||st;
        }
        const last=tk.messages&&tk.messages.length?tk.messages[tk.messages.length-1].text:'';
        return '<div class="ticket-item'+(tk.is_read_by_user?'':' unread')+'" onclick="openTicket('+tk.id+')">'+
            '<div class="ticket-top"><span class="ticket-subject">'+esc(tk.subject)+'</span><span class="ticket-status '+stClass+'">'+stLabel+'</span></div>'+
            '<div class="ticket-preview">'+esc(last.substring(0,80))+'</div>'+
            '<div class="ticket-date">'+tk.updated_at+'</div></div>';
    }).join('')}catch(e){}
}
async function openTicket(id){
    curTicketId=id; go('ticket');$('ticket-title').textContent=t('loading');$('ticket-chat').innerHTML='';$('ticket-reply').style.display='none';
    try{const r=await fetch(API+'/api/tickets/'+id);if(!r.ok)return;
    const t2=await r.json();$('ticket-title').textContent=t2.subject;
    renderTicketChat($('ticket-chat'),t2.messages);
    if(t2.status!=='CLOSED'){
        $('ticket-reply').style.display='flex';
    } else {
        $('ticket-reply').style.display='none';
    }
    }catch(e){}
}
function renderTicketChat(el,msgs){
    el.innerHTML=(msgs||[]).map(m=>{
        const cls=m.is_admin?'admin':'user';
        return '<div class="ticket-msg '+cls+'">'+esc(m.text)+'<div class="ticket-msg-time">'+m.created_at+'</div></div>';
    }).join('');el.scrollTop=el.scrollHeight;
}
async function sendTicketReply(){
    const text=$('ticket-text').value.trim();if(!text||!curTicketId)return;
    try{const r=await fetch(API+'/api/tickets/'+curTicketId+'/reply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    if(r.ok){$('ticket-text').value='';const t=await r.json();renderTicketChat($('ticket-chat'),t.messages);pollTicketStatus()}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}
// Enter to send, Shift+Enter for newline on ticket textareas
function _setupTicketKeys(){
    const tt=$('ticket-text');
    if(tt)tt.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendTicketReply()}});
    const at=$('at-text');
    if(at)at.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendAdmTicketReply()}});
}
function showNewTicket(){
    showModal('<h3>'+t('new_ticket_title')+'</h3><div class="form-group"><label>'+t('subject')+'</label><input class="form-input" id="nt-subj" placeholder="..."></div><div class="form-group"><label>'+t('message')+'</label><textarea class="form-input" id="nt-text" rows="4" placeholder="..." style="resize:vertical"></textarea></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">'+t('cancel')+'</button><button class="btn btn-primary" onclick="createTicket()">'+t('send')+'</button></div>');
}
async function createTicket(){
    const subject=$('nt-subj').value.trim(), text=$('nt-text').value.trim();
    if(!subject||!text)return toast(t('fill_all'),'error');closeModal();
    try{const r=await fetch(API+'/api/tickets',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subject,text})});
    if(r.ok){toast(t('ticket_created'));const t2=await r.json();curTicketId=t2.id;openTicket(t2.id)}else{const j=await r.json();toast(j.detail||t('error'),'error')}}catch(e){toast(t('error'),'error')}
}

/* ‚îÄ‚îÄ Tickets (Admin) ‚îÄ‚îÄ */
const TICKET_STATUS_LABELS={OPEN:'–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',ANSWERED:'–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω',CLOSED:'–ó–∞–∫—Ä—ã—Ç',open:'–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',answered:'–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω',closed:'–ó–∞–∫—Ä—ã—Ç'};
let admTicketsCache=[];
async function loadAdmTickets(){
    try{const r=await fetch(API+'/api/admin/tickets');if(!r.ok)return;admTicketsCache=await r.json();
    const el=$('adm-tickets-list');
    if(!admTicketsCache.length){el.innerHTML='<div class="empty-state">–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤</div>';return}
    // Sort admin tickets by updated_at desc
    admTicketsCache.sort((a,b)=>(b.updated_at||'').localeCompare(a.updated_at||''));
    el.innerHTML=admTicketsCache.map(tk=>{
        const st=tk.status.toLowerCase();
        // Admin statuses: unread by admin‚Üí"–ù–æ–≤—ã–π"(red), answered‚Üí"–ì–æ—Ç–æ–≤–æ"(green), else status
        let stClass=st, stLabel;
        if(!tk.is_read_by_admin && st!=='closed'){
            stClass='new'; stLabel=t('ticket_adm_new');
        } else if(st==='answered'){
            stClass='done'; stLabel=t('ticket_adm_done');
        } else {
            stLabel=t('ticket_'+st)||TICKET_STATUS_LABELS[tk.status]||tk.status;
        }
        const lastMsg=(tk.messages&&tk.messages.length)?tk.messages[tk.messages.length-1].text:'';
        return '<div class="ticket-item'+(tk.is_read_by_admin?'':' unread')+'" onclick="openAdmTicket('+tk.id+')">'+
            '<div class="ticket-top"><span class="ticket-id">#'+tk.id+' ¬∑ ID '+tk.user_telegram_id+'</span><span class="ticket-status '+stClass+'">'+stLabel+'</span></div>'+
            '<div class="ticket-row2"><span class="ticket-subject">'+esc(tk.subject)+'</span></div>'+
            (lastMsg?'<div class="ticket-preview">'+esc(lastMsg.substring(0,80))+'</div>':'')+
            '<div class="ticket-bottom-row"><span class="ticket-date">'+tk.updated_at+'</span><button class="btn-trash" onclick="event.stopPropagation();delAdmTicket('+tk.id+')" title="–£–¥–∞–ª–∏—Ç—å —Ç–∏–∫–µ—Ç">üóë</button></div>'+
            '</div>';
    }).join('')}catch(e){}
}
async function delAdmTicket(id){
    if(!confirm(t('delete_ticket_q')+' #'+id+'?'))return;
    try{const r=await fetch(API+'/api/admin/tickets/'+id,{method:'DELETE'});
    if(r.ok){toast(t('deleted'));loadAdmTickets()}else{const j=await r.json();toast(j.detail||t('error'),'error')}}catch(e){toast(t('error'),'error')}
}
let admCurTicketId=null;
async function openAdmTicket(id){
    admCurTicketId=id;go('aticket');$('at-title').textContent=t('loading');$('at-chat').innerHTML='';
    try{const r=await fetch(API+'/api/admin/tickets/'+id);if(!r.ok)return;
    const tk=await r.json();$('at-title').textContent='#'+tk.id+' '+tk.subject;
    renderTicketChat($('at-chat'),tk.messages);
    }catch(e){}
}
async function delAdmTicketFromDetail(id){
    if(!confirm(t('delete_ticket_q')+' #'+id+'?'))return;
    try{const r=await fetch(API+'/api/admin/tickets/'+id,{method:'DELETE'});
    if(r.ok){toast(t('deleted'));admTab('tickets');go('admin')}else{const j=await r.json();toast(j.detail||t('error'),'error')}}catch(e){toast(t('error'),'error')}
}
async function sendAdmTicketReply(){
    const text=$('at-text').value.trim();if(!text||!admCurTicketId)return;
    try{const r=await fetch(API+'/api/admin/tickets/'+admCurTicketId+'/reply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    if(r.ok){$('at-text').value='';const t2=await r.json();renderTicketChat($('at-chat'),t2.messages);pollTicketStatus()}else toast(t('error'),'error')}catch(e){toast(t('error'),'error')}
}

/* ‚îÄ‚îÄ Admin Brand ‚îÄ‚îÄ */
function loadBrandForm(){$('br-name').value=BRAND.name||'';$('br-logo').value=BRAND.logo||'';$('br-slogan').value=BRAND.slogan||''}
async function saveBrand(){
    const d={name:$('br-name').value.trim(),logo:$('br-logo').value.trim(),slogan:$('br-slogan').value.trim()};
    try{const r=await fetch(API+'/api/settings/brand',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
    if(r.ok){
        BRAND=d;
        const logoEl=$('brand-logo');
        const effectiveLogo=BRAND.logo||DEFAULT_LOGO;
        if(effectiveLogo.startsWith('http')){logoEl.innerHTML='<img class="brand-logo-img" src="'+esc(effectiveLogo)+'" alt="">';logoEl.classList.add('has-img')}
        else{logoEl.textContent=effectiveLogo;logoEl.classList.remove('has-img')}
        $('brand-name').textContent=BRAND.name||DEFAULT_NAME;
        const sl=$('brand-slogan');
        const effSl=BRAND.slogan||DEFAULT_SLOGAN;
        sl.textContent=effSl;sl.style.display=''
        toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
    }else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UTILS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toast(m,t){const e=$('toast');e.textContent=m;e.className='toast visible'+(t?' toast-'+t:'');clearTimeout(e._t);e._t=setTimeout(()=>e.className='toast',3000)}
function showModal(h,cls){
    const mr=$('modal-root');
    const existing=mr.querySelector('.modal-overlay');
    if(existing){
        const card=existing.querySelector('.modal-card');
        if(card){card.innerHTML=h;return}
    }
    mr.innerHTML='<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-card modal-renew'+(cls&&cls!=='modal-renew'?' '+cls:'')+'">'+(h)+'</div></div>';
}
function closeModal(){$('modal-root').innerHTML=''}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function pluralDays(n){
    if(CUR_LOCALE==='EN')return n===1?'day':'days';
    if(CUR_LOCALE==='DE')return n===1?'Tag':'Tage';
    if(CUR_LOCALE==='UK'){const a=Math.abs(n)%100,b=a%10;if(a>10&&a<20)return '–¥–Ω—ñ–≤';if(b>1&&b<5)return '–¥–Ω—ñ';if(b===1)return '–¥–µ–Ω—å';return '–¥–Ω—ñ–≤'}
    const a=Math.abs(n)%100,b=a%10;if(a>10&&a<20)return '–¥–Ω–µ–π';if(b>1&&b<5)return '–¥–Ω—è';if(b===1)return '–¥–µ–Ω—å';return '–¥–Ω–µ–π'
}
function pluralHours(n){
    if(CUR_LOCALE==='EN')return n===1?'hour':'hours';
    if(CUR_LOCALE==='DE')return n===1?'Stunde':'Stunden';
    if(CUR_LOCALE==='UK'){const a=Math.abs(n)%100,b=a%10;if(a>10&&a<20)return '–≥–æ–¥–∏–Ω';if(b>1&&b<5)return '–≥–æ–¥–∏–Ω–∏';if(b===1)return '–≥–æ–¥–∏–Ω—É';return '–≥–æ–¥–∏–Ω'}
    const a=Math.abs(n)%100,b=a%10;if(a>10&&a<20)return '—á–∞—Å–æ–≤';if(b>1&&b<5)return '—á–∞—Å–∞';if(b===1)return '—á–∞—Å';return '—á–∞—Å–æ–≤'
}
function detectOS(){
    const ua=navigator.userAgent||'',p=navigator.platform||'';
    if(/Win/i.test(p))return 'windows';
    if(/Mac/i.test(p)&&!/iPhone|iPad/.test(ua))return 'macos';
    if(/Android/i.test(ua))return 'android';
    if(/iPhone|iPad|iPod/i.test(ua))return 'ios';
    return 'unknown';
}
function getDownloadUrl(){
    const os=detectOS();
    if(os==='windows')return 'https://github.com/Happ-proxy/happ-desktop/releases/latest/download/setup-Happ.x64.exe';
    if(os==='macos')return 'https://github.com/Happ-proxy/happ-desktop/releases/';
    if(os==='android')return 'https://play.google.com/store/apps/details?id=com.happproxy';
    if(os==='ios')return 'https://apps.apple.com/app/happ-proxy-utility-plus/id6746188973';
    return 'https://github.com/Happ-proxy/happ-desktop/releases/';
}

init();
</script>
</body>
</html>
