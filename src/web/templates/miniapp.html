<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<link rel="stylesheet" href="/web/static/css/style.css">
</head>
<body>
<div class="bg-glow"></div>
<div id="particles-js"></div>
<div id="app">

<!-- Loading -->
<div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</p>
</div>

<!-- Error -->
<div id="error-screen" class="loading-screen" style="display:none">
    <p id="error-msg" style="color:var(--red);padding:20px;text-align:center"></p>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="main-app" class="app-wrapper" style="display:none">

<header class="app-header">
    <div class="brand">
        <span class="brand-logo" id="brand-logo">ğŸ”</span>
        <div class="brand-info">
            <span class="brand-name" id="brand-name">VPN Shop</span>
            <span class="brand-slogan" id="brand-slogan"></span>
        </div>
    </div>
    <span class="header-badge" id="hdr-balance" onclick="go('profile')">0 â‚½</span>
</header>

<main class="app-content">

<!-- â•â•â• HOME â•â•â• -->
<section id="p-home" class="page active">
    <!-- Subscription card -->
    <div class="card sub-card">
        <div class="sub-card-top">
            <span class="sub-badge sub-badge-none" id="sub-badge">â€”</span>
            <span class="sub-expire" id="sub-expire"></span>
        </div>
        <div class="sub-traffic" id="sub-traffic"></div>
    </div>

    <!-- Actions -->
    <div class="action-pills">
        <button class="pill trial-pill" id="btn-trial" onclick="startTrial()" style="display:none">ğŸ&nbsp; ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾</button>
        <button class="pill pill-gold" onclick="buySubscription()">ğŸ›’&nbsp; ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ</button>
        <button class="pill pill-cyan" onclick="go('connect')">âŠ™&nbsp; Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ</button>
        <div class="pill-row">
            <button class="pill pill-outline" onclick="go('promo')">ğŸ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹</button>
            <button class="pill pill-outline" onclick="go('devices')">ğŸ“± Ğ£ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°</button>
        </div>
    </div>
</section>

<!-- â•â•â• PLANS â•â•â• -->
<section id="p-plans" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">â€¹</button>
        <h2 class="page-title">Ğ¢Ğ°Ñ€Ğ¸Ñ„Ğ½Ñ‹Ğµ Ğ¿Ğ»Ğ°Ğ½Ñ‹</h2>
    </div>
    <div id="plans-list" class="plans-list"></div>
</section>

<!-- â•â•â• CONNECT â•â•â• -->
<section id="p-connect" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">â€¹</button>
        <h2 class="page-title">ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ</h2>
    </div>
    <div class="card">
        <div class="card-title">Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸</div>
        <div class="connect-box">
            <code id="con-url">â€”</code>
            <button onclick="copyUrl()">ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
        </div>
    </div>
    <div class="card" id="con-actions" style="display:none">
        <div class="card-title">Ğ‘Ñ‹ÑÑ‚Ñ€Ğ¾Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ</div>
        <div class="action-pills">
            <button class="pill pill-cyan" id="btn-oneclick" onclick="">âš¡ ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğ² Ğ¾Ğ´Ğ¸Ğ½ ĞºĞ»Ğ¸Ğº</button>
            <button class="pill pill-outline" id="btn-subpage" onclick="">ğŸ“„ Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸</button>
        </div>
    </div>
    <div class="card">
        <div class="card-title">Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ</div>
        <div class="apps-grid">
            <a class="app-link" onclick="openLink('https://apps.apple.com/app/happ-proxy-utility-plus/id6746188973')"><span class="app-icon">ğŸ</span> iOS</a>
            <a class="app-link" onclick="openLink('https://play.google.com/store/apps/details?id=com.happproxy')"><span class="app-icon">ğŸ¤–</span> Android</a>
            <a class="app-link" onclick="openLink('https://github.com/Happ-proxy/happ-desktop/releases/latest/download/setup-Happ.x64.exe')"><span class="app-icon">ğŸªŸ</span> Windows</a>
            <a class="app-link" onclick="openLink('https://github.com/Happ-proxy/happ-desktop/releases/')"><span class="app-icon">ğŸ</span> macOS</a>
        </div>
    </div>
</section>

<!-- â•â•â• DEVICES â•â•â• -->
<section id="p-devices" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">â€¹</button>
        <h2 class="page-title">ĞœĞ¾Ğ¸ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°</h2>
    </div>
    <div id="devices-info" class="card">
        <div class="card-row"><span class="card-label">Ğ›Ğ¸Ğ¼Ğ¸Ñ‚</span><span class="card-value" id="dev-limit">â€”</span></div>
        <div class="card-row"><span class="card-label">Ğ—Ğ°Ğ½ÑÑ‚Ğ¾</span><span class="card-value" id="dev-used">â€”</span></div>
    </div>
    <div class="action-pills" style="margin-top:10px">
        <button class="pill pill-outline" id="btn-expand-devices" onclick="expandDevices()" style="display:none">â• Ğ Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ ÑĞ»Ğ¾Ñ‚Ñ‹ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²</button>
    </div>
</section>

<!-- â•â•â• PROMO â•â•â• -->
<section id="p-promo" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">â€¹</button>
        <h2 class="page-title">ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹</h2>
    </div>
    <div class="card">
        <div class="card-title">ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´</div>
        <div style="display:flex;gap:8px">
            <input class="form-input" id="promo-input" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ´" style="flex:1">
            <button class="btn btn-primary btn-sm" onclick="activatePromo()">OK</button>
        </div>
        <p id="promo-result" style="font-size:.8rem;margin-top:8px;display:none"></p>
    </div>
</section>

<!-- â•â•â• SUPPORT â•â•â• -->
<section id="p-support" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">â€¹</button>
        <h2 class="page-title">ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°</h2>
    </div>
    <div class="card card-compact" style="cursor:pointer" onclick="go('tickets')">
        <div class="card-title">ğŸ« Ğ¢Ğ¸ĞºĞµÑ‚Ñ‹ <span id="ticket-badge" class="ticket-badge" style="display:none">0</span></div>
        <span class="pill pill-cyan pill-sm">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</span>
    </div>
    <div class="card card-compact" id="support-community" style="display:none">
        <div class="card-title">ğŸ’¬ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğ¾</div>
        <button class="pill pill-cyan pill-sm" id="btn-community" onclick="">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
    </div>
    <div class="card card-compact" id="support-help" style="display:none">
        <div class="card-title">ğŸ›Ÿ ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ</div>
        <button class="pill pill-outline pill-sm" id="btn-support" onclick="">ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ</button>
    </div>
    <div class="card card-compact" id="support-tos" style="display:none">
        <div class="card-title">ğŸ“„ Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ğµ</div>
        <button class="pill pill-outline pill-sm" id="btn-tos" onclick="">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
    </div>
</section>

<!-- â•â•â• TICKET LIST â•â•â• -->
<section id="p-tickets" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('support')">â€¹</button>
        <h2 class="page-title">ĞœĞ¾Ğ¸ Ñ‚Ğ¸ĞºĞµÑ‚Ñ‹</h2>
        <button class="btn btn-primary btn-sm" onclick="showNewTicket()" style="margin-left:auto">+ ĞĞ¾Ğ²Ñ‹Ğ¹</button>
    </div>
    <div id="tickets-list" class="ticket-list"></div>
</section>

<!-- â•â•â• TICKET CHAT â•â•â• -->
<section id="p-ticket" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('tickets');loadTickets()">â€¹</button>
        <h2 class="page-title" id="ticket-title">Ğ¢Ğ¸ĞºĞµÑ‚</h2>
    </div>
    <div id="ticket-chat" class="ticket-chat"></div>
    <div id="ticket-reply" class="ticket-reply-box" style="display:none">
        <textarea id="ticket-text" placeholder="ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµâ€¦" rows="1"></textarea>
        <button class="ticket-send-btn" onclick="sendTicketReply()">â†’</button>
    </div>
    <div id="ticket-close-actions" class="ticket-close-actions" style="display:none">
        <button class="ticket-close-btn resolved" onclick="closeTicket(true)">âœ… Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ Ñ€ĞµÑˆÑ‘Ğ½</button>
        <button class="ticket-close-btn unresolved" onclick="closeTicket(false)">âŒ ĞĞµ Ñ€ĞµÑˆÑ‘Ğ½</button>
    </div>
</section>

<!-- â•â•â• PROFILE â•â•â• -->
<section id="p-profile" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">â€¹</button>
        <h2 class="page-title">ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</h2>
    </div>
    <div class="card">
        <div class="card-row"><span class="card-label">Ğ˜Ğ¼Ñ</span><span class="card-value" id="pr-name">â€”</span></div>
        <div class="card-row"><span class="card-label">Telegram</span><span class="card-value" id="pr-uname">â€”</span></div>
        <div class="card-row"><span class="card-label">ID</span><span class="card-value" id="pr-tid">â€”</span></div>
        <div class="card-row"><span class="card-label">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ</span><span class="card-value" id="pr-balance">â€”</span></div>
        <div class="card-row"><span class="card-label">Ğ Ğ¾Ğ»ÑŒ</span><span class="card-value" id="pr-role">â€”</span></div>
    </div>
    <!-- Balance -->
    <div class="card" id="balance-card" style="display:none">
        <div class="card-title">ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ</div>
        <div class="action-pills">
            <button class="pill pill-gold" onclick="topupBalance()">ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ</button>
        </div>
    </div>
    <!-- Referral -->
    <div class="card" id="ref-card" style="display:none">
        <div class="card-title">ğŸ¤ ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ³Ğ°</div>
        <div class="ref-box">
            <code id="ref-link">â€”</code>
            <button class="btn btn-primary btn-sm btn-full" onclick="copyRef()" style="margin-top:4px">Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ</button>
        </div>
    </div>
</section>

<!-- â•â•â• ADMIN â•â•â• -->
<section id="p-admin" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">â€¹</button>
        <h2 class="page-title">ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ</h2>
    </div>
    <div class="admin-tabs" id="adm-tabs">
        <button class="admin-tab active" onclick="admTab('stats')"><span class="tab-icon">ğŸ“Š</span><span class="tab-label">Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</span></button>
        <button class="admin-tab" onclick="admTab('users')"><span class="tab-icon">ğŸ‘¥</span><span class="tab-label">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸</span></button>
        <button class="admin-tab" onclick="admTab('plans')"><span class="tab-icon">ğŸ“‹</span><span class="tab-label">Ğ¢Ğ°Ñ€Ğ¸Ñ„Ñ‹</span></button>
        <button class="admin-tab" onclick="admTab('settings')"><span class="tab-icon">âš™ï¸</span><span class="tab-label">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</span></button>
        <button class="admin-tab" onclick="admTab('tickets')"><span class="tab-icon">ğŸ«</span><span class="tab-label">Ğ¢Ğ¸ĞºĞµÑ‚Ñ‹</span></button>
        <button class="admin-tab" onclick="admTab('brand')"><span class="tab-icon">ğŸ¨</span><span class="tab-label">Ğ‘Ñ€ĞµĞ½Ğ´</span></button>
    </div>

    <!-- Stats -->
    <div id="adm-stats" class="admin-content active">
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="st-total">â€”</div><div class="stat-label">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</div></div>
            <div class="stat-card"><div class="stat-value" id="st-active">â€”</div><div class="stat-label">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…</div></div>
            <div class="stat-card"><div class="stat-value" id="st-expired">â€”</div><div class="stat-label">Ğ˜ÑÑ‚ĞµĞºÑˆĞ¸Ñ…</div></div>
            <div class="stat-card"><div class="stat-value" id="st-revenue">â€”</div><div class="stat-label">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ â‚½</div></div>
        </div>
    </div>
    <!-- Users -->
    <div id="adm-users" class="admin-content">
        <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="user-search" placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ / ID" oninput="filterUsers()">
        </div>
        <div id="users-list" class="user-list"></div>
    </div>
    <!-- Plans admin -->
    <div id="adm-plans" class="admin-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
            <span style="color:var(--text2);font-size:.84rem" id="adm-plans-count">Ğ¢Ğ°Ñ€Ğ¸Ñ„Ñ‹</span>
            <button class="btn btn-primary btn-sm" onclick="showCreatePlan()">+ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ</button>
        </div>
        <div id="adm-plans-list" class="plans-list"></div>
    </div>
    <!-- Settings -->
    <div id="adm-settings" class="admin-content"><div id="settings-list"></div></div>
    <!-- Admin Tickets -->
    <div id="adm-tickets" class="admin-content">
        <div id="adm-tickets-list" class="ticket-list"></div>
    </div>
    <!-- Brand -->
    <div id="adm-brand" class="admin-content">
        <div class="card">
            <div class="card-title">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±Ñ€ĞµĞ½Ğ´Ğ°</div>
            <div class="form-group"><label>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</label><input class="form-input" id="br-name" placeholder="VPN Shop"></div>
            <div class="form-group"><label>Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ (ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ¸Ğ»Ğ¸ URL ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸)</label><input class="form-input" id="br-logo" placeholder="ğŸ” Ğ¸Ğ»Ğ¸ https://..."></div>
            <div class="form-group"><label>Ğ¡Ğ»Ğ¾Ğ³Ğ°Ğ½</label><input class="form-input" id="br-slogan" placeholder=""></div>
            <button class="btn btn-primary btn-full" onclick="saveBrand()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
        </div>
    </div>
</section>

<!-- â•â•â• ADMIN USER DETAIL â•â•â• -->
<section id="p-auser" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="admTab('users');go('admin')">â€¹</button>
        <h2 class="page-title" id="aud-title">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</h2>
    </div>
    <div id="aud-body"></div>
</section>

<!-- â•â•â• ADMIN TICKET DETAIL â•â•â• -->
<section id="p-aticket" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="admTab('tickets');go('admin')">â€¹</button>
        <h2 class="page-title" id="at-title">Ğ¢Ğ¸ĞºĞµÑ‚</h2>
    </div>
    <div id="at-chat" class="ticket-chat"></div>
    <div id="at-reply" class="ticket-reply-box">
        <textarea id="at-text" placeholder="ĞÑ‚Ğ²ĞµÑ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°â€¦" rows="1"></textarea>
        <button class="ticket-send-btn" onclick="sendAdmTicketReply()">â†’</button>
    </div>
</section>

</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <button class="nav-item active" data-p="home" onclick="go('home')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span>Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ</span>
    </button>
    <button class="nav-item" data-p="support" onclick="go('support')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        <span>ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°</span>
    </button>
    <button class="nav-item" data-p="profile" onclick="go('profile')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span>ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</span>
    </button>
    <button class="nav-item admin-nav" data-p="admin" onclick="go('admin')" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        <span>ĞĞ´Ğ¼Ğ¸Ğ½</span>
    </button>
</nav>
</div>

<button class="ticket-fab" id="ticket-fab" onclick="go('tickets')" title="ĞĞ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ">ğŸ’¬<span class="fab-badge" id="fab-badge"></span></button>
<div id="modal-root"></div>
<div id="toast" class="toast"></div>
</div>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBALS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const API='/web', tg=window.Telegram.WebApp;
let D=null, BRAND={name:'VPN Shop',logo:'ğŸ”',slogan:''}, IS_ADMIN=false;
let usersCache=[], curAdmTab='stats', DOMAIN='';
const AVAIL_LABELS={ALL:'Ğ’ÑĞµ',NEW:'ĞĞ¾Ğ²Ñ‹Ğµ',EXISTING:'Ğ”ĞµĞ¹ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ',INVITED:'ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ',ALLOWED:'Ğ Ğ°Ğ·Ñ€ĞµÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ',TRIAL:'ĞŸÑ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹'};
const TYPE_LABELS={TRAFFIC:'Ğ¢Ñ€Ğ°Ñ„Ğ¸Ğº',DEVICES:'Ğ£ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°',BOTH:'Ğ¢Ñ€Ğ°Ñ„Ğ¸Ğº+Ğ£ÑÑ‚Ñ€.',UNLIMITED:'Ğ‘ĞµĞ·Ğ»Ğ¸Ğ¼Ğ¸Ñ‚'};
const CURRENCY_SYMBOLS={USD:'$',EUR:'â‚¬',XTR:'â˜…',RUB:'â‚½'};

/* â”€â”€ i18n â”€â”€ */
const I18N={
    RU:{
        home:'Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ',support:'ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°',profile:'ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ',admin:'ĞĞ´Ğ¼Ğ¸Ğ½',
        buy:'ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ',trial:'ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾',connect:'Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ',
        promo:'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹',devices:'Ğ£ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°',plans:'Ğ¢Ğ°Ñ€Ğ¸Ñ„Ğ½Ñ‹Ğµ Ğ¿Ğ»Ğ°Ğ½Ñ‹',
        connect_title:'ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ',devices_title:'ĞœĞ¾Ğ¸ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°',
        sub_link:'Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸',copy:'ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ',download:'Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ',
        no_sub:'ĞĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸',active:'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°',expired:'Ğ˜ÑÑ‚ĞµĞºĞ»Ğ°',trial_period:'ĞŸÑ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´',
        limit:'Ğ›Ğ¸Ğ¼Ğ¸Ñ‚',used:'Ğ—Ğ°Ğ½ÑÑ‚Ğ¾',expand_devices:'Ğ Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ ÑĞ»Ğ¾Ñ‚Ñ‹ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²',
        activate_promo:'ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´',enter_code:'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ´',
        tickets:'Ğ¢Ğ¸ĞºĞµÑ‚Ñ‹',community:'Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğ¾',help:'ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ',open:'ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ',write:'ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ',
        my_tickets:'ĞœĞ¾Ğ¸ Ñ‚Ğ¸ĞºĞµÑ‚Ñ‹',new_ticket:'ĞĞ¾Ğ²Ñ‹Ğ¹',
        name:'Ğ˜Ğ¼Ñ',telegram:'Telegram',balance:'Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ',role:'Ğ Ğ¾Ğ»ÑŒ',
        invite_friend:'ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ³Ğ°',copy_link:'Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ',
        remains:'ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ',days_left:'Ğ´Ğ½.',
        select_period:'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´:',cancel:'ĞÑ‚Ğ¼ĞµĞ½Ğ°',close:'Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ',
        active_sub_note:'Ğ£ Ğ²Ğ°Ñ ĞµÑÑ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°. ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ±ÑƒĞ´ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ° Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°.',
        not_enough:'ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑÑ€ĞµĞ´ÑÑ‚Ğ². Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ:',processing:'ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸â€¦',
        sub_done:'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ°!',purchase_error:'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸',net_error:'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸',
        trial_activating:'ĞĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸â€¦',trial_done:'ĞŸÑ€Ğ¾Ğ±Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°!',
        trial_go_connect:'ĞŸĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ñ€Ğ°Ğ·Ğ´ĞµĞ» Â«ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸ĞµÂ» Ğ´Ğ»Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸.',
        setup:'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ',expand_unavail:'ĞĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾',
        expand_trial_msg:'Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ ÑĞ»Ğ¾Ñ‚Ğ¾Ğ² ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ² Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ² Ğ¿Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞµ. ĞŸÑ€Ğ¸Ğ¾Ğ±Ñ€ĞµÑ‚Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ‚Ğ°Ñ€Ğ¸Ñ„.',
        buy_plan:'ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ Ñ‚Ğ°Ñ€Ğ¸Ñ„',
        no_plans:'ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¾Ğ²',loading:'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦',error:'ĞÑˆĞ¸Ğ±ĞºĞ°',
        savings:'Ğ’Ñ‹Ğ³Ğ¾Ğ´Ğ°',
        new_ticket_title:'ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸ĞºĞµÑ‚',subject:'Ğ¢ĞµĞ¼Ğ°',message:'Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ',send:'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ',
        fill_all:'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ',ticket_created:'Ğ¢Ğ¸ĞºĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½',
        resolved:'Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ Ñ€ĞµÑˆÑ‘Ğ½',unresolved:'ĞĞµ Ñ€ĞµÑˆÑ‘Ğ½',
        ticket_closed_resolved:'Ğ¢Ğ¸ĞºĞµÑ‚ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚ ĞºĞ°Ğº Ñ€ĞµÑˆÑ‘Ğ½Ğ½Ñ‹Ğ¹',ticket_closed_unresolved:'Ğ¢Ğ¸ĞºĞµÑ‚ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚ ĞºĞ°Ğº Ğ½ĞµÑ€ĞµÑˆÑ‘Ğ½Ğ½Ñ‹Ğ¹',
        copied:'Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾!',link_copied:'Ğ¡ÑÑ‹Ğ»ĞºĞ° ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°!',no_sub_err:'ĞĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸',
        user_role:'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ',admin_role:'ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€',dev_role:'Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº',
        agreement:'ĞÑ„ĞµÑ€Ñ‚Ğ°',no_tickets:'ĞĞµÑ‚ Ñ‚Ğ¸ĞºĞµÑ‚Ğ¾Ğ²',create_first:'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸ĞºĞµÑ‚',
        write_msg:'ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµâ€¦',
        traffic:'Ğ¢Ñ€Ğ°Ñ„Ğ¸Ğº',dev_short:'ÑƒÑÑ‚Ñ€.',select_plan:'Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ñ€Ğ¸Ñ„',to_date:'Ğ´Ğ¾',topup:'ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ',
        topup_via_bot:'ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· Ğ±Ğ¾Ñ‚Ğ°',expand_via_bot:'Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· Ğ±Ğ¾Ñ‚Ğ°',
        promo_activated:'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½!',quick_connect:'Ğ‘Ñ‹ÑÑ‚Ñ€Ğ¾Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ',one_click:'ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğ² Ğ¾Ğ´Ğ¸Ğ½ ĞºĞ»Ğ¸Ğº',
        sub_page:'Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸',no_active_sub:'ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸',saved:'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾',
        auth_error:'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¸Ğ· Telegram.',user_not_found:'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ğ°.',
    },
    EN:{
        home:'Home',support:'Support',profile:'Profile',admin:'Admin',
        buy:'Buy',trial:'Try for free',connect:'Install & Setup',
        promo:'Promo codes',devices:'Devices',plans:'Plans',
        connect_title:'Connection',devices_title:'My Devices',
        sub_link:'Subscription Link',copy:'Copy',download:'Download App',
        no_sub:'No subscription',active:'Active',expired:'Expired',trial_period:'Trial',
        limit:'Limit',used:'Used',expand_devices:'Expand device slots',
        activate_promo:'Activate promo code',enter_code:'Enter code',
        tickets:'Tickets',community:'Community',help:'Help',open:'Open',write:'Write',
        my_tickets:'My Tickets',new_ticket:'New',
        name:'Name',telegram:'Telegram',balance:'Balance',role:'Role',
        invite_friend:'Invite a friend',copy_link:'Copy link',
        remains:'Remaining',days_left:'d.',
        select_period:'Choose period:',cancel:'Cancel',close:'Close',
        active_sub_note:'You have an active subscription. Payment will be deducted from balance.',
        not_enough:'Not enough funds. Balance:',processing:'Processing purchaseâ€¦',
        sub_done:'Subscription activated!',purchase_error:'Purchase error',net_error:'Network error',
        trial_activating:'Activating trial subscriptionâ€¦',trial_done:'Trial subscription activated!',
        trial_go_connect:'Go to "Connection" section to configure.',
        setup:'Setup',expand_unavail:'Unavailable',
        expand_trial_msg:'Device expansion is not available on trial. Purchase a full plan.',
        buy_plan:'Buy plan',
        no_plans:'No available plans',loading:'Loadingâ€¦',error:'Error',
        savings:'Save',
        new_ticket_title:'New Ticket',subject:'Subject',message:'Message',send:'Send',
        fill_all:'Fill in all fields',ticket_created:'Ticket created',
        resolved:'Resolved',unresolved:'Not resolved',
        ticket_closed_resolved:'Ticket closed as resolved',ticket_closed_unresolved:'Ticket closed as unresolved',
        copied:'Copied!',link_copied:'Link copied!',no_sub_err:'No subscription',
        user_role:'User',admin_role:'Administrator',dev_role:'Developer',
        agreement:'Terms',no_tickets:'No tickets',create_first:'Create your first ticket',
        write_msg:'Write a messageâ€¦',
        traffic:'Traffic',dev_short:'dev.',select_plan:'Select plan',to_date:'until',topup:'Top up',
        topup_via_bot:'Top up balance via bot',expand_via_bot:'Device expansion available via bot',
        promo_activated:'Promo code activated!',quick_connect:'Quick connect',one_click:'One-click connect',
        sub_page:'Subscription page',no_active_sub:'No active subscription',saved:'Saved',
        auth_error:'Auth error. Open from Telegram.',user_not_found:'User not found. Start the bot.',
    },
    UK:{
        home:'Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ°',support:'ĞŸÑ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ°',profile:'ĞŸÑ€Ğ¾Ñ„Ñ–Ğ»ÑŒ',admin:'ĞĞ´Ğ¼Ñ–Ğ½',
        buy:'ĞšÑƒĞ¿Ğ¸Ñ‚Ğ¸',trial:'Ğ¡Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ±ĞµĞ·ĞºĞ¾ÑˆÑ‚Ğ¾Ğ²Ğ½Ğ¾',connect:'Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ñ‚Ğ° Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ñ‚Ğ¸',
        promo:'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¸',devices:'ĞŸÑ€Ğ¸ÑÑ‚Ñ€Ğ¾Ñ—',plans:'Ğ¢Ğ°Ñ€Ğ¸Ñ„Ğ½Ñ– Ğ¿Ğ»Ğ°Ğ½Ğ¸',
        connect_title:'ĞŸÑ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ',devices_title:'ĞœĞ¾Ñ— Ğ¿Ñ€Ğ¸ÑÑ‚Ñ€Ğ¾Ñ—',
        sub_link:'ĞŸĞ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞºĞ¸',copy:'ĞšĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ñ‚Ğ¸',download:'Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¾Ğº',
        no_sub:'ĞĞµĞ¼Ğ°Ñ” Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞºĞ¸',active:'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°',expired:'Ğ—Ğ°ĞºÑ–Ğ½Ñ‡Ğ¸Ğ»Ğ°ÑÑŒ',trial_period:'ĞŸÑ€Ğ¾Ğ±Ğ½Ğ¸Ğ¹ Ğ¿ĞµÑ€Ñ–Ğ¾Ğ´',
        limit:'Ğ›Ñ–Ğ¼Ñ–Ñ‚',used:'Ğ—Ğ°Ğ¹Ğ½ÑÑ‚Ğ¾',expand_devices:'Ğ Ğ¾Ğ·ÑˆĞ¸Ñ€Ğ¸Ñ‚Ğ¸ ÑĞ»Ğ¾Ñ‚Ğ¸ Ğ¿Ñ€Ğ¸ÑÑ‚Ñ€Ğ¾Ñ—Ğ²',
        activate_promo:'ĞĞºÑ‚Ğ¸Ğ²ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´',enter_code:'Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ ĞºĞ¾Ğ´',
        tickets:'Ğ¢Ñ–ĞºĞµÑ‚Ğ¸',community:'Ğ¡Ğ¿Ñ–Ğ»ÑŒĞ½Ğ¾Ñ‚Ğ°',help:'Ğ”Ğ¾Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°',open:'Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸',write:'ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸',
        my_tickets:'ĞœĞ¾Ñ— Ñ‚Ñ–ĞºĞµÑ‚Ğ¸',new_ticket:'ĞĞ¾Ğ²Ğ¸Ğ¹',
        name:'Ğ†Ğ¼Ê¼Ñ',telegram:'Telegram',balance:'Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ',role:'Ğ Ğ¾Ğ»ÑŒ',
        invite_friend:'Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ°',copy_link:'Ğ¡ĞºĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ñ‚Ğ¸ Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ',
        remains:'Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¸Ğ»Ğ¾ÑÑŒ',days_left:'Ğ´Ğ½.',
        select_period:'ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ğ¿ĞµÑ€Ñ–Ğ¾Ğ´:',cancel:'Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸',close:'Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸',
        active_sub_note:'Ğ£ Ğ²Ğ°Ñ Ñ” Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞºĞ°. ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ±ÑƒĞ´Ğµ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ° Ğ· Ğ±Ğ°Ğ»Ğ°Ğ½ÑÑƒ.',
        not_enough:'ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ½ÑŒĞ¾ ĞºĞ¾ÑˆÑ‚Ñ–Ğ². Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ:',processing:'ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸â€¦',
        sub_done:'ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞºÑƒ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¾!',purchase_error:'ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸',net_error:'ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¼ĞµÑ€ĞµĞ¶Ñ–',
        trial_activating:'ĞĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ñ–Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ½Ğ¾Ñ— Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞºĞ¸â€¦',trial_done:'ĞŸÑ€Ğ¾Ğ±Ğ½Ñƒ Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞºÑƒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¾!',
        trial_go_connect:'ĞŸĞµÑ€ĞµĞ¹Ğ´Ñ–Ñ‚ÑŒ Ğ´Ğ¾ Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»Ñƒ Â«ĞŸÑ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ½ÑÂ» Ğ´Ğ»Ñ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ.',
        setup:'ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ñ‚Ğ¸',expand_unavail:'ĞĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾',
        expand_trial_msg:'Ğ Ğ¾Ğ·ÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ ÑĞ»Ğ¾Ñ‚Ñ–Ğ² Ğ¿Ñ€Ğ¸ÑÑ‚Ñ€Ğ¾Ñ—Ğ² Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğµ Ğ² Ğ¿Ñ€Ğ¾Ğ±Ğ½Ñ–Ğ¹ Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑÑ†Ñ–. ĞŸÑ€Ğ¸Ğ´Ğ±Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ Ñ‚Ğ°Ñ€Ğ¸Ñ„.',
        buy_plan:'ĞšÑƒĞ¿Ğ¸Ñ‚Ğ¸ Ñ‚Ğ°Ñ€Ğ¸Ñ„',
        no_plans:'ĞĞµĞ¼Ğ°Ñ” Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ñ… Ñ‚Ğ°Ñ€Ğ¸Ñ„Ñ–Ğ²',loading:'Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñâ€¦',error:'ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°',
        savings:'Ğ’Ğ¸Ğ³Ğ¾Ğ´Ğ°',
        new_ticket_title:'ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ñ–ĞºĞµÑ‚',subject:'Ğ¢ĞµĞ¼Ğ°',message:'ĞŸĞ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ',send:'ĞĞ°Ğ´Ñ–ÑĞ»Ğ°Ñ‚Ğ¸',
        fill_all:'Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½Ñ–Ñ‚ÑŒ Ğ²ÑÑ– Ğ¿Ğ¾Ğ»Ñ',ticket_created:'Ğ¢Ñ–ĞºĞµÑ‚ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾',
        resolved:'ĞŸĞ¸Ñ‚Ğ°Ğ½Ğ½Ñ Ğ²Ğ¸Ñ€Ñ–ÑˆĞµĞ½Ğ¾',unresolved:'ĞĞµ Ğ²Ğ¸Ñ€Ñ–ÑˆĞµĞ½Ğ¾',
        ticket_closed_resolved:'Ğ¢Ñ–ĞºĞµÑ‚ Ğ·Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¾ ÑĞº Ğ²Ğ¸Ñ€Ñ–ÑˆĞµĞ½Ğ¸Ğ¹',ticket_closed_unresolved:'Ğ¢Ñ–ĞºĞµÑ‚ Ğ·Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¾ ÑĞº Ğ½ĞµĞ²Ğ¸Ñ€Ñ–ÑˆĞµĞ½Ğ¸Ğ¹',
        copied:'Ğ¡ĞºĞ¾Ğ¿Ñ–Ğ¹Ğ¾Ğ²Ğ°Ğ½Ğ¾!',link_copied:'ĞŸĞ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ ÑĞºĞ¾Ğ¿Ñ–Ğ¹Ğ¾Ğ²Ğ°Ğ½Ğ¾!',no_sub_err:'ĞĞµĞ¼Ğ°Ñ” Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞºĞ¸',
        user_role:'ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡',admin_role:'ĞĞ´Ğ¼Ñ–Ğ½Ñ–ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€',dev_role:'Ğ Ğ¾Ğ·Ñ€Ğ¾Ğ±Ğ½Ğ¸Ğº',
        agreement:'ĞÑ„ĞµÑ€Ñ‚Ğ°',no_tickets:'ĞĞµĞ¼Ğ°Ñ” Ñ‚Ñ–ĞºĞµÑ‚Ñ–Ğ²',create_first:'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ñ–Ñ‚ÑŒ Ğ¿ĞµÑ€ÑˆĞ¸Ğ¹ Ñ‚Ñ–ĞºĞµÑ‚',
        write_msg:'ĞĞ°Ğ¿Ğ¸ÑˆÑ–Ñ‚ÑŒ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñâ€¦',
        traffic:'Ğ¢Ñ€Ğ°Ñ„Ñ–Ğº',dev_short:'Ğ¿Ñ€Ğ¸ÑÑ‚Ñ€.',select_plan:'ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ñ‚Ğ°Ñ€Ğ¸Ñ„',to_date:'Ğ´Ğ¾',topup:'ĞŸĞ¾Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ñ‚Ğ¸',
        topup_via_bot:'ĞŸĞ¾Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ½Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑÑƒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ±Ğ¾Ñ‚Ğ°',expand_via_bot:'Ğ Ğ¾Ğ·ÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¸ÑÑ‚Ñ€Ğ¾Ñ—Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ±Ğ¾Ñ‚Ğ°',
        promo_activated:'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¾!',quick_connect:'Ğ¨Ğ²Ğ¸Ğ´ĞºĞµ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ',one_click:'ĞŸÑ–Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğ¸ÑÑ Ğ² Ğ¾Ğ´Ğ¸Ğ½ ĞºĞ»Ñ–Ğº',
        sub_page:'Ğ¡Ñ‚Ğ¾Ñ€Ñ–Ğ½ĞºĞ° Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞºĞ¸',no_active_sub:'ĞĞµĞ¼Ğ°Ñ” Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ñ— Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞºĞ¸',saved:'Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾',
        auth_error:'ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ—. Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ğ¹Ñ‚Ğµ Ğ· Telegram.',user_not_found:'ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°.',
    },
    DE:{
        home:'Startseite',support:'Support',profile:'Profil',admin:'Admin',
        buy:'Kaufen',trial:'Kostenlos testen',connect:'Installieren & Einrichten',
        promo:'Promocodes',devices:'GerÃ¤te',plans:'Tarife',
        connect_title:'Verbindung',devices_title:'Meine GerÃ¤te',
        sub_link:'Abo-Link',copy:'Kopieren',download:'App herunterladen',
        no_sub:'Kein Abo',active:'Aktiv',expired:'Abgelaufen',trial_period:'Testphase',
        limit:'Limit',used:'Belegt',expand_devices:'GerÃ¤teslots erweitern',
        activate_promo:'Promocode aktivieren',enter_code:'Code eingeben',
        tickets:'Tickets',community:'Community',help:'Hilfe',open:'Ã–ffnen',write:'Schreiben',
        my_tickets:'Meine Tickets',new_ticket:'Neu',
        name:'Name',telegram:'Telegram',balance:'Guthaben',role:'Rolle',
        invite_friend:'Freund einladen',copy_link:'Link kopieren',
        remains:'Verbleibend',days_left:'T.',
        select_period:'Zeitraum wÃ¤hlen:',cancel:'Abbrechen',close:'SchlieÃŸen',
        active_sub_note:'Sie haben ein aktives Abo. Zahlung wird vom Guthaben abgezogen.',
        not_enough:'Nicht genug Guthaben. Saldo:',processing:'Kauf wird bearbeitetâ€¦',
        sub_done:'Abo abgeschlossen!',purchase_error:'Kauffehler',net_error:'Netzwerkfehler',
        trial_activating:'Test-Abo wird aktiviertâ€¦',trial_done:'Test-Abo aktiviert!',
        trial_go_connect:'Gehen Sie zum Abschnitt "Verbindung" zur Einrichtung.',
        setup:'Einrichten',expand_unavail:'Nicht verfÃ¼gbar',
        expand_trial_msg:'GerÃ¤teerweiterung im Testabo nicht verfÃ¼gbar. Erwerben Sie einen vollen Tarif.',
        buy_plan:'Tarif kaufen',
        no_plans:'Keine verfÃ¼gbaren Tarife',loading:'Ladenâ€¦',error:'Fehler',
        savings:'Ersparnis',
        new_ticket_title:'Neues Ticket',subject:'Betreff',message:'Nachricht',send:'Senden',
        fill_all:'Alle Felder ausfÃ¼llen',ticket_created:'Ticket erstellt',
        resolved:'GelÃ¶st',unresolved:'Nicht gelÃ¶st',
        ticket_closed_resolved:'Ticket als gelÃ¶st geschlossen',ticket_closed_unresolved:'Ticket als ungelÃ¶st geschlossen',
        copied:'Kopiert!',link_copied:'Link kopiert!',no_sub_err:'Kein Abo',
        user_role:'Benutzer',admin_role:'Administrator',dev_role:'Entwickler',
        agreement:'AGB',no_tickets:'Keine Tickets',create_first:'Erstellen Sie Ihr erstes Ticket',
        write_msg:'Nachricht schreibenâ€¦',
        traffic:'Traffic',dev_short:'Ger.',select_plan:'Tarif wÃ¤hlen',to_date:'bis',topup:'Aufladen',
        topup_via_bot:'Guthaben Ã¼ber Bot aufladen',expand_via_bot:'GerÃ¤teerweiterung Ã¼ber Bot verfÃ¼gbar',
        promo_activated:'Promocode aktiviert!',quick_connect:'Schnellverbindung',one_click:'Ein-Klick-Verbindung',
        sub_page:'Abo-Seite',no_active_sub:'Kein aktives Abo',saved:'Gespeichert',
        auth_error:'Auth-Fehler. Aus Telegram Ã¶ffnen.',user_not_found:'Benutzer nicht gefunden. Bot starten.',
    }
};
let CUR_LOCALE='RU';
function t(k){return (I18N[CUR_LOCALE]||I18N.RU)[k]||(I18N.RU[k]||k)}
function applyLocale(){
    // Navigation labels
    document.querySelectorAll('.nav-item').forEach(b=>{
        const pg=b.dataset.p;
        if(pg==='home') b.querySelector('span').textContent=t('home');
        if(pg==='support') b.querySelector('span').textContent=t('support');
        if(pg==='profile') b.querySelector('span').textContent=t('profile');
        if(pg==='admin') b.querySelector('span').textContent=t('admin');
    });
    // Home page buttons
    const hp=$('p-home');
    if(hp){
        const trial=$('btn-trial');if(trial)trial.innerHTML='ğŸ&nbsp; '+t('trial');
        const pills=hp.querySelectorAll('.pill');
        pills.forEach(p=>{
            const oc=p.getAttribute('onclick')||'';
            if(oc.includes('buySubscription')) p.innerHTML='ğŸ›’&nbsp; '+t('buy');
            if(oc.includes("go('connect')")) p.innerHTML='âŠ™&nbsp; '+t('connect');
            if(oc.includes("go('promo')")) p.innerHTML='ğŸ '+t('promo');
            if(oc.includes("go('devices')")) p.innerHTML='ğŸ“± '+t('devices');
        });
    }
    // Page titles
    const pts={'p-plans':'plans','p-connect':'connect_title','p-devices':'devices_title','p-promo':'promo','p-support':'support','p-tickets':'my_tickets','p-profile':'profile'};
    Object.entries(pts).forEach(([id,key])=>{const el=$(id);if(el){const tt=el.querySelector('.page-title');if(tt)tt.textContent=t(key)}});
    // Connect page
    const cp=$('p-connect');
    if(cp){
        const titles=cp.querySelectorAll('.card-title');
        if(titles[0])titles[0].textContent=t('sub_link');
        if(titles[1])titles[1].textContent=t('quick_connect');
        if(titles[2])titles[2].textContent=t('download');
        const copyBtn=cp.querySelector('.connect-box button');if(copyBtn)copyBtn.textContent=t('copy');
        const cpills=cp.querySelectorAll('.pill');
        cpills.forEach(p=>{
            const oc=p.getAttribute('onclick')||'',id=p.id||'';
            if(id==='btn-oneclick') p.innerHTML='âš¡ '+t('one_click');
            if(id==='btn-subpage') p.innerHTML='ğŸ“„ '+t('sub_page');
        });
    }
    // Devices page
    const dp=$('p-devices');
    if(dp){
        const labels=dp.querySelectorAll('.card-label');
        if(labels[0])labels[0].textContent=t('limit');
        if(labels[1])labels[1].textContent=t('used');
        const eb=$('btn-expand-devices');if(eb)eb.innerHTML='â• '+t('expand_devices');
    }
    // Promo page
    const pp=$('p-promo');
    if(pp){
        const ct=pp.querySelector('.card-title');if(ct)ct.textContent=t('activate_promo');
        const inp=$('promo-input');if(inp)inp.placeholder=t('enter_code');
    }
    // Support page
    const sp=$('p-support');
    if(sp){
        const cards=sp.querySelectorAll('.card');
        cards.forEach(c=>{
            const ct=c.querySelector('.card-title');if(!ct)return;
            if(ct.textContent.includes('ğŸ«')||ct.querySelector('#ticket-badge')){ct.childNodes[0].textContent='ğŸ« '+t('tickets')+' '}
            if(ct.textContent.includes('ğŸ’¬')) ct.textContent='ğŸ’¬ '+t('community');
            if(ct.textContent.includes('ğŸ›Ÿ')) ct.textContent='ğŸ›Ÿ '+t('help');
            if(ct.textContent.includes('ğŸ“„')) ct.textContent='ğŸ“„ '+t('agreement');
        });
        sp.querySelectorAll('.pill').forEach(p=>{
            const oc=p.getAttribute('onclick')||'',id=p.id||'';
            if(oc.includes("go('tickets')")) p.textContent=t('open');
            if(id==='btn-community') p.textContent=t('open');
            if(id==='btn-support') p.textContent=t('write');
            if(id==='btn-tos') p.textContent=t('open');
        });
    }
    // Tickets page
    const tp=$('p-tickets');
    if(tp){const nb=tp.querySelector('.btn');if(nb&&nb.textContent.includes('ĞĞ¾Ğ²Ñ‹Ğ¹')||nb&&nb.textContent.includes('New')||nb)nb.textContent='+ '+t('new_ticket')}
    // Ticket chat
    const ttext=$('ticket-text');if(ttext)ttext.placeholder=t('write_msg');
    const cbtns=$('ticket-close-actions');
    if(cbtns){
        const btns=cbtns.querySelectorAll('.ticket-close-btn');
        if(btns[0])btns[0].innerHTML='âœ… '+t('resolved');
        if(btns[1])btns[1].innerHTML='âŒ '+t('unresolved');
    }
    // Profile page
    const pf=$('p-profile');
    if(pf){
        const labels=pf.querySelectorAll('.card-label');
        if(labels[0])labels[0].textContent=t('name');
        if(labels[1])labels[1].textContent=t('telegram');
        if(labels[2])labels[2].textContent='ID';
        if(labels[3])labels[3].textContent=t('balance');
        if(labels[4])labels[4].textContent=t('role');
        const cardTitles=pf.querySelectorAll('.card-title');
        cardTitles.forEach(ct=>{
            if(ct.textContent.includes('ğŸ’°'))ct.textContent='ğŸ’° '+t('balance');
            if(ct.textContent.includes('ğŸ¤'))ct.textContent='ğŸ¤ '+t('invite_friend');
        });
        const pfPills=pf.querySelectorAll('.pill');
        pfPills.forEach(p=>{
            if((p.getAttribute('onclick')||'').includes('topupBalance'))p.textContent=t('topup');
            if((p.getAttribute('onclick')||'').includes('copyRef'))p.textContent=t('copy_link');
        });
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function init(){
    tg.ready(); tg.expand();
    try{tg.setHeaderColor('#080C14')}catch(e){}
    try{tg.setBackgroundColor('#080C14')}catch(e){}
    initParticles();
    try{
        const a=await fetch(API+'/api/auth/tg',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData:tg.initData})});
        if(!a.ok) return showErr('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¸Ğ· Telegram.');
        const dr=await fetch(API+'/api/user/data');
        if(!dr.ok) return showErr('ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ğ°.');
        D=await dr.json();
        try{const br=await fetch(API+'/api/settings/brand');if(br.ok)BRAND=await br.json()}catch(e){}
        try{const cfg=await fetch(API+'/api/config');if(cfg.ok){const c=await cfg.json();DOMAIN=c.domain||''}}catch(e){}
        IS_ADMIN=D.user.role==='DEV'||D.user.role==='ADMIN';
        // Set locale from bot_locale or user language
        const bl=(D.bot_locale||'').toUpperCase();
        if(['RU','EN','UK','DE'].includes(bl)) CUR_LOCALE=bl;
        else {
            const ul=(D.user.language||'').toUpperCase();
            if(['RU','EN','UK','DE'].includes(ul)) CUR_LOCALE=ul;
        }
        $('loading-screen').style.display='none';
        $('main-app').style.display='flex';
        if(IS_ADMIN) document.querySelectorAll('.admin-nav').forEach(e=>e.style.display='');
        render();
        applyLocale();
        // Start polling ticket status every 15 seconds
        setInterval(pollTicketStatus, 15000);
    }catch(e){showErr(t('error')+': '+e.message)}
}

function initParticles(){
    if(typeof particlesJS!=='undefined'){
        particlesJS('particles-js',{
            particles:{
                number:{value:60,density:{enable:true,value_area:800}},
                color:{value:'#24C4F1'},
                shape:{type:'circle'},
                opacity:{value:0.25,random:true,anim:{enable:false}},
                size:{value:2,random:true,anim:{enable:false}},
                line_linked:{enable:true,distance:180,color:'#24C4F1',opacity:0.08,width:1},
                move:{enable:true,speed:0.6,direction:'none',random:false,straight:false,out_mode:'out',bounce:false}
            },
            interactivity:{
                detect_on:'window',
                events:{onhover:{enable:true,mode:'grab'},onclick:{enable:true,mode:'push'},resize:true},
                modes:{grab:{distance:140,line_linked:{opacity:0.3}},push:{particles_nb:1}}
            },
            retina_detect:true
        });
    }
}

function showErr(m){$('loading-screen').style.display='none';$('error-screen').style.display='flex';$('error-msg').textContent=m}
function $(id){return document.getElementById(id)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const mainPages=['home','support','profile','admin'];
let curPage='home';
function go(p){
    curPage=p;
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    $('p-'+p).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.toggle('active',b.dataset.p===p));
    if(p==='home'){tg.BackButton.hide()}else{tg.BackButton.show();tg.BackButton.offClick(goHome);tg.BackButton.onClick(goHome)}
    if(p==='admin')loadAdm(curAdmTab);
    if(p==='plans')renderPlans();
    if(p==='tickets')loadTickets();
    updateFab();
}
function goHome(){go('home')}
function updateFab(){
    const fab=$('ticket-fab'), badge=$('fab-badge');
    // Show only on home page and only when there are open tickets (not closed/resolved)
    if(curPage==='home' && D.has_open_tickets){
        fab.style.display='flex';
        // Gold pulse if admin replied (unread)
        if(D.ticket_unread>0){
            fab.classList.add('has-reply');
            badge.textContent=D.ticket_unread;
            badge.style.display='flex';
        } else {
            fab.classList.remove('has-reply');
            badge.style.display='none';
        }
    } else {
        fab.style.display='none';
        fab.classList.remove('has-reply');
        badge.style.display='none';
    }
}
async function pollTicketStatus(){
    try{
        const r=await fetch(API+'/api/tickets/status');
        if(!r.ok)return;
        const s=await r.json();
        D.has_open_tickets=s.has_open;
        D.ticket_unread=s.unread;
        updateFab();
    }catch(e){}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render(){
    // Brand logo: URL â†’ <img>, otherwise emoji text
    const logoEl=$('brand-logo');
    const logoVal=BRAND.logo||'ğŸ”';
    if(logoVal.startsWith('http')){logoEl.innerHTML='<img class="brand-logo-img" src="'+esc(logoVal)+'" alt="">';logoEl.classList.add('has-img')}
    else{logoEl.textContent=logoVal;logoEl.classList.remove('has-img')}
    $('brand-name').textContent=BRAND.name||'VPN Shop';
    const sloganEl=$('brand-slogan');
    if(BRAND.slogan){sloganEl.textContent=BRAND.slogan;sloganEl.style.display=''}else{sloganEl.style.display='none'}
    $('hdr-balance').textContent=D.user.balance+' '+(CURRENCY_SYMBOLS[D.default_currency]||'â‚½');
    renderSub(); renderConnect(); renderProfile(); renderSupport();
    // Trial button
    if(D.trial_available) $('btn-trial').style.display='';
    else $('btn-trial').style.display='none';
    // Ticket FAB â€” only on home page, only for open (non-closed/resolved) tickets
    updateFab();
    // Ticket badge
    if(D.ticket_unread>0){$('ticket-badge').style.display='';$('ticket-badge').textContent=D.ticket_unread}
    // Expand devices button
    if(D.subscription&&D.subscription.status==='ACTIVE') $('btn-expand-devices').style.display='';
}

function renderSub(){
    const s=D.subscription, b=$('sub-badge'), e=$('sub-expire'), tr=$('sub-traffic');
    if(!s||!s.status){
        b.textContent=t('no_sub');b.className='sub-badge sub-badge-none';
        e.textContent='';tr.innerHTML='';return;
    }
    if(s.is_trial){b.textContent=t('trial_period');b.className='sub-badge sub-badge-trial'}
    else if(s.status==='ACTIVE'){b.textContent=t('active');b.className='sub-badge sub-badge-active'}
    else if(s.status==='EXPIRED'){b.textContent=t('expired');b.className='sub-badge sub-badge-expired'}
    else{b.textContent=s.status;b.className='sub-badge sub-badge-none'}
    e.innerHTML=s.expire_at?'ğŸ“… '+t('to_date')+' '+s.expire_at:'';
    if(s.expire_at && (s.status==='ACTIVE' || s.is_trial)){
        const daysLeft=Math.ceil((new Date(s.expire_at)-new Date())/(1000*60*60*24));
        if(daysLeft>=0) e.innerHTML+='<div style="font-size:.76rem;color:var(--text3);margin-top:2px">'+t('remains')+' '+daysLeft+' '+ pluralDays(daysLeft)+'</div>';
    }
    const tl=s.traffic_limit? s.traffic_limit+' GB':'âˆ';
    tr.innerHTML=t('traffic')+' <b>0 B / '+tl+'</b>';
}

function renderPlans(){
    const el=$('plans-list'), dc=D.default_currency||'RUB', sym=CURRENCY_SYMBOLS[dc]||'â‚½';
    if(!D.plans||!D.plans.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">ğŸ“‹</span><h3>'+t('no_plans')+'</h3></div>';return}
    // Find base price-per-day for discount calc
    let basePpd=null;
    D.plans.forEach(p=>{
        (p.durations||[]).forEach(d=>{
            const pr=findPrice(d,dc);
            if(pr!==null && d.days>0){
                const ppd=pr/d.days;
                if(basePpd===null||d.days<=(basePpd.days||9999)){basePpd={ppd,days:d.days}}
            }
        });
    });

    el.innerHTML=D.plans.map(p=>{
        const durs=(p.durations||[]).map(d=>{
            const pr=findPrice(d,dc);
            if(pr===null) return '';
            let savingsHtml='';
            if(basePpd && d.days>basePpd.days && pr>0){
                const ppd=pr/d.days;
                const pct=Math.round((1-ppd/basePpd.ppd)*100);
                if(pct>0) savingsHtml='<span class="plan-savings">('+t('savings')+' '+pct+'%)</span>';
            }
            return '<div class="plan-duration"><span class="plan-days">'+fmtDays(d.days)+'</span><span class="plan-price">'+pr+' '+sym+' '+savingsHtml+'</span></div>';
        }).join('');
        return '<div class="card plan-card" onclick="selectPlan('+p.id+')"><h3 class="plan-name">'+esc(p.name)+'</h3><div class="plan-info"><span>ğŸ“¦ '+(p.traffic_limit||'âˆ')+' GB</span><span>ğŸ“± '+(p.device_limit||'âˆ')+' '+t('dev_short')+'</span></div><div class="plan-durations">'+durs+'</div><button class="plan-buy-btn" onclick="event.stopPropagation();selectPlan('+p.id+')">'+t('select_plan')+'</button></div>';
    }).join('');
}

function findPrice(dur,currency){
    const p=(dur.prices||[]).find(x=>x.currency===currency);
    return p?parseFloat(p.amount):null;
}
function fmtDays(d){
    if(d<=0)return 'âˆ';
    const l=CUR_LOCALE;
    if(l==='EN'){if(d===1)return '1 day';if(d===7)return '7 days';if(d===30)return '1 mo.';if(d===60)return '2 mo.';if(d===90)return '3 mo.';if(d===180)return '6 mo.';if(d===365)return '1 year';return d+' d.'}
    if(l==='UK'){if(d===1)return '1 Ğ´ĞµĞ½ÑŒ';if(d===7)return '7 Ğ´Ğ½Ñ–Ğ²';if(d===30)return '1 Ğ¼Ñ–Ñ.';if(d===60)return '2 Ğ¼Ñ–Ñ.';if(d===90)return '3 Ğ¼Ñ–Ñ.';if(d===180)return '6 Ğ¼Ñ–Ñ.';if(d===365)return '1 Ñ€Ñ–Ğº';return d+' Ğ´Ğ½.'}
    if(l==='DE'){if(d===1)return '1 Tag';if(d===7)return '7 Tage';if(d===30)return '1 Mon.';if(d===60)return '2 Mon.';if(d===90)return '3 Mon.';if(d===180)return '6 Mon.';if(d===365)return '1 Jahr';return d+' T.'}
    if(d===1)return '1 Ğ´ĞµĞ½ÑŒ';if(d===7)return '7 Ğ´Ğ½ĞµĞ¹';if(d===30)return '1 Ğ¼ĞµÑ.';if(d===60)return '2 Ğ¼ĞµÑ.';if(d===90)return '3 Ğ¼ĞµÑ.';if(d===180)return '6 Ğ¼ĞµÑ.';if(d===365)return '1 Ğ³Ğ¾Ğ´';return d+' Ğ´Ğ½.';
}

function renderConnect(){
    const s=D.subscription;
    $('con-url').textContent=(s&&s.url)?s.url:t('no_active_sub');
    if(s&&s.url&&DOMAIN){
        $('con-actions').style.display='';
        $('btn-oneclick').onclick=()=>openLink('https://'+DOMAIN+'/api/v1/connect/'+s.url.split('/').pop());
        $('btn-subpage').onclick=()=>openLink(s.url);
    }
    const dl=D.subscription&&D.subscription.device_limit;
    $('dev-limit').textContent=dl||'â€”';
    $('dev-used').textContent='â€”';
}

function renderProfile(){
    const u=D.user, sym=CURRENCY_SYMBOLS[D.default_currency]||'â‚½';
    $('pr-name').textContent=u.name||'â€”';
    $('pr-uname').textContent=u.username?'@'+u.username:'â€”';
    $('pr-tid').textContent=u.telegram_id;
    $('pr-balance').textContent=u.balance+' '+sym;
    const rm={USER:t('user_role'),ADMIN:t('admin_role'),DEV:t('dev_role')};
    $('pr-role').textContent=rm[u.role]||u.role;
    if(D.features&&D.features.balance_enabled!==false) $('balance-card').style.display='';
    if(D.features&&D.features.referral_enabled!==false){
        $('ref-card').style.display='';
        const bot=D.bot_username||'bot';
        $('ref-link').textContent='https://t.me/'+bot+'?start=ref_'+u.telegram_id;
    }
}

function renderSupport(){
    if(D.features){
        if(D.features.community_enabled&&D.features.community_url){
            $('support-community').style.display='';
            $('btn-community').onclick=()=>openLink(D.features.community_url);
        }
        if(D.features.tos_enabled){
            $('support-tos').style.display='';
            $('btn-tos').onclick=()=>openLink(D.features.tos_url||'');
        }
    }
    if(D.support_url){
        $('support-help').style.display='';
        $('btn-support').onclick=()=>openLink(D.support_url);
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USER ACTIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buySubscription(){
    if(D.plans&&D.plans.length) go('plans');
    else toast(t('no_plans'),'error');
}
function selectPlan(id){
    const plan=D.plans.find(p=>p.id===id);if(!plan)return;
    const dc=D.default_currency||'RUB', sym=CURRENCY_SYMBOLS[dc]||'â‚½';
    // Find base ppd for savings calc
    let basePpd=null;
    (plan.durations||[]).forEach(d=>{
        const pr=findPrice(d,dc);
        if(pr!==null && d.days>0){
            const ppd=pr/d.days;
            if(basePpd===null||d.days<=(basePpd.days||9999)){basePpd={ppd,days:d.days}}
        }
    });
    const dursHtml=(plan.durations||[]).map(d=>{
        const pr=findPrice(d,dc);if(pr===null)return '';
        let savBadge='';
        if(basePpd && d.days>basePpd.days && pr>0){
            const ppd=pr/d.days;
            const pct=Math.round((1-ppd/basePpd.ppd)*100);
            if(pct>0) savBadge='<span class="plan-savings" style="margin-left:auto">('+t('savings')+' '+pct+'%)</span>';
        }
        return '<div class="plan-duration" style="cursor:pointer;transition:all .2s" onclick="confirmPurchase('+id+','+d.days+','+pr+')" onmouseover="this.style.borderColor=\'var(--cyan-border)\'" onmouseout="this.style.borderColor=\'var(--border)\'"><span class="plan-days">'+fmtDays(d.days)+'</span><span class="plan-price">'+pr+' '+sym+'</span>'+savBadge+'</div>';
    }).join('');
    // Determine purchase note
    let purchaseNote='';
    if(D.subscription&&D.subscription.status==='ACTIVE'){
        purchaseNote='<p style="color:var(--gold);font-size:.8rem;margin-top:8px">âš ï¸ '+t('active_sub_note')+'</p>';
    }
    showModal('<h3>'+esc(plan.name)+'</h3><p style="color:var(--text3);font-size:.84rem;margin-bottom:8px">'+t('select_period')+'</p><div class="plan-durations" style="gap:6px">'+dursHtml+'</div>'+purchaseNote+'<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">'+t('cancel')+'</button></div>');
}
async function confirmPurchase(planId,days,price){
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'â‚½';
    if(D.user.balance<price){
        closeModal();
        return toast(t('not_enough')+' '+D.user.balance+' '+sym,'error');
    }
    closeModal();
    showModal('<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="margin-top:12px;color:var(--text2)">'+t('processing')+'</p></div>');
    try{
        const r=await fetch(API+'/api/purchase',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan_id:planId,duration_days:days})});
        closeModal();
        if(r.ok){
            toast(t('sub_done')+' âœ…');
            const dr=await fetch(API+'/api/user/data');if(dr.ok){D=await dr.json();render()}
        } else {
            try{const j=await r.json();toast(j.detail||t('purchase_error'),'error')}
            catch(e2){toast(t('purchase_error')+' ('+r.status+')','error')}
        }
    }catch(e){closeModal();toast(e.message||t('net_error'),'error')}
}
async function startTrial(){
    showModal('<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="margin-top:12px;color:var(--text2)">'+t('trial_activating')+'</p></div>');
    try{
        const r=await fetch(API+'/api/trial/activate',{method:'POST'});
        closeModal();
        if(r.ok){
            toast(t('trial_done')+' âœ…','success');
            showModal('<div style="text-align:center;padding:30px"><div style="font-size:3rem">âœ…</div><h3 style="margin-top:12px;color:var(--green)">'+t('trial_done')+'</h3><p style="color:var(--text2);font-size:.84rem;margin-top:8px">'+t('trial_go_connect')+'</p><div class="modal-actions"><button class="btn btn-primary" onclick="closeModal();go(\'connect\')">'+t('setup')+'</button><button class="btn btn-secondary" onclick="closeModal()">'+t('close')+'</button></div></div>');
            const dr=await fetch(API+'/api/user/data');if(dr.ok){D=await dr.json();render()}
        } else {
            const j=await r.json();toast(j.detail||t('error'),'error');
        }
    }catch(e){closeModal();toast(t('net_error'),'error')}
}
function expandDevices(){
    if(D.subscription&&D.subscription.is_trial){
        showModal('<div style="text-align:center;padding:30px"><div style="font-size:3rem">âš ï¸</div><h3 style="margin-top:12px;color:var(--gold)">'+t('expand_unavail')+'</h3><p style="color:var(--text2);font-size:.84rem;margin-top:8px">'+t('expand_trial_msg')+'</p><div class="modal-actions"><button class="btn btn-primary" onclick="closeModal();buySubscription()">'+t('buy_plan')+'</button><button class="btn btn-secondary" onclick="closeModal()">'+t('close')+'</button></div></div>');
        return;
    }
    toast(t('expand_via_bot'));
}
async function closeTicket(resolved){
    if(!curTicketId)return;
    try{
        const r=await fetch(API+'/api/tickets/'+curTicketId+'/close',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({resolved})});
        if(r.ok){
            toast(resolved?t('ticket_closed_resolved'):t('ticket_closed_unresolved'));
            $('ticket-reply').style.display='none';
            $('ticket-close-actions').style.display='none';
        }else{const j=await r.json();toast(j.detail||'ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
    }catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
}
function openLink(u){if(u)tg.openLink(u)}
function copyUrl(){
    const s=D.subscription;
    if(s&&s.url)navigator.clipboard.writeText(s.url).then(()=>toast(t('copied'))).catch(()=>toast(t('error'),'error'));
    else toast(t('no_sub_err'),'error');
}
function copyRef(){
    const rl=$('ref-link').textContent;
    navigator.clipboard.writeText(rl).then(()=>toast(t('link_copied'))).catch(()=>toast(t('error'),'error'));
}
function topupBalance(){toast(t('topup_via_bot'))}
async function activatePromo(){
    const code=$('promo-input').value.trim();if(!code)return;
    const r=$('promo-result');
    try{
        const res=await fetch(API+'/api/promocode/activate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
        const d=await res.json();r.style.display='block';
        if(res.ok){r.style.color='var(--green)';r.textContent=d.message||'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½!'}
        else{r.style.color='var(--red)';r.textContent=d.detail||'ĞÑˆĞ¸Ğ±ĞºĞ°'}
    }catch(e){r.style.display='block';r.style.color='var(--red)';r.textContent='ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸'}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function admTab(t){
    curAdmTab=t;
    document.querySelectorAll('#adm-tabs .admin-tab').forEach((b,i)=>b.classList.toggle('active',['stats','users','plans','settings','tickets','brand'][i]===t));
    document.querySelectorAll('.admin-content').forEach(c=>c.classList.remove('active'));
    const el=$('adm-'+t);if(el)el.classList.add('active');
    loadAdm(t);
}
async function loadAdm(t){
    if(t==='stats')await loadStats();
    if(t==='users')await loadUsers();
    if(t==='plans')await loadAdmPlans();
    if(t==='settings')await loadSettings();
    if(t==='tickets')await loadAdmTickets();
    if(t==='brand')loadBrandForm();
}
async function loadStats(){
    try{const r=await fetch(API+'/api/admin/stats');if(!r.ok)return;const d=await r.json();
    $('st-total').textContent=d.total_users||0;$('st-active').textContent=d.active_subscriptions||0;
    $('st-expired').textContent=d.expired_subscriptions||0;$('st-revenue').textContent=(d.total_revenue||0)}catch(e){}
}
async function loadUsers(){
    try{const r=await fetch(API+'/api/admin/users');if(!r.ok)return;usersCache=await r.json();drawUsers(usersCache)}catch(e){}
}
function filterUsers(){
    const q=$('user-search').value.toLowerCase().trim();
    if(!q)return drawUsers(usersCache);
    drawUsers(usersCache.filter(u=>(u.name||'').toLowerCase().includes(q)||String(u.telegram_id).includes(q)||(u.username||'').toLowerCase().includes(q)));
}
function drawUsers(list){
    const el=$('users-list');
    if(!list.length){el.innerHTML='<div class="empty-state">ĞŸÑƒÑÑ‚Ğ¾</div>';return}
    el.innerHTML=list.slice(0,50).map(u=>{
        const ini=(u.name||'?')[0].toUpperCase();
        const rc=u.role==='DEV'?'role-dev':u.role==='ADMIN'?'role-admin':'role-user';
        const rn=u.role==='DEV'?'DEV':u.role==='ADMIN'?'ADM':'USER';
        return '<div class="user-item" onclick="openUser('+u.telegram_id+')"><div class="user-item-info"><div class="user-avatar">'+esc(ini)+'</div><div><div class="user-name">'+esc(u.name||'â€”')+'</div><div class="user-sub">ID: '+u.telegram_id+'</div></div></div><span class="role-badge '+rc+'">'+rn+'</span></div>';
    }).join('');
}
async function openUser(tid){
    go('auser');$('aud-title').textContent='Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦';$('aud-body').innerHTML='<div style="text-align:center;padding:40px"><div class="spinner"></div></div>';
    try{
        const r=await fetch(API+'/api/admin/users/'+tid);if(!r.ok){$('aud-body').innerHTML='<div class="empty-state">ĞÑˆĞ¸Ğ±ĞºĞ°</div>';return}
        const u=await r.json();$('aud-title').textContent=u.name||'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ';drawUserDetail(u);
    }catch(e){$('aud-body').innerHTML='<div class="empty-state">'+e.message+'</div>'}
}
function drawUserDetail(u){
    const rm={USER:'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ',ADMIN:'ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€',DEV:'Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº'};
    const si=u.subscription?'<div class="card-row"><span class="card-label">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</span><span class="card-value">'+(u.subscription.plan_name||'â€”')+'</span></div><div class="card-row"><span class="card-label">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</span><span class="card-value">'+u.subscription.status+'</span></div><div class="card-row"><span class="card-label">Ğ˜ÑÑ‚ĞµĞºĞ°ĞµÑ‚</span><span class="card-value">'+(u.subscription.expire_at||'â€”')+'</span></div>':'<div class="card-row"><span class="card-label">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</span><span class="card-value" style="color:var(--text3)">ĞĞµÑ‚</span></div>';
    $('aud-body').innerHTML='<div class="card"><div class="card-row"><span class="card-label">Ğ˜Ğ¼Ñ</span><span class="card-value">'+esc(u.name||'â€”')+'</span></div><div class="card-row"><span class="card-label">Username</span><span class="card-value">'+(u.username?'@'+esc(u.username):'â€”')+'</span></div><div class="card-row"><span class="card-label">ID</span><span class="card-value">'+u.telegram_id+'</span></div><div class="card-row"><span class="card-label">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ</span><span class="card-value">'+u.balance+' â‚½</span></div><div class="card-row"><span class="card-label">Ğ Ğ¾Ğ»ÑŒ</span><span class="card-value">'+(rm[u.role]||u.role)+'</span></div><div class="card-row"><span class="card-label">Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½</span><span class="card-value">'+(u.is_blocked?'Ğ”Ğ°':'ĞĞµÑ‚')+'</span></div>'+si+'</div><div style="display:flex;flex-direction:column;gap:8px"><button class="btn btn-secondary btn-full" onclick="changeRole('+u.telegram_id+',\''+u.role+'\')">Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ</button><button class="btn btn-secondary btn-full" onclick="changeBal('+u.telegram_id+','+u.balance+')">Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ</button><button class="btn '+(u.is_blocked?'btn-primary':'btn-danger')+' btn-full" onclick="toggleBlock('+u.telegram_id+','+u.is_blocked+')">'+(u.is_blocked?'Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ':'Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ')+'</button></div>';
}
function changeRole(tid,cur){
    const roles=['USER','ADMIN','DEV'],names=['ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ','ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€','Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº'];
    showModal('<h3>Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ</h3>'+roles.map((r,i)=>'<button class="btn '+(r===cur?'btn-primary':'btn-secondary')+' btn-full" style="margin-top:6px" onclick="setRole('+tid+',\''+r+'\')">'+names[i]+'</button>').join('')+'<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button></div>');
}
async function setRole(tid,role){closeModal();try{const r=await fetch(API+'/api/admin/users/'+tid+'/role',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role})});if(r.ok){toast('Ğ Ğ¾Ğ»ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ°');openUser(tid)}else{const d=await r.json();toast(d.detail||'ĞÑˆĞ¸Ğ±ĞºĞ°','error')}}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}}
let balType='basic';
function changeBal(tid,cur){
    balType='basic';
    showModal('<h3>Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ</h3><p style="color:var(--text2);font-size:.84rem;margin-bottom:10px">Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹: '+cur+' â‚½</p>'+
        '<div class="form-group"><label>Ğ¢Ğ¸Ğ¿ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°</label><div style="display:flex;gap:6px;margin-top:4px"><button class="btn btn-primary btn-sm" id="bal-type-basic" onclick="switchBalType(\'basic\')">ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹</button><button class="btn btn-secondary btn-sm" id="bal-type-bonus" onclick="switchBalType(\'bonus\')">Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğ¹</button></div></div>'+
        '<div class="form-group"><label>Ğ¡ÑƒĞ¼Ğ¼Ğ° (+/-)</label><input class="form-input" id="bal-amt" type="number" placeholder="100"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button><button class="btn btn-primary" onclick="setBal('+tid+')">ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button></div>');
}
function switchBalType(t){
    balType=t;
    const bb=$('bal-type-basic'),bn=$('bal-type-bonus');
    if(t==='basic'){bb.className='btn btn-primary btn-sm';bn.className='btn btn-secondary btn-sm'}
    else{bb.className='btn btn-secondary btn-sm';bn.className='btn btn-primary btn-sm'}
}
async function setBal(tid){const a=parseFloat($('bal-amt').value);if(isNaN(a))return toast('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾','error');closeModal();
    const endpoint=balType==='bonus'?'/bonus-balance':'/balance';
    try{const r=await fetch(API+'/api/admin/users/'+tid+endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:a})});if(r.ok){toast((balType==='bonus'?'Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğ¹ Ğ±':'Ğ‘')+'Ğ°Ğ»Ğ°Ğ½Ñ Ğ¸Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½');openUser(tid)}else{const d=await r.json();toast(d.detail||'ĞÑˆĞ¸Ğ±ĞºĞ°','error')}}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}}
async function toggleBlock(tid,blocked){try{const r=await fetch(API+'/api/admin/users/'+tid+'/block',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({block:!blocked})});if(r.ok){toast(blocked?'Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½':'Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');openUser(tid)}else{const d=await r.json();toast(d.detail||'ĞÑˆĞ¸Ğ±ĞºĞ°','error')}}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}}

/* â”€â”€ Admin Plans (enhanced) â”€â”€ */
let admPlansCache=[];
async function loadAdmPlans(){
    try{const r=await fetch(API+'/api/admin/plans');if(!r.ok)return;admPlansCache=await r.json();
    $('adm-plans-count').textContent='Ğ¢Ğ°Ñ€Ğ¸Ñ„Ñ‹ ('+admPlansCache.length+')';
    drawAdmPlans()}catch(e){}
}
function drawAdmPlans(){
    const el=$('adm-plans-list');
    if(!admPlansCache.length){el.innerHTML='<div class="empty-state">ĞĞµÑ‚ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ¾Ğ²</div>';return}
    el.innerHTML=admPlansCache.map(p=>{
        const avl=AVAIL_LABELS[p.availability]||p.availability;
        const isTrial=p.availability==='TRIAL';
        return '<div class="plan-admin-card'+(p.is_active?'':' inactive')+'" onclick="editPlan('+p.id+')">'+
            '<div class="plan-admin-top">'+
                '<span class="plan-admin-name">'+esc(p.name)+'</span>'+
                (p.tag?'<span class="plan-admin-tag">'+esc(p.tag)+'</span>':'')+
                '<span class="avail-badge'+(isTrial?' trial':'')+'">'+avl+'</span>'+
                '<div class="plan-admin-actions" onclick="event.stopPropagation()">'+
                    '<button class="btn-toggle-plan'+(p.is_active?' active':'')+'" onclick="togglePlan('+p.id+',this)" title="'+(p.is_active?'Ğ’Ñ‹ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ':'Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ')+'"></button>'+
                    '<button class="btn-trash" onclick="delPlan('+p.id+')" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ">ğŸ—‘</button>'+
                '</div>'+
            '</div>'+
            '<div class="plan-admin-meta">'+
                '<span>ğŸ“¦ '+(p.traffic_limit||'âˆ')+' GB</span>'+
                '<span>ğŸ“± '+(p.device_limit||'âˆ')+' ÑƒÑÑ‚Ñ€.</span>'+
                '<span>â± '+(p.durations||[]).length+' Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´(Ğ¾Ğ²)</span>'+
            '</div>'+
        '</div>';
    }).join('');
}
async function togglePlan(id,btn){
    try{const r=await fetch(API+'/api/admin/plans/'+id+'/toggle',{method:'PATCH'});
    if(r.ok){const d=await r.json();btn.classList.toggle('active',d.is_active);
    // Update cache
    const p=admPlansCache.find(x=>x.id===id);if(p)p.is_active=d.is_active;
    btn.closest('.plan-admin-card').classList.toggle('inactive',!d.is_active);
    toast(d.is_active?'Ğ’ĞºĞ»ÑÑ‡Ñ‘Ğ½':'Ğ’Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½')}else toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
}
async function delPlan(id){if(!confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‚Ğ°Ñ€Ğ¸Ñ„?'))return;try{const r=await fetch(API+'/api/admin/plans/'+id,{method:'DELETE'});if(r.ok){toast('Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½');loadAdmPlans()}else{const j=await r.json();toast(j.detail||'ĞÑˆĞ¸Ğ±ĞºĞ°','error')}}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}}

/* â”€â”€ Plan Create / Edit Modal â”€â”€ */
let editingPlanId=null;
function showCreatePlan(){editingPlanId=null;showPlanModal({name:'',description:'',tag:'',availability:'ALL',type:'BOTH',traffic_limit:100,device_limit:1,durations:[{days:30,prices:[{currency:D.default_currency||'RUB',amount:'0'}]}]},'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ñ€Ğ¸Ñ„')}
function editPlan(id){
    const p=admPlansCache.find(x=>x.id===id);if(!p)return;
    editingPlanId=id;
    showPlanModal(p,'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ñ€Ğ¸Ñ„');
}
function showPlanModal(p,title){
    const dc=D.default_currency||'RUB';
    const durs=(p.durations||[]).map((d,i)=>{
        const pr=(d.prices||[]).find(x=>x.currency===dc);
        const amt=pr?pr.amount:'0';
        return durEntryHtml(i,d.days,amt);
    }).join('');
    const availOpts=Object.entries(AVAIL_LABELS).map(([k,v])=>'<option value="'+k+'"'+(p.availability===k?' selected':'')+'>'+v+'</option>').join('');
    const typeOpts=Object.entries(TYPE_LABELS).map(([k,v])=>'<option value="'+k+'"'+(p.type===k?' selected':'')+'>'+v+'</option>').join('');
    showModal(
        '<h3>'+title+'</h3>'+
        '<div class="form-group"><label>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</label><input class="form-input" id="np-name" value="'+esc(p.name)+'" placeholder="Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹"></div>'+
        '<div class="form-group"><label>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</label><input class="form-input" id="np-desc" value="'+esc(p.description||'')+'" placeholder="ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğ°"></div>'+
        '<div class="form-row"><div class="form-group"><label>Ğ¢ĞµĞ³</label><input class="form-input" id="np-tag" value="'+esc(p.tag||'')+'" placeholder="base"></div><div class="form-group"><label>Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ</label><select class="form-input" id="np-avail">'+availOpts+'</select></div></div>'+
        '<div class="form-row"><div class="form-group"><label>Ğ¢Ğ¸Ğ¿</label><select class="form-input" id="np-type" onchange="onPlanTypeChange()">'+typeOpts+'</select></div><div class="form-group"><label>Ğ¢Ñ€Ğ°Ñ„Ğ¸Ğº (GB)</label><input class="form-input" id="np-traffic" type="number" value="'+p.traffic_limit+'"></div></div>'+
        '<div class="form-group"><label>Ğ£ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²</label><input class="form-input" id="np-dev" type="number" value="'+p.device_limit+'"></div>'+
        '<div style="margin-bottom:8px"><label style="font-size:.8rem;color:var(--text3);font-weight:500">ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹ Ğ¸ Ñ†ĞµĞ½Ñ‹ ('+(CURRENCY_SYMBOLS[dc]||dc)+')</label></div>'+
        '<div id="dur-list">'+durs+'</div>'+
        '<button class="btn btn-secondary btn-sm" onclick="addDurEntry()" style="margin-bottom:10px">+ ĞŸĞµÑ€Ğ¸Ğ¾Ğ´</button>'+
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button><button class="btn btn-primary" onclick="savePlan()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button></div>'
    );
    // Apply conditional fields after modal renders
    setTimeout(()=>onPlanTypeChange(),0);
}
function onPlanTypeChange(){
    const t=$('np-type');if(!t)return;
    const v=t.value;
    const trEl=$('np-traffic'), devEl=$('np-dev');
    if(!trEl||!devEl)return;
    // TRAFFIC â†’ disable devices; DEVICES â†’ disable traffic
    if(v==='TRAFFIC'){trEl.disabled=false;devEl.disabled=true;devEl.value='0'}
    else if(v==='DEVICES'){trEl.disabled=true;trEl.value='0';devEl.disabled=false}
    else if(v==='UNLIMITED'){trEl.disabled=true;trEl.value='0';devEl.disabled=true;devEl.value='0'}
    else{trEl.disabled=false;devEl.disabled=false}
}
function durEntryHtml(i,days,amount){
    return '<div class="duration-entry" data-idx="'+i+'"><div class="duration-entry-header"><span style="font-size:.8rem;color:var(--text2);font-weight:600">ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ #'+(i+1)+'</span><button class="dur-remove" onclick="this.closest(\'.duration-entry\').remove()">âœ•</button></div><div class="form-row"><div class="form-group"><label>Ğ”Ğ½ĞµĞ¹</label><input class="form-input dur-days" type="number" value="'+days+'" min="1"></div><div class="form-group"><label>Ğ¦ĞµĞ½Ğ°</label><input class="form-input dur-price" type="number" value="'+amount+'" min="0" step="0.01"></div></div></div>';
}
function addDurEntry(){
    const list=$('dur-list');
    const idx=list.querySelectorAll('.duration-entry').length;
    list.insertAdjacentHTML('beforeend',durEntryHtml(idx,30,'0'));
}
async function savePlan(){
    const name=$('np-name').value.trim();if(!name)return toast('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ','error');
    const dc=D.default_currency||'RUB';
    const durations=[];
    $('dur-list').querySelectorAll('.duration-entry').forEach(el=>{
        const days=parseInt(el.querySelector('.dur-days').value)||30;
        const price=el.querySelector('.dur-price').value||'0';
        durations.push({days,prices:[{currency:dc,amount:price}]});
    });
    const body={
        name,
        description:$('np-desc').value.trim(),
        tag:$('np-tag').value.trim(),
        availability:$('np-avail').value,
        type:$('np-type').value,
        traffic_limit:parseInt($('np-traffic').value)||100,
        device_limit:parseInt($('np-dev').value)||1,
        durations
    };
    closeModal();
    try{
        const url=editingPlanId?API+'/api/admin/plans/'+editingPlanId:API+'/api/admin/plans';
        const method=editingPlanId?'PUT':'POST';
        const r=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(r.ok){toast(editingPlanId?'Ğ¢Ğ°Ñ€Ğ¸Ñ„ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½':'Ğ¢Ğ°Ñ€Ğ¸Ñ„ ÑĞ¾Ğ·Ğ´Ğ°Ğ½');loadAdmPlans()}
        else{const j=await r.json();toast(j.detail||'ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
    }catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
}

/* â”€â”€ Admin Settings â”€â”€ */
let settingsCache={};
async function loadSettings(){
    try{const r=await fetch(API+'/api/admin/settings');if(!r.ok)return;settingsCache=await r.json();drawSettings()}catch(e){}
}
function drawSettings(){
    const s=settingsCache;
    const sections=[
        {title:'Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸',items:[
            {key:'balance_enabled',icon:'ğŸ’°',label:'Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ',desc:'ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°',detail:'balance'},
            {key:'community_enabled',icon:'ğŸ’¬',label:'Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğ¾',desc:'Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Telegram-Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ',detail:'community'},
            {key:'tos_enabled',icon:'ğŸ“œ',label:'ĞÑ„ĞµÑ€Ñ‚Ğ°',desc:'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğµ ÑĞ¾Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ğµ'},
            {key:'referral_enabled',icon:'ğŸ¤',label:'Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹',desc:'Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°',detail:'referral'},
            {key:'promocodes_enabled',icon:'ğŸ',label:'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹',desc:'ĞĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ¾Ğ²'},
            {key:'notifications_enabled',icon:'ğŸ””',label:'Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ',desc:'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼',detail:'notifications'},
            {key:'extra_devices_enabled',icon:'ğŸ“±',label:'Ğ”Ğ¾Ğ¿. ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°',desc:'Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ° ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²',detail:'extra_devices'},
            {key:'transfers_enabled',icon:'ğŸ’¸',label:'ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´Ñ‹',desc:'ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸',detail:'transfers'},
            {key:'global_discount_enabled',icon:'ğŸ·',label:'Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞºĞ¸Ğ´ĞºĞ°',desc:'Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ğ½Ğ° Ğ²ÑĞµ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ñ‹',detail:'global_discount'},
        ]},
        {title:'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿',items:[
            {key:'access_enabled',icon:'ğŸ”',label:'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿',desc:'Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ±Ğ¾Ñ‚Ñƒ'},
            {key:'purchases_allowed',icon:'ğŸ›’',label:'ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ¸',desc:'Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºÑƒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº'},
            {key:'registration_allowed',icon:'ğŸ“',label:'Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ',desc:'Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹'},
        ]},
        {title:'Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼',items:[
            {key:'language_enabled',icon:'ğŸŒ',label:'ĞœÑƒĞ»ÑŒÑ‚Ğ¸ÑĞ·Ñ‹Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ',desc:'Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑĞ·Ñ‹ĞºĞ° Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ° Ğ±Ğ¾Ñ‚Ğ°'},
            {key:'access_mode',icon:'ğŸ”‘',label:'Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°',desc:s.access_mode||'PUBLIC',type:'select',options:['PUBLIC','PRIVATE','WHITELIST']},
            {key:'default_currency',icon:'ğŸ’±',label:'Ğ’Ğ°Ğ»ÑÑ‚Ğ°',desc:s.default_currency||'RUB',type:'select',options:['RUB','USD','EUR','XTR'],detail:'currency_rates'},
            {key:'bot_locale',icon:'ğŸ—£',label:'Ğ¯Ğ·Ñ‹Ğº Ğ±Ğ¾Ñ‚Ğ°',desc:s.bot_locale||'RU',type:'select',options:['RU','EN','UK','DE']},
        ]}
    ];
    let html='';
    sections.forEach(sec=>{
        html+='<div style="font-size:.76rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin:14px 0 8px;padding:0 4px">'+sec.title+'</div><div class="card" style="padding:0;overflow:hidden">';
        sec.items.forEach(item=>{
            const val=s[item.key];
            if(item.type==='select'){
                html+='<div class="settings-row" onclick="openSettingDetail(\''+item.key+'\',\''+item.label+'\',\''+(item.detail||'')+'\')"><div class="settings-row-left"><span class="settings-icon">'+item.icon+'</span><div><div class="settings-label">'+item.label+'</div><div class="settings-desc">'+item.desc+'</div></div></div><span class="settings-chevron">'+esc(String(val))+' â€º</span></div>';
            } else if(typeof val==='boolean'){
                html+='<div class="settings-row" onclick="openSettingDetail(\''+item.key+'\',\''+item.label+'\',\''+(item.detail||'')+'\')"><div class="settings-row-left"><span class="settings-icon">'+item.icon+'</span><div><div class="settings-label">'+item.label+'</div><div class="settings-desc">'+item.desc+'</div></div></div><button class="toggle-switch '+(val?'active':'')+'" onclick="event.stopPropagation();toggleSet(\''+item.key+'\','+(!val)+',this)"></button></div>';
            } else {
                html+='<div class="settings-row" onclick="openSettingDetail(\''+item.key+'\',\''+item.label+'\',\''+(item.detail||'')+'\')"><div class="settings-row-left"><span class="settings-icon">'+item.icon+'</span><div><div class="settings-label">'+item.label+'</div><div class="settings-desc">'+esc(String(val))+'</div></div></div><span class="settings-chevron">â€º</span></div>';
            }
        });
        html+='</div>';
    });
    $('settings-list').innerHTML=html;
}
function openSettingDetail(key,label,detail){
    const s=settingsCache, val=s[key];
    let body='';

    // Build detail sub-settings based on detail type
    if(detail==='balance'){
        const modes={SEPARATE:'Ğ Ğ°Ğ·Ğ´ĞµĞ»ÑŒĞ½Ğ¾',COMBINED:'ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹'};
        body+='<div class="form-group"><label>Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°</label><div style="display:flex;gap:6px;margin-top:4px">'+
            Object.entries(modes).map(([k,v])=>'<button class="btn '+((s.balance_mode||'SEPARATE')===k?'btn-primary':'btn-secondary')+' btn-sm" onclick="saveSubSetting(\'balance_mode\',\''+k+'\')">'+v+'</button>').join('')+'</div></div>'+
            '<div class="form-group"><label>ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ</label><input class="form-input" id="sd-bal-min" type="number" value="'+(s.balance_min_amount||10)+'"></div>'+
            '<div class="form-group"><label>ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ</label><input class="form-input" id="sd-bal-max" type="number" value="'+(s.balance_max_amount||100000)+'"></div>'+
            '<button class="btn btn-primary btn-sm btn-full" onclick="saveMultiSub({balance_min_amount:parseInt($(\'sd-bal-min\').value),balance_max_amount:parseInt($(\'sd-bal-max\').value)})">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>';
    } else if(detail==='community'){
        body+='<div class="form-group"><label>URL ÑĞ¾Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğ°</label><input class="form-input" id="sd-comm-url" value="'+esc(s.community_url||'')+'" placeholder="https://t.me/..."></div>'+
            '<button class="btn btn-primary btn-sm btn-full" onclick="saveMultiSub({community_url:$(\'sd-comm-url\').value})">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>';
    } else if(detail==='referral'){
        body+='<div class="form-group"><label>Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ</label><div style="display:flex;gap:6px;margin-top:4px">'+
            ['FIRST','SECOND','THIRD'].map(l=>'<button class="btn '+((s.referral_level||'FIRST')===l?'btn-primary':'btn-secondary')+' btn-sm" onclick="saveSubSetting(\'referral_level\',\''+l+'\')">'+l+'</button>').join('')+'</div></div>'+
            '<div class="form-group"><label>Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ</label><div style="display:flex;gap:6px;margin-top:4px">'+
            ['ON_EACH_PAYMENT','ON_FIRST_PAYMENT'].map(v=>'<button class="btn btn-sm '+((s.referral_accrual_strategy||'ON_EACH_PAYMENT')===v?'btn-primary':'btn-secondary')+'" style="font-size:.7rem" onclick="saveSubSetting(\'referral_accrual_strategy\',\''+v+'\')">'+v.replace(/_/g,' ')+'</button>').join('')+'</div></div>';
    } else if(detail==='notifications'){
        body+='<div class="form-group"><label>ĞĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸</label></div>'+
            '<div class="toggle-row" style="margin-bottom:8px"><label>Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ</label><button class="toggle-switch '+(s.inactive_notif_enabled?'active':'')+'" onclick="saveSubSetting(\'inactive_notif_enabled\','+(!s.inactive_notif_enabled)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="form-group"><label>ĞŸĞ¾Ñ€Ğ¾Ğ³ (Ñ‡Ğ°ÑĞ¾Ğ²)</label><input class="form-input" id="sd-inact-hrs" type="number" value="'+(s.inactive_notif_hours||24)+'"></div>'+
            '<button class="btn btn-primary btn-sm btn-full" onclick="saveMultiSub({inactive_notif_hours:parseInt($(\'sd-inact-hrs\').value)})">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>';
    } else if(detail==='extra_devices'){
        body+='<div class="form-group"><label>Ğ¦ĞµĞ½Ğ° Ğ·Ğ° ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾</label><input class="form-input" id="sd-ed-price" type="number" value="'+(s.extra_devices_price||100)+'"></div>'+
            '<div class="toggle-row" style="margin-bottom:8px"><label>Ğ•Ğ´Ğ¸Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°</label><button class="toggle-switch '+(s.extra_devices_one_time?'active':'')+'" onclick="saveSubSetting(\'extra_devices_one_time\','+(!s.extra_devices_one_time)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="form-group"><label>ĞœĞ¸Ğ½. Ğ´Ğ½ĞµĞ¹ Ğ´Ğ¾ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ</label><input class="form-input" id="sd-ed-days" type="number" value="'+(s.extra_devices_min_days||10)+'"></div>'+
            '<button class="btn btn-primary btn-sm btn-full" onclick="saveMultiSub({extra_devices_price:parseInt($(\'sd-ed-price\').value),extra_devices_min_days:parseInt($(\'sd-ed-days\').value)})">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>';
    } else if(detail==='transfers'){
        body+='<div class="form-group"><label>Ğ¢Ğ¸Ğ¿ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸</label><div style="display:flex;gap:6px;margin-top:4px">'+
            ['percent','fixed'].map(t=>'<button class="btn '+((s.transfers_commission_type||'percent')===t?'btn-primary':'btn-secondary')+' btn-sm" onclick="saveSubSetting(\'transfers_commission_type\',\''+t+'\')">'+({percent:'ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚',fixed:'Ğ¤Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ'}[t])+'</button>').join('')+'</div></div>'+
            '<div class="form-group"><label>ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ ('+(s.transfers_commission_type==='fixed'?'â‚½':'%')+')</label><input class="form-input" id="sd-tr-comm" type="number" value="'+(s.transfers_commission_value||5)+'"></div>'+
            '<div class="form-group"><label>ĞœĞ¸Ğ½. ÑÑƒĞ¼Ğ¼Ğ°</label><input class="form-input" id="sd-tr-min" type="number" value="'+(s.transfers_min_amount||10)+'"></div>'+
            '<div class="form-group"><label>ĞœĞ°ĞºÑ. ÑÑƒĞ¼Ğ¼Ğ°</label><input class="form-input" id="sd-tr-max" type="number" value="'+(s.transfers_max_amount||100000)+'"></div>'+
            '<button class="btn btn-primary btn-sm btn-full" onclick="saveMultiSub({transfers_commission_value:parseInt($(\'sd-tr-comm\').value),transfers_min_amount:parseInt($(\'sd-tr-min\').value),transfers_max_amount:parseInt($(\'sd-tr-max\').value)})">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>';
    } else if(detail==='global_discount'){
        body+='<div class="form-group"><label>Ğ¢Ğ¸Ğ¿ ÑĞºĞ¸Ğ´ĞºĞ¸</label><div style="display:flex;gap:6px;margin-top:4px">'+
            ['percent','fixed'].map(t=>'<button class="btn '+((s.global_discount_type||'percent')===t?'btn-primary':'btn-secondary')+' btn-sm" onclick="saveSubSetting(\'global_discount_type\',\''+t+'\')">'+({percent:'ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚',fixed:'Ğ¤Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ'}[t])+'</button>').join('')+'</div></div>'+
            '<div class="form-group"><label>Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ ÑĞºĞ¸Ğ´ĞºĞ¸</label><input class="form-input" id="sd-gd-val" type="number" value="'+(s.global_discount_value||0)+'"></div>'+
            '<div class="toggle-row" style="margin-bottom:8px"><label>Ğ¡ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°Ñ‚ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸</label><button class="toggle-switch '+(s.global_discount_stack?'active':'')+'" onclick="saveSubSetting(\'global_discount_stack\','+(!s.global_discount_stack)+');this.classList.toggle(\'active\')"></button></div>'+
            '<button class="btn btn-primary btn-sm btn-full" onclick="saveMultiSub({global_discount_value:parseInt($(\'sd-gd-val\').value)})">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>';
    } else if(detail==='currency_rates'){
        // Show select for currency AND currency rates sub-settings
        const opts=['RUB','USD','EUR','XTR'];
        body+=opts.map(o=>'<button class="btn '+(String(val)===o?'btn-primary':'btn-secondary')+' btn-full" style="margin-top:6px" onclick="saveSettingVal(\''+key+'\',\''+o+'\')">'+o+'</button>').join('');
        body+='<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px"><div style="font-size:.76rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">ĞšÑƒÑ€ÑÑ‹ Ğ²Ğ°Ğ»ÑÑ‚</div></div>'+
            '<div class="toggle-row" style="margin-bottom:8px"><label>ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ (Ğ¦Ğ‘ Ğ Ğ¤)</label><button class="toggle-switch '+(s.currency_rates_auto?'active':'')+'" onclick="saveSubSetting(\'currency_rates_auto\','+(!s.currency_rates_auto)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="form-group"><label>USD â†’ RUB</label><input class="form-input" id="sd-cr-usd" type="number" step="0.01" value="'+(s.currency_rates_usd||90)+'"></div>'+
            '<div class="form-group"><label>EUR â†’ RUB</label><input class="form-input" id="sd-cr-eur" type="number" step="0.01" value="'+(s.currency_rates_eur||100)+'"></div>'+
            '<div class="form-group"><label>Stars â†’ RUB</label><input class="form-input" id="sd-cr-stars" type="number" step="0.01" value="'+(s.currency_rates_stars||1.5)+'"></div>'+
            '<button class="btn btn-primary btn-sm btn-full" onclick="saveMultiSub({currency_rates_usd:parseFloat($(\'sd-cr-usd\').value),currency_rates_eur:parseFloat($(\'sd-cr-eur\').value),currency_rates_stars:parseFloat($(\'sd-cr-stars\').value)})">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºÑƒÑ€ÑÑ‹</button>';
    } else if(typeof val==='boolean'){
        // Simple boolean without sub-settings â€” nothing extra
    } else {
        const opts=key==='access_mode'?['PUBLIC','PRIVATE','WHITELIST']:key==='default_currency'?['RUB','USD','EUR','XTR']:key==='bot_locale'?['RU','EN','UK','DE']:[];
        if(opts.length){
            body+=opts.map(o=>'<button class="btn '+(String(val)===o?'btn-primary':'btn-secondary')+' btn-full" style="margin-top:6px" onclick="saveSettingVal(\''+key+'\',\''+o+'\')">'+o+'</button>').join('');
        } else {
            body+='<div class="form-group"><label>Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ</label><input class="form-input" id="set-val" value="'+esc(String(val))+'"></div><button class="btn btn-primary btn-sm" onclick="saveSettingStr(\''+key+'\',$(\'set-val\').value)">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>';
        }
    }
    if(!body)return; // No detail panel needed (e.g. simple toggles like tos, promocodes)
    showModal('<h3>'+label+'</h3>'+body+'<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</button></div>');
}
async function saveSubSetting(k,v){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;toast('Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾')}else toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
}
async function saveMultiSub(obj){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)});
    if(r.ok){Object.assign(settingsCache,obj);closeModal();drawSettings();toast('Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾')}else toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
}
async function toggleSetAndRefresh(k,v,btn){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;btn.classList.toggle('active',v);drawSettings();toast('Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾')}else toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
}
async function toggleSet(k,v,btn){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;btn.classList.toggle('active',v);drawSettings();toast('Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾')}else toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
}
async function saveSettingStr(k,v){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;closeModal();drawSettings();toast('Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾')}else toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
}
async function saveSettingVal(k,v){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;closeModal();drawSettings();toast(t('saved'));
        if(k==='bot_locale'){CUR_LOCALE=v;render();applyLocale()}
    }else toast(t('error'),'error')}catch(e){toast(t('error'),'error')}
}

/* â”€â”€ Tickets (User) â”€â”€ */
let curTicketId=null;
async function loadTickets(){
    try{const r=await fetch(API+'/api/tickets');if(!r.ok)return;const tks=await r.json();
    const el=$('tickets-list');
    if(!tks.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">ğŸ«</span><h3>'+t('no_tickets')+'</h3><p style="color:var(--text3);font-size:.84rem">'+t('create_first')+'</p></div>';return}
    el.innerHTML=tks.map(t=>{
        const st=t.status.toLowerCase();
        const last=t.messages&&t.messages.length?t.messages[t.messages.length-1].text:'';
        return '<div class="ticket-item'+(t.is_read_by_user?'':' unread')+'" onclick="openTicket('+t.id+')">'+
            '<div class="ticket-top"><span class="ticket-subject">'+esc(t.subject)+'</span><span class="ticket-status '+st+'">'+st+'</span></div>'+
            '<div class="ticket-preview">'+esc(last.substring(0,80))+'</div>'+
            '<div class="ticket-date">'+t.updated_at+'</div></div>';
    }).join('')}catch(e){}
}
async function openTicket(id){
    curTicketId=id; go('ticket');$('ticket-title').textContent='Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦';$('ticket-chat').innerHTML='';$('ticket-reply').style.display='none';
    try{const r=await fetch(API+'/api/tickets/'+id);if(!r.ok)return;
    const t=await r.json();$('ticket-title').textContent=t.subject;
    renderTicketChat($('ticket-chat'),t.messages);
    const hasAdminReply=(t.messages||[]).some(m=>m.is_admin);
    if(t.status!=='CLOSED'){
        $('ticket-reply').style.display='flex';
        $('ticket-close-actions').style.display=hasAdminReply?'flex':'none';
    } else {
        $('ticket-reply').style.display='none';
        $('ticket-close-actions').style.display='none';
    }
    }catch(e){}
}
function renderTicketChat(el,msgs){
    el.innerHTML=(msgs||[]).map(m=>{
        const cls=m.is_admin?'admin':'user';
        return '<div class="ticket-msg '+cls+'">'+esc(m.text)+'<div class="ticket-msg-time">'+m.created_at+'</div></div>';
    }).join('');el.scrollTop=el.scrollHeight;
}
async function sendTicketReply(){
    const text=$('ticket-text').value.trim();if(!text||!curTicketId)return;
    try{const r=await fetch(API+'/api/tickets/'+curTicketId+'/reply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    if(r.ok){$('ticket-text').value='';const t=await r.json();renderTicketChat($('ticket-chat'),t.messages)}else toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
}
function showNewTicket(){
    showModal('<h3>'+t('new_ticket_title')+'</h3><div class="form-group"><label>'+t('subject')+'</label><input class="form-input" id="nt-subj" placeholder="..."></div><div class="form-group"><label>'+t('message')+'</label><textarea class="form-input" id="nt-text" rows="4" placeholder="..." style="resize:vertical"></textarea></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">'+t('cancel')+'</button><button class="btn btn-primary" onclick="createTicket()">'+t('send')+'</button></div>');
}
async function createTicket(){
    const subject=$('nt-subj').value.trim(), text=$('nt-text').value.trim();
    if(!subject||!text)return toast(t('fill_all'),'error');closeModal();
    try{const r=await fetch(API+'/api/tickets',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subject,text})});
    if(r.ok){toast(t('ticket_created'));const t2=await r.json();curTicketId=t2.id;openTicket(t2.id)}else{const j=await r.json();toast(j.detail||t('error'),'error')}}catch(e){toast(t('error'),'error')}
}

/* â”€â”€ Tickets (Admin) â”€â”€ */
let admTicketsCache=[];
async function loadAdmTickets(){
    try{const r=await fetch(API+'/api/admin/tickets');if(!r.ok)return;admTicketsCache=await r.json();
    const el=$('adm-tickets-list');
    if(!admTicketsCache.length){el.innerHTML='<div class="empty-state">ĞĞµÑ‚ Ñ‚Ğ¸ĞºĞµÑ‚Ğ¾Ğ²</div>';return}
    el.innerHTML=admTicketsCache.map(t=>{
        const st=t.status.toLowerCase();
        const last=t.messages&&t.messages.length?t.messages[t.messages.length-1].text:'';
        return '<div class="ticket-item'+(t.is_read_by_admin?'':' unread')+'" onclick="openAdmTicket('+t.id+')">'+
            '<div class="ticket-top"><span class="ticket-subject">'+esc(t.subject)+'</span><span class="ticket-status '+st+'">'+st+'</span></div>'+
            '<div class="ticket-preview"><b>ID '+t.user_telegram_id+'</b> â€” '+esc(last.substring(0,60))+'</div>'+
            '<div class="ticket-date">'+t.updated_at+'</div></div>';
    }).join('')}catch(e){}
}
let admCurTicketId=null;
async function openAdmTicket(id){
    admCurTicketId=id;go('aticket');$('at-title').textContent='Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦';$('at-chat').innerHTML='';
    try{const r=await fetch(API+'/api/admin/tickets/'+id);if(!r.ok)return;
    const t=await r.json();$('at-title').textContent='#'+t.id+' '+t.subject;
    renderTicketChat($('at-chat'),t.messages);
    }catch(e){}
}
async function sendAdmTicketReply(){
    const text=$('at-text').value.trim();if(!text||!admCurTicketId)return;
    try{const r=await fetch(API+'/api/admin/tickets/'+admCurTicketId+'/reply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    if(r.ok){$('at-text').value='';const t=await r.json();renderTicketChat($('at-chat'),t.messages)}else toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
}

/* â”€â”€ Admin Brand â”€â”€ */
function loadBrandForm(){$('br-name').value=BRAND.name||'';$('br-logo').value=BRAND.logo||'';$('br-slogan').value=BRAND.slogan||''}
async function saveBrand(){
    const d={name:$('br-name').value.trim()||'VPN Shop',logo:$('br-logo').value.trim()||'ğŸ”',slogan:$('br-slogan').value.trim()};
    try{const r=await fetch(API+'/api/settings/brand',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
    if(r.ok){
        BRAND=d;
        const logoEl=$('brand-logo');
        if(BRAND.logo.startsWith('http')){logoEl.innerHTML='<img class="brand-logo-img" src="'+esc(BRAND.logo)+'" alt="">';logoEl.classList.add('has-img')}
        else{logoEl.textContent=BRAND.logo;logoEl.classList.remove('has-img')}
        $('brand-name').textContent=BRAND.name;
        const sl=$('brand-slogan');
        if(BRAND.slogan){sl.textContent=BRAND.slogan;sl.style.display=''}else{sl.style.display='none'}
        toast('Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾')
    }else toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}catch(e){toast('ĞÑˆĞ¸Ğ±ĞºĞ°','error')}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toast(m,t){const e=$('toast');e.textContent=m;e.className='toast visible'+(t?' toast-'+t:'');clearTimeout(e._t);e._t=setTimeout(()=>e.className='toast',3000)}
function showModal(h){$('modal-root').innerHTML='<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-card">'+h+'</div></div>'}
function closeModal(){$('modal-root').innerHTML=''}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function pluralDays(n){
    if(CUR_LOCALE==='EN')return n===1?'day':'days';
    if(CUR_LOCALE==='DE')return n===1?'Tag':'Tage';
    if(CUR_LOCALE==='UK'){const a=Math.abs(n)%100,b=a%10;if(a>10&&a<20)return 'Ğ´Ğ½Ñ–Ğ²';if(b>1&&b<5)return 'Ğ´Ğ½Ñ–';if(b===1)return 'Ğ´ĞµĞ½ÑŒ';return 'Ğ´Ğ½Ñ–Ğ²'}
    const a=Math.abs(n)%100,b=a%10;if(a>10&&a<20)return 'Ğ´Ğ½ĞµĞ¹';if(b>1&&b<5)return 'Ğ´Ğ½Ñ';if(b===1)return 'Ğ´ĞµĞ½ÑŒ';return 'Ğ´Ğ½ĞµĞ¹'
}

init();
</script>
</body>
</html>
