<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<link rel="stylesheet" href="/web/static/css/style.css">
</head>
<body>
<div class="bg-glow"></div>
<div id="particles-js"></div>
<div id="app">

<!-- Loading -->
<div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <p>Загрузка…</p>
</div>

<!-- Error -->
<div id="error-screen" class="loading-screen" style="display:none">
    <p id="error-msg" style="color:var(--red);padding:20px;text-align:center"></p>
</div>

<!-- ════════════ MAIN APP ════════════ -->
<div id="main-app" class="app-wrapper" style="display:none">

<header class="app-header">
    <div class="brand">
        <span class="brand-logo" id="brand-logo"></span>
        <div class="brand-info">
            <span class="brand-name" id="brand-name">VPN Shop</span>
            <span class="brand-slogan" id="brand-slogan"></span>
        </div>
    </div>
    <div class="header-balances" onclick="go('profile')">
        <span class="header-badge" id="hdr-balance"><svg class="hdr-wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 14a1 1 0 100 2 1 1 0 000-2z" fill="currentColor" stroke="none"/><path d="M22 7V6a2 2 0 00-2-2H4a2 2 0 00-2 2v1"/></svg>0 ₽</span>
        <span class="header-badge header-badge-bonus" id="hdr-bonus" style="display:none"><svg class="hdr-wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/></svg>0 ₽</span>
    </div>
    <button class="btn-icon" id="btn-logout" onclick="webLogout()" title="Выйти" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
    </button>
</header>

<main class="app-content">

<!-- ═══ HOME ═══ -->
<section id="p-home" class="page active">
    <!-- Subscription card -->
    <div class="card sub-card" id="sub-card">
        <!-- Active sub layout -->
        <div id="sub-active-layout" style="display:none">
            <div class="sub-top-row">
                <span class="sub-lbl">Тариф:</span>
                <span class="sub-plan-name" id="sub-plan-name">—</span>
            </div>
            <div class="sub-sep-line"></div>
            <div class="sub-2col">
                <div class="sub-field"><span class="sub-lbl">Истекает:</span><span class="sub-val" id="sub-expire-date">—</span></div>
                <div class="sub-field"><span class="sub-lbl">Трафик:</span><span class="sub-val" id="sub-traffic">—</span></div>
                <div class="sub-field"><span class="sub-lbl">Осталось:</span><span class="sub-val" id="sub-remaining">—</span></div>
                <div class="sub-field"><span class="sub-lbl">Устройств:</span><span class="sub-val" id="sub-devices">—</span></div>
            </div>
            <div class="sub-actions-row">
                <button class="sub-action-btn sub-action-renew" id="btn-renew" onclick="renewCurrentPlan()">Продлить</button>
                <button class="sub-action-btn sub-action-change" id="btn-change" onclick="go('plans')">Сменить</button>
            </div>
        </div>
        <!-- No sub layout -->
        <div id="sub-empty-layout">
            <div class="sub-nosub-text" id="sub-nosub-text">У вас ещё нет активной подписки</div>
            <button class="sub-action-btn sub-action-buy" id="btn-buy-sub" onclick="go('plans')">Купить подписку</button>
        </div>
    </div>

    <!-- Actions -->
    <div class="action-pills">
        <button class="pill trial-pill" id="btn-trial" onclick="startTrial()" style="display:none"><svg class="ico" viewBox="0 0 24 24"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/></svg>&nbsp; Попробовать бесплатно</button>
        <button class="pill pill-cyan" onclick="go('connect')"><svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Подключиться</button>
        <div class="pill-row">
            <button class="pill pill-outline" onclick="go('promo')"><svg class="ico" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Промокод</button>
            <button class="pill pill-outline" onclick="go('devices')"><svg class="ico" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg> Мои устройства</button>
        </div>
        <button class="pill pill-outline" id="btn-invite-home" onclick="inviteFriend()" style="display:none"><svg class="ico" viewBox="0 0 24 24"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg> Пригласить друга</button>
    </div>
</section>

<!-- ═══ PLANS ═══ -->
<section id="p-plans" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‹</button>
        <h2 class="page-title">Тарифные планы</h2>
    </div>
    <div id="plans-list" class="plans-list"></div>
    <div id="plans-bottom-bar" class="plans-bottom-bar" style="display:none">
        <div id="plans-pm-bar-wrap"></div>
    </div>
</section>

<!-- ═══ RENEW ═══ -->
<section id="p-renew" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‹</button>
        <h2 class="page-title">Продлить подписку</h2>
    </div>
    <div id="renew-plan-view" class="plans-list"></div>
    <div id="renew-bottom-bar" class="plans-bottom-bar" style="display:none">
        <div id="renew-pm-bar-wrap"></div>
    </div>
</section>

<!-- ═══ CONNECT ═══ -->
<section id="p-connect" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‹</button>
        <h2 class="page-title">Подключение</h2>
    </div>
    <!-- Block 1: Подключение -->
    <div class="card" id="con-actions" style="display:none">
        <div class="card-title"><svg class="ico" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Подключение</div>
        <div class="action-pills" style="flex-direction:column;gap:8px">
            <button class="pill pill-cyan btn-full" id="btn-download-auto" onclick="openLink(getDownloadUrl())" style="justify-content:center">
                <svg style="width:16px;height:16px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                &nbsp;<span id="btn-download-label">Скачать приложение</span>
            </button>
            <button class="pill pill-outline btn-full" id="btn-oneclick" onclick="" style="justify-content:center">
                <svg style="width:16px;height:16px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                &nbsp;Подключиться
            </button>
        </div>
    </div>
    <!-- Block 2: Подписка -->
    <div class="card" id="con-sub-block">
        <div class="card-title" id="con-link-title"><svg class="ico" viewBox="0 0 24 24"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg> Подписка</div>
        <div class="action-pills" style="flex-direction:column;gap:8px">
            <button class="pill pill-outline btn-full" id="btn-subpage" onclick="" style="display:none;justify-content:center">
                <svg style="width:16px;height:16px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                &nbsp;Страница подписки
            </button>
            <button class="pill pill-outline btn-full" id="btn-qr" onclick="showQR()" style="display:none;justify-content:center">
                <svg style="width:15px;height:15px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="5" y="5" width="3" height="3" fill="currentColor" stroke="none"/><rect x="16" y="5" width="3" height="3" fill="currentColor" stroke="none"/><rect x="5" y="16" width="3" height="3" fill="currentColor" stroke="none"/><path d="M14 14h3v3M20 14v3h-3M14 20h7v-3"/></svg>
                &nbsp;Показать QR код
            </button>
            <button class="pill pill-outline btn-full" id="btn-show-sub" onclick="toggleSubLink()" style="display:none;justify-content:center">
                <svg class="ico" viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.78 7.78 5.5 5.5 0 017.78-7.78zM15.5 7.5l3-3"/></svg>&nbsp;Показать подписку
            </button>
        </div>
        <div id="con-sub-detail" style="display:none;margin-top:12px">
            <div class="connect-box connect-box-clickable" onclick="copyUrl()" title="Нажмите чтобы скопировать">
                <code id="con-url">—</code>
            </div>
        </div>
    </div>
</section>

<!-- ═══ DEVICES ═══ -->
<section id="p-devices" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‹</button>
        <h2 class="page-title">Мои устройства</h2>
    </div>
    <div id="devices-info" class="card">
        <div class="card-row"><span class="card-label">Лимит</span><span class="card-value" id="dev-limit">—</span></div>
        <div class="card-row"><span class="card-label">Занято</span><span class="card-value" id="dev-used">—</span></div>
    </div>
    <div class="action-pills" style="margin-top:10px">
        <button class="pill pill-outline" id="btn-expand-devices" onclick="expandDevices()" style="display:none"><svg class="ico" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Расширить слоты устройств</button>
    </div>
</section>

<!-- ═══ PROMO ═══ -->
<section id="p-promo" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‹</button>
        <h2 class="page-title">Промокоды</h2>
    </div>
    <div class="card">
        <div class="card-title">Активировать промокод</div>
        <div style="display:flex;gap:8px">
            <input class="form-input" id="promo-input" placeholder="Введите код" style="flex:1">
            <button class="btn btn-primary btn-sm" onclick="activatePromo()">OK</button>
        </div>
        <p id="promo-result" style="font-size:.8rem;margin-top:8px;display:none"></p>
    </div>
</section>

<!-- ═══ SUPPORT ═══ -->
<section id="p-support" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‹</button>
        <h2 class="page-title">Поддержка</h2>
    </div>
    <div class="card card-compact" style="cursor:pointer" onclick="go('tickets')">
        <div class="card-title"><svg class="ico" viewBox="0 0 24 24"><path d="M15 5v2M15 11v2M15 17v2M5 5h14a2 2 0 012 2v3a2 2 0 000 4v3a2 2 0 01-2 2H5a2 2 0 01-2-2v-3a2 2 0 000-4V7a2 2 0 012-2z"/></svg> Тикеты <span id="ticket-badge" class="ticket-badge" style="display:none">0</span></div>
        <span class="pill pill-cyan pill-sm">Открыть</span>
    </div>
    <div class="card card-compact" id="support-community" style="display:none">
        <div class="card-title"><svg class="ico" viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg> Сообщество</div>
        <button class="pill pill-cyan pill-sm" id="btn-community" onclick="">Открыть</button>
    </div>
    <div class="card card-compact" id="support-help" style="display:none">
        <div class="card-title"><svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="4.93" y1="4.93" x2="9.17" y2="9.17"/><line x1="14.83" y1="14.83" x2="19.07" y2="19.07"/><line x1="14.83" y1="9.17" x2="19.07" y2="4.93"/><line x1="4.93" y1="19.07" x2="9.17" y2="14.83"/></svg> Помощь</div>
        <button class="pill pill-outline pill-sm" id="btn-support" onclick="">Написать</button>
    </div>
    <div class="card card-compact" id="support-tos" style="display:none">
        <div class="card-title"><svg class="ico" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Соглашение</div>
        <button class="pill pill-outline pill-sm" id="btn-tos" onclick="">Открыть</button>
    </div>
</section>

<!-- ═══ TICKET LIST ═══ -->
<section id="p-tickets" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‹</button>
        <h2 class="page-title">Мои тикеты</h2>
        <button class="btn btn-primary btn-sm" onclick="showNewTicket()" style="margin-left:auto">+ Новый</button>
    </div>
    <div id="tickets-list" class="ticket-list"></div>
</section>

<!-- ═══ TICKET CHAT ═══ -->
<section id="p-ticket" class="page ticket-page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack();loadTickets()">‹</button>
        <h2 class="page-title" id="ticket-title">Тикет</h2>
    </div>
    <div id="ticket-chat" class="ticket-chat"></div>
    <div class="ticket-bottom-bar">
        <div id="ticket-reply" class="ticket-reply-box" style="display:none">
            <div id="ticket-quote-bar" class="ticket-quote-bar">
                <span class="ticket-quote-bar-text" id="ticket-quote-text"></span>
                <button class="ticket-quote-close" onclick="_clearTicketReply()">✕</button>
            </div>
            <div id="ticket-edit-bar" class="ticket-edit-bar">
                <span class="ticket-edit-bar-text"><svg class="ico" viewBox="0 0 24 24" style="width:14px;height:14px"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Редактирование сообщения</span>
                <button class="ticket-quote-close" onclick="_clearTicketEdit()">✕</button>
            </div>
            <div class="ticket-reply-row">
                <button class="ticket-attach-btn" onclick="$('ticket-file').click()" title="Прикрепить файл">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
                </button>
                <input type="file" id="ticket-file" accept="image/*,.pdf,.doc,.docx,.txt" style="display:none" onchange="_ticketAttachFile(this,'ticket')">
                <textarea id="ticket-text" placeholder="Напишите сообщение…" rows="1"></textarea>
                <button class="ticket-send-btn" onclick="sendTicketReply()"><svg width="22" height="22" viewBox="0 0 24 24" fill="var(--cyan)" stroke="none"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
            </div>
        </div>
    </div>
</section>

<!-- ═══ PROFILE ═══ -->
<section id="p-profile" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‹</button>
        <h2 class="page-title">Профиль</h2>
    </div>
    <!-- Section: Your Profile -->
    <div class="card">
        <div class="card-title"><svg class="ico" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Ваш профиль</div>
        <div class="card-row"><span class="card-label">ID</span><span class="card-value card-value-copy" id="pr-tid" onclick="copyValue(this)">—</span></div>
        <div class="card-row"><span class="card-label">Имя</span><span class="card-value" id="pr-name">—</span></div>
        <div class="card-row" id="pr-refcode-row" style="display:none"><span class="card-label">Реф. код</span><span class="card-value card-value-copy" id="pr-refcode" onclick="copyValue(this)">—</span></div>
    </div>
    <!-- Section: Balance -->
    <div class="card" id="balance-card" style="display:none">
        <div class="card-title"><svg class="ico" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 14h.01"/><path d="M22 7V6a2 2 0 00-2-2H4a2 2 0 00-2 2v1"/></svg> Баланс</div>
        <div class="profile-balance-grid">
            <div class="profile-balance-item">
                <div class="profile-balance-label">Основной</div>
                <div class="profile-balance-value" id="pr-balance">0 ₽</div>
            </div>
            <div class="profile-balance-item" id="pr-bonus-item" style="display:none">
                <div class="profile-balance-label">Бонусный</div>
                <div class="profile-balance-value profile-balance-bonus" id="pr-bonus">0 ₽</div>
            </div>
        </div>
        <div class="profile-balance-actions">
            <button class="pill pill-cyan pill-sm" onclick="topupBalance()">Пополнить</button>
            <button class="pill pill-gold pill-sm" id="btn-get-bonus" onclick="showBonusInfo()" style="display:none">Получить</button>
        </div>
    </div>
    <!-- Section: Referral System -->
    <div class="card" id="ref-card" style="display:none">
        <div class="card-title"><svg class="ico" viewBox="0 0 24 24"><path d="M11 17a1 1 0 001 1h3l4-4a1 1 0 000-1.42l-4-4a1 1 0 00-1.42 0L11 11"/><path d="M13 7a1 1 0 00-1-1H9l-4 4a1 1 0 000 1.42l4 4a1 1 0 001.42 0L13 13"/></svg> Реферальная система</div>
        <div class="ref-stats-grid" id="ref-stats"></div>
        <div class="ref-box">
            <code id="ref-link" style="cursor:pointer" onclick="copyRef()" title="Нажмите чтобы скопировать">—</code>
        </div>
        <button class="pill pill-cyan btn-full" id="btn-invite" onclick="inviteFriend()" style="margin-top:10px;justify-content:center"><svg class="ico" viewBox="0 0 24 24"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg> Пригласить друга</button>
    </div>
    <!-- Section: Web Credentials (below invite) -->
    <div class="card" id="web-cred-card">
        <div class="card-title"><svg class="ico" viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.78 7.78 5.5 5.5 0 017.78-7.78zM15.5 7.5l3-3"/></svg> Веб-доступ</div>
        <div id="web-cred-status"></div>
        <div id="web-cred-setup" style="display:none">
            <div class="form-group"><label>Логин</label><input class="form-input" id="wc-username" placeholder="Мин. 3 символа" autocomplete="off"></div>
            <div class="form-group"><label>Пароль</label><input class="form-input" id="wc-password" type="password" placeholder="Мин. 6 символов"></div>
            <div class="form-group"><label>Подтвердите пароль</label><input class="form-input" id="wc-password2" type="password" placeholder="Повторите пароль"></div>
            <div style="display:flex;gap:8px">
                <button class="sub-action-btn sub-action-renew" style="flex:1" onclick="saveWebCredentials()">Применить</button>
                <button class="sub-action-btn sub-action-change" style="flex:1;border-color:rgba(224,79,95,.35);color:var(--red)" onclick="$('web-cred-setup').style.display='none'">Отмена</button>
            </div>
        </div>
        <div id="web-cred-detail" style="display:none">
            <details class="spoiler-card" id="wc-spoiler">
                <summary><span class="spoiler-title">Данные доступа</span><span class="spoiler-chevron">▼</span></summary>
                <div style="margin-top:10px">
                    <div class="card-row"><span class="card-label">Логин</span><span class="card-value" id="wc-disp-login">—</span></div>
                    <div class="card-row"><span class="card-label">Пароль</span><span class="card-value">••••••</span></div>
                    <div id="wc-change-section" style="display:none;margin-top:10px;border-top:1px solid var(--border);padding-top:10px">
                        <div class="form-group"><label>Старый пароль</label><input class="form-input" id="wc-old-pass" type="password" placeholder="Текущий пароль"></div>
                        <div class="form-group"><label>Новый пароль</label><input class="form-input" id="wc-new-pass" type="password" placeholder="Мин. 6 символов"></div>
                        <div class="form-group"><label>Подтвердите новый пароль</label><input class="form-input" id="wc-new-pass2" type="password" placeholder="Повторите пароль"></div>
                    </div>
                    <button class="pill pill-outline pill-sm" style="margin-top:8px;width:100%;justify-content:center" onclick="showChangePass()">Изменить пароль</button>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button class="sub-action-btn sub-action-renew" style="flex:1;border-color:rgba(25,195,125,.35);color:var(--green)" id="wc-apply-btn" onclick="applyWebCredChange()">Применить</button>
                        <button class="sub-action-btn sub-action-change" style="flex:1;border-color:rgba(224,79,95,.35);color:var(--red)" onclick="cancelWebCredChange()">Отмена</button>
                    </div>
                </div>
            </details>
        </div>
    </div>
</section>

<!-- ═══ ADMIN ═══ -->
<section id="p-admin" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="goBack()">‹</button>
        <h2 class="page-title">Панель управления</h2>
    </div>
    <div class="admin-tabs" id="adm-tabs">
        <button class="admin-tab active" onclick="admTab('stats')"><span class="tab-icon"><svg class="ico" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span><span class="tab-label">Статистика</span></button>
        <button class="admin-tab" onclick="admTab('users')"><span class="tab-icon"><svg class="ico" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg></span><span class="tab-label">Пользователи</span></button>
        <button class="admin-tab" onclick="admTab('plans')"><span class="tab-icon"><svg class="ico" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></span><span class="tab-label">Тарифы</span></button>
        <button class="admin-tab" onclick="admTab('settings')"><span class="tab-icon"><svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></span><span class="tab-label">Настройки</span></button>
        <button class="admin-tab" onclick="admTab('tickets')"><span class="tab-icon"><svg class="ico" viewBox="0 0 24 24"><path d="M15 5v2M15 11v2M15 17v2M5 5h14a2 2 0 012 2v3a2 2 0 000 4v3a2 2 0 01-2 2H5a2 2 0 01-2-2v-3a2 2 0 000-4V7a2 2 0 012-2z"/></svg></span><span class="tab-label">Тикеты</span><span class="admin-tab-badge" id="adm-tickets-badge" style="display:none">0</span></button>
        <button class="admin-tab" onclick="admTab('brand')"><span class="tab-icon"><svg class="ico" viewBox="0 0 24 24"><circle cx="13.5" cy="6.5" r="1.5" fill="currentColor" stroke="none"/><circle cx="17.5" cy="10.5" r="1.5" fill="currentColor" stroke="none"/><circle cx="8.5" cy="7.5" r="1.5" fill="currentColor" stroke="none"/><circle cx="6.5" cy="12" r="1.5" fill="currentColor" stroke="none"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 011.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg></span><span class="tab-label">Бренд</span></button>
    </div>

    <!-- Stats -->
    <div id="adm-stats" class="admin-content active">
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="st-total">—</div><div class="stat-label">Пользователей</div></div>
            <div class="stat-card"><div class="stat-value" id="st-active">—</div><div class="stat-label">Активных</div></div>
            <div class="stat-card"><div class="stat-value" id="st-expired">—</div><div class="stat-label">Истекших</div></div>
            <div class="stat-card"><div class="stat-value" id="st-revenue">—</div><div class="stat-label">Баланс ₽</div></div>
        </div>
    </div>
    <!-- Users -->
    <div id="adm-users" class="admin-content">
        <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="user-search" placeholder="Поиск по имени / ID" oninput="filterUsers()">
        </div>
        <div id="users-list" class="user-list"></div>
    </div>
    <!-- Plans admin -->
    <div id="adm-plans" class="admin-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
            <span style="color:var(--text2);font-size:.84rem" id="adm-plans-count">Тарифы</span>
            <button class="btn btn-primary btn-sm" onclick="showCreatePlan()">+ Создать</button>
        </div>
        <div id="adm-plans-list" class="plans-list"></div>
    </div>
    <!-- Settings -->
    <div id="adm-settings" class="admin-content"><div id="settings-list"></div></div>
    <!-- Admin Tickets -->
    <div id="adm-tickets" class="admin-content">
        <div id="adm-tickets-list" class="ticket-list"></div>
    </div>
    <!-- Brand -->
    <div id="adm-brand" class="admin-content">
        <div class="card">
            <div class="card-title">Настройки бренда</div>
            <div class="form-group"><label>Название</label><input class="form-input" id="br-name" placeholder="Введите название"></div>
            <div class="form-group"><label>Логотип (эмодзи или URL картинки)</label><input class="form-input" id="br-logo" placeholder="Укажите эмодзи или url для логотипа"></div>
            <div class="form-group"><label>Слоган</label><input class="form-input" id="br-slogan" placeholder="Введите слоган"></div>
            <button class="btn btn-primary btn-full" id="btn-save-brand" onclick="saveBrand()">Сохранить</button>
        </div>
    </div>
</section>

<!-- ═══ ADMIN USER DETAIL ═══ -->
<section id="p-auser" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="admTab('users');goBack()">‹</button>
        <h2 class="page-title" id="aud-title">Пользователь</h2>
    </div>
    <div id="aud-body"></div>
</section>

<!-- ═══ ADMIN TICKET DETAIL ═══ -->
<section id="p-aticket" class="page ticket-page">
    <div class="page-header">
        <button class="btn-back" onclick="admTab('tickets');goBack()">‹</button>
        <h2 class="page-title" id="at-title">Тикет</h2>
    </div>
    <div id="at-chat" class="ticket-chat"></div>
    <div class="ticket-bottom-bar">
        <div id="at-reply" class="ticket-reply-box">
            <div id="at-quote-bar" class="ticket-quote-bar">
                <span class="ticket-quote-bar-text" id="at-quote-text"></span>
                <button class="ticket-quote-close" onclick="_clearAdmReply()">✕</button>
            </div>
            <div id="at-edit-bar" class="ticket-edit-bar">
                <span class="ticket-edit-bar-text"><svg class="ico" viewBox="0 0 24 24" style="width:14px;height:14px"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Редактирование сообщения</span>
                <button class="ticket-quote-close" onclick="_clearAdmEdit()">✕</button>
            </div>
            <div class="ticket-reply-row">
                <button class="ticket-attach-btn" onclick="$('at-file').click()" title="Прикрепить файл">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
                </button>
                <input type="file" id="at-file" accept="image/*,.pdf,.doc,.docx,.txt" style="display:none" onchange="_ticketAttachFile(this,'adm')">
                <textarea id="at-text" placeholder="Ответ администратора…" rows="1"></textarea>
                <button class="ticket-send-btn" onclick="sendAdmTicketReply()"><svg width="22" height="22" viewBox="0 0 24 24" fill="var(--cyan)" stroke="none"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
            </div>
        </div>
    </div>
</section>

</main>

<!-- Ticket message context menu -->
<div id="msg-ctx-menu" class="msg-ctx-menu" style="display:none">
    <button onclick="_ctxReply()"><svg class="ico" viewBox="0 0 24 24" style="width:16px;height:16px"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 00-4-4H4"/></svg> Ответить</button>
    <div id="ctx-edit-wrap"><hr><button onclick="_ctxEdit()"><svg class="ico" viewBox="0 0 24 24" style="width:16px;height:16px"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Изменить</button></div>
    <div id="ctx-del-wrap"><button class="danger" onclick="_ctxDelete()"><svg class="ico" viewBox="0 0 24 24" style="width:16px;height:16px"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg> Удалить</button></div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <button class="nav-item active" data-p="home" onclick="go('home')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span>Главная</span>
    </button>
    <button class="nav-item" data-p="profile" onclick="go('profile')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span>Профиль</span>
    </button>
    <button class="nav-item" id="nav-community" onclick="" style="display:none">
        <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.783-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
        <span>Группа</span>
    </button>
    <button class="nav-item" data-p="support" onclick="go('tickets')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        <span>Поддержка</span>
        <span class="nav-badge" id="nav-support-badge" style="display:none">0</span>
    </button>
    <button class="nav-item admin-nav" data-p="admin" onclick="go('admin')" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        <span>Админ</span>
        <span class="nav-badge" id="nav-admin-badge" style="display:none">0</span>
    </button>
</nav>
</div>

<div id="modal-root"></div>
<div id="toast" class="toast"></div>
</div>
<script>
/* ═══════════════════════════════════════
   GLOBALS
   ═══════════════════════════════════════ */
const API='/web';
let tg;
try { tg = window.Telegram.WebApp; } catch(e) {
    tg = {ready:()=>{},expand:()=>{},initData:'',setHeaderColor:()=>{},setBackgroundColor:()=>{},
          openTelegramLink:u=>window.open(u,'_blank'),openLink:u=>window.open(u,'_blank'),
          BackButton:{show:()=>{},hide:()=>{},offClick:()=>{},onClick:()=>{}}};
}
let D=null, BRAND={name:'',logo:'',slogan:''}, IS_ADMIN=false;
let planSel={};
const DEFAULT_LOGO='https://i.ibb.co/fdp0nVLN/small-logo.png';
const DEFAULT_NAME='DFC Online';
const DEFAULT_SLOGAN='Работает из упаковки';
let usersCache=[], curAdmTab='stats', DOMAIN='';
const AVAIL_LABELS={ALL:'Все',NEW:'Новые',EXISTING:'Действующие',INVITED:'Приглашённые',ALLOWED:'Разрешённые',TRIAL:'Пробный'};
const TYPE_LABELS={TRAFFIC:'Трафик',DEVICES:'Устройства',BOTH:'Трафик+Устр.',UNLIMITED:'Безлимит'};
const CURRENCY_SYMBOLS={USD:'$',EUR:'€',XTR:'★',RUB:'₽'};

/* ── SVG Icons (replace emoji) ── */
const IC={
gift:'<svg class="ico" viewBox="0 0 24 24"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/></svg>',
connect:'<svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>',
promo:'<svg class="ico" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>',
phone:'<svg class="ico" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
link:'<svg class="ico" viewBox="0 0 24 24"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>',
key:'<svg class="ico" viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.78 7.78 5.5 5.5 0 017.78-7.78zM15.5 7.5l3-3"/></svg>',
plus:'<svg class="ico" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
ticket:'<svg class="ico" viewBox="0 0 24 24"><path d="M15 5v2M15 11v2M15 17v2M5 5h14a2 2 0 012 2v3a2 2 0 000 4v3a2 2 0 01-2 2H5a2 2 0 01-2-2v-3a2 2 0 000-4V7a2 2 0 012-2z"/></svg>',
chat:'<svg class="ico" viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>',
lifebuoy:'<svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="4.93" y1="4.93" x2="9.17" y2="9.17"/><line x1="14.83" y1="14.83" x2="19.07" y2="19.07"/><line x1="14.83" y1="9.17" x2="19.07" y2="4.93"/><line x1="4.93" y1="19.07" x2="9.17" y2="14.83"/></svg>',
file:'<svg class="ico" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
user:'<svg class="ico" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
wallet:'<svg class="ico" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 14h.01"/><path d="M22 7V6a2 2 0 00-2-2H4a2 2 0 00-2 2v1"/></svg>',
handshake:'<svg class="ico" viewBox="0 0 24 24"><path d="M11 17a1 1 0 001 1h3l4-4a1 1 0 000-1.42l-4-4a1 1 0 00-1.42 0L11 11"/><path d="M13 7a1 1 0 00-1-1H9l-4 4a1 1 0 000 1.42l4 4a1 1 0 001.42 0L13 13"/></svg>',
chart:'<svg class="ico" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
users:'<svg class="ico" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>',
list:'<svg class="ico" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
settings:'<svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>',
palette:'<svg class="ico" viewBox="0 0 24 24"><circle cx="13.5" cy="6.5" r="1.5" fill="currentColor" stroke="none"/><circle cx="17.5" cy="10.5" r="1.5" fill="currentColor" stroke="none"/><circle cx="8.5" cy="7.5" r="1.5" fill="currentColor" stroke="none"/><circle cx="6.5" cy="12" r="1.5" fill="currentColor" stroke="none"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 011.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>',
trash:'<svg class="ico" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>',
edit:'<svg class="ico" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
reply:'<svg class="ico" viewBox="0 0 24 24"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 00-4-4H4"/></svg>',
bolt:'<svg class="ico" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
pkg:'<svg class="ico" viewBox="0 0 24 24"><path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
download:'<svg class="ico" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
star:'<svg class="ico ico-f" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
coin:'<svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M9 9h6M9 15h6"/></svg>',
gem:'<svg class="ico" viewBox="0 0 24 24"><polygon points="12 2 2 7 12 22 22 7 12 2"/><polyline points="2 7 12 12 22 7"/></svg>',
bot:'<svg class="ico" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><line x1="12" y1="7" x2="12" y2="11"/><line x1="8" y1="16" x2="8" y2="16.01"/><line x1="16" y1="16" x2="16" y2="16.01"/></svg>',
bell:'<svg class="ico" viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/></svg>',
transfer:'<svg class="ico" viewBox="0 0 24 24"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 014-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 01-4 4H3"/></svg>',
tag:'<svg class="ico" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>',
globe:'<svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>',
card:'<svg class="ico" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>',
megaphone:'<svg class="ico" viewBox="0 0 24 24"><path d="M21 15V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10"/><polyline points="3 15 12 20 21 15"/></svg>',
scroll:'<svg class="ico" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
cart:'<svg class="ico" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>',
pencil:'<svg class="ico" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',
lang:'<svg class="ico" viewBox="0 0 24 24"><path d="M5 8l6 10M15 4l-4 12"/><path d="M2 12h20"/><path d="M18 8a9 9 0 01-9 14"/></svg>',
currency:'<svg class="ico" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
check:'<svg class="ico" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>',
x:'<svg class="ico" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
warn:'<svg class="ico" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
};

/* ── i18n ── */
const I18N={
    RU:{
        home:'Главная',support:'Поддержка',profile:'Профиль',admin:'Админ',
        buy:'Оплатить',buy_sub:'Купить подписку',trial:'Попробовать бесплатно',connect:'Подключиться',renew:'Продлить',change_plan:'Сменить',manage_sub:'Управление подпиской',
        promo:'Промокоды',devices:'Устройства',plans:'Тарифные планы',
        connect_title:'Подключение',devices_title:'Мои устройства',
        sub_link:'Ссылка подписки',copy:'Копировать',download:'Скачать приложение',
        no_sub:'Нет подписки',active:'Активна',expired:'Истекла',trial_period:'Пробный период',
        limit:'Лимит',used:'Занято',expand_devices:'Расширить слоты устройств',
        activate_promo:'Активировать промокод',enter_code:'Введите код',
        tickets:'Тикеты',community:'Сообщество',help:'Помощь',open:'Открыть',write:'Написать',
        my_tickets:'Мои тикеты',new_ticket:'Новый',
        name:'Имя',telegram:'Telegram',balance:'Баланс',role:'Роль',
        invite_friend:'Пригласить друга',copy_link:'Скопировать ссылку',
        remains:'Осталось',days_left:'дн.',
        select_period:'Выберите период:',cancel:'Отмена',close:'Закрыть',
        active_sub_note:'У вас есть активная подписка. Оплата будет списана с баланса.',
        not_enough:'Недостаточно средств. Баланс:',processing:'Обработка покупки…',
        sub_done:'Подписка оформлена!',purchase_error:'Ошибка покупки',net_error:'Ошибка сети',
        trial_activating:'Активация пробной подписки…',trial_done:'Пробная подписка активирована!',
        trial_go_connect:'Перейдите в раздел «Подключение» для настройки.',
        setup:'Настроить',expand_unavail:'Недоступно',
        expand_trial_msg:'Расширение слотов устройств недоступно в пробной подписке. Приобретите полный тариф.',
        buy_plan:'Купить тариф',
        no_plans:'Нет доступных тарифов',loading:'Загрузка…',error:'Ошибка',
        savings:'Выгода',
        new_ticket_title:'Новый тикет',subject:'Тема',message:'Сообщение',send:'Отправить',
        fill_all:'Заполните все поля',ticket_created:'Тикет создан',
        resolved:'Вопрос решён',unresolved:'Не решён',
        ticket_closed_resolved:'Тикет закрыт как решённый',ticket_closed_unresolved:'Тикет закрыт как нерешённый',
        ticket_open:'На рассмотрении',ticket_answered:'Ответ получен',ticket_closed:'Закрыт',ticket_new:'Новое',
        ticket_adm_new:'Новый',ticket_adm_done:'Готово',
        waiting_payment:'Ожидание оплаты',waiting_payment_hint:'Завершите оплату на странице платёжной системы',pay_success:'Оплата прошла успешно!',
        copied:'Скопировано!',link_copied:'Ссылка скопирована!',no_sub_err:'Нет подписки',
        user_role:'Пользователь',admin_role:'Администратор',dev_role:'Разработчик',
        agreement:'Соглашение',no_tickets:'Нет тикетов',create_first:'Создайте первый тикет',
        write_msg:'Напишите сообщение…',
        traffic:'Трафик',dev_short:'устр.',select_plan:'Выбрать тариф',to_date:'до',topup:'Пополнить',
        topup_via_bot:'Пополнение баланса доступно через бота',expand_via_bot:'Расширение устройств доступно через бота',
        promo_activated:'Промокод активирован!',quick_connect:'Быстрое подключение',one_click:'Подключиться',
        sub_page:'Страница подписки',no_active_sub:'Нет активной подписки',saved:'Сохранено',
        auth_error:'Ошибка авторизации. Откройте из Telegram.',user_not_found:'Пользователь не найден. Запустите бота.',
        show_qr:'Показать QR код',show_sub:'Показать подписку',hide_sub:'Скрыть подписку',
        done:'Готово',confirm:'Подтвердить',connection:'Подключение',subscription:'Подписка',
        tariff:'Тариф',period:'Период',cost:'Стоимость',
        sub_change_note:'Подписка будет изменена без перерасчёта средств',sub_renew_note:'Ваша подписка будет продлена',
        download_for:'Скачать для',download_app:'Скачать приложение',topup_amount:'Сумма',payment_method:'Способ оплаты',
        pay_created:'Платёж создан',enter_amount:'Введите сумму',level:'Уровневость',
        reward_l1:'Награда (ур. 1)',reward_l2:'Награда (ур. 2)',reward_type:'Тип награды',
        accrual_cond:'Условия начисления',accrual_form:'Форма начисления',
        invite_text:'Текст приглашения',ref_system:'Реферальная система',
        per_month:'в месяц',best_deal:'выгодно',change_method:'Изменить',
        change_pay_method:'Изменить способ оплаты',pay_btn:'Оплатить',
        apply_code:'Применить',promo_placeholder:'Промокод...',
        admin_panel:'Панель управления',statistics:'Статистика',users:'Пользователи',
        tariffs:'Тарифы',settings:'Настройки',branding:'Бренд',
        web_access:'Веб-доступ',your_profile:'Ваш профиль',referral_sys:'Реферальная система',
        invited:'Приглашено',payments:'Оплат',earned:'Начислено',
        save:'Сохранить',deleted:'Удалён',delete_plan_q:'Удалить тариф?',delete_ticket_q:'Удалить тикет?',
    },
    EN:{
        home:'Home',support:'Support',profile:'Profile',admin:'Admin',
        buy:'Pay',buy_sub:'Buy subscription',trial:'Try for free',connect:'Connect',renew:'Renew',change_plan:'Change plan',manage_sub:'Manage subscription',
        promo:'Promo codes',devices:'Devices',plans:'Plans',
        connect_title:'Connection',devices_title:'My Devices',
        sub_link:'Subscription Link',copy:'Copy',download:'Download App',
        no_sub:'No subscription',active:'Active',expired:'Expired',trial_period:'Trial',
        limit:'Limit',used:'Used',expand_devices:'Expand device slots',
        activate_promo:'Activate promo code',enter_code:'Enter code',
        tickets:'Tickets',community:'Community',help:'Help',open:'Open',write:'Write',
        my_tickets:'My Tickets',new_ticket:'New',
        name:'Name',telegram:'Telegram',balance:'Balance',role:'Role',
        invite_friend:'Invite a friend',copy_link:'Copy link',
        remains:'Remaining',days_left:'d.',
        select_period:'Choose period:',cancel:'Cancel',close:'Close',
        active_sub_note:'You have an active subscription. Payment will be deducted from balance.',
        not_enough:'Not enough funds. Balance:',processing:'Processing purchase…',
        sub_done:'Subscription activated!',purchase_error:'Purchase error',net_error:'Network error',
        trial_activating:'Activating trial subscription…',trial_done:'Trial subscription activated!',
        trial_go_connect:'Go to "Connection" section to configure.',
        setup:'Setup',expand_unavail:'Unavailable',
        expand_trial_msg:'Device expansion is not available on trial. Purchase a full plan.',
        buy_plan:'Buy plan',
        no_plans:'No available plans',loading:'Loading…',error:'Error',
        savings:'Save',
        new_ticket_title:'New Ticket',subject:'Subject',message:'Message',send:'Send',
        fill_all:'Fill in all fields',ticket_created:'Ticket created',
        resolved:'Resolved',unresolved:'Not resolved',
        ticket_closed_resolved:'Ticket closed as resolved',ticket_closed_unresolved:'Ticket closed as unresolved',
        ticket_open:'Pending',ticket_answered:'Reply received',ticket_closed:'Closed',ticket_new:'New',
        ticket_adm_new:'New',ticket_adm_done:'Done',
        waiting_payment:'Waiting for payment',waiting_payment_hint:'Complete payment on the payment system page',pay_success:'Payment successful!',
        copied:'Copied!',link_copied:'Link copied!',no_sub_err:'No subscription',
        user_role:'User',admin_role:'Administrator',dev_role:'Developer',
        agreement:'Terms',no_tickets:'No tickets',create_first:'Create your first ticket',
        write_msg:'Write a message…',
        traffic:'Traffic',dev_short:'dev.',select_plan:'Select plan',to_date:'until',topup:'Top up',
        topup_via_bot:'Top up balance via bot',expand_via_bot:'Device expansion available via bot',
        promo_activated:'Promo code activated!',quick_connect:'Quick connect',one_click:'Connect',
        sub_page:'Subscription page',no_active_sub:'No active subscription',saved:'Saved',
        auth_error:'Auth error. Open from Telegram.',user_not_found:'User not found. Start the bot.',
        show_qr:'Show QR code',show_sub:'Show subscription',hide_sub:'Hide subscription',
        done:'Done',confirm:'Confirm',connection:'Connection',subscription:'Subscription',
        tariff:'Tariff',period:'Period',cost:'Cost',
        sub_change_note:'Subscription will be changed without refund',sub_renew_note:'Your subscription will be renewed',
        download_for:'Download for',download_app:'Download app',topup_amount:'Amount',payment_method:'Payment method',
        pay_created:'Payment created',enter_amount:'Enter amount',level:'Levels',
        reward_l1:'Reward (lvl 1)',reward_l2:'Reward (lvl 2)',reward_type:'Reward type',
        accrual_cond:'Accrual conditions',accrual_form:'Accrual form',
        invite_text:'Invite text',ref_system:'Referral system',
        per_month:'per month',best_deal:'best deal',change_method:'Change',
        change_pay_method:'Change payment method',pay_btn:'Pay',
        apply_code:'Apply',promo_placeholder:'Promo code...',
        admin_panel:'Control panel',statistics:'Statistics',users:'Users',
        tariffs:'Plans',settings:'Settings',branding:'Brand',
        web_access:'Web access',your_profile:'Your profile',referral_sys:'Referral system',
        invited:'Invited',payments:'Payments',earned:'Earned',
        save:'Save',deleted:'Deleted',delete_plan_q:'Delete tariff?',delete_ticket_q:'Delete ticket?',
    },
    UK:{
        home:'Головна',support:'Підтримка',profile:'Профіль',admin:'Адмін',
        buy:'Оплатити',trial:'Спробувати безкоштовно',connect:'Підключитися',renew:'Продовжити',change_plan:'Зміна тарифу',
        promo:'Промокоди',devices:'Пристрої',plans:'Тарифні плани',
        connect_title:'Підключення',devices_title:'Мої пристрої',
        sub_link:'Посилання підписки',copy:'Копіювати',download:'Завантажити додаток',
        no_sub:'Немає підписки',active:'Активна',expired:'Закінчилась',trial_period:'Пробний період',
        limit:'Ліміт',used:'Зайнято',expand_devices:'Розширити слоти пристроїв',
        activate_promo:'Активувати промокод',enter_code:'Введіть код',
        tickets:'Тікети',community:'Спільнота',help:'Допомога',open:'Відкрити',write:'Написати',
        my_tickets:'Мої тікети',new_ticket:'Новий',
        name:'Імʼя',telegram:'Telegram',balance:'Баланс',role:'Роль',
        invite_friend:'Запросити друга',copy_link:'Скопіювати посилання',
        remains:'Залишилось',days_left:'дн.',
        select_period:'Оберіть період:',cancel:'Скасувати',close:'Закрити',
        active_sub_note:'У вас є активна підписка. Оплата буде списана з балансу.',
        not_enough:'Недостатньо коштів. Баланс:',processing:'Обробка покупки…',
        sub_done:'Підписку оформлено!',purchase_error:'Помилка покупки',net_error:'Помилка мережі',
        trial_activating:'Активація пробної підписки…',trial_done:'Пробну підписку активовано!',
        trial_go_connect:'Перейдіть до розділу «Підключення» для налаштування.',
        setup:'Налаштувати',expand_unavail:'Недоступно',
        expand_trial_msg:'Розширення слотів пристроїв недоступне в пробній підписці. Придбайте повний тариф.',
        buy_plan:'Купити тариф',
        no_plans:'Немає доступних тарифів',loading:'Завантаження…',error:'Помилка',
        savings:'Вигода',
        new_ticket_title:'Новий тікет',subject:'Тема',message:'Повідомлення',send:'Надіслати',
        fill_all:'Заповніть всі поля',ticket_created:'Тікет створено',
        resolved:'Питання вирішено',unresolved:'Не вирішено',
        ticket_closed_resolved:'Тікет закрито як вирішений',ticket_closed_unresolved:'Тікет закрито як невирішений',
        ticket_open:'На розгляді',ticket_answered:'Відповідь отримано',ticket_closed:'Закритий',ticket_new:'Нове',
        ticket_adm_new:'Новий',ticket_adm_done:'Готово',
        waiting_payment:'Очікування оплати',waiting_payment_hint:'Завершіть оплату на сторінці платіжної системи',pay_success:'Оплата пройшла успішно!',
        copied:'Скопійовано!',link_copied:'Посилання скопійовано!',no_sub_err:'Немає підписки',
        user_role:'Користувач',admin_role:'Адміністратор',dev_role:'Розробник',
        agreement:'Угода',no_tickets:'Немає тікетів',create_first:'Створіть перший тікет',
        write_msg:'Напишіть повідомлення…',
        traffic:'Трафік',dev_short:'пристр.',select_plan:'Обрати тариф',to_date:'до',topup:'Поповнити',
        topup_via_bot:'Поповнення балансу доступне через бота',expand_via_bot:'Розширення пристроїв доступне через бота',
        promo_activated:'Промокод активовано!',quick_connect:'Швидке підключення',one_click:'Підключитися',
        sub_page:'Сторінка підписки',no_active_sub:'Немає активної підписки',saved:'Збережено',
        auth_error:'Помилка авторизації. Відкрийте з Telegram.',user_not_found:'Користувача не знайдено. Запустіть бота.',
        show_qr:'Показати QR код',show_sub:'Показати підписку',hide_sub:'Сховати підписку',
        done:'Готово',confirm:'Підтвердити',connection:'Підключення',subscription:'Підписка',
        tariff:'Тариф',period:'Період',cost:'Вартість',
        sub_change_note:'Підписку буде змінено без перерахунку коштів',sub_renew_note:'Вашу підписку буде продовжено',
        download_for:'Завантажити для',download_app:'Завантажити додаток',topup_amount:'Сума',payment_method:'Спосіб оплати',
        pay_created:'Платіж створено',enter_amount:'Введіть суму',level:'Рівневість',
        reward_l1:'Нагорода (рів. 1)',reward_l2:'Нагорода (рів. 2)',reward_type:'Тип нагороди',
        accrual_cond:'Умови нарахування',accrual_form:'Форма нарахування',
        invite_text:'Текст запрошення',ref_system:'Реферальна система',
        per_month:'на місяць',best_deal:'вигідно',change_method:'Змінити',
        change_pay_method:'Змінити спосіб оплати',pay_btn:'Оплатити',
        apply_code:'Застосувати',promo_placeholder:'Промокод...',
        admin_panel:'Панель управління',statistics:'Статистика',users:'Користувачі',
        tariffs:'Тарифи',settings:'Налаштування',branding:'Бренд',
        web_access:'Веб-доступ',your_profile:'Ваш профіль',referral_sys:'Реферальна система',
        invited:'Запрошено',payments:'Оплат',earned:'Нараховано',
        save:'Зберегти',deleted:'Видалено',delete_plan_q:'Видалити тариф?',delete_ticket_q:'Видалити тикет?',
    },
    DE:{
        home:'Startseite',support:'Support',profile:'Profil',admin:'Admin',
        buy:'Bezahlen',trial:'Kostenlos testen',connect:'Verbinden',renew:'Verlängern',change_plan:'Tarif wechseln',
        promo:'Promocodes',devices:'Geräte',plans:'Tarife',
        connect_title:'Verbindung',devices_title:'Meine Geräte',
        sub_link:'Abo-Link',copy:'Kopieren',download:'App herunterladen',
        no_sub:'Kein Abo',active:'Aktiv',expired:'Abgelaufen',trial_period:'Testphase',
        limit:'Limit',used:'Belegt',expand_devices:'Geräteslots erweitern',
        activate_promo:'Promocode aktivieren',enter_code:'Code eingeben',
        tickets:'Tickets',community:'Community',help:'Hilfe',open:'Öffnen',write:'Schreiben',
        my_tickets:'Meine Tickets',new_ticket:'Neu',
        name:'Name',telegram:'Telegram',balance:'Guthaben',role:'Rolle',
        invite_friend:'Freund einladen',copy_link:'Link kopieren',
        remains:'Verbleibend',days_left:'T.',
        select_period:'Zeitraum wählen:',cancel:'Abbrechen',close:'Schließen',
        active_sub_note:'Sie haben ein aktives Abo. Zahlung wird vom Guthaben abgezogen.',
        not_enough:'Nicht genug Guthaben. Saldo:',processing:'Kauf wird bearbeitet…',
        sub_done:'Abo abgeschlossen!',purchase_error:'Kauffehler',net_error:'Netzwerkfehler',
        trial_activating:'Test-Abo wird aktiviert…',trial_done:'Test-Abo aktiviert!',
        trial_go_connect:'Gehen Sie zum Abschnitt "Verbindung" zur Einrichtung.',
        setup:'Einrichten',expand_unavail:'Nicht verfügbar',
        expand_trial_msg:'Geräteerweiterung im Testabo nicht verfügbar. Erwerben Sie einen vollen Tarif.',
        buy_plan:'Tarif kaufen',
        no_plans:'Keine verfügbaren Tarife',loading:'Laden…',error:'Fehler',
        savings:'Ersparnis',
        new_ticket_title:'Neues Ticket',subject:'Betreff',message:'Nachricht',send:'Senden',
        fill_all:'Alle Felder ausfüllen',ticket_created:'Ticket erstellt',
        resolved:'Gelöst',unresolved:'Nicht gelöst',
        ticket_closed_resolved:'Ticket als gelöst geschlossen',ticket_closed_unresolved:'Ticket als ungelöst geschlossen',
        ticket_open:'In Bearbeitung',ticket_answered:'Antwort erhalten',ticket_closed:'Geschlossen',ticket_new:'Neu',
        ticket_adm_new:'Neu',ticket_adm_done:'Erledigt',
        waiting_payment:'Warten auf Zahlung',waiting_payment_hint:'Schließen Sie die Zahlung auf der Zahlungsseite ab',pay_success:'Zahlung erfolgreich!',
        copied:'Kopiert!',link_copied:'Link kopiert!',no_sub_err:'Kein Abo',
        user_role:'Benutzer',admin_role:'Administrator',dev_role:'Entwickler',
        agreement:'AGB',no_tickets:'Keine Tickets',create_first:'Erstellen Sie Ihr erstes Ticket',
        write_msg:'Nachricht schreiben…',
        traffic:'Traffic',dev_short:'Ger.',select_plan:'Tarif wählen',to_date:'bis',topup:'Aufladen',
        topup_via_bot:'Guthaben über Bot aufladen',expand_via_bot:'Geräteerweiterung über Bot verfügbar',
        promo_activated:'Promocode aktiviert!',quick_connect:'Schnellverbindung',one_click:'Verbinden',
        sub_page:'Abo-Seite',no_active_sub:'Kein aktives Abo',saved:'Gespeichert',
        auth_error:'Auth-Fehler. Aus Telegram öffnen.',user_not_found:'Benutzer nicht gefunden. Bot starten.',
        show_qr:'QR-Code anzeigen',show_sub:'Abo anzeigen',hide_sub:'Abo verbergen',
        done:'Fertig',confirm:'Bestätigen',connection:'Verbindung',subscription:'Abonnement',
        tariff:'Tarif',period:'Zeitraum',cost:'Kosten',
        sub_change_note:'Abo wird ohne Rückerstattung geändert',sub_renew_note:'Ihr Abo wird verlängert',
        download_for:'Herunterladen für',download_app:'App herunterladen',topup_amount:'Betrag',payment_method:'Zahlungsmethode',
        pay_created:'Zahlung erstellt',enter_amount:'Betrag eingeben',level:'Stufen',
        reward_l1:'Belohnung (St. 1)',reward_l2:'Belohnung (St. 2)',reward_type:'Belohnungstyp',
        accrual_cond:'Gutschriftbedingungen',accrual_form:'Gutschriftform',
        invite_text:'Einladungstext',ref_system:'Empfehlungssystem',
        per_month:'pro Monat',best_deal:'günstig',change_method:'Ändern',
        change_pay_method:'Zahlungsmethode ändern',pay_btn:'Bezahlen',
        apply_code:'Anwenden',promo_placeholder:'Promocode...',
        admin_panel:'Verwaltung',statistics:'Statistik',users:'Benutzer',
        tariffs:'Tarife',settings:'Einstellungen',branding:'Marke',
        web_access:'Web-Zugang',your_profile:'Ihr Profil',referral_sys:'Empfehlungssystem',
        invited:'Eingeladen',payments:'Zahlungen',earned:'Verdient',
        save:'Speichern',deleted:'Gelöscht',delete_plan_q:'Tarif löschen?',delete_ticket_q:'Ticket löschen?',
    }
};
let CUR_LOCALE='RU';
function t(k){return (I18N[CUR_LOCALE]||I18N.RU)[k]||(I18N.RU[k]||k)}
function applyLocale(){
    // Navigation labels
    document.querySelectorAll('.nav-item').forEach(b=>{
        const pg=b.dataset.p;
        if(pg==='home') b.querySelector('span').textContent=t('home');
        if(pg==='support') b.querySelector('span').textContent=t('support');
        if(pg==='profile') b.querySelector('span').textContent=t('profile');
        if(pg==='admin') b.querySelector('span').textContent=t('admin');
    });
    // Home page buttons
    const hp=$('p-home');
    if(hp){
        const trial=$('btn-trial');if(trial)trial.innerHTML=IC.gift+'&nbsp; '+t('trial');
        // Sub card buttons
        $('sub-nosub-text').textContent=t('no_active_sub');
        $('btn-buy-sub').textContent=t('buy_sub');
        $('btn-renew').textContent=t('renew');
        const pills=hp.querySelectorAll('.pill');
        pills.forEach(p=>{
            const oc=p.getAttribute('onclick')||'';
            if(oc.includes("go('connect')")) p.innerHTML=IC.connect+' '+t('connect');
            if(oc.includes("go('promo')")) p.innerHTML=IC.promo+' '+t('promo');
            if(oc.includes("go('devices')")) p.innerHTML=IC.phone+' '+t('devices');
            if(oc.includes("inviteFriend()")) p.innerHTML=IC.link+' '+t('invite_friend');
        });
        const commB=$('btn-community-home');if(commB&&commB.style.display!=='none')commB.innerHTML=IC.chat+' '+t('community');
        const helpB=$('btn-help-home');if(helpB)helpB.innerHTML=IC.lifebuoy+' '+t('help');
    }
    // Page titles
    const pts={'p-plans':'plans','p-connect':'connect_title','p-devices':'devices_title','p-promo':'promo','p-support':'support','p-tickets':'my_tickets','p-profile':'profile'};
    Object.entries(pts).forEach(([id,key])=>{const el=$(id);if(el){const tt=el.querySelector('.page-title');if(tt)tt.textContent=t(key)}});
    // Connect page
    const cp=$('p-connect');
    if(cp){
        const cardTitles=cp.querySelectorAll('.card-title');
        if(cardTitles[0])cardTitles[0].innerHTML=IC.bolt+' '+t('connection');
        if(cardTitles[1])cardTitles[1].innerHTML=IC.link+' '+t('subscription');
        // Download button
        const dlBtn=$('btn-download-label');
        if(dlBtn) dlBtn.textContent=t('download_app');
        const cpills=cp.querySelectorAll('.pill');
        cpills.forEach(p=>{
            const id=p.id||'';
            if(id==='btn-oneclick'){const txt=p.childNodes[p.childNodes.length-1];if(txt)txt.textContent=' '+t('one_click')}
            if(id==='btn-subpage'){const txt=p.childNodes[p.childNodes.length-1];if(txt)txt.textContent=' '+t('sub_page')}
            if(id==='btn-qr') p.innerHTML='<svg style="width:15px;height:15px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="5" y="5" width="3" height="3" fill="currentColor" stroke="none"/><rect x="16" y="5" width="3" height="3" fill="currentColor" stroke="none"/><rect x="5" y="16" width="3" height="3" fill="currentColor" stroke="none"/><path d="M14 14h3v3M20 14v3h-3M14 20h7v-3"/></svg>&nbsp;'+t('show_qr');
            if(id==='btn-show-sub'){const det=$('con-sub-detail');p.innerHTML=IC.key+'&nbsp;'+(det&&det.style.display!=='none'?t('hide_sub'):t('show_sub'))}
        });
    }
    // Devices page
    const dp=$('p-devices');
    if(dp){
        const labels=dp.querySelectorAll('.card-label');
        if(labels[0])labels[0].textContent=t('limit');
        if(labels[1])labels[1].textContent=t('used');
        const eb=$('btn-expand-devices');if(eb)eb.innerHTML=IC.plus+' '+t('expand_devices');
    }
    // Promo page
    const pp=$('p-promo');
    if(pp){
        const ct=pp.querySelector('.card-title');if(ct)ct.textContent=t('activate_promo');
        const inp=$('promo-input');if(inp)inp.placeholder=t('enter_code');
    }
    // Support page
    const sp=$('p-support');
    if(sp){
        const cards=sp.querySelectorAll('.card');
        cards.forEach(c=>{
            const ct=c.querySelector('.card-title');if(!ct)return;
            if(ct.querySelector('#ticket-badge')||ct.querySelector('.ico')){const svg=ct.querySelector('svg');if(svg&&ct.querySelector('#ticket-badge')){const tn=document.createTextNode(' '+t('tickets')+' ');if(ct.childNodes[1])ct.replaceChild(tn,ct.childNodes[1]);else ct.insertBefore(tn,ct.querySelector('#ticket-badge'))}}
            const cid=c.id||'';
            if(cid==='support-community'){ct.innerHTML=IC.chat+' '+t('community')}
            if(cid==='support-help'){ct.innerHTML=IC.lifebuoy+' '+t('help')}
            if(cid==='support-tos'){ct.innerHTML=IC.file+' '+t('agreement')}
        });
        sp.querySelectorAll('.pill').forEach(p=>{
            const oc=p.getAttribute('onclick')||'',id=p.id||'';
            if(oc.includes("go('tickets')")) p.textContent=t('open');
            if(id==='btn-community') p.textContent=t('open');
            if(id==='btn-support') p.textContent=t('write');
            if(id==='btn-tos') p.textContent=t('open');
        });
    }
    // Tickets page
    const tp=$('p-tickets');
    if(tp){const nb=tp.querySelector('.btn');if(nb&&nb.textContent.includes('Новый')||nb&&nb.textContent.includes('New')||nb)nb.textContent='+ '+t('new_ticket')}
    // Ticket chat
    const ttext=$('ticket-text');if(ttext)ttext.placeholder=t('write_msg');
    const cbtns=$('ticket-close-actions');
    if(cbtns){
        const btns=cbtns.querySelectorAll('.ticket-close-btn');
        if(btns[0])btns[0].innerHTML=IC.check+' '+t('resolved');
        if(btns[1])btns[1].innerHTML=IC.x+' '+t('unresolved');
    }
    // Profile page
    const pf=$('p-profile');
    if(pf){
        const labels=pf.querySelectorAll('.card-label');
        // Profile layout: ID, Имя, Реф.код
        if(labels[0])labels[0].textContent='ID';
        if(labels[1])labels[1].textContent=t('name');
        const cardTitles=pf.querySelectorAll('.card-title');
        cardTitles.forEach((ct,i)=>{
            if(i===0)ct.innerHTML=IC.user+' '+t('profile');
            if(i===1)ct.innerHTML=IC.wallet+' '+t('balance');
            if(i===2)ct.innerHTML=IC.handshake+' '+t('invite_friend');
        });
        const pfPills=pf.querySelectorAll('.pill');
        pfPills.forEach(p=>{
            if((p.getAttribute('onclick')||'').includes('topupBalance'))p.textContent=t('topup');
            if((p.getAttribute('onclick')||'').includes('copyRef'))p.textContent=t('copy_link');
            if((p.getAttribute('onclick')||'').includes('inviteFriend'))p.innerHTML=IC.link+' '+t('invite_friend');
        });
    }
    // Admin - save brand button
    const sbBtn=$('btn-save-brand');if(sbBtn)sbBtn.textContent=t('save');
}

/* ═══════════════════════════════════════
   INIT
   ═══════════════════════════════════════ */
function initParticles(){
    if(typeof particlesJS==='undefined')return;
    particlesJS('particles-js',{
        particles:{
            number:{value:70,density:{enable:true,value_area:800}},
            color:{value:'#24C4F1'},
            shape:{type:'circle'},
            opacity:{value:0.25,random:true,anim:{enable:true,speed:0.4,opacity_min:0,sync:false}},
            size:{value:2,random:true,anim:{enable:false}},
            line_linked:{enable:true,distance:180,color:'#24C4F1',opacity:0.08,width:1},
            move:{enable:true,speed:0.6,direction:'none',random:false,straight:false,out_mode:'out',bounce:false}
        },
        interactivity:{
            detect_on:'window',
            events:{onhover:{enable:true,mode:'grab'},onclick:{enable:true,mode:'push'},resize:true},
            modes:{grab:{distance:140,line_linked:{opacity:0.3}},push:{particles_nb:1}}
        },
        retina_detect:true
    });
}
async function init(){
    tg.ready(); tg.expand();
    try{tg.setHeaderColor('#080C14')}catch(e){}
    try{tg.setBackgroundColor('#080C14')}catch(e){}
    try{
        // Try Telegram auth if initData available
        if(tg.initData){
            const a=await fetch(API+'/api/auth/tg',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData:tg.initData})});
            if(!a.ok) return showErr(t('auth_error'));
        }
        // Try to load user data (works with cookie from tg auth or web login)
        const dr=await fetch(API+'/api/user/data');
        if(!dr.ok){
            // No valid session — redirect to login for web, show error for miniapp
            if(!tg.initData){window.location.href='/web/login';return}
            return showErr('Ошибка загрузки профиля. Попробуйте перезапустить.');
        }
        D=await dr.json();
        try{const br=await fetch(API+'/api/settings/brand');if(br.ok)BRAND=await br.json()}catch(e){}
        try{const cfg=await fetch(API+'/api/config');if(cfg.ok){const c=await cfg.json();DOMAIN=c.domain||''}}catch(e){}
        IS_ADMIN=D.user.role==='DEV'||D.user.role==='ADMIN';
        // Set locale from bot_locale or user language
        const bl=(D.bot_locale||'').toUpperCase();
        if(['RU','EN','UK','DE'].includes(bl)) CUR_LOCALE=bl;
        else {
            const ul=(D.user.language||'').toUpperCase();
            if(['RU','EN','UK','DE'].includes(ul)) CUR_LOCALE=ul;
        }
        $('loading-screen').style.display='none';
        $('main-app').style.display='flex';
        if(IS_ADMIN) document.querySelectorAll('.admin-nav').forEach(e=>e.style.display='');
        // Show logout button for web users (not inside Telegram)
        if(!tg.initData){const lb=$('btn-logout');if(lb)lb.style.display=''}
        initParticles();
        render();
        applyLocale();
        _setupTicketKeys();
        // Start polling ticket status every 15 seconds
        setInterval(pollTicketStatus, 15000);
    }catch(e){showErr(t('error')+': '+e.message)}
}

function showErr(m){$('loading-screen').style.display='none';$('error-screen').style.display='flex';$('error-msg').textContent=m}
function $(id){return document.getElementById(id)}

/* ═══════════════════════════════════════
   NAVIGATION
   ═══════════════════════════════════════ */
const mainPages=['home','support','profile','admin'];
let curPage='home';
let navHistory=[];
function go(p){
    if(curPage!==p) navHistory.push(curPage);
    curPage=p;
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    $('p-'+p).classList.add('active');
    const navP=({tickets:'support',ticket:'support',aticket:'admin',auser:'admin'})[p]||p;
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.toggle('active',b.dataset.p===navP));
    if(p==='home'){tg.BackButton.hide();navHistory=[]}else{tg.BackButton.show();tg.BackButton.offClick(goBack);tg.BackButton.onClick(goBack)}
    if(p==='admin')loadAdm(curAdmTab);
    if(p==='plans'){renderPlans()}else{const pb=$('plans-bottom-bar');if(pb)pb.style.display='none'}
    if(p==='renew'){}else{const rb=$('renew-bottom-bar');if(rb)rb.style.display='none'}
    if(p==='tickets')loadTickets();
    updateFab();
}
function goBack(){
    // First close any open modal/overlay
    const mr=$('modal-root');
    if(mr&&mr.innerHTML.trim()){
        const co=mr.querySelector('.confirm-overlay');
        if(co){co.remove();return}
        closeModal();return;
    }
    if(navHistory.length>0){const prev=navHistory.pop();go(prev);if(prev==='home')navHistory=[]}else{go('home')}
}
function goHome(){go('home')}
function updateFab(){
    // Nav support badge
    const nb=$('nav-support-badge');
    if(nb){if(D.ticket_unread>0){nb.style.display='flex';nb.textContent=D.ticket_unread}else{nb.style.display='none'}}
    // Admin ticket badge
    const ab=$('nav-admin-badge');
    if(ab&&IS_ADMIN){if(D.admin_ticket_unread>0){ab.style.display='flex';ab.textContent=D.admin_ticket_unread}else{ab.style.display='none'}}
    // Admin tickets tab badge
    const atb=$('adm-tickets-badge');
    if(atb&&IS_ADMIN){if(D.admin_ticket_unread>0){atb.style.display='inline-flex';atb.textContent=D.admin_ticket_unread}else{atb.style.display='none'}}
}
async function pollTicketStatus(){
    try{
        const r=await fetch(API+'/api/tickets/status');
        if(!r.ok)return;
        const s=await r.json();
        D.has_open_tickets=s.has_open;
        D.ticket_unread=s.unread;
        if(s.admin_unread!==undefined) D.admin_ticket_unread=s.admin_unread;
        updateFab();
    }catch(e){}
}

/* ═══════════════════════════════════════
   RENDER
   ═══════════════════════════════════════ */
function render(){
    // Brand logo: URL → <img>, emoji → text, empty → default logo
    const logoEl=$('brand-logo');
    const logoVal=BRAND.logo||'';
    const effectiveLogo=logoVal||DEFAULT_LOGO;
    if(effectiveLogo.startsWith('http')){logoEl.innerHTML='<img class="brand-logo-img" src="'+esc(effectiveLogo)+'" alt="">';logoEl.classList.add('has-img')}
    else if(effectiveLogo){logoEl.textContent=effectiveLogo;logoEl.classList.remove('has-img')}
    else{logoEl.textContent='';logoEl.classList.remove('has-img')}
    $('brand-name').textContent=BRAND.name||DEFAULT_NAME;
    const sloganEl=$('brand-slogan');
    const effectiveSlogan=BRAND.slogan||DEFAULT_SLOGAN;
    sloganEl.textContent=effectiveSlogan;sloganEl.style.display=''
    const _cs=CURRENCY_SYMBOLS[D.default_currency]||'\u20bd';
    $('hdr-balance').innerHTML='<svg class="hdr-wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 14a1 1 0 100 2 1 1 0 000-2z" fill="currentColor" stroke="none"/><path d="M22 7V6a2 2 0 00-2-2H4a2 2 0 00-2 2v1"/></svg>'+D.user.balance+' '+_cs;
    const _bm=D.features&&D.features.balance_mode;
    const _rb=D.user.referral_balance||0;
    if(_bm==='SEPARATE'){$('hdr-bonus').style.display='';$('hdr-bonus').innerHTML='<svg class="hdr-wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/></svg>'+_rb+' '+_cs}else{$('hdr-bonus').style.display='none'}
    renderSub(); renderConnect(); renderProfile(); renderSupport(); renderHomeExtras();
    // Trial button — hide if user has/had subscription or used trial
    const hasSub=D.subscription&&D.subscription.status;
    if(D.trial_available && !hasSub) $('btn-trial').style.display='';
    else $('btn-trial').style.display='none';
    // Ticket FAB — only on home page, only for open (non-closed/resolved) tickets
    updateFab();
    // Ticket badge
    if(D.ticket_unread>0){$('ticket-badge').style.display='';$('ticket-badge').textContent=D.ticket_unread}
    // Expand devices button
    if(D.subscription&&D.subscription.status==='ACTIVE') $('btn-expand-devices').style.display='';
}

function renderSub(){
    const s=D.subscription;
    const activeLayout=$('sub-active-layout'), emptyLayout=$('sub-empty-layout');

    if(!s||!s.status||s.status==='EXPIRED'){
        activeLayout.style.display='none';
        emptyLayout.style.display='';
        $('sub-nosub-text').textContent=t('no_active_sub');
        return;
    }

    activeLayout.style.display='';
    emptyLayout.style.display='none';

    // Plan name
    const pn=$('sub-plan-name');
    const planLabel=s.is_trial?t('trial_period'):(s.plan_name||'—');
    pn.textContent=planLabel;
    pn.className='sub-plan-name'+(s.status==='EXPIRED'?' sub-plan-expired':'');

    // Expire info: date + remaining days
    const eid=$('sub-expire-date');
    const eir=$('sub-remaining');
    if(eid){
        if(s.expire_at&&(s.status==='ACTIVE'||s.is_trial)){
            const datePart=s.expire_at.split(' ')[0];
            eid.textContent=datePart;
            const parts=s.expire_at.match(/(\d{2})\.(\d{2})\.(\d{4})\s+(\d{2}):(\d{2})/);
            if(parts){
                const expireDate=new Date(parseInt(parts[3]),parseInt(parts[2])-1,parseInt(parts[1]),parseInt(parts[4]),parseInt(parts[5]));
                const diff=expireDate-new Date();
                if(diff>0){
                    const daysLeft=Math.floor(diff/(1000*60*60*24));
                    if(eir) eir.textContent=daysLeft+' '+pluralDays(daysLeft);
                } else {if(eir) eir.textContent='0 '+pluralDays(0)}
            } else {if(eir) eir.textContent='—'}
        } else {eid.textContent='—';if(eir) eir.textContent='—'}
    }

    // Traffic — use current plan type to decide display
    const currentPlan=D.plans&&s.plan_id?D.plans.find(p=>p.id===s.plan_id):null;
    let tl;
    if(currentPlan){
        if(currentPlan.type==='DEVICES') tl='Безлим.';
        else tl=(currentPlan.traffic_limit||'∞')+' ГБ';
    } else {
        tl=s.traffic_limit? s.traffic_limit+' ГБ':'∞';
    }
    const tr=$('sub-traffic');
    if(tr) tr.textContent=tl;

    // Devices
    const dl=$('sub-devices');
    if(dl){
        const devLimit=s.device_limit||'∞';
        const devActive=(typeof s.active_devices_count==='number')?s.active_devices_count:null;
        dl.textContent=(devActive!==null)?(devActive+' из '+devLimit):devLimit;
    }

    // Show/hide renew (only for paid subs)
    if(s.is_trial){
        $('btn-renew').style.display='none';
        $('btn-change').textContent=t('buy_sub');
    } else {
        $('btn-renew').style.display='';
        $('btn-change').textContent=t('change_plan');
    }
}

function renderHomeExtras(){
    // nav Группа button (community)
    const navComm=$('nav-community');
    if(D.features&&D.features.community_enabled&&D.features.community_url){
        const url=D.features.community_url;
        if(navComm){navComm.style.display='';navComm.onclick=()=>openLink(url);}
    } else {
        if(navComm) navComm.style.display='none';
    }
    // Invite button
    const ib=$('btn-invite-home');
    if(ib){
        ib.style.display=(D.features&&D.features.referral_enabled)?'':'none';
    }
}

function _getPayMethods(){
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'₽';
    const gateways=D.available_gateways||[];
    let methods=[];
    gateways.forEach(gw=>{
        methods.push({type:gw.type,name:GW_LABELS[gw.type]||gw.type,icon:GW_ICONS[gw.type]||IC.card,desc:GW_DESCS[gw.type]||''});
    });
    methods.push({type:'balance',name:t('balance'),icon:IC.wallet,desc:D.user.balance+' '+sym});
    return methods;
}
function _getDefaultMethod(){
    const methods=_getPayMethods();
    return methods.length>0?methods[0].type:'balance';
}
function _fmtPr(n){return n>=1000?n.toLocaleString('ru-RU'):String(n)}

function _renderDurGrid(plan,planId){
    const dc=D.default_currency||'RUB',sym=CURRENCY_SYMBOLS[dc]||'₽';
    let basePpd=null,bestDealDays=null,lowestPpd=null;
    (plan.durations||[]).forEach(d=>{
        const pr=findPrice(d,dc);
        if(pr!==null&&d.days>0){
            const ppd=pr/d.days;
            if(basePpd===null||d.days<basePpd.days)basePpd={ppd,days:d.days};
            if(lowestPpd===null||ppd<lowestPpd){lowestPpd=ppd;bestDealDays=d.days}
        }
    });
    const durs=(plan.durations||[]).filter(d=>findPrice(d,dc)!==null);
    const firstDur=durs[0];
    if(!planSel[planId]){
        planSel[planId]={days:firstDur?firstDur.days:0,price:firstDur?findPrice(firstDur,dc):0,method:_getDefaultMethod()};
    }
    return durs.map(d=>{
        const pr=findPrice(d,dc);
        const isSelected=planSel[planId].days===d.days;
        const isBestDeal=d.days===bestDealDays&&durs.length>1&&basePpd&&d.days>basePpd.days;
        const ppm=d.days>=30?Math.round(pr/(d.days/30)):null;
        let h='<div class="plan-dur-card'+(isSelected?' selected':'')+'" onclick="selectDur(event,'+planId+','+d.days+','+pr+')">';
        if(isBestDeal)h+='<span class="pdc-badge">'+t('best_deal')+'</span>';
        h+='<div class="plan-dur-card-period">'+fmtDaysFull(d.days)+'</div>';
        h+='<div class="plan-dur-card-price">'+_fmtPr(pr)+' '+sym+'</div>';
        if(ppm!==null&&d.days>30)h+='<div class="plan-dur-card-ppm">'+_fmtPr(ppm)+' '+sym+' '+t('per_month')+'</div>';
        h+='</div>';
        return h;
    }).join('');
}
function _renderPmBar(planId,opts){
    const methods=_getPayMethods();
    const sel=planSel[planId];
    const method=methods.find(m=>m.type===sel.method)||methods[0];
    const canChange=methods.length>1;
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'₽';
    const showPayBtn=opts&&opts.showPay;
    return '<div class="plan-pm-bar" '+(canChange?'onclick="showPayMethodPicker(event,'+planId+')"':'')+'>'+
        '<div class="plan-pm-icon">'+method.icon+'</div>'+
        '<div class="plan-pm-info">'+
            '<div class="plan-pm-name">'+esc(method.name)+'</div>'+
            '<div class="plan-pm-desc">'+esc(method.desc)+'</div>'+
        '</div>'+
        (showPayBtn?'<button class="plan-pm-pay-btn" onclick="event.stopPropagation();planPayClick(event,'+planId+')">'+t('pay_btn')+' '+_fmtPr(sel.price)+' '+sym+'</button>'
        :(canChange?'<div class="plan-pm-change">'+t('change_method')+' ›</div>':''))+
    '</div>';
}
function _renderPayBtn(planId){
    const sel=planSel[planId];
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'₽';
    return '<button class="plan-pay-btn" id="pay-btn-'+planId+'" onclick="planPayClick(event,'+planId+')">'+t('pay_btn')+' '+_fmtPr(sel.price)+' '+sym+'</button>';
}

function renderPlans(){
    const el=$('plans-list'),dc=D.default_currency||'RUB',sym=CURRENCY_SYMBOLS[dc]||'₽';
    if(!D.plans||!D.plans.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">'+IC.list+'</span><h3>'+t('no_plans')+'</h3></div>';return}
    const activePlanId=D.subscription&&D.subscription.status==='ACTIVE'?(D.subscription.plan_id||(D.subscription.plan&&D.subscription.plan.id)):null;
    const visiblePlans=activePlanId?D.plans.filter(p=>p.id!==activePlanId):D.plans;
    if(!visiblePlans.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">'+IC.check+'</span><h3>Нет доступных планов</h3><p style="color:var(--text3);font-size:.84rem">Ваш текущий план — единственный</p></div>';return}
    const singlePlan=visiblePlans.length===1;
    el.innerHTML=visiblePlans.map(p=>{
        const desc=p.description||'';
        const trafficText=(p.traffic_limit||'∞')+' GB';
        const devicesText=(p.device_limit||'∞')+' '+t('dev_short');
        let minPrice=null;
        (p.durations||[]).forEach(d=>{const pr=findPrice(d,dc);if(pr!==null&&(minPrice===null||pr<minPrice))minPrice=pr});
        const priceText=minPrice!==null?('от '+minPrice+' '+sym):'';
        const gridHtml=_renderDurGrid(p,p.id);
        const pmBar=_renderPmBar(p.id);
        const payBtn=_renderPayBtn(p.id);
        return '<div class="card plan-card-new'+(singlePlan?' open':'')+'" '+(singlePlan?'':'onclick="togglePlanCard(this,event)"')+' data-plan-id="'+p.id+'">'+
            '<div class="plan-card-header">'+
                '<div class="plan-card-name">'+esc(p.name)+'</div>'+
                (singlePlan?'':'<div class="plan-card-price">'+priceText+'</div>')+
            '</div>'+
            (desc?'<div class="plan-card-desc">'+esc(desc)+'</div>':'')+
            '<div class="plan-card-meta"><span>'+IC.pkg+' '+trafficText+'</span><span>'+IC.phone+' '+devicesText+'</span></div>'+
            '<div class="plan-card-body"'+(singlePlan?' style="max-height:none;opacity:1;margin-top:12px"':'')+'>'+
                '<div class="plan-dur-grid">'+gridHtml+'</div>'+
            '</div>'+
            (singlePlan?'':'<div class="plan-card-toggle" onclick="event.stopPropagation();togglePlanCard(this.parentElement)">▼</div>')+
        '</div>';
    }).join('');
    // Only show sticky bar when a card is open; for single plan it's always open
    if(singlePlan){
        selectedPlanId=visiblePlans[0].id;
        _updateStickyBar();
    } else {
        selectedPlanId=null;
        const bar=$('plans-bottom-bar');if(bar)bar.style.display='none';
    }
}
let selectedPlanId=null;
function _updateStickyBar(){
    const bar=$('plans-bottom-bar');
    if(!selectedPlanId||!planSel[selectedPlanId]){if(bar)bar.style.display='none';return}
    if(bar)bar.style.display='';
    const wrap=$('plans-pm-bar-wrap');
    if(wrap)wrap.innerHTML=_renderPmBar(selectedPlanId,{showPay:true});
}
function planPayClickGlobal(){
    if(!selectedPlanId)return;
    const sel=planSel[selectedPlanId];
    if(!sel||!sel.days||!sel.price)return;
    if(sel.method==='balance'){
        showConfirmPurchase(selectedPlanId,sel.days,sel.price,'balance');
    } else {
        doPayment(selectedPlanId,sel.days,sel.price,sel.method);
    }
}
function togglePlanCard(card,ev){
    if(ev&&ev.target&&ev.target.closest&&ev.target.closest('.plan-card-body'))return;
    const isOpen=card.classList.contains('open');
    document.querySelectorAll('.plan-card-new.open').forEach(c=>{if(c!==card)c.classList.remove('open')});
    card.classList.toggle('open',!isOpen);
    document.querySelectorAll('.plan-card-new .plan-card-toggle').forEach(el=>{
        el.textContent=el.parentElement.classList.contains('open')?'▲':'▼';
    });
    if(!isOpen){
        const pid=parseInt(card.getAttribute('data-plan-id'));
        if(pid){selectedPlanId=pid;_updateStickyBar()}
    } else {
        // Card was closed
        selectedPlanId=null;
        const bar=$('plans-bottom-bar');if(bar)bar.style.display='none';
    }
}
function selectDur(e,planId,days,price){
    e.stopPropagation();
    planSel[planId]=planSel[planId]||{};
    planSel[planId].days=days;planSel[planId].price=price;
    planSel[planId].method=planSel[planId].method||_getDefaultMethod();
    const card=document.querySelector('[data-plan-id="'+planId+'"]');
    if(card){
        card.querySelectorAll('.plan-dur-card').forEach(c=>c.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
    }
    selectedPlanId=planId;
    _updateStickyBar();
    if(renewPlanId===planId)_updateRenewBar();
}
function _updatePayBtn(planId){
    const sel=planSel[planId];if(!sel)return;
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'₽';
    const btn=document.getElementById('pay-btn-'+planId);
    if(btn)btn.textContent=t('pay_btn')+' '+_fmtPr(sel.price)+' '+sym;
}
function showPayMethodPicker(e,planId){
    e.stopPropagation();
    const methods=_getPayMethods();
    const sel=planSel[planId];
    let itemsHtml=methods.map(m=>{
        const isSelected=sel.method===m.type;
        return '<div class="pm-picker-item'+(isSelected?' selected':'')+'" onclick="changePayMethod('+planId+',\''+m.type+'\')">'+
            '<div class="pm-picker-icon">'+m.icon+'</div>'+
            '<div class="pm-picker-info">'+
                '<div class="pm-picker-name">'+esc(m.name)+'</div>'+
                (m.desc?'<div class="pm-picker-desc">'+esc(m.desc)+'</div>':'')+
            '</div>'+
            '<div class="pm-picker-check"></div>'+
        '</div>';
    }).join('');
    showModal(
        '<div style="margin-bottom:14px">'+
            '<h3 style="margin:0;font-size:.88rem;color:var(--text2);font-weight:600">Способы оплаты</h3>'+
        '</div>'+
        '<div class="pm-picker-list">'+itemsHtml+'</div>',
        'modal-renew'
    );
}
function changePayMethod(planId,method){
    planSel[planId].method=method;
    closeModal();
    document.querySelectorAll('[data-plan-id="'+planId+'"] .plan-pm-bar, #renew-plan-view .plan-pm-bar').forEach(bar=>{
        bar.outerHTML=_renderPmBar(planId);
    });
    _updateStickyBar();
    if(renewPlanId===planId)_updateRenewBar();
}
function planPayClick(e,planId){
    e.stopPropagation();
    const sel=planSel[planId];
    if(!sel||!sel.days||!sel.price)return;
    if(sel.method==='balance'){
        showConfirmPurchase(planId,sel.days,sel.price,'balance');
    } else {
        doPayment(planId,sel.days,sel.price,sel.method);
    }
}
function applyPlanPromo(e,planId){
    e.stopPropagation();
    const input=document.getElementById('plan-promo-'+planId);
    if(!input)return;
    const code=input.value.trim();if(!code)return;
    (async()=>{
        try{
            const res=await fetch(API+'/api/promocode/activate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
            const d=await res.json();
            if(res.ok){toast(d.message||t('promo_activated'));input.value='';const dr=await fetch(API+'/api/user/data');if(dr.ok){D=await dr.json();render()}}
            else toast(d.detail||t('error'),'error');
        }catch(e2){toast(t('net_error'),'error')}
    })();
}
function _buildPayOpts(){
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'₽';
    const gateways=D.available_gateways||[];
    let options='<option value="balance">'+IC.wallet+' '+t('balance')+' ('+D.user.balance+' '+sym+')</option>';
    gateways.forEach(gw=>{
        const label=GW_LABELS[gw.type]||gw.type;
        const icon=GW_ICONS[gw.type]||IC.card;
        options+='<option value="'+gw.type+'">'+icon+' '+label+'</option>';
    });
    return options;
}
function showConfirmPurchase(planId,days,price,payMethod){
    if(!payMethod)payMethod='balance';
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'₽';
    const plan=D.plans.find(p=>p.id===planId);
    const planName=plan?esc(plan.name):'—';
    const gateways=D.available_gateways||[];
    let pmLabel=IC.wallet+' '+t('balance');
    if(payMethod==='balance'){pmLabel=IC.wallet+' '+t('balance')}
    else{const gw=gateways.find(g=>g.type===payMethod);pmLabel=(GW_ICONS[payMethod]||IC.card)+' '+(gw?(GW_LABELS[gw.type]||gw.type):payMethod)}
    let note='';
    if(D.subscription&&D.subscription.status==='ACTIVE'){
        const curPlanId=D.subscription.plan_id||(D.subscription.plan&&D.subscription.plan.id);
        if(curPlanId && curPlanId!==planId){
            note='<div class="confirm-note">'+IC.warn+' '+t('sub_change_note')+'</div>';
        } else {
            note='<div class="confirm-note">'+IC.warn+' '+t('sub_renew_note')+'</div>';
        }
    }
    const h='<h3>'+t('confirm')+'</h3>'+
        '<div class="confirm-info">'+
            '<div class="confirm-row"><span class="c-label">'+t('tariff')+':</span><span class="c-value" style="color:var(--green)">'+planName+'</span></div>'+
            '<div class="confirm-row"><span class="c-label">'+t('period')+':</span><span class="c-value">'+fmtDaysFull(days)+'</span></div>'+
            '<div class="confirm-row"><span class="c-label">'+t('cost')+':</span><span class="c-value" style="color:var(--cyan)">'+price+' '+sym+'</span></div>'+
            '<div style="border-top:1px solid rgba(255,255,255,.06);margin:8px 0"></div>'+
            '<div class="confirm-row"><span class="c-label">'+t('payment_method')+':</span><span class="c-value">'+pmLabel+'</span></div>'+
        '</div>'+
        note+
        '<div class="renew-pay-actions">'+
            '<button class="btn-confirm-pay" onclick="closeConfirmOverlay();doPayment('+planId+','+days+','+price+',\''+payMethod+'\')">'+ t('confirm') +'</button>'+
            '<button class="btn btn-cancel" onclick="closeConfirmOverlay()">'+t('cancel')+'</button>'+
        '</div>';
    $('modal-root').insertAdjacentHTML('beforeend',
        '<div class="modal-overlay confirm-overlay" onclick="if(event.target===this)closeConfirmOverlay()" style="z-index:510">'+
        '<div class="modal-card modal-renew">'+h+'</div></div>'
    );
}
function closeConfirmOverlay(){const o=$('modal-root').querySelector('.confirm-overlay');if(o)o.remove()}
function doPayment(planId,days,price,method){
    if(!method)method='balance';
    if(method==='balance') return confirmPurchase(planId,days,price);
    payViaGateway(planId,days,method);
}
let _payPollTimer=null;
async function payViaGateway(planId,days,gwType){
    showModal('<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="margin-top:12px;color:var(--text2)">'+t('processing')+'</p></div>');
    try{
        const r=await fetch(API+'/api/purchase',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan_id:planId,duration_days:days,gateway:gwType})});
        closeModal();
        if(r.ok){
            const j=await r.json();
            if(j.payment_url){
                openLink(j.payment_url);
                _showPayWaiting(planId,days,gwType,j.payment_url);
            } else {
                toast(t('sub_done'),'success');
                const dr=await fetch(API+'/api/user/data');if(dr.ok){D=await dr.json();render()}
            }
        } else {
            try{const j=await r.json();toast(j.detail||t('purchase_error'),'error')}
            catch(e2){toast(t('purchase_error')+' ('+r.status+')','error')}
        }
    }catch(e){closeModal();toast(e.message||t('net_error'),'error')}
}
function _showPayWaiting(planId,days,gwType,payUrl){
    const plan=D.plans.find(p=>p.id===planId);
    const planName=plan?esc(plan.name):'—';
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'₽';
    const sel=planSel[planId];
    const amount=sel?_fmtPr(sel.price):'—';
    const gwLabel=(GW_ICONS[gwType]||IC.card)+' '+(GW_LABELS[gwType]||gwType);
    showModal(
        '<div style="text-align:center;padding:16px 0">'+
            '<div class="spinner" style="margin:0 auto"></div>'+
            '<h3 style="margin-top:16px;color:var(--gold)">'+t('waiting_payment')+'</h3>'+
            '<p style="color:var(--text3);font-size:.82rem;margin-top:6px">'+t('waiting_payment_hint')+'</p>'+
            '<div class="confirm-info" style="margin-top:16px;text-align:left">'+
                '<div class="confirm-row"><span class="c-label">'+t('tariff')+':</span><span class="c-value" style="color:var(--green)">'+planName+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('period')+':</span><span class="c-value">'+fmtDaysFull(days)+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('cost')+':</span><span class="c-value" style="color:var(--cyan)">'+amount+' '+sym+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('payment_method')+':</span><span class="c-value">'+gwLabel+'</span></div>'+
            '</div>'+
            '<div style="margin-top:18px;display:flex;flex-direction:column;gap:8px">'+
                '<button class="btn btn-primary btn-full" onclick="openLink(\''+esc(payUrl)+'\')">'+t('pay_btn')+'</button>'+
                '<button class="btn btn-secondary btn-full" onclick="_cancelPayWaiting()">'+t('cancel')+'</button>'+
            '</div>'+
        '</div>',
        'modal-renew'
    );
    // Start polling for payment completion
    if(_payPollTimer)clearInterval(_payPollTimer);
    const oldSubStatus=D.subscription?D.subscription.status:null;
    const oldSubExpire=D.subscription?D.subscription.expire_date:null;
    _payPollTimer=setInterval(async()=>{
        try{
            const dr=await fetch(API+'/api/user/data');
            if(!dr.ok)return;
            const newD=await dr.json();
            const newSub=newD.subscription;
            const changed=newSub&&(newSub.status==='ACTIVE')&&(oldSubStatus!=='ACTIVE'||newSub.expire_date!==oldSubExpire);
            if(changed){
                clearInterval(_payPollTimer);_payPollTimer=null;
                D=newD;render();
                closeModal();
                _showPaySuccess(planName,days,amount+' '+sym,gwLabel);
            }
        }catch(e){}
    },4000);
}
function _cancelPayWaiting(){
    if(_payPollTimer){clearInterval(_payPollTimer);_payPollTimer=null}
    closeModal();
}
function _showPaySuccess(planName,period,cost,method){
    showModal(
        '<div style="text-align:center;padding:16px 0">'+
            '<div style="font-size:3.5rem">'+IC.check+'</div>'+
            '<h3 style="margin-top:12px;color:var(--green)">'+t('pay_success')+'</h3>'+
            '<div class="confirm-info" style="margin-top:16px;text-align:left">'+
                '<div class="confirm-row"><span class="c-label">'+t('tariff')+':</span><span class="c-value" style="color:var(--green)">'+planName+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('period')+':</span><span class="c-value">'+period+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('cost')+':</span><span class="c-value" style="color:var(--cyan)">'+cost+'</span></div>'+
                '<div class="confirm-row"><span class="c-label">'+t('payment_method')+':</span><span class="c-value">'+method+'</span></div>'+
            '</div>'+
            '<button class="btn btn-primary btn-full" style="margin-top:18px" onclick="closeModal()">'+t('done')+'</button>'+
        '</div>',
        'modal-renew'
    );
}

function findPrice(dur,currency){
    const p=(dur.prices||[]).find(x=>x.currency===currency);
    return p?parseFloat(p.amount):null;
}
function fmtDays(d){
    if(d<=0)return '∞';
    const l=CUR_LOCALE;
    if(l==='EN'){if(d===1)return '1 day';if(d===7)return '7 days';if(d===30)return '1 mo.';if(d===60)return '2 mo.';if(d===90)return '3 mo.';if(d===180)return '6 mo.';if(d===365)return '1 year';return d+' d.'}
    if(l==='UK'){if(d===1)return '1 день';if(d===7)return '7 днів';if(d===30)return '1 міс.';if(d===60)return '2 міс.';if(d===90)return '3 міс.';if(d===180)return '6 міс.';if(d===365)return '1 рік';return d+' дн.'}
    if(l==='DE'){if(d===1)return '1 Tag';if(d===7)return '7 Tage';if(d===30)return '1 Mon.';if(d===60)return '2 Mon.';if(d===90)return '3 Mon.';if(d===180)return '6 Mon.';if(d===365)return '1 Jahr';return d+' T.'}
    if(d===1)return '1 день';if(d===7)return '7 дней';if(d===30)return '1 мес.';if(d===60)return '2 мес.';if(d===90)return '3 мес.';if(d===180)return '6 мес.';if(d===365)return '1 год';return d+' дн.';
}
function fmtDaysFull(d){
    if(d<=0)return '∞';
    const l=CUR_LOCALE;
    if(l==='EN'){if(d===1)return '1 day';if(d===7)return '7 days';if(d===30)return '1 month';if(d===60)return '2 months';if(d===90)return '3 months';if(d===180)return '6 months';if(d===365)return '1 year';return d+' days'}
    if(l==='UK'){if(d===1)return '1 день';if(d===7)return '7 днів';if(d===30)return '1 місяць';if(d===60)return '2 місяці';if(d===90)return '3 місяці';if(d===180)return '6 місяців';if(d===365)return '1 рік';return d+' днів'}
    if(l==='DE'){if(d===1)return '1 Tag';if(d===7)return '7 Tage';if(d===30)return '1 Monat';if(d===60)return '2 Monate';if(d===90)return '3 Monate';if(d===180)return '6 Monate';if(d===365)return '1 Jahr';return d+' Tage'}
    if(d===1)return '1 день';if(d===7)return '7 дней';if(d===30)return '1 месяц';if(d===60)return '2 месяца';if(d===90)return '3 месяца';if(d===180)return '6 месяцев';if(d===365)return '1 год';return d+' '+pluralDays(d);
}

function renderConnect(){
    const s=D.subscription;
    $('con-url').textContent=(s&&s.url)?s.url:t('no_active_sub');
    // Download button — always same label
    $('btn-download-label').textContent=t('download_app');
    if(s&&s.url&&DOMAIN){
        $('con-actions').style.display='';
        $('btn-oneclick').onclick=()=>openLink('https://'+DOMAIN+'/api/v1/connect/'+s.url);
        $('btn-subpage').onclick=()=>openLink(s.url);
        $('btn-subpage').style.display='';
        $('btn-qr').style.display='';
        $('btn-show-sub').style.display='';
    } else {
        $('con-actions').style.display='';
        $('btn-subpage').style.display='none';
        $('btn-qr').style.display='none';
        $('btn-show-sub').style.display='none';
    }
    const dl=D.subscription&&D.subscription.device_limit;
    $('dev-limit').textContent=dl||'—';
    $('dev-used').textContent='—';
}
function toggleSubLink(){
    const det=$('con-sub-detail');
    const btn=$('btn-show-sub');
    if(det.style.display==='none'){
        det.style.display='';
        btn.innerHTML=IC.key+'&nbsp;'+t('hide_sub');
    } else {
        det.style.display='none';
        btn.innerHTML=IC.key+'&nbsp;'+t('show_sub');
    }
}

function copyValue(el){
    const v=el.textContent;
    navigator.clipboard.writeText(v).then(()=>toast(t('copied'))).catch(()=>toast(t('error'),'error'));
}
function copySubInfo(el){
    const v=(el.textContent||'').trim();
    if(!v||v==='—') return;
    navigator.clipboard.writeText(v).then(()=>{
        const t2=$('toast');t2.textContent=t('copied');
        t2.className='toast toast-center visible';
        clearTimeout(t2._t);t2._t=setTimeout(()=>{t2.className='toast';},2500);
    }).catch(()=>{});
}
function renderProfile(){
    const u=D.user, sym=CURRENCY_SYMBOLS[D.default_currency]||'₽';
    $('pr-name').textContent=u.name||'—';
    $('pr-tid').textContent=u.telegram_id;
    // Referral code from database
    if(D.features&&D.features.referral_enabled!==false && u.referral_code){
        $('pr-refcode-row').style.display='';
        $('pr-refcode').textContent=u.referral_code;
    }
    // Balance section
    $('pr-balance').textContent=u.balance+' '+sym;
    const bm=D.features&&D.features.balance_mode;
    const rb=u.referral_balance||0;
    if(bm==='SEPARATE'){
        $('pr-bonus-item').style.display='';
        $('pr-bonus').textContent=rb+' '+sym;
        $('btn-get-bonus').style.display='';
    } else {
        $('pr-bonus-item').style.display='none';
        $('btn-get-bonus').style.display='none';
    }
    if(D.features&&D.features.balance_enabled!==false) $('balance-card').style.display='';
    // Web credentials section
    loadWebCredStatus();
    // Referral section
    if(D.features&&D.features.referral_enabled!==false){
        $('ref-card').style.display='';
        $('ref-link').textContent=D.ref_link||'Бот не настроен';
        // Referral stats
        const rs=D.referral_stats||{};
        const statsEl=$('ref-stats');
        statsEl.innerHTML=
            '<div class="ref-stat-item"><div class="ref-stat-value">'+(rs.invited_count||0)+'</div><div class="ref-stat-label">Приглашено</div></div>'+
            '<div class="ref-stat-item"><div class="ref-stat-value">'+(rs.payments_count||0)+'</div><div class="ref-stat-label">Оплат</div></div>'+
            '<div class="ref-stat-item"><div class="ref-stat-value">'+(rs.total_bonus||0)+' '+sym+'</div><div class="ref-stat-label">Начислено</div></div>';
    }
}
async function loadWebCredStatus(){
    try{
        const r=await fetch(API+'/api/auth/check',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({telegram_id:D.user.telegram_id})});
        const d=await r.json();
        const el=$('web-cred-status');
        if(d.has_credentials){
            el.innerHTML='<div class="card-row"><span class="card-label">Статус</span><span class="card-value" style="color:var(--green)">Подключено ✓</span></div>';
            $('web-cred-setup').style.display='none';
            $('web-cred-detail').style.display='';
            $('wc-disp-login').textContent=d.web_username||'—';
            $('wc-change-section').style.display='none';
            // spoiler arrow toggle
            const sp=$('wc-spoiler');
            if(sp){sp.removeAttribute('open')}
        } else {
            el.innerHTML='<div class="card-row"><span class="card-label">Статус</span><span class="card-value" style="color:var(--text3)">Не подключен</span></div>';
            $('web-cred-setup').style.display='';
            $('web-cred-detail').style.display='none';
        }
    }catch(e){}
}

function showChangePass(){
    $('wc-change-section').style.display='';
    $('wc-old-pass').value='';$('wc-new-pass').value='';$('wc-new-pass2').value='';
}
function cancelWebCredChange(){
    $('wc-change-section').style.display='none';
    const sp=$('wc-spoiler');if(sp)sp.removeAttribute('open');
}
async function applyWebCredChange(){
    const chSec=$('wc-change-section');
    if(chSec.style.display!=='none'){
        const op=$('wc-old-pass').value,np=$('wc-new-pass').value,np2=$('wc-new-pass2').value;
        if(!op)return toast('Введите текущий пароль','error');
        if(!np||np.length<6)return toast('Новый пароль минимум 6 символов','error');
        if(np!==np2)return toast('Пароли не совпадают','error');
        try{
            const r=await fetch(API+'/api/user/credentials/password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({old_password:op,new_password:np})});
            if(r.ok){toast('Пароль изменён');$('wc-change-section').style.display='none'}
            else{const d=await r.json();toast(d.detail||'Ошибка','error')}
        }catch(e){toast('Ошибка','error')}
    } else {
        const sp=$('wc-spoiler');if(sp)sp.removeAttribute('open');
    }
}
async function saveWebCredentials(){
    const un=$('wc-username').value.trim(),pw=$('wc-password').value,pw2=$('wc-password2').value;
    if(!un||un.length<3)return toast('Логин минимум 3 символа','error');
    if(!pw||pw.length<6)return toast('Пароль минимум 6 символов','error');
    if(pw!==pw2)return toast('Пароли не совпадают','error');
    try{
        const r=await fetch(API+'/api/user/credentials',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({web_username:un,password:pw})});
        if(r.ok){toast('Сохранено');loadWebCredStatus()}
        else{const d=await r.json();toast(d.detail||'Ошибка','error')}
    }catch(e){toast('Ошибка','error')}
}
function showBonusInfo(){
    const refLink=D.ref_link;
    if(!refLink){toast('Бот не настроен','error');return}
    showModal('<h3>Бонусный баланс</h3>'+
        '<p style="color:var(--text2);font-size:.84rem;margin-bottom:12px">Бонусный баланс начисляется за приглашение друзей через реферальную ссылку.</p>'+
        '<div class="ref-box" style="margin-bottom:12px"><code>'+esc(refLink)+'</code></div>'+
        '<div class="modal-actions" style="flex-direction:column;gap:8px">'+
        '<button class="btn btn-primary btn-full" onclick="closeModal();inviteFriend()">'+IC.link+' Пригласить друга</button>'+
        '<button class="btn btn-secondary btn-full" onclick="closeModal()">'+t('close')+'</button></div>');
}
function inviteFriend(){
    const refLink=D.ref_link;
    if(!refLink){toast(t('error'),'error');return}
    let template=(settingsCache&&settingsCache.referral_invite_message!=null)?settingsCache.referral_invite_message:((D.features&&D.features.referral_invite_message)||'');
    let msg='';
    if(template){
        msg=template.replace(/\{space\}/g,'\n').replace(/\{url\}/g,refLink).replace(/\{name\}/g,BRAND.name||DEFAULT_NAME);
        if(msg.startsWith('\n'))msg=msg.substring(1);
    }
    if(!msg)msg=(BRAND.name||DEFAULT_NAME)+'\n'+refLink;
    const shareUrl='https://t.me/share/url?text='+encodeURIComponent(msg);
    try{
        if(typeof tg.openTelegramLink==='function')tg.openTelegramLink(shareUrl);
        else window.open(shareUrl,'_blank');
    }catch(e){
        window.open(shareUrl,'_blank');
    }
}

function renderSupport(){
    if(D.features){
        if(D.features.community_enabled&&D.features.community_url){
            $('support-community').style.display='';
            $('btn-community').onclick=()=>openLink(D.features.community_url);
        }
        if(D.features.tos_enabled){
            $('support-tos').style.display='';
            $('btn-tos').onclick=()=>openLink(D.features.tos_url||'');
        }
    }
    if(D.support_url){
        $('support-help').style.display='';
        $('btn-support').onclick=()=>openLink(D.support_url);
    }
}

/* ═══════════════════════════════════════
   USER ACTIONS
   ═══════════════════════════════════════ */
function openPayment(){
    if(!D.plans||!D.plans.length) return toast(t('no_plans'),'error');
    go('plans');
}
function renewCurrentPlan(){
    const s=D.subscription;
    if(!s) return go('plans');
    const planId=s.plan_id||(s.plan&&s.plan.id);
    const plan=D.plans.find(p=>p.id===planId)||
               (s.plan_name?D.plans.find(p=>p.name===s.plan_name):null);
    if(!plan) return go('plans');
    go('renew');
    renderRenewPage(plan);
}
function renderRenewPage(plan){
    const dc=D.default_currency||'RUB',sym=CURRENCY_SYMBOLS[dc]||'₽';
    let trafficText;
    if(plan.type==='DEVICES') trafficText='Безлимитный';
    else trafficText=(plan.traffic_limit||'∞')+' GB';
    const devicesText=(plan.device_limit||'∞')+' '+t('dev_short');
    const gridHtml=_renderDurGrid(plan,plan.id);
    $('renew-plan-view').innerHTML=
        '<div class="card plan-card-new open" data-plan-id="'+plan.id+'">'+
            '<div class="plan-card-header">'+
                '<div class="plan-card-name">'+esc(plan.name)+'</div>'+
            '</div>'+
            '<div class="plan-card-meta"><span>'+IC.pkg+' '+trafficText+'</span><span>'+IC.phone+' '+devicesText+'</span></div>'+
            '<div class="plan-card-body" style="max-height:none;opacity:1;margin-top:12px">'+
                '<div class="plan-dur-grid">'+gridHtml+'</div>'+
            '</div>'+
        '</div>';
    // Populate sticky bar
    renewPlanId=plan.id;
    _updateRenewBar();
}
let renewPlanId=null;
function _updateRenewBar(){
    const bar=$('renew-bottom-bar');
    if(!renewPlanId||!planSel[renewPlanId]){if(bar)bar.style.display='none';return}
    if(bar)bar.style.display='';
    const wrap=$('renew-pm-bar-wrap');
    if(wrap)wrap.innerHTML=_renderPmBar(renewPlanId,{showPay:true});
}
function renewPayClickGlobal(){
    if(!renewPlanId)return;
    const sel=planSel[renewPlanId];
    if(!sel||!sel.days||!sel.price)return;
    if(sel.method==='balance'){
        showConfirmPurchase(renewPlanId,sel.days,sel.price,'balance');
    } else {
        doPayment(renewPlanId,sel.days,sel.price,sel.method);
    }
}
function selectPlan(id){
    /* Legacy — now handled by renderPlans grid inline */
    go('plans');
}
async function confirmPurchase(planId,days,price){
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'₽';
    if(D.user.balance<price){
        closeModal();
        return toast(t('not_enough')+' '+D.user.balance+' '+sym,'error');
    }
    closeModal();
    showModal('<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="margin-top:12px;color:var(--text2)">'+t('processing')+'</p></div>');
    try{
        const r=await fetch(API+'/api/purchase',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan_id:planId,duration_days:days})});
        closeModal();
        if(r.ok){
            toast(t('sub_done'),'success');
            const dr=await fetch(API+'/api/user/data');if(dr.ok){D=await dr.json();render()}
        } else {
            try{const j=await r.json();toast(j.detail||t('purchase_error'),'error')}
            catch(e2){toast(t('purchase_error')+' ('+r.status+')','error')}
        }
    }catch(e){closeModal();toast(e.message||t('net_error'),'error')}
}
async function startTrial(){
    showModal('<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="margin-top:12px;color:var(--text2)">'+t('trial_activating')+'</p></div>');
    try{
        const r=await fetch(API+'/api/trial/activate',{method:'POST'});
        closeModal();
        if(r.ok){
            toast(t('trial_done'),'success');
            showModal('<div style="text-align:center;padding:30px"><div style="font-size:3rem">'+IC.check+'</div><h3 style="margin-top:12px;color:var(--green)">'+t('trial_done')+'</h3><p style="color:var(--text2);font-size:.84rem;margin-top:8px">'+t('trial_go_connect')+'</p><div class="modal-actions" style="flex-direction:column;gap:8px;margin-top:14px"><button class="btn btn-primary btn-full" onclick="closeModal();openLink(getDownloadUrl())">'+IC.download+' '+t('download')+'</button><button class="btn btn-primary btn-full" style="background:linear-gradient(135deg,var(--cyan),#1AA3CC)" onclick="closeModal();go(\'connect\')">'+IC.connect+' '+t('connect')+'</button><button class="btn btn-secondary btn-full" onclick="closeModal()">'+t('close')+'</button></div></div>');
            const dr=await fetch(API+'/api/user/data');if(dr.ok){D=await dr.json();render()}
        } else {
            const j=await r.json();toast(j.detail||t('error'),'error');
        }
    }catch(e){closeModal();toast(t('net_error'),'error')}
}
function expandDevices(){
    if(D.subscription&&D.subscription.is_trial){
        showModal('<div style="text-align:center;padding:30px"><div style="font-size:3rem">'+IC.warn+'</div><h3 style="margin-top:12px;color:var(--gold)">'+t('expand_unavail')+'</h3><p style="color:var(--text2);font-size:.84rem;margin-top:8px">'+t('expand_trial_msg')+'</p><div class="modal-actions"><button class="btn btn-primary" onclick="closeModal();buySubscription()">'+t('buy_plan')+'</button><button class="btn btn-secondary" onclick="closeModal()">'+t('close')+'</button></div></div>');
        return;
    }
    toast(t('expand_via_bot'));
}
function openLink(u){if(u){if(tg.initData)tg.openLink(u);else window.open(u,'_blank')}}
async function webLogout(){try{await fetch(API+'/api/auth/logout',{method:'POST'})}catch(e){}window.location.href='/web/login'}
function copyUrl(){
    const s=D.subscription;
    if(s&&s.url)navigator.clipboard.writeText(s.url).then(()=>toast(t('copied'))).catch(()=>toast(t('error'),'error'));
    else toast(t('no_sub_err'),'error');
}
function copyRef(){
    const rl=$('ref-link').textContent;
    navigator.clipboard.writeText(rl).then(()=>toast(t('link_copied'))).catch(()=>toast(t('error'),'error'));
}
function topupBalance(){
    const gateways=D.available_gateways||[];
    if(!gateways.length){toast(t('topup_via_bot'));return}
    const sym=CURRENCY_SYMBOLS[D.default_currency]||'₽';
    let gwOpts=gateways.map(gw=>{
        const label=GW_LABELS[gw.type]||gw.type;
        const icon=GW_ICONS[gw.type]||IC.card;
        return '<option value="'+gw.type+'">'+icon+' '+label+'</option>';
    }).join('');
    showModal('<h3>'+t('topup')+'</h3>'+
        '<div class="form-group"><label>'+t('topup_amount')+' ('+sym+')</label><input class="form-input" id="topup-amt" type="number" placeholder="100" min="1"></div>'+
        '<div class="form-group"><label>'+t('payment_method')+'</label><select class="pay-method-select" id="topup-gw">'+gwOpts+'</select></div>'+
        '<div class="modal-actions" style="gap:8px">'+
            '<button class="btn-confirm-pay" onclick="doTopup()">'+t('topup')+'</button>'+
            '<button class="btn btn-cancel" onclick="closeModal()">'+t('cancel')+'</button>'+
        '</div>');
}
async function doTopup(){
    const amt=parseInt($('topup-amt').value);
    const gw=$('topup-gw').value;
    if(!amt||amt<=0)return toast(t('enter_amount'),'error');
    closeModal();
    showModal('<div style="text-align:center;padding:20px"><div class="spinner"></div><p style="margin-top:12px;color:var(--text2)">'+t('processing')+'</p></div>');
    try{
        const r=await fetch(API+'/api/topup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:amt,gateway:gw})});
        closeModal();
        if(r.ok){
            const j=await r.json();
            if(j.payment_url)openLink(j.payment_url);
            else toast(t('pay_created'),'success');
        } else {
            const j=await r.json();toast(j.detail||t('error'),'error');
        }
    }catch(e){closeModal();toast(t('net_error'),'error')}
}
async function activatePromo(){
    const code=$('promo-input').value.trim();if(!code)return;
    const r=$('promo-result');
    try{
        const res=await fetch(API+'/api/promocode/activate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
        const d=await res.json();r.style.display='block';
        if(res.ok){r.style.color='var(--green)';r.textContent=d.message||t('promo_activated')}
        else{r.style.color='var(--red)';r.textContent=d.detail||t('error')}
    }catch(e){r.style.display='block';r.style.color='var(--red)';r.textContent=t('net_error')}
}

/* ═══════════════════════════════════════
   ADMIN
   ═══════════════════════════════════════ */
function admTab(t){
    curAdmTab=t;
    document.querySelectorAll('#adm-tabs .admin-tab').forEach((b,i)=>b.classList.toggle('active',['stats','users','plans','settings','tickets','brand'][i]===t));
    document.querySelectorAll('.admin-content').forEach(c=>c.classList.remove('active'));
    const el=$('adm-'+t);if(el)el.classList.add('active');
    loadAdm(t);
}
async function loadAdm(t){
    if(t==='stats')await loadStats();
    if(t==='users')await loadUsers();
    if(t==='plans')await loadAdmPlans();
    if(t==='settings')await loadSettings();
    if(t==='tickets')await loadAdmTickets();
    if(t==='brand')loadBrandForm();
}
async function loadStats(){
    try{const r=await fetch(API+'/api/admin/stats');if(!r.ok)return;const d=await r.json();
    $('st-total').textContent=d.total_users||0;$('st-active').textContent=d.active_subscriptions||0;
    $('st-expired').textContent=d.expired_subscriptions||0;$('st-revenue').textContent=(d.total_revenue||0)}catch(e){}
}
async function loadUsers(){
    try{const r=await fetch(API+'/api/admin/users');if(!r.ok)return;usersCache=await r.json();drawUsers(usersCache)}catch(e){}
}
function filterUsers(){
    const q=$('user-search').value.toLowerCase().trim();
    if(!q)return drawUsers(usersCache);
    drawUsers(usersCache.filter(u=>(u.name||'').toLowerCase().includes(q)||String(u.telegram_id).includes(q)||(u.username||'').toLowerCase().includes(q)));
}
function drawUsers(list){
    const el=$('users-list');
    if(!list.length){el.innerHTML='<div class="empty-state">Пусто</div>';return}
    el.innerHTML=list.slice(0,50).map(u=>{
        const ini=(u.name||'?')[0].toUpperCase();
        const rc=u.role==='DEV'?'role-dev':u.role==='ADMIN'?'role-admin':'role-user';
        const rn=u.role==='DEV'?'DEV':u.role==='ADMIN'?'ADM':'USER';
        return '<div class="user-item" onclick="openUser('+u.telegram_id+')"><div class="user-item-info"><div class="user-avatar">'+esc(ini)+'</div><div><div class="user-name">'+esc(u.name||'—')+'</div><div class="user-sub">ID: '+u.telegram_id+'</div></div></div><span class="role-badge '+rc+'">'+rn+'</span></div>';
    }).join('');
}
async function openUser(tid){
    go('auser');$('aud-title').textContent=t('loading');$('aud-body').innerHTML='<div style="text-align:center;padding:40px"><div class="spinner"></div></div>';
    try{
        const r=await fetch(API+'/api/admin/users/'+tid);if(!r.ok){$('aud-body').innerHTML='<div class="empty-state">Ошибка</div>';return}
        const u=await r.json();$('aud-title').textContent=u.name||'Пользователь';drawUserDetail(u);
    }catch(e){$('aud-body').innerHTML='<div class="empty-state">'+e.message+'</div>'}
}
function drawUserDetail(u){
    const rm={USER:'Пользователь',ADMIN:'Администратор',DEV:'Разработчик'};
    const si=u.subscription?'<div class="card-row"><span class="card-label">Подписка</span><span class="card-value">'+(u.subscription.plan_name||'—')+'</span></div><div class="card-row"><span class="card-label">Статус</span><span class="card-value">'+u.subscription.status+'</span></div><div class="card-row"><span class="card-label">Истекает</span><span class="card-value">'+(u.subscription.expire_at||'—')+'</span></div>':'<div class="card-row"><span class="card-label">Подписка</span><span class="card-value" style="color:var(--text3)">Нет</span></div>';
    $('aud-body').innerHTML='<div class="card"><div class="card-row"><span class="card-label">Имя</span><span class="card-value">'+esc(u.name||'—')+'</span></div><div class="card-row"><span class="card-label">Username</span><span class="card-value">'+(u.username?'@'+esc(u.username):'—')+'</span></div><div class="card-row"><span class="card-label">ID</span><span class="card-value">'+u.telegram_id+'</span></div><div class="card-row"><span class="card-label">Баланс</span><span class="card-value">'+u.balance+' ₽</span></div><div class="card-row"><span class="card-label">Роль</span><span class="card-value">'+(rm[u.role]||u.role)+'</span></div><div class="card-row"><span class="card-label">Заблокирован</span><span class="card-value">'+(u.is_blocked?'Да':'Нет')+'</span></div>'+si+'</div><div style="display:flex;flex-direction:column;gap:8px"><button class="btn btn-secondary btn-full" onclick="changeRole('+u.telegram_id+',\''+u.role+'\')">Изменить роль</button><button class="btn btn-secondary btn-full" onclick="changeBal('+u.telegram_id+','+u.balance+')">Изменить баланс</button><button class="btn '+(u.is_blocked?'btn-primary':'btn-danger')+' btn-full" onclick="toggleBlock('+u.telegram_id+','+u.is_blocked+')">'+(u.is_blocked?'Разблокировать':'Заблокировать')+'</button></div>';
}
function changeRole(tid,cur){
    const roles=['USER','ADMIN','DEV'],names=['Пользователь','Администратор','Разработчик'];
    showModal('<h3>Изменить роль</h3>'+roles.map((r,i)=>'<button class="btn '+(r===cur?'btn-primary':'btn-secondary')+' btn-full" style="margin-top:6px" onclick="setRole('+tid+',\''+r+'\')">'+names[i]+'</button>').join('')+'<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Отмена</button></div>');
}
async function setRole(tid,role){closeModal();try{const r=await fetch(API+'/api/admin/users/'+tid+'/role',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role})});if(r.ok){toast('Роль изменена');openUser(tid)}else{const d=await r.json();toast(d.detail||'Ошибка','error')}}catch(e){toast('Ошибка','error')}}
let balType='basic';
function changeBal(tid,cur){
    balType='basic';
    showModal('<h3>Изменить баланс</h3><p style="color:var(--text2);font-size:.84rem;margin-bottom:10px">Текущий: '+cur+' ₽</p>'+
        '<div class="form-group"><label>Тип баланса</label><div style="display:flex;gap:6px;margin-top:4px"><button class="btn btn-primary btn-sm" id="bal-type-basic" onclick="switchBalType(\'basic\')">Основной</button><button class="btn btn-secondary btn-sm" id="bal-type-bonus" onclick="switchBalType(\'bonus\')">Бонусный</button></div></div>'+
        '<div class="form-group"><label>Сумма (+/-)</label><input class="form-input" id="bal-amt" type="number" placeholder="100"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Отмена</button><button class="btn btn-primary" onclick="setBal('+tid+')">Применить</button></div>');
}
function switchBalType(t){
    balType=t;
    const bb=$('bal-type-basic'),bn=$('bal-type-bonus');
    if(t==='basic'){bb.className='btn btn-primary btn-sm';bn.className='btn btn-secondary btn-sm'}
    else{bb.className='btn btn-secondary btn-sm';bn.className='btn btn-primary btn-sm'}
}
async function setBal(tid){const a=parseFloat($('bal-amt').value);if(isNaN(a))return toast('Введите число','error');closeModal();
    const endpoint=balType==='bonus'?'/bonus-balance':'/balance';
    try{const r=await fetch(API+'/api/admin/users/'+tid+endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:a})});if(r.ok){toast((balType==='bonus'?'Бонусный б':'Б')+'аланс изменён');openUser(tid)}else{const d=await r.json();toast(d.detail||'Ошибка','error')}}catch(e){toast('Ошибка','error')}}
async function toggleBlock(tid,blocked){try{const r=await fetch(API+'/api/admin/users/'+tid+'/block',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({block:!blocked})});if(r.ok){toast(blocked?'Разблокирован':'Заблокирован');openUser(tid)}else{const d=await r.json();toast(d.detail||'Ошибка','error')}}catch(e){toast('Ошибка','error')}}

/* ── Admin Plans (enhanced) ── */
let admPlansCache=[];
async function loadAdmPlans(){
    try{const r=await fetch(API+'/api/admin/plans');if(!r.ok)return;admPlansCache=await r.json();
    $('adm-plans-count').textContent='Тарифы ('+admPlansCache.length+')';
    drawAdmPlans()}catch(e){}
}
function drawAdmPlans(){
    const el=$('adm-plans-list');
    if(!admPlansCache.length){el.innerHTML='<div class="empty-state">Нет тарифов</div>';return}
    el.innerHTML=admPlansCache.map(p=>{
        const avl=AVAIL_LABELS[p.availability]||p.availability;
        const isTrial=p.availability==='TRIAL';
        return '<div class="plan-admin-card'+(p.is_active?'':' inactive')+'" onclick="editPlan('+p.id+')">'+
            '<div class="plan-admin-top">'+
                '<span class="plan-admin-name">'+esc(p.name)+'</span>'+
                (p.tag?'<span class="plan-admin-tag">'+esc(p.tag)+'</span>':'')+
                '<span class="avail-badge'+(isTrial?' trial':'')+'">'+avl+'</span>'+
                '<div class="plan-admin-actions" onclick="event.stopPropagation()">'+
                    '<button class="btn-toggle-plan'+(p.is_active?' active':'')+'" onclick="togglePlan('+p.id+',this)" title="'+(p.is_active?'Выключить':'Включить')+'"></button>'+
                    '<button class="btn-trash" onclick="delPlan('+p.id+')" title="Удалить">'+IC.trash+'</button>'+
                '</div>'+
            '</div>'+
            '<div class="plan-admin-meta">'+
                '<span>'+IC.pkg+' '+(p.traffic_limit||'∞')+' GB</span>'+
                '<span>'+IC.phone+' '+(p.device_limit||'∞')+' устр.</span>'+
                '<span>⏱ '+(p.durations||[]).length+' период(ов)</span>'+
            '</div>'+
        '</div>';
    }).join('');
}
async function togglePlan(id,btn){
    try{const r=await fetch(API+'/api/admin/plans/'+id+'/toggle',{method:'PATCH'});
    if(r.ok){const d=await r.json();btn.classList.toggle('active',d.is_active);
    // Update cache
    const p=admPlansCache.find(x=>x.id===id);if(p)p.is_active=d.is_active;
    btn.closest('.plan-admin-card').classList.toggle('inactive',!d.is_active);
    toast(d.is_active?'Включён':'Выключен')}else toast('Ошибка','error')}catch(e){toast('Ошибка','error')}
}
async function delPlan(id){if(!confirm(t('delete_plan_q')))return;try{const r=await fetch(API+'/api/admin/plans/'+id,{method:'DELETE'});if(r.ok){toast(t('deleted'));loadAdmPlans()}else{const j=await r.json();toast(j.detail||t('error'),'error')}}catch(e){toast(t('error'),'error')}}

/* ── Plan Create / Edit Modal ── */
let editingPlanId=null;
function showCreatePlan(){editingPlanId=null;showPlanModal({name:'',description:'',tag:'',availability:'ALL',type:'BOTH',traffic_limit:100,device_limit:1,durations:[{days:30,prices:[{currency:D.default_currency||'RUB',amount:'0'}]}]},'Создать тариф')}
function editPlan(id){
    const p=admPlansCache.find(x=>x.id===id);if(!p)return;
    editingPlanId=id;
    showPlanModal(p,'Редактировать тариф');
}
function showPlanModal(p,title){
    const dc=D.default_currency||'RUB';
    const durs=(p.durations||[]).map((d,i)=>{
        const pr=(d.prices||[]).find(x=>x.currency===dc);
        const amt=pr?pr.amount:'0';
        return durEntryHtml(i,d.days,amt);
    }).join('');
    const availOpts=Object.entries(AVAIL_LABELS).map(([k,v])=>'<option value="'+k+'"'+(p.availability===k?' selected':'')+'>'+v+'</option>').join('');
    const typeOpts=Object.entries(TYPE_LABELS).map(([k,v])=>'<option value="'+k+'"'+(p.type===k?' selected':'')+'>'+v+'</option>').join('');
    showModal(
        '<h3>'+title+'</h3>'+
        '<div class="form-group"><label>Название</label><input class="form-input" id="np-name" value="'+esc(p.name)+'" placeholder="Базовый"></div>'+
        '<div class="form-group"><label>Описание</label><input class="form-input" id="np-desc" value="'+esc(p.description||'')+'" placeholder="Описание тарифа"></div>'+
        '<div class="form-row"><div class="form-group"><label>Тег</label><input class="form-input" id="np-tag" value="'+esc(p.tag||'')+'" placeholder="base"></div><div class="form-group"><label>Доступность</label><select class="form-input" id="np-avail">'+availOpts+'</select></div></div>'+
        '<div class="form-row"><div class="form-group"><label>Тип</label><select class="form-input" id="np-type" onchange="onPlanTypeChange()">'+typeOpts+'</select></div><div class="form-group"><label>Трафик (GB)</label><input class="form-input" id="np-traffic" type="number" value="'+p.traffic_limit+'"></div></div>'+
        '<div class="form-group"><label>Устройств</label><input class="form-input" id="np-dev" type="number" value="'+p.device_limit+'"></div>'+
        '<div style="margin-bottom:8px"><label style="font-size:.8rem;color:var(--text3);font-weight:500">Периоды и цены ('+(CURRENCY_SYMBOLS[dc]||dc)+')</label></div>'+
        '<div id="dur-list">'+durs+'</div>'+
        '<button class="btn btn-secondary btn-sm" onclick="addDurEntry()" style="margin-bottom:10px">+ Период</button>'+
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">'+t('cancel')+'</button><button class="btn btn-primary" onclick="savePlan()">'+t('save')+'</button></div>'
    );
    // Apply conditional fields after modal renders
    setTimeout(()=>onPlanTypeChange(),0);
}
function onPlanTypeChange(){
    const t=$('np-type');if(!t)return;
    const v=t.value;
    const trEl=$('np-traffic'), devEl=$('np-dev');
    if(!trEl||!devEl)return;
    // TRAFFIC → disable devices; DEVICES → disable traffic
    if(v==='TRAFFIC'){trEl.disabled=false;devEl.disabled=true;devEl.value='0'}
    else if(v==='DEVICES'){trEl.disabled=true;trEl.value='0';devEl.disabled=false}
    else if(v==='UNLIMITED'){trEl.disabled=true;trEl.value='0';devEl.disabled=true;devEl.value='0'}
    else{trEl.disabled=false;devEl.disabled=false}
}
function durEntryHtml(i,days,amount){
    return '<div class="duration-entry" data-idx="'+i+'"><div class="duration-entry-header"><span style="font-size:.8rem;color:var(--text2);font-weight:600">Период #'+(i+1)+'</span><button class="dur-remove" onclick="this.closest(\'.duration-entry\').remove()">✕</button></div><div class="form-row"><div class="form-group"><label>Дней</label><input class="form-input dur-days" type="number" value="'+days+'" min="1"></div><div class="form-group"><label>Цена</label><input class="form-input dur-price" type="number" value="'+amount+'" min="0" step="0.01"></div></div></div>';
}
function addDurEntry(){
    const list=$('dur-list');
    const idx=list.querySelectorAll('.duration-entry').length;
    list.insertAdjacentHTML('beforeend',durEntryHtml(idx,30,'0'));
}
async function savePlan(){
    const name=$('np-name').value.trim();if(!name)return toast('Введите название','error');
    const dc=D.default_currency||'RUB';
    const durations=[];
    $('dur-list').querySelectorAll('.duration-entry').forEach(el=>{
        const days=parseInt(el.querySelector('.dur-days').value)||30;
        const price=el.querySelector('.dur-price').value||'0';
        durations.push({days,prices:[{currency:dc,amount:price}]});
    });
    const body={
        name,
        description:$('np-desc').value.trim(),
        tag:$('np-tag').value.trim(),
        availability:$('np-avail').value,
        type:$('np-type').value,
        traffic_limit:parseInt($('np-traffic').value)||100,
        device_limit:parseInt($('np-dev').value)||1,
        durations
    };
    closeModal();
    try{
        const url=editingPlanId?API+'/api/admin/plans/'+editingPlanId:API+'/api/admin/plans';
        const method=editingPlanId?'PUT':'POST';
        const r=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(r.ok){toast(editingPlanId?'Тариф обновлён':'Тариф создан');loadAdmPlans()}
        else{const j=await r.json();toast(j.detail||'Ошибка','error')}
    }catch(e){toast('Ошибка','error')}
}

/* ── Admin Settings ── */
let settingsCache={};
async function loadSettings(){
    try{const r=await fetch(API+'/api/admin/settings');if(!r.ok)return;settingsCache=await r.json();
    try{const gr=await fetch(API+'/api/admin/gateways');if(gr.ok)gatewaysCache=await gr.json()}catch(e){}
    drawSettings()}catch(e){}
}
function drawSettings(){
    const s=settingsCache;
    const mkToggle=(key,val,stopProp)=>{
        const cls='toggle-switch'+(val?' active':'');
        const sp=stopProp?'event.stopPropagation();':'';
        return '<button class="'+cls+'" onclick="'+sp+'toggleSet(\''+key+'\','+(!val)+');this.classList.toggle(\'active\')"></button>';
    };
    const mkRow=(item)=>{
        const val=s[item.key];
        if(item.type==='select'){
            return '<div class="settings-row" onclick="openSettingDetail(\''+item.key+'\',\''+item.label+'\',\''+(item.detail||'')+'\')"><div class="settings-row-left"><span class="settings-icon">'+item.icon+'</span><div><div class="settings-label">'+item.label+'</div><div class="settings-desc">'+item.desc+'</div></div></div><span class="settings-chevron">'+esc(String(val))+' &#8250;</span></div>';
        } else if(typeof val==='boolean'){
            if(item.detail){
                return '<div class="settings-row" onclick="openSettingDetail(\''+item.key+'\',\''+item.label+'\',\''+item.detail+'\')"><div class="settings-row-left"><span class="settings-icon">'+item.icon+'</span><div><div class="settings-label">'+item.label+'</div><div class="settings-desc">'+item.desc+'</div></div></div>'+mkToggle(item.key,val,true)+'</div>';
            } else {
                return '<div class="settings-row"><div class="settings-row-left"><span class="settings-icon">'+item.icon+'</span><div><div class="settings-label">'+item.label+'</div><div class="settings-desc">'+item.desc+'</div></div></div>'+mkToggle(item.key,val,false)+'</div>';
            }
        } else {
            return '<div class="settings-row" onclick="openSettingDetail(\''+item.key+'\',\''+item.label+'\',\''+(item.detail||'')+'\')"><div class="settings-row-left"><span class="settings-icon">'+item.icon+'</span><div><div class="settings-label">'+item.label+'</div><div class="settings-desc">'+esc(String(val||'—'))+'</div></div></div><span class="settings-chevron">&#8250;</span></div>';
        }
    };
    const funcItems=[
        {key:'balance_enabled',icon:IC.wallet,label:'Баланс',desc:'Пополнение и использование баланса',detail:'balance'},
        {key:'referral_enabled',icon:IC.handshake,label:'Реф.система',desc:'Реферальная программа',detail:'referral'},
        {key:'promocodes_enabled',icon:IC.gift,label:'Промокоды',desc:'Активация промокодов'},
        {key:'notifications_enabled',icon:IC.bell,label:'Уведомления',desc:'Уведомления пользователей',detail:'notifications'},
        {key:'extra_devices_enabled',icon:IC.phone,label:'Доп. устройства',desc:'Расширение лимита устройств',detail:'extra_devices'},
        {key:'transfers_enabled',icon:IC.transfer,label:'Переводы',desc:'Переводы баланса между пользователями',detail:'transfers'},
        {key:'global_discount_enabled',icon:IC.tag,label:'Глобальная скидка',desc:'Скидка на все тарифы',detail:'global_discount'},
        {key:'community_enabled',icon:IC.chat,label:'Сообщество',desc:'Ссылка на Telegram-группу',detail:'community'},
        {key:'tos_enabled',icon:IC.file,label:'Соглашение',desc:'Пользовательское соглашение',detail:'tos'},
        {key:'language_enabled',icon:IC.globe,label:'Мультиязычность',desc:'Выбор языка интерфейса'},
    ];
    let gwRows='';
    gatewaysCache.forEach(gw=>{
        const label=GW_LABELS[gw.type]||gw.type;
        const icon=GW_ICONS[gw.type]||IC.card;
        gwRows+='<div class="settings-row" onclick="openGatewayDetail('+gw.id+')"><div class="settings-row-left"><span class="settings-icon">'+icon+'</span><div><div class="settings-label">'+label+'</div><div class="settings-desc">'+gw.currency+' • '+(gw.is_active?'Активна':'Неактивна')+'</div></div></div><button class="toggle-switch '+(gw.is_active?'active':'')+'" onclick="event.stopPropagation();toggleGw('+gw.id+','+(!gw.is_active)+',this)"></button></div>';
    });
    if(!gatewaysCache.length) gwRows='<div class="settings-row"><div class="settings-row-left"><span class="settings-icon">'+IC.card+'</span><div><div class="settings-label">Нет платёжных систем</div><div class="settings-desc">Настройте в панели Remnawave</div></div></div></div>';
    const botItems=[
        {key:'access_mode',icon:IC.key,label:'Режим доступа',desc:s.access_mode||'PUBLIC',type:'select',detail:'access_mode'},
        {key:'channel_required',icon:IC.megaphone,label:'Подписка на канал',desc:s.channel_link?'Канал: '+s.channel_link:'Не настроено',detail:'channel'},
        {key:'rules_required',icon:IC.scroll,label:'Принятие правил',desc:'Требовать принятие условий при входе',detail:'tos'},
        {key:'purchases_allowed',icon:IC.cart,label:'Разрешить покупки',desc:'Разрешить покупку подписок'},
        {key:'registration_allowed',icon:IC.pencil,label:'Разрешить регистрацию',desc:'Регистрация новых пользователей'},
        {key:'default_currency',icon:IC.currency,label:'Валюта',desc:s.default_currency||'RUB',type:'select',detail:'currency_rates'},
        {key:'bot_locale',icon:IC.lang,label:'Язык бота',desc:s.bot_locale||'RU',type:'select',detail:'bot_locale'},
    ];
    let html='';
    html+='<details class="spoiler-card settings-spoiler" open><summary><span class="spoiler-title">'+IC.settings+' Функционал</span><span class="spoiler-chevron">▼</span></summary><div class="card" style="padding:0;overflow:hidden;margin-top:10px;margin-bottom:0">';
    funcItems.forEach(item=>{html+=mkRow(item)});
    html+='</div></details>';
    html+='<details class="spoiler-card settings-spoiler"><summary><span class="spoiler-title">'+IC.card+' Платёжные системы</span><span class="spoiler-chevron">▼</span></summary><div class="card" style="padding:0;overflow:hidden;margin-top:10px;margin-bottom:0">';
    html+=gwRows;
    html+='</div></details>';
    html+='<details class="spoiler-card settings-spoiler"><summary><span class="spoiler-title">'+IC.bot+' Управление ботом</span><span class="spoiler-chevron">▼</span></summary><div class="card" style="padding:0;overflow:hidden;margin-top:10px;margin-bottom:0">';
    botItems.forEach(item=>{html+=mkRow(item)});
    html+='</div></details>';
    $('settings-list').innerHTML=html;
}
let curDetailCtx=null;
function openSettingDetail(key,label,detail){
    curDetailCtx={key,label,detail};
    const s=settingsCache, val=s[key];
    let body='';
    let saveAction='';
    if(detail==='balance'){
        const curMode=s.balance_mode||'SEPARATE';
        const sym=CURRENCY_SYMBOLS[s.default_currency]||'₽';
        body+='<div class="setting-inline-row"><span class="setting-inline-label">Режим баланса</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'balance_mode\',this.value)"><option value="SEPARATE"'+(curMode==='SEPARATE'?' selected':'')+'>Раздельно</option><option value="COMBINED"'+(curMode==='COMBINED'?' selected':'')+'>Объединённый</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">Минимальное пополнение</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-bal-min" type="number" value="'+(s.balance_min_amount||10)+'" style="width:80px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+sym+'</span></div></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">Максимальное пополнение</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-bal-max" type="number" value="'+(s.balance_max_amount||100000)+'" style="width:80px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+sym+'</span></div></div>';
        saveAction='saveMultiSub({balance_min_amount:parseInt($(\'sd-bal-min\').value),balance_max_amount:parseInt($(\'sd-bal-max\').value)})';
    } else if(detail==='community'){
        body+='<div class="form-group"><label>URL сообщества</label><input class="form-input" id="sd-comm-url" value="'+esc(s.community_url||'')+'" placeholder="https://t.me/..."></div>';
        saveAction='saveMultiSub({community_url:$(\'sd-comm-url\').value})';
    } else if(detail==='referral'){
        const curLevel=String(s.referral_level||1);
        const curRt=s.referral_reward_type||'MONEY';
        const curAs=s.referral_accrual_strategy||'ON_EACH_PAYMENT';
        const curRs=s.referral_reward_strategy||'AMOUNT';
        const rewardUnit=curRs==='PERCENT'?'%':(curRt==='EXTRA_DAYS'?'дней':(CURRENCY_SYMBOLS[s.default_currency]||'₽'));
        body+='<div class="setting-inline-row"><span class="setting-inline-label">Уровневость</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'referral_level\',parseInt(this.value));setTimeout(()=>openSettingDetail(\'referral_enabled\',\'Реф.система\',\'referral\'),100)"><option value="1"'+(curLevel==='1'?' selected':'')+'>1 уровень</option><option value="2"'+(curLevel==='2'?' selected':'')+'>2 уровня</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">Тип награды</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'referral_reward_type\',this.value)"><option value="MONEY"'+(curRt==='MONEY'?' selected':'')+'>Деньги</option><option value="EXTRA_DAYS"'+(curRt==='EXTRA_DAYS'?' selected':'')+'>Дни</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">Условия начисления</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'referral_accrual_strategy\',this.value)"><option value="ON_EACH_PAYMENT"'+(curAs==='ON_EACH_PAYMENT'?' selected':'')+'>За каждую оплату</option><option value="ON_FIRST_PAYMENT"'+(curAs==='ON_FIRST_PAYMENT'?' selected':'')+'>За первую оплату</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">Форма начисления</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'referral_reward_strategy\',this.value)"><option value="AMOUNT"'+(curRs==='AMOUNT'?' selected':'')+'>Фиксированная</option><option value="PERCENT"'+(curRs==='PERCENT'?' selected':'')+'>Процентная</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">Награда (ур. 1)</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-ref-val" type="number" value="'+(s.referral_reward_value||10)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+rewardUnit+'</span></div></div>'+
            (curLevel==='2'?'<div class="setting-inline-row"><span class="setting-inline-label">Награда (ур. 2)</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-ref-val2" type="number" value="'+(s.referral_reward_value_l2||5)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+rewardUnit+'</span></div></div>':'')+
            '<div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px"><div class="form-group"><label>Текст приглашения</label><textarea class="form-input" id="sd-ref-msg" rows="7" style="resize:vertical;min-height:120px" placeholder="Введите текст приглашения.\n{space} — перенос строки\n{url} — реферальная ссылка\n{name} — название бота">'+esc(s.referral_invite_message||'')+'</textarea></div></div>';
        saveAction='saveMultiSub({referral_reward_value:parseInt($(\'sd-ref-val\').value),referral_reward_value_l2:$(\'sd-ref-val2\')?parseInt($(\'sd-ref-val2\').value):undefined,referral_invite_message:$(\'sd-ref-msg\').value})';
    } else if(detail==='notifications'){
        const unLabels={un_expires_3d:'Истекает через 3 дня',un_expires_2d:'Истекает через 2 дня',un_expires_1d:'Истекает через 1 день',un_expired:'Подписка истекла',un_limited:'Трафик исчерпан',un_expired_1d_ago:'Истекла 1 день назад',un_referral_attached:'Реферал присоединён',un_referral_reward:'Реферальная награда'};
        const snLabels={sn_bot_lifetime:'Время работы бота',sn_bot_update:'Обновление бота',sn_user_registered:'Регистрация пользователя',sn_subscription:'Подписка',sn_extra_devices:'Доп. устройства',sn_promocode:'Промокод активирован',sn_trial:'Пробный период',sn_node_status:'Статус ноды',sn_user_connected:'Первое подключение',sn_user_hwid:'HWID пользователя',sn_billing:'Биллинг',sn_balance_transfer:'Перевод баланса'};
        body+='<div style="font-size:.76rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Пользовательские</div>';
        Object.entries(unLabels).forEach(([k,v])=>{
            body+='<div class="toggle-row"><label>'+v+'</label><button class="toggle-switch '+(s[k]?'active':'')+'" onclick="saveSubSetting(\''+k+'\','+(!s[k])+');this.classList.toggle(\'active\')"></button></div>';
        });
        body+='<div style="font-size:.76rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin:14px 0 8px">Системные</div>';
        Object.entries(snLabels).forEach(([k,v])=>{
            body+='<div class="toggle-row"><label>'+v+'</label><button class="toggle-switch '+(s[k]?'active':'')+'" onclick="saveSubSetting(\''+k+'\','+(!s[k])+');this.classList.toggle(\'active\')"></button></div>';
        });
    } else if(detail==='extra_devices'){
        const sym=CURRENCY_SYMBOLS[s.default_currency]||'₽';
        body+='<div class="setting-inline-row"><span class="setting-inline-label">Цена за устройство</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-ed-price" type="number" value="'+(s.extra_devices_price||100)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+sym+'</span></div></div>'+
            '<div class="toggle-row" style="margin-bottom:8px"><label>Единоразовая оплата</label><button class="toggle-switch '+(s.extra_devices_one_time?'active':'')+'" onclick="saveSubSetting(\'extra_devices_one_time\','+(!s.extra_devices_one_time)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">Мин. дней до истечения</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-ed-days" type="number" value="'+(s.extra_devices_min_days||10)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"></div></div>';
        saveAction='saveMultiSub({extra_devices_price:parseInt($(\'sd-ed-price\').value),extra_devices_min_days:parseInt($(\'sd-ed-days\').value)})';
    } else if(detail==='transfers'){
        const curTct=s.transfers_commission_type||'percent';
        const commUnit=curTct==='fixed'?(CURRENCY_SYMBOLS[s.default_currency]||'₽'):'%';
        const sym=CURRENCY_SYMBOLS[s.default_currency]||'₽';
        body+='<div class="setting-inline-row"><span class="setting-inline-label">Тип комиссии</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'transfers_commission_type\',this.value);setTimeout(()=>openSettingDetail(\'transfers_enabled\',\'Переводы\',\'transfers\'),100)"><option value="percent"'+(curTct==='percent'?' selected':'')+'>Процент</option><option value="fixed"'+(curTct==='fixed'?' selected':'')+'>Фиксированная</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">Комиссия</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-tr-comm" type="number" value="'+(s.transfers_commission_value||5)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+commUnit+'</span></div></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">Мин. сумма</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-tr-min" type="number" value="'+(s.transfers_min_amount||10)+'" style="width:80px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+sym+'</span></div></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">Макс. сумма</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-tr-max" type="number" value="'+(s.transfers_max_amount||100000)+'" style="width:80px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+sym+'</span></div></div>';
        saveAction='saveMultiSub({transfers_commission_value:parseInt($(\'sd-tr-comm\').value),transfers_min_amount:parseInt($(\'sd-tr-min\').value),transfers_max_amount:parseInt($(\'sd-tr-max\').value)})';
    } else if(detail==='global_discount'){
        const curGdt=s.global_discount_type||'percent';
        const discUnit=curGdt==='fixed'?(CURRENCY_SYMBOLS[s.default_currency]||'₽'):'%';
        body+='<div class="setting-inline-row"><span class="setting-inline-label">Тип скидки</span><select class="pay-method-select setting-inline-select" onchange="saveSubSetting(\'global_discount_type\',this.value);setTimeout(()=>openSettingDetail(\'global_discount_enabled\',\'Глобальная скидка\',\'global_discount\'),100)"><option value="percent"'+(curGdt==='percent'?' selected':'')+'>Процент</option><option value="fixed"'+(curGdt==='fixed'?' selected':'')+'>Фиксированная</option></select></div>'+
            '<div class="setting-inline-row"><span class="setting-inline-label">Значение скидки</span><div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="form-input" id="sd-gd-val" type="number" value="'+(s.global_discount_value||0)+'" style="width:70px;text-align:center;padding:5px 8px;font-size:.78rem"><span style="color:var(--text3);font-size:.78rem;white-space:nowrap">'+discUnit+'</span></div></div>'+
            '<div class="toggle-row" style="margin-bottom:8px"><label>Складывать скидки</label><button class="toggle-switch '+(s.global_discount_stack?'active':'')+'" onclick="saveSubSetting(\'global_discount_stack\','+(!s.global_discount_stack)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:10px"><div style="font-size:.76rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Применять к</div>'+
            '<div class="toggle-row"><label>Подписки</label><button class="toggle-switch '+(s.global_discount_apply_sub?'active':'')+'" onclick="saveSubSetting(\'global_discount_apply_sub\','+(!s.global_discount_apply_sub)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="toggle-row"><label>Доп. устройства</label><button class="toggle-switch '+(s.global_discount_apply_devices?'active':'')+'" onclick="saveSubSetting(\'global_discount_apply_devices\','+(!s.global_discount_apply_devices)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="toggle-row"><label>Комиссия переводов</label><button class="toggle-switch '+(s.global_discount_apply_transfer?'active':'')+'" onclick="saveSubSetting(\'global_discount_apply_transfer\','+(!s.global_discount_apply_transfer)+');this.classList.toggle(\'active\')"></button></div></div>';
        saveAction='saveMultiSub({global_discount_value:parseInt($(\'sd-gd-val\').value)})';
    } else if(detail==='currency_rates'){
        const opts=['RUB','USD','EUR','XTR'];
        body+=opts.map(o=>'<button class="sub-action-btn sub-action-'+(String(val)===o?'renew':'change')+'" style="margin-top:6px;width:100%" onclick="saveSettingVal(\''+key+'\',\''+o+'\')">'+o+'</button>').join('');
        body+='<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px"><div style="font-size:.76rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Курсы валют</div></div>'+
            '<div class="toggle-row" style="margin-bottom:8px"><label>Автообновление (ЦБ РФ)</label><button class="toggle-switch '+(s.currency_rates_auto?'active':'')+'" onclick="saveSubSetting(\'currency_rates_auto\','+(!s.currency_rates_auto)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="form-group"><label>USD → RUB</label><input class="form-input" id="sd-cr-usd" type="number" step="0.01" value="'+(s.currency_rates_usd||90)+'"></div>'+
            '<div class="form-group"><label>EUR → RUB</label><input class="form-input" id="sd-cr-eur" type="number" step="0.01" value="'+(s.currency_rates_eur||100)+'"></div>'+
            '<div class="form-group"><label>Stars → RUB</label><input class="form-input" id="sd-cr-stars" type="number" step="0.01" value="'+(s.currency_rates_stars||1.5)+'"></div>';
        saveAction='saveMultiSub({currency_rates_usd:parseFloat($(\'sd-cr-usd\').value),currency_rates_eur:parseFloat($(\'sd-cr-eur\').value),currency_rates_stars:parseFloat($(\'sd-cr-stars\').value)})';
    } else if(detail==='tos'){
        body+='<div class="form-group"><label>URL соглашения</label><input class="form-input" id="sd-tos-url" value="'+esc(s.tos_url||'')+'" placeholder="https://..."></div>';
        saveAction='saveSettingStr(\'tos_url\',$(\'sd-tos-url\').value)';
    } else if(detail==='access_mode'){
        const amLabels={PUBLIC:'Публичный',INVITED:'По приглашению',RESTRICTED:'Ограниченный'};
        body+=Object.entries(amLabels).map(([k,v])=>'<button class="sub-action-btn sub-action-'+(String(val)===k?'renew':'change')+'" style="margin-top:6px;width:100%" onclick="saveSettingVal(\'access_mode\',\''+k+'\')">'+v+'</button>').join('');
    } else if(detail==='channel'){
        body+='<div class="toggle-row" style="margin-bottom:12px"><label>Обязательная подписка</label><button class="toggle-switch '+(s.channel_required?'active':'')+'" onclick="saveSubSetting(\'channel_required\','+(!s.channel_required)+');this.classList.toggle(\'active\')"></button></div>'+
            '<div class="form-group"><label>Ссылка на канал</label><input class="form-input" id="sd-ch-link" value="'+esc(s.channel_link||'')+'" placeholder="https://t.me/..."></div>';
        saveAction='saveSettingStr(\'channel_link\',$(\'sd-ch-link\').value)';
    } else if(detail==='bot_locale'){
        const locLabels={RU:'Русский',EN:'English',UK:'Українська',DE:'Deutsch'};
        body+=Object.entries(locLabels).map(([k,v])=>'<button class="sub-action-btn sub-action-'+(String(val)===k?'renew':'change')+'" style="margin-top:6px;width:100%" onclick="saveSettingVal(\'bot_locale\',\''+k+'\')">'+v+'</button>').join('');
    } else if(typeof val==='boolean'){
    } else {
        body+='<div class="form-group"><label>Значение</label><input class="form-input" id="set-val" value="'+esc(String(val||''))+'"></div>';
        saveAction='saveSettingStr(\''+key+'\',$(\'set-val\').value)';
    }
    if(!body)return;
    let footer='<div class="modal-actions" style="gap:8px">';
    if(saveAction) footer+='<button class="sub-action-btn sub-action-renew" style="flex:1;border-color:rgba(25,195,125,.35);color:var(--green)" onclick="'+saveAction+'">Принять</button>';
    footer+='<button class="sub-action-btn sub-action-change" style="flex:1;border-color:rgba(224,79,95,.35);color:var(--red)" onclick="closeModal()">Отмена</button></div>';
    showModal('<h3>'+label+'</h3>'+body+footer);
}
async function saveSubSetting(k,v){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;toast('Сохранено');
        if(curDetailCtx)openSettingDetail(curDetailCtx.key,curDetailCtx.label,curDetailCtx.detail);
    }else toast('Ошибка','error')}catch(e){toast('Ошибка','error')}
}
async function saveMultiSub(obj){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)});
    if(r.ok){Object.assign(settingsCache,obj);
        if(D.features&&obj.referral_invite_message!=null)D.features.referral_invite_message=obj.referral_invite_message;
        closeModal();drawSettings();toast('Сохранено')}else toast('Ошибка','error')}catch(e){toast('Ошибка','error')}
}
async function toggleSetAndRefresh(k,v,btn){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;if(btn&&typeof btn.classList!=='undefined')btn.classList.toggle('active',v);drawSettings();toast('Сохранено')}else toast('Ошибка','error')}catch(e){toast('Ошибка','error')}
}
async function toggleSet(k,v,dotId){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;
        const dot=typeof dotId==='string'?$(dotId):dotId;
        if(dot){dot.classList.toggle('active',v);}
        drawSettings();toast('Сохранено')
    }else toast('Ошибка','error')}catch(e){toast('Ошибка','error')}
}

/* ═══ PAYMENT GATEWAYS ═══ */
let gatewaysCache=[];
const GW_LABELS={TELEGRAM_STARS:'Telegram Stars',YOOKASSA:'ЮKassa',YOOMONEY:'ЮMoney',CRYPTOMUS:'Cryptomus',HELEKET:'Криптовалюта',CRYPTOPAY:'CryptoPay',ROBOKASSA:'Robokassa',BALANCE:'Баланс'};
const GW_ICONS={TELEGRAM_STARS:IC.star,YOOKASSA:'<svg viewBox="0 0 24 24" width="27" height="27" style="vertical-align:middle"><circle cx="12" cy="12" r="11" fill="#8B3FFD"/><text x="12" y="17" text-anchor="middle" fill="#fff" font-size="14" font-weight="700" font-family="Arial">Ю</text></svg>',YOOMONEY:'<svg viewBox="0 0 24 24" width="27" height="27" style="vertical-align:middle"><circle cx="12" cy="12" r="11" fill="#8B3FFD"/><text x="12" y="17" text-anchor="middle" fill="#fff" font-size="14" font-weight="700" font-family="Arial">Ю</text></svg>',CRYPTOMUS:IC.coin,HELEKET:'₿',CRYPTOPAY:IC.gem,ROBOKASSA:IC.bot,BALANCE:IC.wallet};
const GW_DESCS={TELEGRAM_STARS:'Telegram',YOOKASSA:'Оплата банковской картой',YOOMONEY:'Банковская карта',CRYPTOMUS:'USDT, TON, BTC и другие',HELEKET:'BTC, USDT и другие',CRYPTOPAY:'TON, USDT и другие',ROBOKASSA:'Банковские карты',BALANCE:'Оплата с баланса'};
const GW_SECRET_FIELDS=['api_key','secret_key'];
async function loadGateways(){
    try{const r=await fetch(API+'/api/admin/gateways');if(!r.ok)return;gatewaysCache=await r.json();drawGateways()}catch(e){}
}
function drawGateways(){
    drawSettings();
}
async function toggleGw(id,v,btn){
    try{const r=await fetch(API+'/api/admin/gateways/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({is_active:v})});
    if(r.ok){btn.classList.toggle('active',v);const gw=gatewaysCache.find(g=>g.id===id);if(gw)gw.is_active=v;drawGateways();toast('Сохранено')}else toast('Ошибка','error')}catch(e){toast('Ошибка','error')}
}
function openGatewayDetail(id){
    const gw=gatewaysCache.find(g=>g.id===id);if(!gw)return;
    const label=GW_LABELS[gw.type]||gw.type;
    const settings=gw.settings||{};
    const fields=Object.keys(settings);
    if(!fields.length){
        showModal('<h3>'+label+'</h3><p style="color:var(--text3);font-size:.84rem;margin:12px 0">Нет настраиваемых параметров</p><div class="modal-actions"><button class="sub-action-btn sub-action-change" style="flex:1;border-color:rgba(224,79,95,.35);color:var(--red)" onclick="closeModal()">Отмена</button></div>');
        return;
    }
    let body='<h3>'+label+'</h3><div style="margin-top:12px">';
    fields.forEach(f=>{
        const isSecret=GW_SECRET_FIELDS.includes(f);
        body+='<div class="form-group"><label>'+f+'</label><input class="form-input" id="gw-f-'+f+'" type="'+(isSecret?'password':'text')+'" value="'+esc(String(settings[f]||''))+'" placeholder="'+f+'"></div>';
    });
    body+='</div><div class="modal-actions" style="gap:8px"><button class="sub-action-btn sub-action-renew" style="flex:1;border-color:rgba(25,195,125,.35);color:var(--green)" onclick="saveGwSettings('+id+')">Принять</button><button class="sub-action-btn sub-action-change" style="flex:1;border-color:rgba(224,79,95,.35);color:var(--red)" onclick="closeModal()">Отмена</button></div>';
    showModal(body);
}
async function saveGwSettings(id){
    const gw=gatewaysCache.find(g=>g.id===id);if(!gw)return;
    const settings=gw.settings||{};
    const upd={};
    Object.keys(settings).forEach(f=>{
        const el=$('gw-f-'+f);if(el)upd[f]=el.value;
    });
    try{const r=await fetch(API+'/api/admin/gateways/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({settings:upd})});
    if(r.ok){closeModal();loadGateways();toast('Сохранено')}else toast('Ошибка','error')}catch(e){toast('Ошибка','error')}
}

function showQR(){
    const s=D&&D.subscription;
    if(!s||!s.url)return toast(t('no_active_sub')||'Нет активной подписки','error');
    const qrUrl='https://api.qrserver.com/v1/create-qr-code/?size=200x200&color=24C4F1&bgcolor=080C14&data='+encodeURIComponent(s.url);
    showModal('<h3>QR-код</h3><div style="text-align:center;padding:10px 0"><img src="'+qrUrl+'" style="width:200px;height:200px;border-radius:12px" alt="QR"></div><p style="font-size:.75rem;color:var(--text3);text-align:center">Отсканируйте для подключения</p><div class="modal-actions"><button class="btn-confirm-pay" style="flex:1" onclick="closeModal()">Готово</button></div>');
}
async function saveSettingStr(k,v){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;closeModal();drawSettings();toast('Сохранено')}else toast('Ошибка','error')}catch(e){toast('Ошибка','error')}
}
async function saveSettingVal(k,v){
    try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});
    if(r.ok){settingsCache[k]=v;closeModal();drawSettings();toast(t('saved'));
        if(k==='bot_locale'){CUR_LOCALE=v;render();applyLocale()}
    }else toast(t('error'),'error')}catch(e){toast(t('error'),'error')}
}

/* ── Tickets (User) ── */
let curTicketId=null;
async function loadTickets(){
    try{const r=await fetch(API+'/api/tickets');if(!r.ok)return;const tks=await r.json();
    const el=$('tickets-list');
    if(!tks.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">'+IC.ticket+'</span><h3>'+t('no_tickets')+'</h3><p style="color:var(--text3);font-size:.84rem">'+t('create_first')+'</p></div>';return}
    // Sort by updated_at descending (newest first)
    tks.sort((a,b)=>(b.updated_at||'').localeCompare(a.updated_at||''));
    el.innerHTML=tks.map(tk=>{
        const st=tk.status.toLowerCase();
        // User statuses: unread→"Новое"(red), OPEN→"На рассмотрении", ANSWERED→"Ответ получен"
        let stClass=st, stLabel;
        if(!tk.is_read_by_user && st!=='closed'){
            stClass='new'; stLabel=t('ticket_new');
        } else {
            stLabel=t('ticket_'+st)||st;
        }
        const last=tk.messages&&tk.messages.length?tk.messages[tk.messages.length-1].text:'';
        return '<div class="ticket-item" onclick="openTicket('+tk.id+')">'+
            '<div class="ticket-top"><span class="ticket-subject">'+esc(tk.subject)+'</span><span class="ticket-status '+stClass+'">'+stLabel+'</span></div>'+
            '<div class="ticket-preview">'+esc(last.substring(0,80))+'</div>'+
            '<div class="ticket-date">'+tk.updated_at+'</div></div>';
    }).join('')}catch(e){}
}
async function openTicket(id){
    curTicketId=id; go('ticket');$('ticket-title').textContent=t('loading');$('ticket-chat').innerHTML='';$('ticket-reply').style.display='none';
    try{const r=await fetch(API+'/api/tickets/'+id);if(!r.ok)return;
    const t2=await r.json();$('ticket-title').textContent=t2.subject;
    renderTicketChat($('ticket-chat'),t2.messages,false);
    if(t2.status!=='CLOSED'){
        $('ticket-reply').style.display='flex';
    } else {
        $('ticket-reply').style.display='none';
    }
    // API marks ticket as read on GET — refresh badge count immediately
    pollTicketStatus();
    }catch(e){}
}
function _fmtTicketTime(dateStr){
    if(!dateStr)return '';
    try{
        const d=new Date(dateStr);
        if(isNaN(d))return dateStr;
        const now=new Date();
        const hh=String(d.getHours()).padStart(2,'0');
        const mm=String(d.getMinutes()).padStart(2,'0');
        const time=hh+':'+mm;
        const isToday=d.getDate()===now.getDate()&&d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
        if(isToday)return time;
        const yesterday=new Date(now);yesterday.setDate(now.getDate()-1);
        const isYesterday=d.getDate()===yesterday.getDate()&&d.getMonth()===yesterday.getMonth()&&d.getFullYear()===yesterday.getFullYear();
        if(isYesterday)return 'вчера, '+time;
        const months=['янв','фев','мар','апр','май','июн','июл','авг','сен','окт','ноя','дек'];
        if(d.getFullYear()===now.getFullYear())return d.getDate()+' '+months[d.getMonth()]+', '+time;
        return d.getDate()+' '+months[d.getMonth()]+' '+d.getFullYear()+', '+time;
    }catch(e){return dateStr}
}
function renderTicketChat(el,msgs,isAdm){
    el.innerHTML=(msgs||[]).map(m=>{
        const cls=m.is_admin?'admin':'user';
        const canEdit=isAdm?m.is_admin:!m.is_admin;
        const canDel=isAdm||!m.is_admin;
        return '<div class="ticket-msg '+cls+'" data-mid="'+m.id+'" data-is-admin="'+m.is_admin+'" data-sender="'+m.sender_telegram_id+'" oncontextmenu="_msgCtx(event,this,'+JSON.stringify(canEdit)+','+JSON.stringify(canDel)+','+JSON.stringify(!!isAdm)+')">'+
            _renderMsgContent(m.text)+
            '<div class="ticket-msg-time">'+_fmtTicketTime(m.created_at)+'</div></div>';
    }).join('');
    requestAnimationFrame(()=>{el.scrollTop=el.scrollHeight});
}
function _renderMsgContent(text){
    if(!text)return '';
    // Image
    if(text.startsWith('[IMG:')){
        const src=text.slice(5,-1);
        return '<img class="ticket-msg-img" src="'+src.replace(/"/g,'&quot;')+'" onclick="(()=>{const w=window.open();w.document.write(\'<img src="'+src.replace(/"/g,'&quot;').replace(/'/g,"\\'")+'" style="max-width:100%">\')})()">';
    }
    // Quote lines at top
    const lines=text.split('\n');
    const qLines=[],tLines=[];let q=true;
    for(const l of lines){if(q&&l.startsWith('> ')){qLines.push(l.slice(2))}else{q=false;tLines.push(l)}}
    if(qLines.length){
        return '<div class="ticket-quote">'+esc(qLines.join('\n'))+'</div>'+esc(tLines.join('\n')).replace(/\n/g,'<br>');
    }
    return esc(text).replace(/\n/g,'<br>');
}
// ── Context menu ──
let _ctxTarget=null,_ctxTicketId=null,_ctxIsAdm=false,_ctxCanEdit=false,_ctxCanDel=false;
function _msgCtx(e,el,canEdit,canDel,isAdm){
    e.preventDefault();e.stopPropagation();
    _ctxTarget=el;_ctxIsAdm=isAdm;_ctxCanEdit=canEdit;_ctxCanDel=canDel;
    _ctxTicketId=isAdm?admCurTicketId:curTicketId;
    const m=$('msg-ctx-menu');
    const ew=$('ctx-edit-wrap');const dw=$('ctx-del-wrap');
    if(ew)ew.style.display=canEdit?'':'none';
    if(dw)dw.style.display=canDel?'':'none';
    m.style.display='block';
    const x=Math.min(e.clientX,window.innerWidth-180);
    const y=Math.min(e.clientY,window.innerHeight-140);
    m.style.left=x+'px';m.style.top=y+'px';
    document.addEventListener('click',_closeCtx,{once:true});
}
function _closeCtx(){const m=$('msg-ctx-menu');if(m)m.style.display='none'}
function _ctxReply(){
    _closeCtx();if(!_ctxTarget)return;
    const txt=_ctxTarget.querySelector('.ticket-msg-img')?'[Изображение]':(_ctxTarget.textContent||'').split('\n')[0].trim().substring(0,80);
    if(_ctxIsAdm){
        const qb=$('at-quote-bar');const qt=$('at-quote-text');
        if(qb&&qt){qt.textContent=txt;qb.classList.add('visible')}
        _clearAdmEdit();$('at-text')&&$('at-text').focus();
    } else {
        const qb=$('ticket-quote-bar');const qt=$('ticket-quote-text');
        if(qb&&qt){qt.textContent=txt;qb.classList.add('visible')}
        _clearTicketEdit();$('ticket-text')&&$('ticket-text').focus();
    }
}
function _ctxEdit(){
    _closeCtx();if(!_ctxTarget||!_ctxCanEdit)return;
    const mid=_ctxTarget.dataset.mid;
    const rawText=_ctxTarget.dataset.rawText||((_ctxTarget.querySelector('.ticket-msg-img'))?'[IMG:'+_ctxTarget.querySelector('.ticket-msg-img').src+']':
        ((_ctxTarget.querySelector('.ticket-quote'))?'> '+_ctxTarget.querySelector('.ticket-quote').textContent+'\n'+(_ctxTarget.childNodes[1]||{textContent:''}).textContent:
        (_ctxTarget.textContent||'').replace(/\s+$/,'').split('\n').slice(0,-1).join('\n')));
    if(_ctxIsAdm){
        const eb=$('at-edit-bar');if(eb)eb.classList.add('visible');
        _clearAdmReply();
        const ta=$('at-text');if(ta){ta.value=rawText||'';ta.focus();ta.dataset.editMid=mid}
    } else {
        const eb=$('ticket-edit-bar');if(eb)eb.classList.add('visible');
        _clearTicketReply();
        const ta=$('ticket-text');if(ta){ta.value=rawText||'';ta.focus();ta.dataset.editMid=mid}
    }
}
async function _ctxDelete(){
    _closeCtx();if(!_ctxTarget||!_ctxCanDel)return;
    const mid=_ctxTarget.dataset.mid;
    const base=_ctxIsAdm?API+'/api/admin/tickets/'+_ctxTicketId+'/messages/'+mid:API+'/api/tickets/'+_ctxTicketId+'/messages/'+mid;
    try{const r=await fetch(base,{method:'DELETE'});
    if(r.ok){_ctxTarget.remove()}else{const j=await r.json();toast(j.detail||t('error'),'error')}}
    catch(e){toast(t('error'),'error')}
}
function _clearTicketReply(){const b=$('ticket-quote-bar');if(b)b.classList.remove('visible')}
function _clearTicketEdit(){const b=$('ticket-edit-bar');if(b)b.classList.remove('visible');const ta=$('ticket-text');if(ta)delete ta.dataset.editMid}
function _clearAdmReply(){const b=$('at-quote-bar');if(b)b.classList.remove('visible')}
function _clearAdmEdit(){const b=$('at-edit-bar');if(b)b.classList.remove('visible');const ta=$('at-text');if(ta)delete ta.dataset.editMid}
async function _ticketAttachFile(input,mode){
    const file=input.files&&input.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=async function(ev){
        if(file.type.startsWith('image/')){
            const b64=ev.target.result;
            const text='[IMG:'+b64+']';
            if(mode==='adm'){await _sendAdmMsg(text)}else{await _sendUsrMsg(text)}
        } else {
            toast('Поддерживаются только изображения','error');
        }
        input.value='';
    };
    reader.readAsDataURL(file);
}
async function sendTicketReply(){
    const ta=$('ticket-text');const raw=(ta.value||'').trim();if(!raw||!curTicketId)return;
    const editMid=ta.dataset&&ta.dataset.editMid;
    const qb=$('ticket-quote-bar');
    let text=raw;
    if(!editMid&&qb&&qb.classList.contains('visible')){
        const qt=$('ticket-quote-text');
        text='> '+(qt?qt.textContent:'')+'\n\n'+raw;
    }
    await _sendUsrMsg(text,editMid||null);
}
async function _sendUsrMsg(text,editMid){
    const ta=$('ticket-text');
    try{
        let r;
        if(editMid){
            r=await fetch(API+'/api/tickets/'+curTicketId+'/messages/'+editMid,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
            if(r.ok){const msgs=await fetch(API+'/api/tickets/'+curTicketId).then(x=>x.json());renderTicketChat($('ticket-chat'),msgs.messages,false);}
        } else {
            r=await fetch(API+'/api/tickets/'+curTicketId+'/reply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
            if(r.ok){const t2=await r.json();renderTicketChat($('ticket-chat'),t2.messages,false);pollTicketStatus();}
        }
        if(!r.ok){const j=await r.json();toast(j.detail||'Ошибка','error');return}
        if(ta)ta.value='';_clearTicketReply();_clearTicketEdit();
    }catch(e){toast('Ошибка','error')}
}
async function sendAdmTicketReply(){
    const ta=$('at-text');const raw=(ta.value||'').trim();if(!raw||!admCurTicketId)return;
    const editMid=ta.dataset&&ta.dataset.editMid;
    const qb=$('at-quote-bar');
    let text=raw;
    if(!editMid&&qb&&qb.classList.contains('visible')){
        const qt=$('at-quote-text');
        text='> '+(qt?qt.textContent:'')+'\n\n'+raw;
    }
    await _sendAdmMsg(text,editMid||null);
}
async function _sendAdmMsg(text,editMid){
    const ta=$('at-text');
    try{
        let r;
        if(editMid){
            r=await fetch(API+'/api/admin/tickets/'+admCurTicketId+'/messages/'+editMid,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
            if(r.ok){const msgs=await fetch(API+'/api/admin/tickets/'+admCurTicketId).then(x=>x.json());renderTicketChat($('at-chat'),msgs.messages,true);}
        } else {
            r=await fetch(API+'/api/admin/tickets/'+admCurTicketId+'/reply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
            if(r.ok){const t2=await r.json();renderTicketChat($('at-chat'),t2.messages,true);pollTicketStatus();}
        }
        if(!r.ok){const j=await r.json();toast(j.detail||t('error'),'error');return}
        if(ta)ta.value='';_clearAdmReply();_clearAdmEdit();
    }catch(e){toast(t('error'),'error')}
}
// Enter to send, Shift+Enter for newline on ticket textareas
function _setupTicketKeys(){
    const tt=$('ticket-text');
    if(tt){
        tt.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendTicketReply()}});
        tt.addEventListener('paste',function(e){_handleTicketPaste(e,'ticket')});
    }
    const at=$('at-text');
    if(at){
        at.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendAdmTicketReply()}});
        at.addEventListener('paste',function(e){_handleTicketPaste(e,'adm')});
    }
}
let _pendingPaste=null;
function _handleTicketPaste(e,mode){
    const items=e.clipboardData&&e.clipboardData.items;
    if(!items)return;
    for(const item of items){
        if(item.type.startsWith('image/')){
            e.preventDefault();
            const file=item.getAsFile();if(!file)return;
            const reader=new FileReader();
            reader.onload=function(ev){
                _pendingPaste={dataUrl:ev.target.result,mode};
                _showPasteModal(ev.target.result);
            };
            reader.readAsDataURL(file);
            return;
        }
    }
}
function _showPasteModal(dataUrl){
    showModal(
        '<h3 style="margin:0 0 12px">Отправить изображение</h3>'+
        '<img class="paste-preview-img" src="'+dataUrl.replace(/"/g,'&quot;')+'" alt="">'+
        '<div style="font-size:.78rem;color:var(--text3);margin-bottom:6px">Подпись</div>'+
        '<textarea id="paste-caption" class="form-input" placeholder="Тут можно ввести сообщение" rows="2" style="resize:none;width:100%;box-sizing:border-box"></textarea>'+
        '<div class="modal-actions" style="margin-top:14px;display:flex;justify-content:flex-end;gap:8px">'+
        '<button class="btn btn-secondary" onclick="closeModal();_pendingPaste=null">Отмена</button>'+
        '<button class="btn btn-primary" onclick="_pasteModalSend()">Отправить</button>'+
        '</div>'
    );
    setTimeout(()=>{
        const c=$('paste-caption');
        if(c){
            c.focus();
            c.addEventListener('keydown',function(e){
                if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();_pasteModalSend()}
            });
        }
    },100);
}
async function _pasteModalSend(){
    if(!_pendingPaste){closeModal();return}
    const caption=$('paste-caption')?$('paste-caption').value.trim():'';
    let dataUrl=_pendingPaste.dataUrl;
    const sendFn=async(du)=>{
        const imgTag='[IMG:'+du+']';
        const text=caption?imgTag+'\n'+caption:imgTag;
        const mode=_pendingPaste.mode;
        _pendingPaste=null;closeModal();
        if(mode==='adm')await _sendAdmMsg(text);else await _sendUsrMsg(text);
    };
    if(dataUrl.startsWith('data:image/')){
        try{
            const img=new Image();
            img.onload=function(){
                const maxW=1200,maxH=1200;
                let w=img.width,h=img.height;
                if(w>maxW||h>maxH){const r=Math.min(maxW/w,maxH/h);w=Math.round(w*r);h=Math.round(h*r)}
                const cv=document.createElement('canvas');cv.width=w;cv.height=h;
                cv.getContext('2d').drawImage(img,0,0,w,h);
                sendFn(cv.toDataURL('image/jpeg',0.82));
            };
            img.src=dataUrl;
        }catch(ex){sendFn(dataUrl)}
    } else {sendFn(dataUrl)}
}
function showNewTicket(){
    showModal('<h3>'+t('new_ticket_title')+'</h3><div class="form-group"><label>'+t('subject')+'</label><input class="form-input" id="nt-subj" placeholder="..." autocomplete="off"></div><div class="form-group"><label>'+t('message')+'</label><textarea class="form-input" id="nt-text" rows="4" placeholder="..." style="resize:vertical" autocomplete="off"></textarea></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">'+t('cancel')+'</button><button class="btn btn-primary" onclick="createTicket()">'+t('send')+'</button></div>');
}
async function createTicket(){
    const subject=$('nt-subj').value.trim(), text=$('nt-text').value.trim();
    if(!subject||!text)return toast(t('fill_all'),'error');closeModal();
    try{const r=await fetch(API+'/api/tickets',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subject,text})});
    if(r.ok){toast(t('ticket_created'));const t2=await r.json();curTicketId=t2.id;openTicket(t2.id)}else{const j=await r.json();toast(j.detail||t('error'),'error')}}catch(e){toast(t('error'),'error')}
}

/* ── Tickets (Admin) ── */
const TICKET_STATUS_LABELS={OPEN:'На рассмотрении',ANSWERED:'Ответ получен',CLOSED:'Закрыт',open:'На рассмотрении',answered:'Ответ получен',closed:'Закрыт'};
let admTicketsCache=[];
async function loadAdmTickets(){
    try{const r=await fetch(API+'/api/admin/tickets');if(!r.ok)return;admTicketsCache=await r.json();
    const el=$('adm-tickets-list');
    if(!admTicketsCache.length){el.innerHTML='<div class="empty-state">Нет тикетов</div>';return}
    // Sort admin tickets by updated_at desc
    admTicketsCache.sort((a,b)=>(b.updated_at||'').localeCompare(a.updated_at||''));
    el.innerHTML=admTicketsCache.map(tk=>{
        const st=tk.status.toLowerCase();
        // Admin statuses: unread by admin→"Новый"(red), answered→"Готово"(green), else status
        let stClass=st, stLabel;
        if(!tk.is_read_by_admin && st!=='closed'){
            stClass='new'; stLabel=t('ticket_adm_new');
        } else if(st==='answered'){
            stClass='done'; stLabel=t('ticket_adm_done');
        } else {
            stLabel=t('ticket_'+st)||TICKET_STATUS_LABELS[tk.status]||tk.status;
        }
        const lastMsg=(tk.messages&&tk.messages.length)?tk.messages[tk.messages.length-1].text:'';
        return '<div class="ticket-item" onclick="openAdmTicket('+tk.id+')">'+
            '<div class="ticket-top"><span class="ticket-id">#'+tk.id+' · ID '+tk.user_telegram_id+'</span><span class="ticket-status '+stClass+'">'+stLabel+'</span></div>'+
            '<div class="ticket-row2"><span class="ticket-subject">'+esc(tk.subject)+'</span></div>'+
            (lastMsg?'<div class="ticket-preview">'+esc(lastMsg.substring(0,80))+'</div>':'')+
            '<div class="ticket-bottom-row"><span class="ticket-date">'+tk.updated_at+'</span><button class="btn-trash" onclick="event.stopPropagation();delAdmTicket('+tk.id+')" title="Удалить тикет">'+IC.trash+'</button></div>'+
            '</div>';
    }).join('')}catch(e){}
}
async function delAdmTicket(id){
    if(!confirm(t('delete_ticket_q')+' #'+id+'?'))return;
    try{const r=await fetch(API+'/api/admin/tickets/'+id,{method:'DELETE'});
    if(r.ok){toast(t('deleted'));loadAdmTickets()}else{const j=await r.json();toast(j.detail||t('error'),'error')}}catch(e){toast(t('error'),'error')}
}
let admCurTicketId=null;
async function openAdmTicket(id){
    admCurTicketId=id;go('aticket');$('at-title').textContent=t('loading');$('at-chat').innerHTML='';
    _clearAdmReply();_clearAdmEdit();
    try{const r=await fetch(API+'/api/admin/tickets/'+id);if(!r.ok)return;
    const tk=await r.json();$('at-title').textContent='#'+tk.id+' '+tk.subject;
    renderTicketChat($('at-chat'),tk.messages,true);
    // Clear admin badge immediately
    pollTicketStatus();
    }catch(e){}
}
async function delAdmTicketFromDetail(id){
    if(!confirm(t('delete_ticket_q')+' #'+id+'?'))return;
    try{const r=await fetch(API+'/api/admin/tickets/'+id,{method:'DELETE'});
    if(r.ok){toast(t('deleted'));admTab('tickets');go('admin')}else{const j=await r.json();toast(j.detail||t('error'),'error')}}catch(e){toast(t('error'),'error')}
}

/* ── Admin Brand ── */
function loadBrandForm(){$('br-name').value=BRAND.name||'';$('br-logo').value=BRAND.logo||'';$('br-slogan').value=BRAND.slogan||''}
async function saveBrand(){
    const d={name:$('br-name').value.trim(),logo:$('br-logo').value.trim(),slogan:$('br-slogan').value.trim()};
    try{const r=await fetch(API+'/api/settings/brand',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
    if(r.ok){
        BRAND=d;
        const logoEl=$('brand-logo');
        const effectiveLogo=BRAND.logo||DEFAULT_LOGO;
        if(effectiveLogo.startsWith('http')){logoEl.innerHTML='<img class="brand-logo-img" src="'+esc(effectiveLogo)+'" alt="">';logoEl.classList.add('has-img')}
        else{logoEl.textContent=effectiveLogo;logoEl.classList.remove('has-img')}
        $('brand-name').textContent=BRAND.name||DEFAULT_NAME;
        const sl=$('brand-slogan');
        const effSl=BRAND.slogan||DEFAULT_SLOGAN;
        sl.textContent=effSl;sl.style.display=''
        toast('Сохранено')
    }else toast('Ошибка','error')}catch(e){toast('Ошибка','error')}
}

/* ═══════════════════════════════════════
   UTILS
   ═══════════════════════════════════════ */
function toast(m,t){const e=$('toast');e.textContent=m;e.className='toast visible'+(t?' toast-'+t:'');clearTimeout(e._t);e._t=setTimeout(()=>e.className='toast',3000)}
function showModal(h,cls){
    const mr=$('modal-root');
    const existing=mr.querySelector('.modal-overlay');
    if(existing){
        const card=existing.querySelector('.modal-card');
        if(card){card.innerHTML=h;return}
    }
    mr.innerHTML='<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-card modal-renew'+(cls&&cls!=='modal-renew'?' '+cls:'')+'">'+(h)+'</div></div>';
}
function closeModal(){$('modal-root').innerHTML=''}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function pluralDays(n){
    if(CUR_LOCALE==='EN')return n===1?'day':'days';
    if(CUR_LOCALE==='DE')return n===1?'Tag':'Tage';
    if(CUR_LOCALE==='UK'){const a=Math.abs(n)%100,b=a%10;if(a>10&&a<20)return 'днів';if(b>1&&b<5)return 'дні';if(b===1)return 'день';return 'днів'}
    const a=Math.abs(n)%100,b=a%10;if(a>10&&a<20)return 'дней';if(b>1&&b<5)return 'дня';if(b===1)return 'день';return 'дней'
}
function pluralHours(n){
    if(CUR_LOCALE==='EN')return n===1?'hour':'hours';
    if(CUR_LOCALE==='DE')return n===1?'Stunde':'Stunden';
    if(CUR_LOCALE==='UK'){const a=Math.abs(n)%100,b=a%10;if(a>10&&a<20)return 'годин';if(b>1&&b<5)return 'години';if(b===1)return 'годину';return 'годин'}
    const a=Math.abs(n)%100,b=a%10;if(a>10&&a<20)return 'часов';if(b>1&&b<5)return 'часа';if(b===1)return 'час';return 'часов'
}
function detectOS(){
    const ua=navigator.userAgent||'',p=navigator.platform||'';
    if(/Win/i.test(p))return 'windows';
    if(/Mac/i.test(p)&&!/iPhone|iPad/.test(ua))return 'macos';
    if(/Android/i.test(ua))return 'android';
    if(/iPhone|iPad|iPod/i.test(ua))return 'ios';
    return 'unknown';
}
function getDownloadUrl(){
    const os=detectOS();
    if(os==='windows')return 'https://github.com/Happ-proxy/happ-desktop/releases/latest/download/setup-Happ.x64.exe';
    if(os==='macos')return 'https://github.com/Happ-proxy/happ-desktop/releases/';
    if(os==='android')return 'https://play.google.com/store/apps/details?id=com.happproxy';
    if(os==='ios')return 'https://apps.apple.com/app/happ-proxy-utility-plus/id6746188973';
    return 'https://github.com/Happ-proxy/happ-desktop/releases/';
}

init();
</script>
</body>
</html>
