<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<link rel="stylesheet" href="/web/static/css/style.css">
</head>
<body>
<div class="bg-glow"></div>
<div id="particles-js"></div>
<div id="app">

<!-- Loading -->
<div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
</div>

<!-- Error -->
<div id="error-screen" class="loading-screen" style="display:none">
    <p id="error-msg" style="color:var(--red);padding:20px;text-align:center"></p>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="main-app" class="app-wrapper" style="display:none">

<header class="app-header">
    <div class="brand">
        <span class="brand-logo" id="brand-logo">üîê</span>
        <span class="brand-name" id="brand-name">VPN Shop</span>
    </div>
    <span class="header-badge" id="hdr-balance" onclick="go('profile')">0 ‚ÇΩ</span>
</header>

<main class="app-content">

<!-- ‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê -->
<section id="p-home" class="page active">
    <!-- Subscription card -->
    <div class="card sub-card">
        <div class="sub-card-top">
            <span class="sub-badge sub-badge-none" id="sub-badge">‚Äî</span>
            <span class="sub-expire" id="sub-expire"></span>
        </div>
        <div class="sub-traffic" id="sub-traffic"></div>
    </div>

    <!-- Actions -->
    <div class="action-pills">
        <button class="pill pill-gold" onclick="buySubscription()">üõí&nbsp; –ö—É–ø–∏—Ç—å</button>
        <button class="pill trial-pill" id="btn-trial" onclick="startTrial()" style="display:none">üéÅ&nbsp; –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
        <button class="pill pill-cyan" onclick="go('connect')">‚äô&nbsp; –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
        <div class="pill-row">
            <button class="pill pill-outline" onclick="go('promo')">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥—ã</button>
            <button class="pill pill-outline" onclick="go('devices')">üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>
        </div>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê PLANS ‚ïê‚ïê‚ïê -->
<section id="p-plans" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã</h2>
    </div>
    <div id="plans-list" class="plans-list"></div>
</section>

<!-- ‚ïê‚ïê‚ïê CONNECT ‚ïê‚ïê‚ïê -->
<section id="p-connect" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h2>
    </div>
    <div class="card">
        <div class="card-title">–°—Å—ã–ª–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏</div>
        <div class="connect-box">
            <code id="con-url">‚Äî</code>
            <button onclick="copyUrl()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>
    <div class="card" id="con-actions" style="display:none">
        <div class="card-title">–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
        <div class="action-pills">
            <button class="pill pill-cyan" id="btn-oneclick" onclick="">‚ö° –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤ –æ–¥–∏–Ω –∫–ª–∏–∫</button>
            <button class="pill pill-outline" id="btn-subpage" onclick="">üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏</button>
        </div>
    </div>
    <div class="card">
        <div class="card-title">–°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
        <div class="apps-grid">
            <a class="app-link" onclick="openLink('https://apps.apple.com/app/happ-proxy-utility-plus/id6746188973')"><span class="app-icon">üçè</span> iOS</a>
            <a class="app-link" onclick="openLink('https://play.google.com/store/apps/details?id=com.happproxy')"><span class="app-icon">ü§ñ</span> Android</a>
            <a class="app-link" onclick="openLink('https://github.com/Happ-proxy/happ-desktop/releases/latest/download/setup-Happ.x64.exe')"><span class="app-icon">ü™ü</span> Windows</a>
            <a class="app-link" onclick="openLink('https://github.com/Happ-proxy/happ-desktop/releases/')"><span class="app-icon">üçé</span> macOS</a>
        </div>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê DEVICES ‚ïê‚ïê‚ïê -->
<section id="p-devices" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h2>
    </div>
    <div id="devices-info" class="card">
        <div class="card-row"><span class="card-label">–õ–∏–º–∏—Ç</span><span class="card-value" id="dev-limit">‚Äî</span></div>
        <div class="card-row"><span class="card-label">–ó–∞–Ω—è—Ç–æ</span><span class="card-value" id="dev-used">‚Äî</span></div>
    </div>
    <p style="font-size:.82rem;color:var(--text3);margin-top:8px">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –±–æ—Ç–µ.</p>
</section>

<!-- ‚ïê‚ïê‚ïê PROMO ‚ïê‚ïê‚ïê -->
<section id="p-promo" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ü—Ä–æ–º–æ–∫–æ–¥—ã</h2>
    </div>
    <div class="card">
        <div class="card-title">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</div>
        <div style="display:flex;gap:8px">
            <input class="form-input" id="promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" style="flex:1">
            <button class="btn btn-primary btn-sm" onclick="activatePromo()">OK</button>
        </div>
        <p id="promo-result" style="font-size:.8rem;margin-top:8px;display:none"></p>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê SUPPORT ‚ïê‚ïê‚ïê -->
<section id="p-support" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
    </div>
    <div class="card card-compact" style="cursor:pointer" onclick="go('tickets')">
        <div class="card-title">üé´ –¢–∏–∫–µ—Ç—ã <span id="ticket-badge" class="ticket-badge" style="display:none">0</span></div>
        <span class="pill pill-cyan pill-sm">–û—Ç–∫—Ä—ã—Ç—å</span>
    </div>
    <div class="card card-compact" id="support-community" style="display:none">
        <div class="card-title">üí¨ –°–æ–æ–±—â–µ—Å—Ç–≤–æ</div>
        <button class="pill pill-cyan pill-sm" id="btn-community" onclick="">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="card card-compact" id="support-help" style="display:none">
        <div class="card-title">üõü –ü–æ–º–æ—â—å</div>
        <button class="pill pill-outline pill-sm" id="btn-support" onclick="">–ù–∞–ø–∏—Å–∞—Ç—å</button>
    </div>
    <div class="card card-compact" id="support-tos" style="display:none">
        <div class="card-title">üìÑ –°–æ–≥–ª–∞—à–µ–Ω–∏–µ</div>
        <button class="pill pill-outline pill-sm" id="btn-tos" onclick="">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê TICKET LIST ‚ïê‚ïê‚ïê -->
<section id="p-tickets" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('support')">‚Äπ</button>
        <h2 class="page-title">–ú–æ–∏ —Ç–∏–∫–µ—Ç—ã</h2>
        <button class="btn btn-primary btn-sm" onclick="showNewTicket()" style="margin-left:auto">+ –ù–æ–≤—ã–π</button>
    </div>
    <div id="tickets-list" class="ticket-list"></div>
</section>

<!-- ‚ïê‚ïê‚ïê TICKET CHAT ‚ïê‚ïê‚ïê -->
<section id="p-ticket" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('tickets');loadTickets()">‚Äπ</button>
        <h2 class="page-title" id="ticket-title">–¢–∏–∫–µ—Ç</h2>
    </div>
    <div id="ticket-chat" class="ticket-chat"></div>
    <div id="ticket-reply" class="ticket-reply-box" style="display:none">
        <textarea id="ticket-text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" rows="1"></textarea>
        <button class="ticket-send-btn" onclick="sendTicketReply()">‚Üí</button>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê -->
<section id="p-profile" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ü—Ä–æ—Ñ–∏–ª—å</h2>
    </div>
    <div class="card">
        <div class="card-row"><span class="card-label">–ò–º—è</span><span class="card-value" id="pr-name">‚Äî</span></div>
        <div class="card-row"><span class="card-label">Telegram</span><span class="card-value" id="pr-uname">‚Äî</span></div>
        <div class="card-row"><span class="card-label">ID</span><span class="card-value" id="pr-tid">‚Äî</span></div>
        <div class="card-row"><span class="card-label">–ë–∞–ª–∞–Ω—Å</span><span class="card-value" id="pr-balance">‚Äî</span></div>
        <div class="card-row"><span class="card-label">–†–æ–ª—å</span><span class="card-value" id="pr-role">‚Äî</span></div>
    </div>
    <!-- Balance -->
    <div class="card" id="balance-card" style="display:none">
        <div class="card-title">üí∞ –ë–∞–ª–∞–Ω—Å</div>
        <div class="action-pills">
            <button class="pill pill-gold" onclick="topupBalance()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        </div>
    </div>
    <!-- Referral -->
    <div class="card" id="ref-card" style="display:none">
        <div class="card-title">ü§ù –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</div>
        <div class="ref-box">
            <code id="ref-link">‚Äî</code>
            <button class="btn btn-primary btn-sm btn-full" onclick="copyRef()" style="margin-top:4px">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        </div>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê ADMIN ‚ïê‚ïê‚ïê -->
<section id="p-admin" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="go('home')">‚Äπ</button>
        <h2 class="page-title">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
    </div>
    <div class="admin-tabs" id="adm-tabs">
        <button class="admin-tab active" onclick="admTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="admin-tab" onclick="admTab('users')">–ü–æ–ª—å–∑.</button>
        <button class="admin-tab" onclick="admTab('plans')">–¢–∞—Ä–∏—Ñ—ã</button>
        <button class="admin-tab" onclick="admTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button class="admin-tab" onclick="admTab('tickets')">–¢–∏–∫–µ—Ç—ã</button>
        <button class="admin-tab" onclick="admTab('brand')">–ë—Ä–µ–Ω–¥</button>
    </div>

    <!-- Stats -->
    <div id="adm-stats" class="admin-content active">
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="st-total">‚Äî</div><div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div></div>
            <div class="stat-card"><div class="stat-value" id="st-active">‚Äî</div><div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div></div>
            <div class="stat-card"><div class="stat-value" id="st-expired">‚Äî</div><div class="stat-label">–ò—Å—Ç–µ–∫—à–∏—Ö</div></div>
            <div class="stat-card"><div class="stat-value" id="st-revenue">‚Äî</div><div class="stat-label">–ë–∞–ª–∞–Ω—Å ‚ÇΩ</div></div>
        </div>
    </div>
    <!-- Users -->
    <div id="adm-users" class="admin-content">
        <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ / ID" oninput="filterUsers()">
        </div>
        <div id="users-list" class="user-list"></div>
    </div>
    <!-- Plans admin -->
    <div id="adm-plans" class="admin-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
            <span style="color:var(--text2);font-size:.84rem" id="adm-plans-count">–¢–∞—Ä–∏—Ñ—ã</span>
            <button class="btn btn-primary btn-sm" onclick="showCreatePlan()">+ –°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <div id="adm-plans-list" class="plans-list"></div>
    </div>
    <!-- Settings -->
    <div id="adm-settings" class="admin-content"><div id="settings-list"></div></div>
    <!-- Admin Tickets -->
    <div id="adm-tickets" class="admin-content">
        <div id="adm-tickets-list" class="ticket-list"></div>
    </div>
    <!-- Brand -->
    <div id="adm-brand" class="admin-content">
        <div class="card">
            <div class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–µ–Ω–¥–∞</div>
            <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="form-input" id="br-name" placeholder="VPN Shop"></div>
            <div class="form-group"><label>–õ–æ–≥–æ—Ç–∏–ø (—ç–º–æ–¥–∑–∏)</label><input class="form-input" id="br-logo" placeholder="üîê"></div>
            <div class="form-group"><label>–°–ª–æ–≥–∞–Ω</label><input class="form-input" id="br-slogan" placeholder=""></div>
            <button class="btn btn-primary btn-full" onclick="saveBrand()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</section>

<!-- ‚ïê‚ïê‚ïê ADMIN USER DETAIL ‚ïê‚ïê‚ïê -->
<section id="p-auser" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="admTab('users');go('admin')">‚Äπ</button>
        <h2 class="page-title" id="aud-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
    </div>
    <div id="aud-body"></div>
</section>

<!-- ‚ïê‚ïê‚ïê ADMIN TICKET DETAIL ‚ïê‚ïê‚ïê -->
<section id="p-aticket" class="page">
    <div class="page-header">
        <button class="btn-back" onclick="admTab('tickets');go('admin')">‚Äπ</button>
        <h2 class="page-title" id="at-title">–¢–∏–∫–µ—Ç</h2>
    </div>
    <div id="at-chat" class="ticket-chat"></div>
    <div id="at-reply" class="ticket-reply-box">
        <textarea id="at-text" placeholder="–û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞‚Ä¶" rows="1"></textarea>
        <button class="ticket-send-btn" onclick="sendAdmTicketReply()">‚Üí</button>
    </div>
</section>

</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <button class="nav-item active" data-p="home" onclick="go('home')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button class="nav-item" data-p="support" onclick="go('support')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
    </button>
    <button class="nav-item" data-p="profile" onclick="go('profile')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </button>
    <button class="nav-item admin-nav" data-p="admin" onclick="go('admin')" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        <span>–ê–¥–º–∏–Ω</span>
    </button>
</nav>
</div>

<div id="modal-root"></div>
<div id="toast" class="toast"></div>
</div>
<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GLOBALS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const API='/web', tg=window.Telegram.WebApp;
let D=null, BRAND={name:'VPN Shop',logo:'üîê',slogan:''}, IS_ADMIN=false;
let usersCache=[], curAdmTab='stats', DOMAIN='';
const AVAIL_LABELS={ALL:'–í—Å–µ',NEW:'–ù–æ–≤—ã–µ',EXISTING:'–î–µ–π—Å—Ç–≤—É—é—â–∏–µ',INVITED:'–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ',ALLOWED:'–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ',TRIAL:'–ü—Ä–æ–±–Ω—ã–π'};
const TYPE_LABELS={TRAFFIC:'–¢—Ä–∞—Ñ–∏–∫',DEVICES:'–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',BOTH:'–¢—Ä–∞—Ñ–∏–∫+–£—Å—Ç—Ä.',UNLIMITED:'–ë–µ–∑–ª–∏–º–∏—Ç'};
const CURRENCY_SYMBOLS={USD:'$',EUR:'‚Ç¨',XTR:'‚òÖ',RUB:'‚ÇΩ'};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function init(){
    tg.ready(); tg.expand();
    try{tg.setHeaderColor('#080C14')}catch(e){}
    try{tg.setBackgroundColor('#080C14')}catch(e){}
    initParticles();
    try{
        const a=await fetch(API+'/api/auth/tg',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData:tg.initData})});
        if(!a.ok) return showErr('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û—Ç–∫—Ä–æ–π—Ç–µ –∏–∑ Telegram.');
        const dr=await fetch(API+'/api/user/data');
        if(!dr.ok) return showErr('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.');
        D=await dr.json();
        try{const br=await fetch(API+'/api/settings/brand');if(br.ok)BRAND=await br.json()}catch(e){}
        try{const cfg=await fetch(API+'/api/config');if(cfg.ok){const c=await cfg.json();DOMAIN=c.domain||''}}catch(e){}
        IS_ADMIN=D.user.role==='DEV'||D.user.role==='ADMIN';
        $('loading-screen').style.display='none';
        $('main-app').style.display='flex';
        if(IS_ADMIN) document.querySelectorAll('.admin-nav').forEach(e=>e.style.display='');
        render();
    }catch(e){showErr('–û—à–∏–±–∫–∞: '+e.message)}
}

function initParticles(){
    if(typeof particlesJS!=='undefined'){
        particlesJS('particles-js',{
            particles:{
                number:{value:60,density:{enable:true,value_area:800}},
                color:{value:'#24C4F1'},
                shape:{type:'circle'},
                opacity:{value:0.25,random:true,anim:{enable:false}},
                size:{value:2,random:true,anim:{enable:false}},
                line_linked:{enable:true,distance:180,color:'#24C4F1',opacity:0.08,width:1},
                move:{enable:true,speed:0.6,direction:'none',random:false,straight:false,out_mode:'out',bounce:false}
            },
            interactivity:{
                detect_on:'window',
                events:{onhover:{enable:true,mode:'grab'},onclick:{enable:true,mode:'push'},resize:true},
                modes:{grab:{distance:140,line_linked:{opacity:0.3}},push:{particles_nb:1}}
            },
            retina_detect:true
        });
    }
}

function showErr(m){$('loading-screen').style.display='none';$('error-screen').style.display='flex';$('error-msg').textContent=m}
function $(id){return document.getElementById(id)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAVIGATION
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const mainPages=['home','support','profile','admin'];
function go(p){
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    $('p-'+p).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.toggle('active',b.dataset.p===p));
    if(p==='home'){tg.BackButton.hide()}else{tg.BackButton.show();tg.BackButton.offClick(goHome);tg.BackButton.onClick(goHome)}
    if(p==='admin')loadAdm(curAdmTab);
    if(p==='plans')renderPlans();
    if(p==='tickets')loadTickets();
}
function goHome(){go('home')}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RENDER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function render(){
    $('brand-logo').textContent=BRAND.logo||'üîê';
    $('brand-name').textContent=BRAND.name||'VPN Shop';
    $('hdr-balance').textContent=D.user.balance+' '+(CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ');
    renderSub(); renderConnect(); renderProfile(); renderSupport();
    // Trial button
    if(D.trial_available) $('btn-trial').style.display='';
    // Ticket badge
    if(D.ticket_unread>0){$('ticket-badge').style.display='';$('ticket-badge').textContent=D.ticket_unread}
}

function renderSub(){
    const s=D.subscription, b=$('sub-badge'), e=$('sub-expire'), t=$('sub-traffic');
    if(!s||!s.status){
        b.textContent='–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏';b.className='sub-badge sub-badge-none';
        e.textContent='';t.innerHTML='';return;
    }
    if(s.is_trial){b.textContent='–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥';b.className='sub-badge sub-badge-trial'}
    else if(s.status==='ACTIVE'){b.textContent='–ê–∫—Ç–∏–≤–Ω–∞';b.className='sub-badge sub-badge-active'}
    else if(s.status==='EXPIRED'){b.textContent='–ò—Å—Ç–µ–∫–ª–∞';b.className='sub-badge sub-badge-expired'}
    else{b.textContent=s.status;b.className='sub-badge sub-badge-none'}
    e.innerHTML=s.expire_at?'üìÖ –¥–æ '+s.expire_at:'';
    const tl=s.traffic_limit? s.traffic_limit+' GB':'‚àû';
    t.innerHTML='–¢—Ä–∞—Ñ–∏–∫ <b>0 B / '+tl+'</b>';
}

function renderPlans(){
    const el=$('plans-list'), dc=D.default_currency||'RUB', sym=CURRENCY_SYMBOLS[dc]||'‚ÇΩ';
    if(!D.plans||!D.plans.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">üìã</span><h3>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤</h3></div>';return}
    // Find base price-per-day for discount calc
    let basePpd=null;
    D.plans.forEach(p=>{
        (p.durations||[]).forEach(d=>{
            const pr=findPrice(d,dc);
            if(pr!==null && d.days>0){
                const ppd=pr/d.days;
                if(basePpd===null||d.days<=(basePpd.days||9999)){basePpd={ppd,days:d.days}}
            }
        });
    });

    el.innerHTML=D.plans.map(p=>{
        const durs=(p.durations||[]).map(d=>{
            const pr=findPrice(d,dc);
            if(pr===null) return '';
            let discountHtml='';
            if(basePpd && d.days>basePpd.days && pr>0){
                const ppd=pr/d.days;
                const pct=Math.round((1-ppd/basePpd.ppd)*100);
                if(pct>0) discountHtml='<span class="plan-discount-badge">-'+pct+'%</span>';
            }
            return '<div class="plan-duration"><span class="plan-days">'+fmtDays(d.days)+'</span><span class="plan-price">'+pr+' '+sym+discountHtml+'</span></div>';
        }).join('');
        return '<div class="card plan-card" onclick="selectPlan('+p.id+')"><h3 class="plan-name">'+esc(p.name)+'</h3><div class="plan-info"><span>üì¶ '+(p.traffic_limit||'‚àû')+' GB</span><span>üì± '+(p.device_limit||'‚àû')+' —É—Å—Ç—Ä.</span></div><div class="plan-durations">'+durs+'</div><button class="plan-buy-btn" onclick="event.stopPropagation();selectPlan('+p.id+')">–í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ</button></div>';
    }).join('');
}

function findPrice(dur,currency){
    const p=(dur.prices||[]).find(x=>x.currency===currency);
    return p?parseFloat(p.amount):null;
}
function fmtDays(d){
    if(d<=0)return '‚àû';
    if(d===1)return '1 –¥–µ–Ω—å';
    if(d===7)return '7 –¥–Ω–µ–π';
    if(d===30)return '1 –º–µ—Å.';
    if(d===60)return '2 –º–µ—Å.';
    if(d===90)return '3 –º–µ—Å.';
    if(d===180)return '6 –º–µ—Å.';
    if(d===365)return '1 –≥–æ–¥';
    return d+' –¥–Ω.';
}

function renderConnect(){
    const s=D.subscription;
    $('con-url').textContent=(s&&s.url)?s.url:'–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏';
    if(s&&s.url&&DOMAIN){
        $('con-actions').style.display='';
        $('btn-oneclick').onclick=()=>openLink('https://'+DOMAIN+'/api/v1/connect/'+s.url.split('/').pop());
        $('btn-subpage').onclick=()=>openLink(s.url);
    }
    const dl=D.subscription&&D.subscription.device_limit;
    $('dev-limit').textContent=dl||'‚Äî';
    $('dev-used').textContent='‚Äî';
}

function renderProfile(){
    const u=D.user, sym=CURRENCY_SYMBOLS[D.default_currency]||'‚ÇΩ';
    $('pr-name').textContent=u.name||'‚Äî';
    $('pr-uname').textContent=u.username?'@'+u.username:'‚Äî';
    $('pr-tid').textContent=u.telegram_id;
    $('pr-balance').textContent=u.balance+' '+sym;
    const rm={USER:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',ADMIN:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',DEV:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫'};
    $('pr-role').textContent=rm[u.role]||u.role;
    if(D.features&&D.features.balance_enabled!==false) $('balance-card').style.display='';
    if(D.features&&D.features.referral_enabled!==false){
        $('ref-card').style.display='';
        const bot=D.bot_username||'bot';
        $('ref-link').textContent='https://t.me/'+bot+'?start=ref_'+u.telegram_id;
    }
}

function renderSupport(){
    if(D.features){
        if(D.features.community_enabled&&D.features.community_url){
            $('support-community').style.display='';
            $('btn-community').onclick=()=>openLink(D.features.community_url);
        }
        if(D.features.tos_enabled){
            $('support-tos').style.display='';
            $('btn-tos').onclick=()=>openLink(D.features.tos_url||'');
        }
    }
    if(D.support_url){
        $('support-help').style.display='';
        $('btn-support').onclick=()=>openLink(D.support_url);
    }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   USER ACTIONS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buySubscription(){
    if(D.plans&&D.plans.length) go('plans');
    else toast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤','error');
}
function selectPlan(id){toast('–ü–æ–∫—É–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞')}
function startTrial(){toast('–ü—Ä–æ–±–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞')}
function openLink(u){if(u)tg.openLink(u)}
function copyUrl(){
    const s=D.subscription;
    if(s&&s.url)navigator.clipboard.writeText(s.url).then(()=>toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!')).catch(()=>toast('–û—à–∏–±–∫–∞','error'));
    else toast('–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏','error');
}
function copyRef(){
    const t=$('ref-link').textContent;
    navigator.clipboard.writeText(t).then(()=>toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')).catch(()=>toast('–û—à–∏–±–∫–∞','error'));
}
function topupBalance(){toast('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞')}
async function activatePromo(){
    const code=$('promo-input').value.trim();if(!code)return;
    const r=$('promo-result');
    try{
        const res=await fetch(API+'/api/promocode/activate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
        const d=await res.json();r.style.display='block';
        if(res.ok){r.style.color='var(--green)';r.textContent=d.message||'–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!'}
        else{r.style.color='var(--red)';r.textContent=d.detail||'–û—à–∏–±–∫–∞'}
    }catch(e){r.style.display='block';r.style.color='var(--red)';r.textContent='–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ADMIN
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function admTab(t){
    curAdmTab=t;
    document.querySelectorAll('#adm-tabs .admin-tab').forEach((b,i)=>b.classList.toggle('active',['stats','users','plans','settings','tickets','brand'][i]===t));
    document.querySelectorAll('.admin-content').forEach(c=>c.classList.remove('active'));
    const el=$('adm-'+t);if(el)el.classList.add('active');
    loadAdm(t);
}
async function loadAdm(t){
    if(t==='stats')await loadStats();
    if(t==='users')await loadUsers();
    if(t==='plans')await loadAdmPlans();
    if(t==='settings')await loadSettings();
    if(t==='tickets')await loadAdmTickets();
    if(t==='brand')loadBrandForm();
}
async function loadStats(){
    try{const r=await fetch(API+'/api/admin/stats');if(!r.ok)return;const d=await r.json();
    $('st-total').textContent=d.total_users||0;$('st-active').textContent=d.active_subscriptions||0;
    $('st-expired').textContent=d.expired_subscriptions||0;$('st-revenue').textContent=(d.total_revenue||0)}catch(e){}
}
async function loadUsers(){
    try{const r=await fetch(API+'/api/admin/users');if(!r.ok)return;usersCache=await r.json();drawUsers(usersCache)}catch(e){}
}
function filterUsers(){
    const q=$('user-search').value.toLowerCase().trim();
    if(!q)return drawUsers(usersCache);
    drawUsers(usersCache.filter(u=>(u.name||'').toLowerCase().includes(q)||String(u.telegram_id).includes(q)||(u.username||'').toLowerCase().includes(q)));
}
function drawUsers(list){
    const el=$('users-list');
    if(!list.length){el.innerHTML='<div class="empty-state">–ü—É—Å—Ç–æ</div>';return}
    el.innerHTML=list.slice(0,50).map(u=>{
        const ini=(u.name||'?')[0].toUpperCase();
        const rc=u.role==='DEV'?'role-dev':u.role==='ADMIN'?'role-admin':'role-user';
        const rn=u.role==='DEV'?'DEV':u.role==='ADMIN'?'ADM':'USER';
        return '<div class="user-item" onclick="openUser('+u.telegram_id+')"><div class="user-item-info"><div class="user-avatar">'+esc(ini)+'</div><div><div class="user-name">'+esc(u.name||'‚Äî')+'</div><div class="user-sub">ID: '+u.telegram_id+'</div></div></div><span class="role-badge '+rc+'">'+rn+'</span></div>';
    }).join('');
}
async function openUser(tid){
    go('auser');$('aud-title').textContent='–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';$('aud-body').innerHTML='<div style="text-align:center;padding:40px"><div class="spinner"></div></div>';
    try{
        const r=await fetch(API+'/api/admin/users/'+tid);if(!r.ok){$('aud-body').innerHTML='<div class="empty-state">–û—à–∏–±–∫–∞</div>';return}
        const u=await r.json();$('aud-title').textContent=u.name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';drawUserDetail(u);
    }catch(e){$('aud-body').innerHTML='<div class="empty-state">'+e.message+'</div>'}
}
function drawUserDetail(u){
    const rm={USER:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',ADMIN:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',DEV:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫'};
    const si=u.subscription?'<div class="card-row"><span class="card-label">–ü–æ–¥–ø–∏—Å–∫–∞</span><span class="card-value">'+(u.subscription.plan_name||'‚Äî')+'</span></div><div class="card-row"><span class="card-label">–°—Ç–∞—Ç—É—Å</span><span class="card-value">'+u.subscription.status+'</span></div><div class="card-row"><span class="card-label">–ò—Å—Ç–µ–∫–∞–µ—Ç</span><span class="card-value">'+(u.subscription.expire_at||'‚Äî')+'</span></div>':'<div class="card-row"><span class="card-label">–ü–æ–¥–ø–∏—Å–∫–∞</span><span class="card-value" style="color:var(--text3)">–ù–µ—Ç</span></div>';
    $('aud-body').innerHTML='<div class="card"><div class="card-row"><span class="card-label">–ò–º—è</span><span class="card-value">'+esc(u.name||'‚Äî')+'</span></div><div class="card-row"><span class="card-label">Username</span><span class="card-value">'+(u.username?'@'+esc(u.username):'‚Äî')+'</span></div><div class="card-row"><span class="card-label">ID</span><span class="card-value">'+u.telegram_id+'</span></div><div class="card-row"><span class="card-label">–ë–∞–ª–∞–Ω—Å</span><span class="card-value">'+u.balance+' ‚ÇΩ</span></div><div class="card-row"><span class="card-label">–†–æ–ª—å</span><span class="card-value">'+(rm[u.role]||u.role)+'</span></div><div class="card-row"><span class="card-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span><span class="card-value">'+(u.is_blocked?'–î–∞':'–ù–µ—Ç')+'</span></div>'+si+'</div><div style="display:flex;flex-direction:column;gap:8px"><button class="btn btn-secondary btn-full" onclick="changeRole('+u.telegram_id+',\''+u.role+'\')">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button><button class="btn btn-secondary btn-full" onclick="changeBal('+u.telegram_id+','+u.balance+')">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button><button class="btn '+(u.is_blocked?'btn-primary':'btn-danger')+' btn-full" onclick="toggleBlock('+u.telegram_id+','+u.is_blocked+')">'+(u.is_blocked?'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å')+'</button></div>';
}
function changeRole(tid,cur){
    const roles=['USER','ADMIN','DEV'],names=['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å','–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä','–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫'];
    showModal('<h3>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</h3>'+roles.map((r,i)=>'<button class="btn '+(r===cur?'btn-primary':'btn-secondary')+' btn-full" style="margin-top:6px" onclick="setRole('+tid+',\''+r+'\')">'+names[i]+'</button>').join('')+'<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>');
}
async function setRole(tid,role){closeModal();try{const r=await fetch(API+'/api/admin/users/'+tid+'/role',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role})});if(r.ok){toast('–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞');openUser(tid)}else{const d=await r.json();toast(d.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}
function changeBal(tid,cur){
    showModal('<h3>–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3><p style="color:var(--text2);font-size:.84rem;margin-bottom:10px">–¢–µ–∫—É—â–∏–π: '+cur+' ‚ÇΩ</p><div class="form-group"><label>–°—É–º–º–∞ (+/-)</label><input class="form-input" id="bal-amt" type="number" placeholder="100"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="setBal('+tid+')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>');
}
async function setBal(tid){const a=parseFloat($('bal-amt').value);if(isNaN(a))return toast('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ','error');closeModal();try{const r=await fetch(API+'/api/admin/users/'+tid+'/balance',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:a})});if(r.ok){toast('–ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω—ë–Ω');openUser(tid)}else{const d=await r.json();toast(d.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}
async function toggleBlock(tid,blocked){try{const r=await fetch(API+'/api/admin/users/'+tid+'/block',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({block:!blocked})});if(r.ok){toast(blocked?'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');openUser(tid)}else{const d=await r.json();toast(d.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}

/* ‚îÄ‚îÄ Admin Plans (enhanced) ‚îÄ‚îÄ */
let admPlansCache=[];
async function loadAdmPlans(){
    try{const r=await fetch(API+'/api/admin/plans');if(!r.ok)return;admPlansCache=await r.json();
    $('adm-plans-count').textContent='–¢–∞—Ä–∏—Ñ—ã ('+admPlansCache.length+')';
    drawAdmPlans()}catch(e){}
}
function drawAdmPlans(){
    const el=$('adm-plans-list');
    if(!admPlansCache.length){el.innerHTML='<div class="empty-state">–ù–µ—Ç —Ç–∞—Ä–∏—Ñ–æ–≤</div>';return}
    el.innerHTML=admPlansCache.map(p=>{
        const avl=AVAIL_LABELS[p.availability]||p.availability;
        const isTrial=p.availability==='TRIAL';
        return '<div class="plan-admin-card'+(p.is_active?'':' inactive')+'" onclick="editPlan('+p.id+')">'+
            '<div class="plan-admin-top">'+
                '<span class="plan-admin-name">'+esc(p.name)+'</span>'+
                (p.tag?'<span class="plan-admin-tag">'+esc(p.tag)+'</span>':'')+
                '<span class="avail-badge'+(isTrial?' trial':'')+'">'+avl+'</span>'+
                '<div class="plan-admin-actions" onclick="event.stopPropagation()">'+
                    '<button class="btn-toggle-plan'+(p.is_active?' active':'')+'" onclick="togglePlan('+p.id+',this)" title="'+(p.is_active?'–í—ã–∫–ª—é—á–∏—Ç—å':'–í–∫–ª—é—á–∏—Ç—å')+'"></button>'+
                    '<button class="btn-trash" onclick="delPlan('+p.id+')" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>'+
                '</div>'+
            '</div>'+
            '<div class="plan-admin-meta">'+
                '<span>üì¶ '+(p.traffic_limit||'‚àû')+' GB</span>'+
                '<span>üì± '+(p.device_limit||'‚àû')+' —É—Å—Ç—Ä.</span>'+
                '<span>‚è± '+(p.durations||[]).length+' –ø–µ—Ä–∏–æ–¥(–æ–≤)</span>'+
            '</div>'+
        '</div>';
    }).join('');
}
async function togglePlan(id,btn){
    try{const r=await fetch(API+'/api/admin/plans/'+id+'/toggle',{method:'PATCH'});
    if(r.ok){const d=await r.json();btn.classList.toggle('active',d.is_active);
    // Update cache
    const p=admPlansCache.find(x=>x.id===id);if(p)p.is_active=d.is_active;
    btn.closest('.plan-admin-card').classList.toggle('inactive',!d.is_active);
    toast(d.is_active?'–í–∫–ª—é—á—ë–Ω':'–í—ã–∫–ª—é—á–µ–Ω')}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}
async function delPlan(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ?'))return;try{const r=await fetch(API+'/api/admin/plans/'+id,{method:'DELETE'});if(r.ok){toast('–£–¥–∞–ª—ë–Ω');loadAdmPlans()}else{const j=await r.json();toast(j.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}}

/* ‚îÄ‚îÄ Plan Create / Edit Modal ‚îÄ‚îÄ */
let editingPlanId=null;
function showCreatePlan(){editingPlanId=null;showPlanModal({name:'',description:'',tag:'',availability:'ALL',type:'BOTH',traffic_limit:100,device_limit:1,durations:[{days:30,prices:[{currency:D.default_currency||'RUB',amount:'0'}]}]},'–°–æ–∑–¥–∞—Ç—å —Ç–∞—Ä–∏—Ñ')}
function editPlan(id){
    const p=admPlansCache.find(x=>x.id===id);if(!p)return;
    editingPlanId=id;
    showPlanModal(p,'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞—Ä–∏—Ñ');
}
function showPlanModal(p,title){
    const dc=D.default_currency||'RUB';
    const durs=(p.durations||[]).map((d,i)=>{
        const pr=(d.prices||[]).find(x=>x.currency===dc);
        const amt=pr?pr.amount:'0';
        return durEntryHtml(i,d.days,amt);
    }).join('');
    const availOpts=Object.entries(AVAIL_LABELS).map(([k,v])=>'<option value="'+k+'"'+(p.availability===k?' selected':'')+'>'+v+'</option>').join('');
    const typeOpts=Object.entries(TYPE_LABELS).map(([k,v])=>'<option value="'+k+'"'+(p.type===k?' selected':'')+'>'+v+'</option>').join('');
    showModal(
        '<h3>'+title+'</h3>'+
        '<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="form-input" id="np-name" value="'+esc(p.name)+'" placeholder="–ë–∞–∑–æ–≤—ã–π"></div>'+
        '<div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input class="form-input" id="np-desc" value="'+esc(p.description||'')+'" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞"></div>'+
        '<div class="form-row"><div class="form-group"><label>–¢–µ–≥</label><input class="form-input" id="np-tag" value="'+esc(p.tag||'')+'" placeholder="base"></div><div class="form-group"><label>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</label><select class="form-input" id="np-avail">'+availOpts+'</select></div></div>'+
        '<div class="form-row"><div class="form-group"><label>–¢–∏–ø</label><select class="form-input" id="np-type">'+typeOpts+'</select></div><div class="form-group"><label>–¢—Ä–∞—Ñ–∏–∫ (GB)</label><input class="form-input" id="np-traffic" type="number" value="'+p.traffic_limit+'"></div></div>'+
        '<div class="form-group"><label>–£—Å—Ç—Ä–æ–π—Å—Ç–≤</label><input class="form-input" id="np-dev" type="number" value="'+p.device_limit+'"></div>'+
        '<div style="margin-bottom:8px"><label style="font-size:.8rem;color:var(--text3);font-weight:500">–ü–µ—Ä–∏–æ–¥—ã –∏ —Ü–µ–Ω—ã ('+(CURRENCY_SYMBOLS[dc]||dc)+')</label></div>'+
        '<div id="dur-list">'+durs+'</div>'+
        '<button class="btn btn-secondary btn-sm" onclick="addDurEntry()" style="margin-bottom:10px">+ –ü–µ—Ä–∏–æ–¥</button>'+
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="savePlan()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>'
    );
}
function durEntryHtml(i,days,amount){
    return '<div class="duration-entry" data-idx="'+i+'"><div class="duration-entry-header"><span style="font-size:.8rem;color:var(--text2);font-weight:600">–ü–µ—Ä–∏–æ–¥ #'+(i+1)+'</span><button class="dur-remove" onclick="this.closest(\'.duration-entry\').remove()">‚úï</button></div><div class="form-row"><div class="form-group"><label>–î–Ω–µ–π</label><input class="form-input dur-days" type="number" value="'+days+'" min="1"></div><div class="form-group"><label>–¶–µ–Ω–∞</label><input class="form-input dur-price" type="number" value="'+amount+'" min="0" step="0.01"></div></div></div>';
}
function addDurEntry(){
    const list=$('dur-list');
    const idx=list.querySelectorAll('.duration-entry').length;
    list.insertAdjacentHTML('beforeend',durEntryHtml(idx,30,'0'));
}
async function savePlan(){
    const name=$('np-name').value.trim();if(!name)return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','error');
    const dc=D.default_currency||'RUB';
    const durations=[];
    $('dur-list').querySelectorAll('.duration-entry').forEach(el=>{
        const days=parseInt(el.querySelector('.dur-days').value)||30;
        const price=el.querySelector('.dur-price').value||'0';
        durations.push({days,prices:[{currency:dc,amount:price}]});
    });
    const body={
        name,
        description:$('np-desc').value.trim(),
        tag:$('np-tag').value.trim(),
        availability:$('np-avail').value,
        type:$('np-type').value,
        traffic_limit:parseInt($('np-traffic').value)||100,
        device_limit:parseInt($('np-dev').value)||1,
        durations
    };
    closeModal();
    try{
        const url=editingPlanId?API+'/api/admin/plans/'+editingPlanId:API+'/api/admin/plans';
        const method=editingPlanId?'PUT':'POST';
        const r=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(r.ok){toast(editingPlanId?'–¢–∞—Ä–∏—Ñ –æ–±–Ω–æ–≤–ª—ë–Ω':'–¢–∞—Ä–∏—Ñ —Å–æ–∑–¥–∞–Ω');loadAdmPlans()}
        else{const j=await r.json();toast(j.detail||'–û—à–∏–±–∫–∞','error')}
    }catch(e){toast('–û—à–∏–±–∫–∞','error')}
}

/* ‚îÄ‚îÄ Admin Settings ‚îÄ‚îÄ */
async function loadSettings(){
    try{const r=await fetch(API+'/api/admin/settings');if(!r.ok)return;const s=await r.json();
    $('settings-list').innerHTML='<div class="card">'+Object.entries(s).map(([k,v])=>{
        const l=sLabel(k);
        if(typeof v==='boolean')return '<div class="toggle-row"><label>'+l+'</label><button class="toggle-switch '+(v?'active':'')+'" onclick="toggleSet(\''+k+'\','+(!v)+',this)"></button></div>';
        return '<div class="card-row"><span class="card-label">'+l+'</span><span class="card-value">'+esc(String(v))+'</span></div>';
    }).join('')+'</div>'}catch(e){}
}
function sLabel(k){const m={balance_enabled:'–ë–∞–ª–∞–Ω—Å',community_enabled:'–°–æ–æ–±—â–µ—Å—Ç–≤–æ',tos_enabled:'–û—Ñ–µ—Ä—Ç–∞',referral_enabled:'–†–µ—Ñ–µ—Ä–∞–ª—ã',promocodes_enabled:'–ü—Ä–æ–º–æ–∫–æ–¥—ã',notifications_enabled:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',access_enabled:'–î–æ—Å—Ç—É–ø',language_enabled:'–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å',access_mode:'–†–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞',default_currency:'–í–∞–ª—é—Ç–∞',purchases_allowed:'–ü–æ–∫—É–ø–∫–∏',registration_allowed:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'};return m[k]||k}
async function toggleSet(k,v,btn){try{const r=await fetch(API+'/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[k]:v})});if(r.ok){btn.classList.toggle('active',v);toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}}

/* ‚îÄ‚îÄ Tickets (User) ‚îÄ‚îÄ */
let curTicketId=null;
async function loadTickets(){
    try{const r=await fetch(API+'/api/tickets');if(!r.ok)return;const tks=await r.json();
    const el=$('tickets-list');
    if(!tks.length){el.innerHTML='<div class="empty-state"><span class="empty-icon">üé´</span><h3>–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤</h3><p style="color:var(--text3);font-size:.84rem">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–∏–∫–µ—Ç</p></div>';return}
    el.innerHTML=tks.map(t=>{
        const st=t.status.toLowerCase();
        const last=t.messages&&t.messages.length?t.messages[t.messages.length-1].text:'';
        return '<div class="ticket-item'+(t.is_read_by_user?'':' unread')+'" onclick="openTicket('+t.id+')">'+
            '<div class="ticket-top"><span class="ticket-subject">'+esc(t.subject)+'</span><span class="ticket-status '+st+'">'+st+'</span></div>'+
            '<div class="ticket-preview">'+esc(last.substring(0,80))+'</div>'+
            '<div class="ticket-date">'+t.updated_at+'</div></div>';
    }).join('')}catch(e){}
}
async function openTicket(id){
    curTicketId=id; go('ticket');$('ticket-title').textContent='–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';$('ticket-chat').innerHTML='';$('ticket-reply').style.display='none';
    try{const r=await fetch(API+'/api/tickets/'+id);if(!r.ok)return;
    const t=await r.json();$('ticket-title').textContent=t.subject;
    renderTicketChat($('ticket-chat'),t.messages);
    if(t.status!=='CLOSED'){$('ticket-reply').style.display='flex'}
    else{$('ticket-reply').style.display='none'}
    }catch(e){}
}
function renderTicketChat(el,msgs){
    el.innerHTML=(msgs||[]).map(m=>{
        const cls=m.is_admin?'admin':'user';
        return '<div class="ticket-msg '+cls+'">'+esc(m.text)+'<div class="ticket-msg-time">'+m.created_at+'</div></div>';
    }).join('');el.scrollTop=el.scrollHeight;
}
async function sendTicketReply(){
    const text=$('ticket-text').value.trim();if(!text||!curTicketId)return;
    try{const r=await fetch(API+'/api/tickets/'+curTicketId+'/reply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    if(r.ok){$('ticket-text').value='';const t=await r.json();renderTicketChat($('ticket-chat'),t.messages)}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}
function showNewTicket(){
    showModal('<h3>–ù–æ–≤—ã–π —Ç–∏–∫–µ—Ç</h3><div class="form-group"><label>–¢–µ–º–∞</label><input class="form-input" id="nt-subj" placeholder="–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º"></div><div class="form-group"><label>–°–æ–æ–±—â–µ–Ω–∏–µ</label><textarea class="form-input" id="nt-text" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É‚Ä¶" style="resize:vertical"></textarea></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="createTicket()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>');
}
async function createTicket(){
    const subject=$('nt-subj').value.trim(), text=$('nt-text').value.trim();
    if(!subject||!text)return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è','error');closeModal();
    try{const r=await fetch(API+'/api/tickets',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subject,text})});
    if(r.ok){toast('–¢–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω');const t=await r.json();curTicketId=t.id;openTicket(t.id)}else{const j=await r.json();toast(j.detail||'–û—à–∏–±–∫–∞','error')}}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}

/* ‚îÄ‚îÄ Tickets (Admin) ‚îÄ‚îÄ */
let admTicketsCache=[];
async function loadAdmTickets(){
    try{const r=await fetch(API+'/api/admin/tickets');if(!r.ok)return;admTicketsCache=await r.json();
    const el=$('adm-tickets-list');
    if(!admTicketsCache.length){el.innerHTML='<div class="empty-state">–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤</div>';return}
    el.innerHTML=admTicketsCache.map(t=>{
        const st=t.status.toLowerCase();
        const last=t.messages&&t.messages.length?t.messages[t.messages.length-1].text:'';
        return '<div class="ticket-item'+(t.is_read_by_admin?'':' unread')+'" onclick="openAdmTicket('+t.id+')">'+
            '<div class="ticket-top"><span class="ticket-subject">'+esc(t.subject)+'</span><span class="ticket-status '+st+'">'+st+'</span></div>'+
            '<div class="ticket-preview"><b>ID '+t.user_telegram_id+'</b> ‚Äî '+esc(last.substring(0,60))+'</div>'+
            '<div class="ticket-date">'+t.updated_at+'</div></div>';
    }).join('')}catch(e){}
}
let admCurTicketId=null;
async function openAdmTicket(id){
    admCurTicketId=id;go('aticket');$('at-title').textContent='–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';$('at-chat').innerHTML='';
    try{const r=await fetch(API+'/api/admin/tickets/'+id);if(!r.ok)return;
    const t=await r.json();$('at-title').textContent='#'+t.id+' '+t.subject;
    renderTicketChat($('at-chat'),t.messages);
    }catch(e){}
}
async function sendAdmTicketReply(){
    const text=$('at-text').value.trim();if(!text||!admCurTicketId)return;
    try{const r=await fetch(API+'/api/admin/tickets/'+admCurTicketId+'/reply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    if(r.ok){$('at-text').value='';const t=await r.json();renderTicketChat($('at-chat'),t.messages)}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}

/* ‚îÄ‚îÄ Admin Brand ‚îÄ‚îÄ */
function loadBrandForm(){$('br-name').value=BRAND.name||'';$('br-logo').value=BRAND.logo||'';$('br-slogan').value=BRAND.slogan||''}
async function saveBrand(){
    const d={name:$('br-name').value.trim()||'VPN Shop',logo:$('br-logo').value.trim()||'üîê',slogan:$('br-slogan').value.trim()};
    try{const r=await fetch(API+'/api/settings/brand',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
    if(r.ok){BRAND=d;$('brand-logo').textContent=BRAND.logo;$('brand-name').textContent=BRAND.name;toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')}else toast('–û—à–∏–±–∫–∞','error')}catch(e){toast('–û—à–∏–±–∫–∞','error')}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UTILS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toast(m,t){const e=$('toast');e.textContent=m;e.className='toast visible'+(t?' toast-'+t:'');clearTimeout(e._t);e._t=setTimeout(()=>e.className='toast',3000)}
function showModal(h){$('modal-root').innerHTML='<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal-card">'+h+'</div></div>'}
function closeModal(){$('modal-root').innerHTML=''}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

init();
</script>
</body>
</html>
